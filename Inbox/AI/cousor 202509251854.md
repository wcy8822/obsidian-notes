

文件路径:
根目录/Users/didi/Downloads/panth/tag_ct_clean

待整理的数据源/Users/didi/Downloads/panth/tag_ct_clean/outputs_real_prod_20250923_093500/temp
里面有 3 个文件,,

文件路径和对应的表头字段如下:
/Users/didi/Downloads/panth/tag_ct_clean/outputs_real_prod_20250923_093500/temp/20250923_0833_RAW1.xlsx

|   |   |   |   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|---|
|store_id|tag_code|raw_value|source|observed_at|data_quality_score|value_type|value_text|value_column|enum_code|
|5439970606908645474|brand_name|凉城县通达加油站|s2|2025-07-24 00:00:00|1|region_full_0919||||

| /Users/didi/Downloads/panth/tag_ct_clean/outputs_real_prod_20250923_093500/temp/06_final.xlsx |            |                     |                     |             |               |            |                |             |             |                    |            |                |                  |
| --------------------------------------------------------------------------------------------- | ---------- | ------------------- | ------------------- | ----------- | ------------- | ---------- | -------------- | ----------- | ----------- | ------------------ | ---------- | -------------- | ---------------- |
| store_id                                                                                      | tag_code   | raw_values          | preliminary_results | brand_final | win_logic     | confidence | is_valid_brand | is_fallback | observed_at | data_quality_score | value_type | closest_source | trace_id         |
| 1134360643181499214                                                                           | brand_name | 中国石化铜都加油站(春晓路)；虚拟商户 | 中国石化 (80)；          | 中国石化        | 所有初步结果一致，直接选中 | 80         | TRUE           | FALSE       |             |                    | text       | s3             | 8cd5dc26bb9711ab |



/Users/didi/Downloads/panth/tag_ct_clean/outputs_real_prod_20250923_093500/temp/raw_s3_correction_tag_staging.csv

|          |            |          |                   |                     |                     |        |                |          |        |      |                 |
| -------- | ---------- | -------- | ----------------- | ------------------- | ------------------- | ------ | -------------- | -------- | ------ | ---- | --------------- |
| store_id | as_of_date | tag_code | target_value_bool | target_value_number | target_value_string | source | evidence_state | ttl_days | reason | conf | upload_batch_id |


处理逻辑是:
通过RAW1 和 final 表来产出 RAW_S*_correction_tag_staging.csv

步骤 1:
|   |   |   |   |   |   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|---|---|---|
  
|store_id|as_of_date|tag_code|target_value_bool|target_value_number|target_value_string|source|evidence_state|ttl_days|reason|conf|upload_batch_id|
|强关联RAW1|关联RAW1,空值留空|强关联RAW1|3个valve值通过 通过tag_spec.csv查询,tag_code的对应的value_type_connect,`tag_code, value_type_connect, ,做插槽选择.命中哪个写入哪个.主键=store_id+as_of_date+tag_code；三槽位互斥；值槽位仅一项非空：`target_value_bool/number/string`。|||强关联RAW1|找得到就传回找不到就空值|通过RAW1的tag_code查字典对应的ttl_days+()用as_of_dat表示数据更新日期-今天)的天数,来表示这个标签还有多少天就到期了|读raw1的value_type|有就传没有就留空|返回RAW1的文件名|

步骤 2:根据步骤 1 的结果,对 tag_code=brand_name,对应的 target_value_string(按逻辑应该是写入这里的),如果不是要防呆检测哈.  做改写更新,原列和对应值备份成target_value_string_back,新逻辑写入target_value_string,新逻辑是用 final 的数据做回填,同时,校验其对应的source列的值,如果是空值,用 final 表中的closest_source做回填.

步骤 3,按source来源做拆分,按 S1,S2,S3做分类,如果有空值和未知的默认放入 S3 数据中,保存成对应不同的文件名( raw_s*_correction_tag_staging.csv,*用对应的 1/2/3回填
),保存在根目录下 out_时间戳做批次
我要写个数据整理的代码,帮我写个 PRD,我投喂给 cline帮我产出. 大概逻辑:产出一个



请在 organize_tags.py 中，新增“brand_name 枚举对齐与回填”步骤（执行时序：在 brand_final 回填完成之后、无意义行丢弃/去重/分流之前），按如下规则实现：

【输入参考表】
- tag_enum 路径：/Users/didi/Downloads/panth/tag_ct_clean/data/ref/tag_enum.csv
  * 字段至少包含：tag_code, enum_label, enum_code
- other 回填参考表：/Users/didi/Downloads/panth/tag_ct_clean/data/ref/raw_s3_correction_tag_staging.csv
  * 字段至少包含：store_id, tag_code, target_value_string

【处理范围】
- 仅处理 staging 中 tag_code == 'brand_name' 的记录（tag_code 先统一小写 strip）

【步骤 1：枚举对齐】
- 将当前行的 target_value_string 作为 enum_label，连同 tag_code 组成键 (tag_code, enum_label)
- 在 tag_enum.csv 中查找 enum_code；命中则写入 staging['enum_code']，target_value_string 不变
- 未命中则 staging['enum_code'] = 'other'

【步骤 2：other 回填】
- 过滤 staging 中 enum_code == 'other' 的行，按主键 (store_id,  tag_code) 与 raw_s3_correction_tag_staging.csv 关联
- 若命中参考表，则覆盖 staging['target_value_string'] = ref['target_value_string']
- 命不中则保持原值

【细节要求】
- 联合键对齐前对 store_id 做 normalize（沿用现有 normalize_store_id 规则）；as_of_date/标签大小写需要 strip/统一格式
- 不改变三槽互斥与既有 brand_final 回填逻辑；本步骤仅新增 enum_code 与可能覆盖 target_value_string（仅在 enum_code='other' 且参考表命中时）
- 新增计数写入 run_manifest.json：
  - brand_enum_lookup_total：参与查枚举的行数
  - brand_enum_hit：命中枚举的行数
  - brand_enum_other：未命中且置 other 的行数
  - brand_enum_other_backfill_hit：在 other 中通过参考表成功覆盖 target_value_string 的行数

【验收断言】
- brand_enum_lookup_total = staging 中 tag_code='brand_name' 的行数
- brand_enum_hit + brand_enum_other == brand_enum_lookup_total
- 示例：若某行 brand_name 的 target_value_string='壳牌' 且 tag_enum 中存在 ('brand_name','壳牌')->enum_code='SHELL'，则应写入 enum_code='SHELL'；若不存在则 enum_code='other'，并尝试用 raw_s3_correction_tag_staging.csv 通过 (store_id, tag_code) 覆盖 target_value_string（命中才覆盖）。



/Users/didi/Downloads/panth/tag_ct_clean/out_20250923_143236/correction_tag_staging_all.csv 这个是我的文件,

表头如下,store_id as_of_date tag_code target_value_bool target_value_number target_value_string source evidence_state ttl_days reason conf upload_batch_id closest_source target_value_string_back;1.用store_id as_of_date tag_code source 去重.2.对