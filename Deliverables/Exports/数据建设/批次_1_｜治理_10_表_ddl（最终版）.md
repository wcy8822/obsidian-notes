# 批次 1｜治理 10 表 DDL（最终版）
> 说明：保持通用 SQL 方言，可在 Hive/StarRocks/ClickHouse 按需微调类型；键/索引/检查约束尽量通用。所有表均按 **tag_id/spec_version/rule_version** 可检索；来源类型按你口径：official/region/ops/external/intel。

```sql
/*
 * 1) 标签目录（三层路径 + A/B + 归属）
 */
CREATE TABLE IF NOT EXISTS tag_catalog (
  tag_id              STRING      NOT NULL,        -- 全局唯一（建议 UUID 或稳定英文码）
  tier1               STRING      NOT NULL,        -- 一级：基础合作/策略运营/站内服务
  tier2               STRING      NOT NULL,        -- 二级
  tier3               STRING      NOT NULL,        -- 三级（具体标签名）
  tag_code            STRING      NOT NULL,        -- 英文码（用于字段命名）
  tag_class           STRING      NOT NULL,        -- 'A' | 'B'
  status              STRING      DEFAULT 'released', -- draft/released/deprecated
  owner_biz           STRING      DEFAULT '王超宇',
  owner_data          STRING      DEFAULT 'DE_TBD',
  created_at          TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
  updated_at          TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (tag_id)
);
CREATE INDEX IF NOT EXISTS idx_tag_catalog_path ON tag_catalog (tier1,tier2,tier3);

/*
 * 2) 标签规格/口径（SCD2 风格）
 */
CREATE TABLE IF NOT EXISTS tag_spec (
  tag_id              STRING      NOT NULL,
  spec_version        STRING      NOT NULL,    -- 1.0.0
  definition          STRING      NOT NULL,    -- 人话定义与边界
  value_type          STRING      NOT NULL,    -- bool/enum/id/text/number
  fallback            STRING      NOT NULL,    -- Unknown/其他 口径
  examples            STRING,                  -- 边界案例
  effective_from      DATE        NOT NULL,
  effective_to        DATE,                    -- 为空=当前生效
  approved_by         STRING,
  approved_at         TIMESTAMP,
  PRIMARY KEY (tag_id, spec_version)
);
CREATE INDEX IF NOT EXISTS idx_tag_spec_current ON tag_spec (tag_id, effective_to);

/*
 * 3) 标签枚举/字典
 */
CREATE TABLE IF NOT EXISTS tag_enum (
  tag_id              STRING      NOT NULL,
  spec_version        STRING      NOT NULL,
  enum_code           STRING      NOT NULL,    -- 存储值：1/0/99 或 brand_id 等
  enum_label          STRING      NOT NULL,    -- 展示值：中文名等
  sort_order          INT         DEFAULT 0,
  is_default          BOOLEAN     DEFAULT FALSE,
  PRIMARY KEY (tag_id, spec_version, enum_code)
);
CREATE INDEX IF NOT EXISTS idx_tag_enum_label ON tag_enum (tag_id, enum_label);

/*
 * 4) 质量门槛/抽样
 */
CREATE TABLE IF NOT EXISTS tag_quality_policy (
  tag_id              STRING      NOT NULL,
  spec_version        STRING      NOT NULL,
  acc_min             DECIMAL(5,2) DEFAULT 0.90,
  cov_min             DECIMAL(5,2) DEFAULT 0.90,
  fresh_sla           STRING       DEFAULT 'T+1',
  stable_max          DECIMAL(5,2) DEFAULT 0.05,
  sample_min_n        INT          DEFAULT 50,
  sample_pct          DECIMAL(5,2) DEFAULT 0.05,
  review_mode         STRING       DEFAULT 'double_kappa>=0.8',
  PRIMARY KEY (tag_id, spec_version)
);

/*
 * 5) 数据源注册（来源契约）
 */
CREATE TABLE IF NOT EXISTS tag_source_registry (
  source_id           STRING      NOT NULL,   -- official/region/ops/external/intel 或自定义
  source_name         STRING      NOT NULL,   -- 可读名称
  table_name          STRING      NOT NULL,
  refresh_policy      STRING,                 -- T+1/实时/周更
  primary_keys        STRING,                 -- JSON: ["station_id","as_of_date"]
  fields              STRING,                 -- JSON：字段契约（名称/类型/是否必填）
  sla                 STRING,                 -- 例如 08:00 前就绪
  drift_threshold     STRING,                 -- JSON：分布漂移阈值
  owner_biz           STRING      DEFAULT '王超宇',
  owner_data          STRING      DEFAULT 'DE_TBD',
  created_at          TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
  updated_at          TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (source_id)
);
CREATE INDEX IF NOT EXISTS idx_src_table ON tag_source_registry (table_name);

/*
 * 6) 规则配置（声明式，执行层读取生成 SQL/作业）
 */
CREATE TABLE IF NOT EXISTS tag_rule_config (
  tag_id              STRING      NOT NULL,
  spec_version        STRING      NOT NULL,
  rule_version        STRING      NOT NULL,
  region_scope        STRING,                 -- JSON：省/市/站型灰度
  priority            STRING,                 -- JSON：来源/证据优先级
  thresholds          STRING,                 -- JSON：相似度/次数/N,K,TTL 等
  weights             STRING,                 -- JSON：来源权重（official/region/ops/external/intel）
  fallback            STRING,                 -- JSON：回退策略（Unknown/其他）
  blacklist           STRING,                 -- JSON：禁配/黑名单
  whitelist           STRING,                 -- JSON：白名单/强制
  created_at          TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
  is_active           BOOLEAN     DEFAULT TRUE,
  PRIMARY KEY (tag_id, rule_version)
);
CREATE INDEX IF NOT EXISTS idx_rule_active ON tag_rule_config (tag_id, is_active);

/*
 * 7) 探测器配置（A 类）
 */
CREATE TABLE IF NOT EXISTS tag_detector_config (
  detector_id         STRING      NOT NULL,   -- 例如 overlap_price_expose
  tag_id              STRING      NOT NULL,
  rule_version        STRING      NOT NULL,
  signal_type         STRING      NOT NULL,   -- price_expose/text_ocr/psi_spike
  window_days         INT         NOT NULL,   -- 2/3/7 等
  threshold           STRING      NOT NULL,   -- JSON：阈值
  effect              STRING      NOT NULL,   -- JSON：对 evidence_state 的影响
  is_active           BOOLEAN     DEFAULT TRUE,
  created_at          TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (detector_id)
);
CREATE INDEX IF NOT EXISTS idx_detector_tag ON tag_detector_config (tag_id);

/*
 * 8) 发版记录
 */
CREATE TABLE IF NOT EXISTS tag_release (
  tag_id              STRING      NOT NULL,
  rule_version        STRING      NOT NULL,
  region_scope        STRING,                 -- JSON：省/市范围
  metrics             STRING,                 -- JSON：QA 指标（Acc/Cov/Fresh/Stable）
  affected_rows       BIGINT,                 -- 影响条数
  released_by         STRING,
  released_at         TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
  rollback_point      STRING,                 -- 版本或日期
  PRIMARY KEY (tag_id, rule_version, released_at)
);
CREATE INDEX IF NOT EXISTS idx_release_latest ON tag_release (tag_id, released_at);

/*
 * 9) 变更审计
 */
CREATE TABLE IF NOT EXISTS tag_change_log (
  tag_id              STRING      NOT NULL,
  change_id           STRING      NOT NULL,   -- UUID
  actor               STRING      NOT NULL,
  change_summary      STRING      NOT NULL,
  before              STRING,                 -- JSON
  after               STRING,                 -- JSON
  changed_at          TIMESTAMP   DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (tag_id, change_id)
);
CREATE INDEX IF NOT EXISTS idx_change_time ON tag_change_log (changed_at);

/*
 * 10) 金标准样本集（验收/回归）
 */
CREATE TABLE IF NOT EXISTS tag_testset (
  tag_id              STRING      NOT NULL,
  spec_version        STRING      NOT NULL,
  region              STRING      NOT NULL,
  station_gid         STRING      NOT NULL,
  label_value         STRING      NOT NULL,   -- 金标值
  evidence            STRING,                 -- JSON：标注证据
  reviewed_by         STRING,
  reviewed_at         TIMESTAMP,
  is_gold             BOOLEAN     DEFAULT TRUE,
  PRIMARY KEY (tag_id, spec_version, region, station_gid)
);
CREATE INDEX IF NOT EXISTS idx_testset_region ON tag_testset (region);
```

## 辅助 View（便于引擎侧统一取“当前有效”）
```sql
-- 当前生效的规格版本
CREATE VIEW IF NOT EXISTS vw_tag_spec_current AS
SELECT s.* FROM tag_spec s
WHERE s.effective_to IS NULL;

-- 当前激活的规则配置
CREATE VIEW IF NOT EXISTS vw_tag_rule_active AS
SELECT * FROM tag_rule_config WHERE is_active = TRUE;
```

## 示例：来源注册与权重（占位示例）
```sql
INSERT INTO tag_source_registry (source_id, source_name, table_name, refresh_policy, primary_keys, fields, sla)
VALUES
('official','官方/内部','dim_station_master','T+1','["station_id"]','{"station_id":"string","name":"string"}','04:00'),
('region','区域回填','dwd_region_feedback','T+1','["store_id","report_time"]','{"store_id":"string","service":"string"}','20:00'),
('ops','商户运营','coop_ops_entry','T+1','["store_id","updated_at"]','{"brand_display":"string"}','20:00'),
('external','外采/竞对','ext_competitor_station','T+1','["poi_id"]','{"poi_id":"string","lng":"double"}','12:00'),
('intel','情报源','raw_intelligence_form','T+1','["evidence_id"]','{"brand_text":"string"}','20:00');

-- 规则配置中的来源权重（写入 JSON）
UPDATE tag_rule_config
SET weights='{"official":1.0,"region":0.9,"ops":0.85,"external":0.8,"intel":0.7}'
WHERE tag_id='overlap' AND rule_version='1.0.0';
```

