# 《拒收与校验规则清单 v1.0》（RAW→STD）

> 版本：v1.0 · 适用里程碑：**930 上线 P0=13 标签**  
> 范围：**三源 RAW（S2/S3/S4）→ STD** 的到数与质量校验；不含 SQL，实现由 DE 按本清单在作业中落地。

---

## 0. 设计原则
- **先快挡后高挡**：RAW 层只做“能跑起来”的硬校验；STD 层做类型/口径收口。  
- **三色灯**：`Reject（拒收） / Warn（警告） / Auto-Fix（自动修复）`——尽量把可确定修复的留在 STD，避免过度拒收。  
- **统一主键**：除 S1 外，RAW 统一主键 **`(store_id, as_of_date, tag_code)`**；同键覆盖（幂等）。

---

## 1. 校验顺序（流水线）
1) **文件/分区可读**（编码/表头/分区存在）→  
2) **主键与槽位**（三件套、互斥）→  
3) **字典命中**（`tag_code` 在 `vw_tag_spec_current`）→  
4) **类型一致**（`tag_code → value_type` 与 `target_value_*` 匹配）→  
5) **订正属性**（仅 S3：`ttl_days>0`）→  
6) **时间字段**（`as_of_date` 合法；`report_time` 可解析）→  
7) **业务值域**（枚举合法、时段格式等）→  
8) **重复/覆盖策略**（同键多行收口为一条，取最后一次或按批次优先）→  
9) **落 STD**（统一布尔/枚举/单位；写 `std_ruleset`）。

---

## 2. RAW 层硬校验（Reject）
> 命中任一项 **拒收**（不入 STD），由业务修正后重投。

| 代码 | 规则 | 说明 |
|---|---|---|
| **R001** | 主键缺失 | `store_id`/`as_of_date`/`tag_code` 任一为空 |
| **R002** | 槽位互斥违规 | `target_value_bool/number/string` 同时填了 ≥2 项 |
| **R003** | `tag_code` 不存在 | 未命中 `vw_tag_spec_current`（或状态非 `active`） |
| **R004** | 类型错配 | 例如 `value_type=BOOL` 却填了 `target_value_string` |
| **R005** | 布尔非法 | `target_value_bool ∉ {0,1,99}` |
| **R006** | 订正缺少 TTL | S3（`raw_ops_tag`）未提供 `ttl_days` 或 `≤0` |
| **R007** | 时间非法 | `as_of_date`/`report_time` 解析失败；或 `as_of_date` 在未来 |
| **R008** | 订正禁用 | 标签在字典中 `allow_ops_fix=false` 但写入了 S3 |

> 注：**没有 `store_id` 的行不允许进入 RAW**（先通过 S1 解析，再投）。

---

## 3. RAW 层软校验（Warn）
> 不阻断入 STD，但会在 QC 面板标红并建议整改。

| 代码 | 规则 | 说明 |
|---|---|---|
| **W101** | 重复过多 | 同 `(store_id, as_of_date, tag_code)` 多次投递（>3 次/日） |
| **W102** | 缺少 `reason` | S3/S4 建议提供订正/情报依据说明 |
| **W103** | 批次异常 | `batch_id` 缺失或非约定格式 |
| **W104** | 渠道未知 | `source_channel` 超出约定枚举（app/form/excel/...） |

---

## 4. STD 层自动修复（Auto-Fix）
> 可确定的无损修复在 STD 完成；无法修复的转 **Reject（S 段）** 或 **Warn**。

| 代码 | 行为 | 说明 |
|---|---|---|
| **A201** | 文本去噪 | 去首尾空格、全角半角统一、压缩重复空格 |
| **A202** | 大小写/别名归一 | 枚举/文本按字典别名归并为标准 code |
| **A203** | 布尔显式化 | 将 `true/false/Yes/No/是/否` 统一为 `1/0`（仅当原字段落在 `target_value_string` 且类型=BOOL） |
| **A204** | 时段合法化 | `HHMM-HHMM` 校正（`8:00-22:00` → `0800-2200`；跨日/颠倒标记为 99 并 Warn） |
| **A205** | 单位归一 | 数值单位换算（如分钟→小时）按规则执行 |

---

## 5. STD 层拒收（S 段 Reject）
> 无法自动修复且会污染口径的，**停止进入 INPUT**。

| 代码 | 规则 | 说明 |
|---|---|---|
| **S301** | 枚举非法 | `target_value_string` 不在 `enum_set` 中 |
| **S302** | 时段非法 | `open.hours` 无法合法化（如 `2500-1200`） |
| **S303** | 数值越界 | 超出定义的物理/业务上限（如负数或上限外） |
| **S304** | 订正过期 | S3 提供的 `as_of_date + ttl_days < 今天`（历史订正过期，不发布） |

---

## 6. 重复与覆盖（幂等策略）
- **定义**：同一 `(store_id, as_of_date, tag_code)` 在 RAW 出现多行。  
- **S2/S4**：保留**最后一次**（按 `report_time` 或 `ingested_at` 较新者）；其余作为历史投递忽略。  
- **S3（订正）**：同键多行 → 取 **`ttl_days` 最大** 且 **最新 `report_time`** 的一行；并标注 `reason` 最新。

---

## 7. 值域与格式（跨源通用）
- **布尔**：`1/0/99`；`99=未知/不适用`。  
- **时段**：`HHMM-HHMM`（四位数字-四位数字；`0000-2359` 视为全天）。  
- **枚举**：`value_string` 需填写 **code**，展示再映射中文。  
- **数值**：按标签定义的单位与范围校验；无单位的数值不予接收。

---

## 8. 字典与权限（治理约束）
- **字典命中**：`tag_code` 必须命中 `vw_tag_spec_current`；若 `status!='active'` 或变更生效期不覆盖 `as_of_date`，拒收（R003）。  
- **订正白名单**：仅当标签在字典中 `allow_ops_fix=true` 时，S3 才可提交（否则 R008）。

---

## 9. 源别差异化规则
- **S2（区域）**：允许更丰富的 `reason/ext_*`；若与官方事实强冲突，进入融合时降权。  
- **S3（订正）**：`ttl_days` 必填，锁定优先；到期自动降级。  
- **S4（情报）**：视为侧证，通常权重较低；来源渠道需要在 `reason` 标注。

---

## 10. 质量面板（推荐指标）
- **RAW**：分区行数、主键去重率、R00x 命中次数、W10x 命中次数、槽位互斥违规率。  
- **STD**：S30x 命中次数、A20x 自动修复次数、类型一致率、枚举合法率、时段合法率。  
- **TOP N 错误**：按 `tag_code/source` 分布，定位训练与指引改进点。

---

## 11. 边界豁免（需治理备案）
- **紧急活动**：短期大促临时订正，可放宽 Stable 阈值与 TTL 下限，但必须在字典/治理登记并设失效期。  
- **历史补录**：允许补录历史 `as_of_date`，但若跨越 `tag_code` 生效区间外，拒收（R003）。

---

## 12. 交付清单（DE 落地项）
- [ ] 在导入作业中实现本清单的 **Reject/Warn/Auto-Fix** 规则映射  
- [ ] QC 指标落地至看板（RAW/STD 两层）  
- [ ] 错误代码对照与说明文档对外可见（用于业务自查）  
- [ ] 单测/集成测试：构造覆盖 R00x/S30x/A20x 的样例数据  
- [ ] 与《回填模板》《映射模板》联动更新（字段/枚举变更）

---

## 13. 附：错误代码对照速查
- **R00x**（RAW 硬拒收）：R001 主键缺失；R002 槽位互斥；R003 字典未命中；R004 类型错配；R005 布尔非法；R006 订正缺少 TTL；R007 时间非法；R008 订正禁用。  
- **W10x**（RAW 软警告）：W101 重复过多；W102 缺少 `reason`；W103 批次异常；W104 渠道未知。  
- **A20x**（STD 自动修复）：A201 文本去噪；A202 别名归一；A203 布尔显式化；A204 时段合法化；A205 单位归一。  
- **S30x**（STD 拒收）：S301 枚举非法；S302 时段非法；S303 数值越界；S304 订正过期。

