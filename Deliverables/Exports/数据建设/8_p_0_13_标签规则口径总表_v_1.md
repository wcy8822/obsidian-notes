# 《P0=13 标签规则口径总表 v1.0》（无 SQL）

> 适用：**滴滴加油 · 930 上线**  
> 结构：逐条给出 **tag_id/tag_code、A/B 分类、取值类型、业务定义、SoT/数据源矩阵、清洗映射（RAW→STD→INPUT Tall）、融合与回退、订正（Locked + TTL）、QA 与监控点、边界案例**。  
> 公共约束：**Acc≥90 / Cov≥90 / Fresh=T+1 / Stable≤5%**；值槽位**三选一且互斥**；订正优先（命中即 `evidence_state='Locked'`，TTL 到期自动降级）。

---

## 0. 图例与共识
- **A 类**：线下上翻+多源证据（region/ops/intel + official 佐证）。
- **B 类**：纯线上契约（official 事实可重算）。
- **SoT（Source of Truth）**：主数据或契约事实的权威来源；A 类以证据阶梯+仲裁形成最终值。
- **证据阶梯**：`Unknown → Candidate → Inferred → Verified → Locked`（订正触发）
- **RAW 主键**：`(store_id, as_of_date, tag_code)`；写入 Hive 分区 `ingest_date`。

---

## 1）品牌等级（B）
- **tag_id/tag_code**：`brand_level`  
- **取值类型**：ENUM（`KA/CKA/小散`）
- **定义**：品牌 ∈ 顶级清单 ⇒ `KA`；否则同（签约方×品牌）有效合同门店数 ≥10 ⇒ `CKA`；其余 `小散`。
- **SoT/数据源**：S1 `dim_brand_main(is_top_tier)`、`fact_station_contract(is_valid, contract_party_id, brand_id, store_id)`。
- **清洗映射**：无 RAW；STD 直接来自 S1 视图；INPUT Tall `signal_key='brand.level'`，`value_string∈{KA,CKA,小散}`。
- **融合/回退**：B 类单一来源；无多源冲突；字段缺失则**不产出**。
- **订正**：不建议；若临时覆盖，走 Locked（TTL≤30）。
- **QA/监控**：Cov 与 Acc≥90；稳定性≤5%。
- **边界**：品牌合并/改名走治理映射；历史回放按 `effective_from/to`。

---

## 2）品牌外显文案（A）
- **tag_id/tag_code**：`brand_display`  
- **取值类型**：STRING（中文文案）
- **定义**：门头/油站看板上对外展示的品牌文字（不等同于合同品牌）。
- **数据源矩阵**：region（现场上翻）/ intel（表单/侧证）/ ops（口径收口） + official（合同品牌仅作对照）。
- **清洗映射**：RAW 文本去噪（空白、全角、标点统一）；STD 规范化同义词；INPUT Tall `signal_key='brand.display'`，`value_string`。
- **融合/回退**：一致性×来源权重×新鲜度；冲突回退为 `Unknown` 并开工单。
- **订正**：支持 Locked（TTL 默认 180）。
- **QA/监控**：枚举/敏感词审查；稳定性≤5%。
- **边界**：同站多块牌匾取主看板；临时共建在 `reason` 备注。

---

## 3）是否重叠站（A）
- **tag_id/tag_code**：`overlap`  
- **取值类型**：BOOL（1/0/99）
- **定义**：本站与竞对站点为同一真实实体（门店共享/同址共用）。
- **数据源矩阵**：official（我方站点） + external/intel（竞对 POI、价露） + region/ops（核实）。
- **ER 口径**：城市 200m；郊/高 500m；名称强匹配≥0.90 直连；弱匹配（0.75–0.90）需地址 token/工商编码辅证。
- **探测器**：`price_expose` 连续 N 天（1→Candidate/3→Inferred/7→Verified）。
- **清洗映射**：INPUT Tall `signal_key='overlap.exists'`；布尔 1/0/99。
- **仲裁顺序**：来源权重（official>region>ops>external>intel）×一致性×新鲜度×ER 评分。
- **订正**：支持 Locked；TTL 到期自动降级。
- **QA/监控**：Acc≥90、Stable≤5%；追踪 `trace` 中 ER 对与证据列表。
- **边界**：连片园区/高速服务区谨慎；电话号不作为匹配字段。

---

## 4）是否合作中小供给（A）
- **tag_id/tag_code**：`mid_vendor_exists`  
- **取值类型**：BOOL（1/0/99）
- **定义**：与中小油品供给方存在合作（供油/联营/联合促销等）。
- **数据源矩阵**：ops（合同侧口径）/ intel（侧证）/ region（现场确认）；official（合同对照）。
- **清洗映射**：INPUT Tall `signal_key='vendor.mid.exists'`；布尔 1/0/99。
- **融合**：ops>region>intel；需至少一条可核验依据（`reason`）。
- **订正**：支持 Locked；TTL 默认 180。
- **QA/监控**：Acc/Cov≥90；不合规样本回退 99。
- **边界**：以站点维度为准；集团级合作需下钻到站点。

---

## 5）合作中小供给名称（A）
- **tag_id/tag_code**：`mid_vendor_name`  
- **取值类型**：STRING（中文/英文）
- **定义**：实际合作的中小供给方名称（规范到工商主体名或平台主体名）。
- **数据源矩阵**：ops（合同）/ intel（侧证）/ region（看板/小票）。
- **清洗映射**：文本清洗 + 字典对齐（工商/别名）；INPUT Tall `signal_key='vendor.mid.name'`，`value_string`。
- **融合**：与 `mid_vendor_exists=1` 互为校验；冲突则降级 `exists=99`。
- **订正**：支持 Locked；TTL 180。
- **QA/监控**：枚举/别名覆盖；稳定性≤5%。
- **边界**：多供应商时取主要供给；余者入 `trace`。

---

## 6）非共享/唯一价策略（B）
- **tag_id/tag_code**：`ns_unique_pricing`  
- **取值类型**：BOOL（1/0/99）
- **定义（工作口径）**：该站执行的油价策略对竞对或同集团站点**不可复用/不共享**，体现为**价差曲线独立**或合同条款限定的**专属价**。
- **SoT/数据源**：S1 价格/价差事实（`fact_price`, `fact_spread`）+ 合同侧条款（如有）。
- **清洗映射**：基于站×日价差曲线的相似性聚类；独立性显著标记为 1；INPUT Tall `signal_key='pricing.unique'`（BOOL）。
- **订正**：可暂不开放，或 Locked（TTL≤30）作为临时标注；以线上事实为准。
- **QA/监控**：Stable 控制；异常变更需回溯合同/活动。
- **边界**：节假日促销需排除；与集团统一价策略冲突时以合同口径为准。

---

## 7）是否有洗车服务（A）
- **tag_id/tag_code**：`service_carwash_exists`  
- **取值类型**：BOOL（1/0/99）
- **定义**：站内提供洗车服务（含自助/人工/全自动）。
- **数据源矩阵**：region 主 / ops（价目表/合同）辅 / intel 辅。
- **清洗映射**：INPUT Tall `signal_key='service.carwash.exists'`；布尔 1/0/99。
- **订正**：Locked 允许；TTL 默认 180。
- **QA/监控**：Acc≥90；Stable≤5%。
- **边界**：同址第三方洗车需满足“站内可达且对本站顾客开放”。

---

## 8）洗车类型（A）
- **tag_id/tag_code**：`service_carwash_type`  
- **取值类型**：ENUM（`manual/auto/self/none`）
- **定义**：洗车服务的类型：人工（manual）/ 全自动（auto）/ 自助（self）/ 无（none）。
- **数据源矩阵**：region 主 / intel 辅 / ops 佐证。
- **清洗映射**：字典归一化；INPUT Tall `signal_key='service.carwash.type'`，`value_string` ∈ enum。
- **订正**：Locked 允许；TTL 180。
- **QA/监控**：枚举合法率=100%；Stable≤5%。
- **边界**：多类型并存时取主类型（频次/产能最高）。

---

## 9）是否有便利店（A）
- **tag_id/tag_code**：`service_store_exists`  
- **取值类型**：BOOL（1/0/99）
- **定义**：站内存在对外营业的便利店/零售点。
- **数据源矩阵**：region 主 / ops（承包合同）辅 / intel 侧证。
- **清洗映射**：INPUT Tall `signal_key='service.store.exists'`；布尔 1/0/99。
- **订正**：Locked；TTL 180。
- **QA/监控**：Acc≥90；Stable≤5%。
- **边界**：售卖柜台但无独立收银可按 `exists=0`；临时摊位不计入。

---

## 10）是否有卫生间（A）
- **tag_id/tag_code**：`service_restroom_exists`  
- **取值类型**：BOOL（1/0/99）
- **定义**：站内有可供顾客使用的卫生间。
- **数据源矩阵**：region 主 / intel 辅。
- **清洗映射**：INPUT Tall `signal_key='service.restroom.exists'`；布尔 1/0/99。
- **订正**：Locked；TTL 180。
- **QA/监控**：Acc≥90；Stable≤5%。
- **边界**：员工专用不计入；维修/封闭期按 `99`。

---

## 11）是否有停车位（A）
- **tag_id/tag_code**：`service_parking_exists`  
- **取值类型**：BOOL（1/0/99）
- **定义**：站内或连带区域提供可用停车位。
- **数据源矩阵**：region 主 / intel 辅。
- **清洗映射**：INPUT Tall `signal_key='service.parking.exists'`；布尔 1/0/99。
- **订正**：Locked；TTL 180。
- **QA/监控**：Acc≥90；Stable≤5%。
- **边界**：路边临停不计；第三方付费车场仅当对本站顾客开放时记 1。

---

## 12）是否 24 小时营业（A）
- **tag_id/tag_code**：`open_24h`  
- **取值类型**：BOOL（1/0/99）
- **定义**：当日是否 24 小时对外营业（含夜间轮岗不间断）。
- **数据源矩阵**：region/ops 主（排班表/公告）/ intel 侧证。
- **清洗映射**：INPUT Tall `signal_key='open.24h'`；布尔 1/0/99。
- **订正**：Locked；TTL 90/180（看运营策略）。
- **QA/监控**：Acc≥90；Stable≤5%。
- **边界**：夜间仅自助、不提供加油服务则按 `0`。

---

## 13）当天营业时段（A）
- **tag_id/tag_code**：`open_hours`  
- **取值类型**：STRING（`HHMM-HHMM`）
- **定义**：当日对外营业的主时段（首个连续时段）。
- **数据源矩阵**：region/ops 主 / intel 侧证。
- **清洗映射**：正则解析并合法化（跨日/颠倒回退 99）；INPUT Tall `signal_key='open.hours'`，`value_string='HHMM-HHMM'`。
- **订正**：Locked；TTL 90。
- **QA/监控**：Acc≥90；格式合法率=100%。
- **边界**：多时段取首时段；跨日取 `0000-2359` 并在 `reason` 备注。

---

## 附录 A · 七件套口径（输出 Tall）
- **字段**：`value_*`（三选一）· `source`（region/ops/intel/official/fusion）· `conf`（0–100）· `ver`（规则版本）· `class`（A/B）· `evidence_state`（阶梯）· `trace_id`（指向 `tag_trace`）
- **SCD2**：`effective_from/effective_to/is_current + updated_at`；兼容回放/回滚。

## 附录 B · QA 抽样与门槛
- **抽样**：≥50 或 ≥5%；双人一致 **Kappa≥0.8**；枚举/字典项须 100% 合法。
- **阻断条件**：槽位互斥>0、类型错配>0、Stable>8%、Cov/Acc<85%（Critical）。

## 附录 C · 订正（Locked）口径
- **优先级**：先判订正 → 再走融合；生效即 `evidence_state='Locked'`。
- **TTL**：必填且 `>0`；到期降级；超上限需报备（建议上限 180）。
- **回溯**：`tag_release` 记录发布点；可按日期/版本回放。

