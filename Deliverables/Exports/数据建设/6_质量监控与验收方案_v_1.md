# 《质量监控与验收方案 v1.0》（无 SQL）

> 版本：v1.0 · 适用里程碑：**930 上线 P0=13 标签**  
> 口径：四源入（S1–S4）→ 三段式（RAW→STD→INPUT Tall）→ 规则融合 → 输出 Tall → Hot 宽层  
> 统一约束：**RAW 主键 `(store_id, as_of_date, tag_code)`；值槽位三选一且互斥；无回执表（Hive 自查）**

---

## 0. 目标与范围
- 建立**可度量、可告警、可回放**的质量闭环，确保上线与持续运行的稳定性。  
- 范围：指标口径、采样与抽检、监控与告警、验收标准（930）、日/周/月运维节奏；不含 SQL/代码。

---

## 1. 指标体系与口径（标签级）
> 除特别说明外，统计口径默认为 **as_of_date=D**，主体为能对齐到 `store_id/station_gid` 的样本。

### 1.1 覆盖率（Cov）
- **定义**：`Cov = 有值样本数 / 目标主体数`（目标主体数：当日参与计算的门店集合）。
- **阈值**：≥ **90%**（标签可设更高/分域阈值）。

### 1.2 准确率（Acc）
- **定义**：对齐 `tag_testset` 的标注集：`Acc = 正确样本数 / 标注样本数`。  
- **抽样要求**：`标注样本数 ≥ max(50, 5%*目标主体数)`；双人一致后取最终标注。
- **阈值**：≥ **90%**；当低于阈值时，须给出“回退规则/阈值/权重调整”的修正方案。

### 1.3 稳定性（Stable）
- **定义（DoD 变更率）**：`Stable = |变更样本数| / 可比较样本数`，其中  
  - 变更样本数：当日与 D-1 的标签值不同（含从/到缺失的变动不计入稳定性，计入覆盖率变化）；  
  - 可比较样本数：D 与 D-1 双方均有值的样本。  
- **阈值**：≤ **5%**（异常需说明原因；可在促销/节假日阶段设置临时放宽系数）。

### 1.4 新鲜度（Fresh）
- **定义**：`Fresh = 产出完成时间 ≤ D+1 11:00` 的达标比例（按分区/任务）。
- **阈值**：100% 达标；若达不到，需记录原因并触发灰度或回退。

### 1.5 槽位互斥率（Slot-Excl Violations）
- **定义**：`value_string/value_number/value_bool` **同时非空样本数 / 总样本数`（应为 0）。**
- **阈值**：= **0**；任何非零直接阻断发布。

### 1.6 类型/枚举合法率
- **定义**：填写槽位与 `value_type` 一致、且枚举在 `enum_set` 内的比例。  
- **阈值**：= **100%**；不达标的记录不发布。

### 1.7 ER 对齐率
- **定义**：成功从 RAW/STD 对齐到 `store_id → station_gid` 的比例。  
- **阈值**：≥ **99%**；不足部分进入“待处理清单”，不得进入 INPUT。

### 1.8 Locked 指标（订正）
- **Locked 比例**：当日 Locked 条数 / 当日总条数（标签级/全局）。
- **TTL 将到期数**：近 7/30 天内到期的 Locked 条数。  
- **降级成功率**：到期后成功降级为普通融合的比例（目标 100%）。

### 1.9 Trace 覆盖率
- **定义**：输出样本中，可追溯到 `tag_trace` 的比例（A 类必须有 trace）。  
- **阈值**：A 类=100%；B 类≥95%。

---

## 2. 抽样与一致性（标注）
- **抽样设计**：分层抽样（城市线级、区域、业态/品牌），优先覆盖尾部地区与边界案例。  
- **样本量**：≥ `max(50, 5%)`；关键标签/新上线阶段可翻倍。  
- **双人一致**：两人独立标注，计算 **Cohen’s Kappa**；阈值 **≥0.8**。不达标需复盘字段与指引。  
- **冲突处理**：设立裁决人（产品/治理），裁决样本纳入 `tag_testset`。

---

## 3. 监控与看板（分层）
> 监控按 **RAW/STD/INPUT/OUTPUT/Hot** 五层制作模块化面板；所有模块均支持日/周趋势、分区域钻取、标签筛选。

### 3.1 RAW 层
- **到数**（分区行数、主键去重率）、**必填非空**、**槽位互斥违规数**、**`tag_code` 命中率**、**`store_id` 存在率**。

### 3.2 STD 层
- **类型一致率**（`tag_code→value_type`）、**枚举合法率**、**时段合法率**（如 `HHMM-HHMM`）。

### 3.3 INPUT Tall 层（`tag_input`）
- **写入成功率**、**source 分布**（region/ops/intel）、**ER 对齐率**、**trace 预占位率**。

### 3.4 OUTPUT Tall 层（`tag_value_fact`）
- **Acc/Cov/Stable/Fresh**（标签级）、**槽位互斥=0**、**Trace 覆盖率**、**Locked 比例/TTL 将到期**。

### 3.5 Hot 宽层
- **白名单命中率**、**透视完成时间**、**兼容视图一致性**（与旧口径对比差异率）。

---

## 4. 告警与处置（R/A/G）
> 分为 **Info / Warning / Critical**，Critical 触发阻断或回滚。

| 指标 | 绿 | 黄 | 红（Critical） | 处置 |
|---|---|---|---|---|
| Fresh | 100% | 99–<100% | <99% | 灰度/回滚前版，发布后补算 |
| Cov | ≥90% | 85–<90% | <85% | 标注复核 + 回放或阈值调整提案 |
| Acc | ≥90% | 85–<90% | <85% | 阻断该标签发布，回放前版 |
| Stable | ≤5% | 5–8% | >8% | 阻断/灰度，触发根因分析 |
| 槽位互斥 | 0 | >0 | >0 | 直接阻断；修复后再跑 |
| 类型/枚举合法 | 100% | <100% | <100% | 不合法记录不发布；溯源修正 |
| ER 对齐 | ≥99% | 98–<99% | <98% | 降级/回放；补齐映射后重跑 |
| Locked TTL 降级 | 100% | 95–<100% | <95% | 修复作业并回放 |

---

## 5. 验收标准（**930**）
**必须全部打勾方可视为达标：**
1) **表层面**：`tag_input / tag_value_fact / tag_wide_daily(+compat)` 建完且产出正常。  
2) **功能面**：P0=13 标签**全部上线**，`tag_wide_hot_list` 白名单加载完成。  
3) **订正机制**：`raw_ops_tag` → Locked(+TTL) 全链路演练通过（含到期降级）。  
4) **回放/回滚**：各完成至少 1 次演练（含发布记录与对比报告）。  
5) **质量指标**：P0=13 标签在连续 7 天窗口内：`Cov ≥90%`、`Acc ≥90%`、`Stable ≤5%`、`Fresh=100%`。  
6) **合规与追溯**：trace 外置，A 类 100% 覆盖；`tag_change_log / tag_release` 可审计。  
7) **文档与模板**：A–E 文档到位（交付单、跑数手册、映射模板、回填模板、订正 SOP）。

---

## 6. 运行节奏
- **日**：分区到数与基础 QC（RAW/STD/INPUT/OUTPUT/Hot）、质量四指标、告警处置；必要时回放前版。  
- **周**：抽样评估（Acc/Kappa）、稳定性/覆盖率趋势复盘、规则阈值微调提案。  
- **月**：`ext_*` 字段使用频次统计与**归并升级**为 STD 正式列；白名单滚动评审（新增/剔除）。  
- **季度**：标签规格卡/治理策略盘点，关键日期回放复核。

---

## 7. 角色与分工
- **业务/区域**：回填与订正、样本抽检、问题线索与依据沉淀。  
- **DE**：落表/标准化/融合/发布、看板与告警、回放与回滚。  
- **DS**：抽样设计、Acc/Kappa 评估、阈值建议与漂移分析。  
- **产品/治理**：`tag_spec / rule_config / quality_policy` 的变更管理与发版合规。

---

## 8. 发布前/后 Checklist
**发布前**  
- [ ] RAW/STD/INPUT/OUTPUT/Hot 分区到数；  
- [ ] 槽位互斥=0；类型/枚举合法=100%；  
- [ ] ER 对齐≥99%；  
- [ ] Acc/Cov/Stable/Fresh 达标；  
- [ ] Locked TTL 到期处理无积压；  
- [ ] 需要灰度/回放/回滚的标签已完成。  

**发布后**  
- [ ] 看板指标刷新；  
- [ ] 质量波动解释记录；  
- [ ] 异常事件（若有）登记 `tag_release`/变更审计；  
- [ ] 若触发回滚，通知消费者并补算 Hot。

---

## 9. 附：口径速查
- **Acc**：对齐 `tag_testset` 的正确率；`≥90%`。  
- **Cov**：有值覆盖/目标主体；`≥90%`。  
- **Stable**：DoD 变更率（仅比较有值样本）；`≤5%`。  
- **Fresh**：D+1 ≤11:00 发布完成；`=100%`。  
- **Kappa**：双人一致性；`≥0.8`。

