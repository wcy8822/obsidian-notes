# 迭代日志\_1&2（合并版 · 可投喂）

> 用途：把“迭代日志 1”（你上传的自动更新版）与“迭代日志 2”（本轮生成）**去重合并**，形成可直接投喂下一轮对话的统一启动包。\
> 版控：SemVer；本稿 v1.0（合并首版）。

---

## 🧭 一页版摘要

- **目标**：930 前上线 **P0=13 标签**；搭建可扩展的 **标签数据底座 3.0**（长期 200+）。
- **四源**：S1 数仓（官方） / S2 区域反馈 / S3 商户运营·订正（Locked+TTL） / S4 情报侧证。
- **三段式**：**RAW（业务交付） → STD（DE 标准化） → INPUT Tall（信号事实）**。
- **输出**：**OUTPUT Tall**（`tag_value_fact`：三槽位互斥 + **七件套** + **SCD2**）→ **Hot 宽层**（`tag_wide_daily`，白名单透视）。
- **证据外置**：`tag_trace`（完整证据 JSON；以 `trace_id` 指向）。
- **质量闸门**：**Acc ≥90 / Cov ≥90 / Stable ≤5% / Fresh=T+1（D+1 ≤ 11:00）**。

---

## ✅ 合并后的核心共识（去重清洗）

1. **标签层级**：三级（三级为最小颗粒）；A/B 分类：A=线下上翻（多源融合+证据阶梯），B=纯线上契约（可重算）。
2. **RAW 主键**：除 S1 外，RAW 统一 ``；值槽位 `` 三选一且互斥；S3 订正 `` 必填。
3. **STD 职能**：类型/枚举/单位/时段归一与强校验；`tag_code → value_type` 一致性为硬约束。
4. **INPUT Tall**：键 `as_of_date, source, store_id, signal_key`；同键覆盖幂等。
5. **字典与映射**：`tag_spec`→`vw_tag_spec_current`；`tag_signal_map(tag_code→signal_key)`；兼容改名用 `tag_backward_compat`。
6. **订正优先**：命中即 `evidence_state='Locked'`、`conf≈100`；**TTL 到期自动降级**。只允许 `allow_ops_fix=true` 的标签。
7. **输出 Tall**：三槽位互斥 + 七件套（`source/conf/ver/class/evidence_state/trace_id`）+ SCD2；A 类 **trace 覆盖率=100%**。
8. **Hot 宽层**：`tag_wide_daily` 由 `tag_wide_hot_list` 控制列展开；兼容视图 `tag_wide_daily_compat` 供旧消费过渡。
9. **运维动作**：支持回放（snapshot）、回滚（release）、白名单灰度/停用，质量看板分 RAW/STD/INPUT/OUTPUT/Hot 五层。

---

## 🧩 源数据与协作边界（四源一口径）

- **S1（官方数仓）**：合同/价差/交易/画像等线上事实；B 类 SoT；提供 `store_id/station_gid` 与主属性。
- **S2（区域反馈）**：线下上翻；RAW→STD→INPUT；作为 A 类重要证据。
- **S3（商户运营）**：**订正**入口；RAW 需 `ttl_days>0` 与 `reason`；Locked+TTL 机制。
- **S4（情报反馈）**：侧证/专项；通常权重较低，需标注来源渠道。
- **字典不视为数据源**：属于治理/清洗索引；新增标签必须先登记再填报。

---

## 🔌 三段式落地要点（RAW→STD→INPUT）

- **RAW（业务交付）**：CSV 列头统一；分区 `ingest_date`；三槽位互斥；主键幂等覆盖。
- **STD（DE 承接）**：布尔/枚举/时段/单位归一；自动修复（A20x）与拒收（S30x）清单明确。
- **INPUT Tall（DE 产出）**：信号行化；ER 后补 `station_gid`；与 `tag_signal_map` 构建 1:1 映射。

---

## 🏷️ 输出层与白名单

- **OUTPUT Tall**：`tag_value_fact`；读当前值：`as_of_date=D & is_current=1`；历史追溯：`effective_from/to`。
- **Hot**：白名单驱动列展开：每标签展开 **1 个值槽位 + 七件套**；缺失在兼容层派生处理（如布尔 99），不污染 Hot。
- **回退**：白名单标签可快速 `enabled=false` 停写；历史列保留。

---

## 🧱 质量与发布（闸门统一）

- **阻断条件**：槽位互斥>0、类型/枚举不合法、Stable>8%、Fresh<99%。
- **达标门槛**：Acc/Cov≥90、Stable≤5、Fresh=100（D+1 ≤ 11:00）。
- **订正监控**：Locked 比例、TTL 将到期清单、到期降级成功率。
- **验收（930）**：P0=13 全部上线；连续 7 天四指标达标；回放/回滚各演练≥1 次；trace 可审计。

---

## 📚 本轮产出物（12 份，可在画布查看）

1. DE 交付单（边界与 RAW 规范）
2. 跑数与回放手册
3. 四源→INPUT 映射模板
4. 回填模板（S2/S3/S4）
5. 订正治理与放行 SOP
6. 质量监控与验收方案
7. 白名单驱动的宽表透视规范
8. P0=13 标签规则口径总表
9. 输入/输出 Tall 表结构与七件套口径
10. 拒收与校验规则清单（RAW→STD）
11. 术语与命名规范
12. 上线演练 Checklist（v1.1）

---

## 🚀 启动 Prompt（合并版 · 直接复制）

```
你是我的数据工程协作助理。请在“标签数据底座3.0”框架内工作：
- 目标：930 上线 P0=13；SLA：D+1 ≤ 11:00；质量闸门：Acc/Cov≥90、Stable≤5%、Fresh=T+1。
- 四源：S1（官方）/ S2（区域）/ S3（运营订正·Locked+TTL）/ S4（情报侧证）。
- 三段式：RAW(主键=store_id+as_of_date+tag_code；三槽位互斥) → STD(类型/枚举/时段/单位归一) → INPUT Tall(信号事实)。
- 输出层：OUTPUT Tall(tag_value_fact·三槽位互斥+七件套+SCD2) → Hot(tag_wide_daily·白名单)；证据外置 tag_trace。
- 字典与映射：tag_spec/vw_tag_spec_current、tag_signal_map、tag_backward_compat。
- 订正优先：ops 命中即 Locked，TTL 到期降级；仅 allow_ops_fix=true 的标签允许订正。
本轮任务：<写清本轮要做的具体任务，例如“P1 标签设计/调度 DAG/ER 细化/测试集与 Kappa 口径”等>。
输出要求：
1) 给出可落地的表/字段与边界；2) 提供面向 DE 的输入模板或伪代码；3) 明确质量与发布门槛；
4) 如需，补充回放/回滚与白名单变更步骤；5) 产出 md 文档，可在 Open Canvas 打开。

其他要求
# 交互的个性化需求（可复用模块）

> 用途：作为“启动包”的固定模块，放在迭代日志/交付单前置位置；明确协作节奏、表达口径与产出方式。

---

## 1) 工作节奏偏好（先对焦→再成文）

* **先框架对焦**：先把目标、数据源边界、表结构与口径框出来，再产出文稿。
* **脑暴—反馈—迭代**：先开“思路版”，快速收敛关键决策点；确认后再出“定稿版”。
* **分批交付**：大件分解为多份 md 文档，**逐份**产出，避免一次性长文。
* **Open Canvas 协同**：优先在画布里创建/更新文档，便于你在线批注、可下载存档。
* **关键词触发**：

  * “**先对焦**/仅对焦”= 不要额外产出，只给框架/结论要点；
  * “**继续**”= 接着产出下一份或执行下一步；
  * “**拍板/同意/确认**”= 以此为准落地实现与文稿定稿。

## 2) 表达与措辞（温和协同）

* 跨部门沟通强调“**承接/协作/建议**”，避免“全责/必须”等高压词。
* 先给**可行路径与替代方案**，再给建议；对上游/业务口径保持尊重。

## 3) 交付形式与颗粒度

* **格式**：一律 **Markdown**，置于 **Open Canvas**；必要时提供 CSV 表头可直接复制。
* **可下载**：确保画布内容可复制/另存；避免“文件不存在”的下载失败场景。
* **颗粒度**：

  * 业务需讲清：**数据源来源/落地边界/必填字段/校验规则/SLA**；
  * DE 需落地：**表名/主键/分区/字段字典/拒收规则/发布流程**；
  * DS 需明确：**抽样与 Kappa/Acc、漂移与阈值**。

## 4) 方法论与口径（本项目特有）

* **四源**：S1 数仓（官方）/ S2 区域反馈 / S3 商户运营·订正（Locked+TTL）/ S4 情报侧证；字典**不是数据源**。
* **三段式**：RAW（业务交付）→ STD（DE 标准化）→ INPUT Tall（信号事实）。
* **Tall I/O**：输入/输出都用 Tall；输出层 `tag_value_fact` = **三槽位互斥 + 七件套 + SCD2**；证据 `tag_trace` 外置。
* **白名单宽表**：`tag_wide_daily` 仅对白名单标签列展开；兼容视图 `tag_wide_daily_compat` 渐进迁移。
* **质量闸门**：Acc/Cov≥90、Stable≤5%、Fresh=T+1（**D+1 ≤ 11:00**）。
* **订正优先**：命中即 `evidence_state='Locked'`，**TTL 必填且 >0**，到期降级。

## 5) 避坑清单（执行时默认遵循）

* **占位符必须回填**：不得留下 \`\` 这类空占位；统一写全主键、槽位、字段名。
* **主键/槽位**：RAW 统一主键 **`(store_id, as_of_date, tag_code)`**；值槽位仅一项非空：`target_value_bool/number/string`。
* **ID 口径**：输入一律使用 **`store_id`**；`station_gid` 仅在 INPUT/Tall 后续 ER 补齐。
* **布尔与枚举**：布尔取 `1/0/99`；枚举填 **code**，展示再映射中文。
* **订正**：仅允许 `allow_ops_fix=true` 的标签；`ttl_days>0` 必填；订正为最高优先级，带 `reason`。
* **一次一件事**：每次只创建一个新文档；大改动按“先对焦→再成文”的节奏走。

## 6) 版本与日志

* 每轮结束更新“**迭代日志**”（精华包 + 启动 Prompt + 产出清单 + 下一步）。
* 使用 **SemVer**，记录 `snapshot_id/release_id/spec_version/rule_version` 等。

---

> 这个模块可以嵌入到：《迭代日志 1&2（合并版 · 可投喂）》和后续任何交付文档的“前置共识”段落，以保证协作体验一致。

```

---

## ♻️ 循环机制（如何持续更新合并日志）

- **何时更**：每轮对话收尾更新本稿（新增共识、产物、下一步、版本号）。
- **怎么更**：按“四段体”追加——①共识补充；②新产出物；③下一步议题；④若涉及字典/规则/白名单，记录 `spec_version/rule_version` 与 `release_id/snapshot_id`。
- **不破历史**：仅追加；重口径需显式“改/废弃/兼容映射”注记。

---

## 🔜 下一步议题（建议起点）

- P1 标签规格卡批量模板（含 `enum_set` 设计）
- 站点 ER 口径细化与映射提升（ER ≥99%）
- 调度 DAG 与看板指标最小上线集（RAW/STD/INPUT/OUTPUT/Hot）

---

## 🧾 合并来源与差异记录

- **来源 A：迭代日志 1（你上传的自动更新版）**——保留其“目标/共识/口径/产出/下一步”骨架。
- **来源 B：迭代日志 2（本轮生成）**——补充了四源边界、三段式细节、订正 Locked+TTL、七件套与白名单规范、质量与演练。
- **差异清洗**：
  - 将“字典是数据源”的表述统一为“字典非数据源，属治理索引”。
  - 统一 RAW 主键与三槽位互斥；S3 必填 `ttl_days>0`。
  - OUTPUT 以 SCD2 与七件套为准；A 类 trace 覆盖=100%。

