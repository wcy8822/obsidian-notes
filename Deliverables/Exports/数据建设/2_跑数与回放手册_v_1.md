# 《跑数与回放手册 v1.0》

> 版本：v1.0 · 适用里程碑：**930 上线 P0=13 标签**  
> 口径：**四源入（S1–S4）→ 三段式（RAW→STD→INPUT Tall）→ 规则融合 → 输出 Tall → Hot 宽层**  
> SLA：**T+1，最晚 D+1 11:00 完成发布**  
> 关键约束：**RAW 主键统一 `(store_id, as_of_date, tag_code)`；值槽位三选一且互斥；无“回执表”，以 Hive 查询自查**

---

## 0. 目标与范围
- 目标：定义**每日跑数流程、回放/回滚方法、分区与幂等语义、发布前质量闸门与告警**。  
- 范围：不含 SQL/代码；以表结构与作业步骤为准；适用于 P0=13，兼容后续扩展。

---

## 1. 环境与依赖
- 计算与存储：Hive（分区表）；元数据统一登记在治理表。  
- 调度：Airflow/等价平台（DAG 编排）；时间口径默认 UTC+8。  
- 只读视图：`vw_official_*`（S1，官方数仓视图）。

---

## 2. DAG 拓扑（逻辑）
**按源分支 + 汇总融合**：
1) **Region 分支**：`raw_region_tag (ingest_date)` → `std_region_tag (as_of_date)` → **`tag_input`**  
2) **Ops 分支**：`raw_ops_tag (ingest_date)` → `std_ops_tag (as_of_date)` → **`tag_input`**  
3) **Intel 分支**：`raw_intel_tag (ingest_date)` → `std_intel_tag (as_of_date)` → **`tag_input`**  
4) **Official 视图**：`vw_official_*` 提供主体与 B 类事实  
5) **融合与规则**：`tag_input + vw_official_* + 治理配置` → **`tag_value_fact`**（SCD2+七件套）  
6) **透视**：`tag_value_fact + tag_wide_hot_list` → **`tag_wide_daily`**；兼容：`tag_wide_daily_compat`

> 说明：`tag_input` 即 INPUT Tall（信号事实）。

---

## 3. 每日时序（建议）
- **D 20:00 前**：S2/S3/S4 RAW 分区写入完成。  
- **D+1 02:00**：STD 标准化（含值域校验与 `tag_code→value_type` 校验）。  
- **D+1 03:00**：ER & enrich（补齐 `station_gid`、主体属性）。  
- **D+1 03:30**：规则融合（A 类权重/证据阶梯；B 类契约）。  
- **D+1 04:00**：生成 `tag_value_fact` 当日分区（`as_of_date=D`）。  
- **D+1 04:10**：Hot 透视 `tag_wide_daily` + 兼容视图。  
- **D+1 04:20–11:00**：质量校验/告警与必要回放窗口；**不延误则默认 04:30 发布**。  
- **交付承诺**：**≤ 11:00** 必达；如触发阻断，走灰度或前版回滚。

---

## 4. 分区与主键语义
- **RAW**：分区 `ingest_date=YYYYMMDD`；**主键 `(store_id, as_of_date, tag_code)`**；同键覆盖（幂等）。  
- **STD**：分区 `as_of_date=YYYYMMDD`；保留 `std_ruleset` 版本。  
- **INPUT Tall (`tag_input`)**：分区 `as_of_date`；键：`as_of_date, source, store_id, signal_key`。  
- **输出 Tall (`tag_value_fact`)**：分区 `as_of_date`；SCD2 字段：`effective_from/effective_to/is_current`。  
- **Hot 宽层**：分区 `as_of_date`；白名单驱动列展开。

---

## 5. 幂等与覆盖策略
- RAW：同 `(store_id, as_of_date, tag_code)` 多次写入 → 以**最后一次**为准。  
- STD：标准化按 `as_of_date` 覆盖；保留 `std_ruleset` 便于追溯。  
- 规则融合：`(station_gid, as_of_date, tag_id)` 覆盖同版；不同 `rule_version` 通过 SCD2 表达。

---

## 6. 发布前质量闸门（阻断条件）
**任一命中 → 暂缓发布（转灰度或回滚前版）**：
1) **槽位互斥违规**：输出 Tall 任一记录有 2 个及以上值槽位非空。  
2) **口径未登记**：`tag_code` 未命中 `vw_tag_spec_current` 或类型错配。  
3) **主体缺失**：无法对齐 `store_id` 或 `station_gid`。  
4) **稳定性异常**：某标签当日 `Stable > 5%`（对比 D-1）。  
5) **覆盖异常**：当日 `Cov < 90%`（以业务口径/域内阈值为准）。  
6) **SLA 超时**：关键分区未到数或延迟超阈值。

---

## 7. 监控与告警
- **到数**：RAW/STD/INPUT/输出/Hot 各层分区是否到位；延迟分钟数。  
- **规模**：各层行数、Distinct 主键/键数、去重率。  
- **一致性**：`tag_code→value_type`、值域合法率、空值率。  
- **质量**：Acc/Cov/Stable/Fresh（对齐 `tag_testset` 与治理阈值）。  
- **订正**：`Locked` 比例、TTL 将到期清单。  
- **ER**：未对齐比例、地理/名称匹配命中率。  
- **告警等级**：Info/Warning/Critical（Critical 触发阻断或回滚）。

---

## 8. 回放（Replay）
- **定义**：指定 `as_of_date`（或时间窗）+ `rule_version`，从 INPUT Tall 与官方视图重算 `tag_value_fact` 与 Hot。  
- **前置**：冻结当日治理配置（`tag_spec/rule_config/quality_policy`）为快照。  
- **步骤**：
  1) 冻结配置快照并标记回放批次号；  
  2) 以同一个批次号覆盖输出分区（不改 RAW/STD/INPUT）；  
  3) 生成一次性的 `tag_release` 记录（类型=Replay）。  
- **校验**：与目标版对比行数、七件套差异、质量指标；通过后发布或灰度验证。

---

## 9. 回滚（Rollback）
- **定义**：选择任一历史“发布点”，将其标记为当前版（`is_current=true`），并在 `tag_release` 写入回滚事件。  
- **触发**：质量闸门持续不达标、上游事实异常、规则回退请求。  
- **步骤**：
  1) 选择目标 `release_id`；  
  2) 设置当前版 `is_current=false`，目标版 `is_current=true`；  
  3) 重新生成 Hot；  
  4) 通知消费者。

---

## 10. 订正（Ops）在流程中的表达
- **输入**：`raw_ops_tag`（含 `ttl_days`、`reason`）。  
- **规则优先**：先判 whitelist/priority，命中 → 输出 `evidence_state='Locked'`；TTL 到期自动降级。  
- **监控**：`Locked` 占比、近 7/30 天到期清单、到期后降级是否成功。

---

## 11. 常见异常与处置
- **RAW 未到数/主键冲突高**：与业务核对数据集，按“同键覆盖”重投；必要时延迟发布。  
- **STD 口径错配**：发现 `tag_code→value_type` 不一致，暂停该标签发布，修正治理后回放。  
- **ER 失败率高**：检查地理/名称阈值；必要时启用行政区兜底，或降为 `Unknown/其他`。  
- **稳定性跳变**：触发阻断，回放上一版并定位上游。  
- **订正过期**：批量降级为普通融合；如需维持，业务提交续期。

---

## 12. 权限与合规
- **写权限**：RAW/STD/INPUT/输出层由 DE 控制；  
- **读权限**：业务与 DS 可读 OUTPUT/Hot/兼容视图；  
- **审计**：`tag_release`、`tag_change_log`、`spec_version/rule_version` 可追溯。

---

## 13. 每日 Checklist（发布前）
- [ ] RAW 三表分区到数；主键去重率正常  
- [ ] STD 成功；值域/类型校验通过  
- [ ] INPUT Tall 写入成功；未对齐率在阈值内  
- [ ] 输出 Tall 行数对账、槽位互斥=0  
- [ ] 质量四指标达标；稳定性≤5%  
- [ ] Hot 透视完成；兼容视图生效  
- [ ] 如需，灰度/回放/回滚记录已写入

---

## 14. 周期性任务（建议）
- **周**：抽样复核（Acc/Kappa）、回放演练一次；监控阈值复盘。  
- **月**：统计 `ext_*` 字段使用频度，归并升级为 STD 正式列；白名单滚动评审。  
- **季度**：规格卡/规则/质量政策大盘点；回放关键日期样本。

---

## 15. 术语速记
- **INPUT Tall**：信号事实（站×日×信号键×单值）。  
- **输出 Tall**：`tag_value_fact`（站×日×标签ID，SCD2+七件套）。  
- **Hot**：`tag_wide_daily`（白名单透视）。  
- **Locked**：订正锁定，TTL 到期降级。

