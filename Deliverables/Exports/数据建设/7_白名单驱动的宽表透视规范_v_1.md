# 《白名单驱动的宽表透视规范 v1.0》

> 版本：v1.0 · 适用里程碑：**930 上线 P0=13 标签**  
> 目标：在不改动 Tall 事实表结构的前提下，为常用查询提供**稳定、低成本**的列式访问界面；用**白名单**控制列膨胀与发布节奏。

---

## 0. 背景与定位
- **来源**：`tag_value_fact`（输出 Tall，站×日×标签ID，SCD2+七件套）。  
- **去向**：`tag_wide_daily`（Hot 宽表，仅对白名单标签做列展开），兼容视图 `tag_wide_daily_compat` 用于旧消费迁移。  
- **原则**：
  1) **白名单驱动**：只对纳入白名单的标签展开列；其他标签在 Tall 查询。  
  2) **七件套可见**：对每个标签展开 **值槽位三选一 + 七件套**（供稽核/定位）。  
  3) **SCD2 收口**：仅取当日 `is_current=1` 的记录做透视；历史追溯仍查 Tall。

---

## 1. 表与分区
### 1.1 白名单表：`tag_wide_hot_list`
**作用**：声明哪些标签进入宽表，以及列命名/展示配置与发布策略。

**建议字段**：
- 核心：`tag_id BIGINT` · `tag_code STRING` · `tag_name STRING` · `domain STRING` · `value_type ENUM('BOOL','NUMBER','STRING','ENUM')`
- 控制：`enabled BOOLEAN`（是否生效） · `order_index INT`（列顺序） · `effective_from DATE` · `effective_to DATE` · `is_current BOOLEAN`
- 展示：`display_name STRING` · `display_unit STRING NULL` · `compat_alias STRING NULL`（旧列名映射）
- 发布：`rollout_policy ENUM('direct','gray','canary')` · `owner STRING` · `added_by STRING` · `added_at TIMESTAMP` · `reason STRING`

> **列顺序**由 `order_index` 决定；删除只需 `enabled=false`，历史列保留但标注停用。

### 1.2 Hot 宽表：`tag_wide_daily`
**分区**：`as_of_date=YYYYMMDD`

**公共主体列（最小集）**：`store_id STRING` · `station_gid STRING` · `city STRING` · `province STRING` · `lng DECIMAL(10,6)` · `lat DECIMAL(10,6)` · `as_of_date DATE`

**标签列（对每个白名单标签展开 1 值 + 七件套）**
- 列前缀：`col_prefix = tag_code` 中的 `.` 替换为 `_`（例：`service.carwash_exists` → `service_carwash_exists`）。
- **值槽位（互斥）**：
  - `${col_prefix}_value_bool TINYINT`
  - `${col_prefix}_value_number DECIMAL(..)`
  - `${col_prefix}_value_string STRING`
- **七件套**：
  - `${col_prefix}_source STRING`
  - `${col_prefix}_conf TINYINT`
  - `${col_prefix}_ver STRING`（规则版本）
  - `${col_prefix}_class STRING`（A/B）
  - `${col_prefix}_state STRING`（evidence_state）
  - `${col_prefix}_trace_id STRING`

> **互斥约束**：同一标签的三种 `value_*` 仅一项非空。

### 1.3 兼容视图：`tag_wide_daily_compat`
- **作用**：对旧的字段口径提供映射；从 `tag_wide_daily` 选择并改名，或做简单派生（如布尔映射为 `Y/N`）。
- **管理**：兼容别名存入 `tag_wide_hot_list.compat_alias` 或独立映射表 `tag_wide_compat_map(old_col → tag_code)`。

---

## 2. 透视生成逻辑（Tall → Wide）
1) **取数**：从 `tag_value_fact` 读取 `as_of_date=D` & `is_current=1` 的记录；仅保留 `tag_id ∈ tag_wide_hot_list(enabled=true, is_current=1)`。  
2) **去重**：若同一 `(store_id, tag_id)` 当日存在多条（理论上不应发生），按以下**并列优先级**取一条：
   - `evidence_state` 优先级：`Locked > Verified > Inferred > Candidate > Unknown`；其次  
   - `conf` 值大者优先；其次  
   - `updated_at` 晚者优先。
3) **展开**：按 `tag_code` 生成列前缀，将 `value_*` 与七件套写入对应列。  
4) **缺失填充**：默认留空；如业务要求布尔缺失显示 `99`，在 **兼容视图**层做派生，不污染 Hot。  
5) **列顺序**：公共列在前，随后按 `order_index` 排列标签列族。

---

## 3. 上线与变更流程（白名单驱动）
1) **提案**：产品/数据提交白名单变更（新增/剔除/灰度），附使用场景与预估收益。  
2) **影响评估**：DE 评估列数增长、存储/查询开销；DS 评估质量与稳定性。  
3) **审批与发版**：治理通过后写入 `tag_wide_hot_list` 并 `enabled=true`；灰度策略用 `rollout_policy` 标注。  
4) **构建与核验**：首日仅在灰度分区或子集跑批；校验行数/互斥=0/兼容视图一致性；无异常后全量开启。  
5) **回退**：出现质量或成本问题，直接将该 `tag_code` 的 `enabled=false`；历史列保留，不再写入新分区。

---

## 4. 性能与成本建议
- **列数控制**：白名单目标 **≤50 标签**；按 1 值 + 6 元信息 ≈ **7 列/标签**，总列数 ~350 + 公共列，仍可控。  
- **存储**：优先使用列式存储与压缩；仅对必要列投影查询。  
- **增量构建**：每日仅构建当日分区；如平台支持，可对**变更门店**做稀疏更新，但以全量分区为基准。  
- **并发与分桶**：大规模查询建议对 `store_id` 或 `city` 进行合理分桶/并行读取。

---

## 5. 消费与迁移指南
- **推荐查询**：常用看板/报表优先读 `tag_wide_daily`；需追溯原因或多标签拼接时，转查 Tall（`tag_value_fact + tag_trace`）。  
- **旧口径迁移**：
  - 第一步：将旧查询映射到 `tag_wide_daily_compat`（仅字段别名/派生）；  
  - 第二步：逐步切换到标准列名（`service_carwash_exists_*` 等），并移除兼容别名；  
  - 第三步：下线 `compat` 视图或仅保留最小兼容面。

---

## 6. 命名规范与示例
- 列前缀：`col_prefix = tag_code.replace('.', '_')`  
- 示例（`service.carwash_exists`、`open.24h`、`brand.display_text`）：
  - `service_carwash_exists_value_bool` · `service_carwash_exists_source/conf/ver/class/state/trace_id`
  - `open_24h_value_bool` · `open_24h_source/conf/ver/class/state/trace_id`
  - `brand_display_text_value_string` · `brand_display_text_source/conf/ver/class/state/trace_id`

---

## 7. 风险与护栏
- **列爆炸**：严控白名单规模；季度复盘“低使用率列”并考虑下线。  
- **口径漂移**：任何 `tag_code` 改名/并拆并合走治理与回退；兼容映射要有失效时间。  
- **多值冲突**：异常情况下按 §2 的优先策略收口，并在监控中单列统计。  
- **数据敏感**：`trace_id` 仅作为追溯指针；敏感明细在 `tag_trace`，不直接展开到宽表。

---

## 8. 发布前 Checklist（每次白名单变更）
- [ ] `tag_wide_hot_list` 变更入库，`enabled/rollout_policy/order_index` 正确  
- [ ] 首日灰度构建成功：行数对账、槽位互斥=0、兼容视图一致性通过  
- [ ] 质量指标（Acc/Cov/Stable）无异常波动  
- [ ] 查询成本评估通过（扫描列数/行数、时延）  
- [ ] 消费方完成字段映射与用例验证  
- [ ] 需要回退时已验证 `enabled=false` 的快速撤回路径

---

## 9. FAQ
- **Q：为什么要把七件套也带到宽表？** 便于稽核与问题定位；同时避免遇事再回 Tall。  
- **Q：`trace_id` 有用吗？** 有。点击追溯到 `tag_trace` 可获得完整证据 JSON。  
- **Q：布尔缺失要不要默认 99？** 在 **兼容视图**层做，不污染 Hot。  
- **Q：白名单多快更新一次？** 建议**月度滚动**；紧急场景可临时提案灰度加入。

