# 标签数据底座3.0 · 迭代日志 2（自动更新补全）

> 用途：本对话框的“共识黑匣子”。可直接投喂到下一轮对话。 参照前置：**《标签数据底座3.0 · 迭代日志（自动更新版）》**（记为**迭代日志 1**）。

---

## 🧪 对话精华包（v1）

### 1. 项目与里程碑

- 目标：**930 上线 P0=13 标签**；搭建可扩展的 **标签数据底座 3.0**（长期 200+ 标签）。
- 质量闸门：**Acc≥90 / Cov≥90 / Fresh=T+1 / Stable≤5%**；发布截至 **D+1 ≤ 11:00**。

### 2. 源数据与边界（四源一口径）

- **S1 数仓（官方）**：合同/价差/交易/画像等线上事实，作为主数据与 B 类 SoT。
- **S2 区域反馈**：线下上翻（门店现场、外显品牌、营业信息等）。
- **S3 商户运营（订正）**：口径收口与优先修正（**Locked + TTL**）。
- **S4 情报反馈**：侧证/专项（重叠、中小供给等）。
- **共识**：字典**不是**数据源，属于清洗/治理索引；未来新源保留空接口即可接入。

### 3. RAW → STD → INPUT（三段式协作）

- **RAW（业务交付）**：三表统一主键 ``；值槽位三选一互斥；S3 订正 `` 必填；分区 `ingest_date`。
- **STD（DE 承接）**：类型对齐（布尔 1/0/99、枚举 code、时段合法化）、枚举/单位归一、`tag_code→value_type` 校验。
- **INPUT Tall（DE 产出）**：**信号事实**（站×日×`signal_key`×单值）；键 `as_of_date, source, store_id, signal_key`。

### 4. 标签字典与映射

- `tag_spec`（治理主表）→ `vw_tag_spec_current`（当前有效视图）；``** 推荐 UUIDv7**，`tag_code` 稳定可读。
- `tag_signal_map`：`tag_code → signal_key`；`tag_backward_compat`：兼容旧编码。

### 5. 输出与证据

- **输出 Tall**：`tag_value_fact`（站×日×`tag_id`；三槽位互斥 + **七件套** `source/conf/ver/class/evidence_state/trace_id`；**SCD2**）。
- **证据外置**：`tag_trace(trace_id, trace_json, created_at...)`。
- **Hot 宽层**：`tag_wide_daily`（白名单 `tag_wide_hot_list` 驱动列展开）+ 兼容视图 `tag_wide_daily_compat`。

### 6. 订正优先（S3）

- 进入：`raw_ops_tag`；命中即 ``，`conf≈100`；**TTL 到期自动降级**。
- 护栏：仅允许字典中 `allow_ops_fix=true` 的标签；订正需 `reason`，并设日阈值/灰度。

### 7. 质量与发布

- 拒收与校验：RAW 硬拒（主键/互斥/类型/字典/时间/TTL）、STD 自动修复与 S 段拒收（枚举非法、时段非法、越界、过期）。
- 监控：Acc/Cov/Stable/Fresh、槽位互斥=0、类型合法=100%、ER 对齐≥99%、Locked/TTL 达标。
- 回放/回滚：以 `snapshot_id/release_id` 管理；兼容灰度与快速停用（白名单）。

### 8. 落地命名（短名）

- RAW：`raw_region_tag / raw_ops_tag / raw_intel_tag`
- STD：`std_region_tag / std_ops_tag / std_intel_tag`
- INPUT：`tag_input`
- OUTPUT：`tag_value_fact`
- Hot：`tag_wide_daily` · 白名单 `tag_wide_hot_list` · 兼容 `tag_wide_daily_compat`
- 治理：`tag_spec / vw_tag_spec_current / tag_signal_map / tag_change_log / tag_backward_compat`

### 9. 本轮新增交付（12 份）

- 1）DE交付单（边界与 RAW 规范）  2）跑数与回放手册  3）四源→INPUT 映射模板  4）回填模板（S2/S3/S4）
- 5）订正治理 SOP  6）质量监控与验收方案  7）白名单透视规范  8）P0=13 规则总表
- 9）输入/输出 Tall 与七件套  10）拒收与校验清单  11）术语与命名规范  12）上线演练 Checklist（v1.1）

---

## 🚀 启动 Prompt（可直接复制到新对话）

```
你是我的数据工程协作助理。请在“标签数据底座3.0”框架内工作：
- 目标：930 上线 P0=13 标签；SLA：D+1 ≤ 11:00；质量闸门：Acc/Cov≥90、Stable≤5%、Fresh=T+1。
- 四源：S1（数仓官方）、S2（区域反馈）、S3（商户运营·订正 Locked+TTL）、S4（情报侧证）。
- 三段式：RAW(业务交付·主键=store_id+as_of_date+tag_code) → STD(类型/枚举/时段/单位归一) → INPUT Tall(信号事实)。
- 输出层：OUTPUT Tall(tag_value_fact·三槽位互斥+七件套+SCD2) → Hot 宽层(tag_wide_daily·白名单)；证据外置 tag_trace。
- 字典与映射：tag_spec/vw_tag_spec_current、tag_signal_map、tag_backward_compat。
- 订正优先：ops 命中即 Locked，TTL 到期降级；仅 allow_ops_fix=true 的标签允许订正。
本轮任务：<请在此写清楚要做的具体任务，例如“P1 标签设计/调度DAG/测试集与Kappa口径/ER 细化”等>。
输出要求：
1) 给出可落地的表/字段与边界；2) 提供面向 DE 的标准化输入模板或伪代码；3) 明确质量与发布门槛；
4) 如需，补充回放/回滚与白名单变更步骤；5) 产出 md 文档，可在 Open Canvas 打开。
```

---

## ♻️ 循环机制（如何持续更新本日志）

**更新时机**（每轮对话收尾）：

1. 补“对话精华包”的新增点（
   - 新共识 / 新边界 / 新表结构 / 新规则口径 / 新清单）；
2. 把本轮“产出物”列到“新增交付”；
3. 写“下一步议题”（明确 1–3 个具体动作，含“谁/何时/到什么程度”）；
4. 若涉及字典/规则/白名单变更，记录 `spec_version/rule_version` 与 `release_id/snapshot_id`。

**版控约定**：

- 采用 **SemVer**；小改动 `PATCH`；新章节 `MINOR`；结构性调整 `MAJOR`。
- 每次更新只追加，不破坏既有历史；必要时用“改/废弃/兼容映射”标识。

---

## 🔜 下一步议题（起草）

- P1 标签需求池与规格卡批量模板（含 `enum_set` 设计）
- ER 口径细化与站点映射质量提升方案（≥99%）
- 调度 DAG 与看板指标（RAW/STD/INPUT/OUTPUT/Hot）最小上线集

---

## 📎 附：字段/表名速查

- **主键**：`(store_id, as_of_date, tag_code)`；**值槽位**：`target_value_bool/number/string`（互斥）。
- **INPUT 键**：`as_of_date, source, store_id, signal_key`；**OUTPUT 键**：`station_gid, as_of_date, tag_id`。
- **七件套**：`source/conf/ver/class/evidence_state/trace_id`（值槽位三选一）。

