# 批次 5｜情报源模板 & 入库脚本约定
> 用途：兜底数据采集 & 校准；由区域/运营/外部调研人员填报，通过产品表单 → 原始库 → 标准化 → ER 融合 → 标签逻辑。

---

## 1. 表单字段模板（可直接配置）
- **站点基础**
  - `station_name`：站点名称（文本）
  - `address`：详细地址（文本）
  - `lng`：经度（数字）
  - `lat`：纬度（数字）
  - `city`：城市（下拉）
  - `province`：省份（下拉）

- **合作/品牌**
  - `brand_text`：外显品牌原文（文本，例：中石化 XX 加油站）
  - `contract_party_name`：合同方（文本，可选）
  - `pop_name`：POP 名称（文本，可选）

- **竞争/合作**
  - `overlap_guess`：是否重叠站（1/0/99）
  - `mid_vendor_name`：合作中小供给名称（八大枚举+其他）

- **站内服务**
  - `has_carwash`：是否有洗车（1/0/99）
  - `carwash_type`：洗车类型（机器/手工/未知）
  - `has_store`：是否有便利店（1/0/99）
  - `has_restroom`：是否有卫生间（1/0/99）
  - `has_parking`：是否有停车位（1/0/99）

- **营业信息**
  - `open_24h`：是否 24 小时营业（1/0/99）
  - `open_hours`：营业时间（文本，例 0700-2200）

- **证据与元信息**
  - `evidence_url`：照片/文件 URL
  - `reporter`：填报人
  - `report_time`：填报时间（自动）
  - `remark`：备注

---

## 2. 入库表结构
### 2.1 原始表 raw_intelligence_form
```sql
CREATE TABLE IF NOT EXISTS raw_intelligence_form (
  evidence_id STRING PRIMARY KEY,
  station_name STRING,
  address STRING,
  lng DECIMAL(10,6),
  lat DECIMAL(10,6),
  city STRING,
  province STRING,
  brand_text STRING,
  contract_party_name STRING,
  pop_name STRING,
  overlap_guess SMALLINT,
  mid_vendor_name STRING,
  has_carwash SMALLINT,
  carwash_type STRING,
  has_store SMALLINT,
  has_restroom SMALLINT,
  has_parking SMALLINT,
  open_24h SMALLINT,
  open_hours STRING,
  evidence_url STRING,
  reporter STRING,
  report_time TIMESTAMP,
  remark STRING
);
```

### 2.2 标准化表 std_intelligence_form
```sql
CREATE TABLE IF NOT EXISTS std_intelligence_form AS
SELECT evidence_id,
       TRIM(station_name) AS station_name,
       REGEXP_REPLACE(brand_text,'[\\s（）()]','') AS brand_norm,
       CASE WHEN open_24h IN ('是','1','yes','true') THEN 1
            WHEN open_24h IN ('否','0','no','false') THEN 0
            ELSE 99 END AS open_24h_std,
       CASE WHEN carwash_type RLIKE '机|全自|隧道' THEN '机器清洗'
            WHEN carwash_type RLIKE '手|人工' THEN '手工清洗'
            ELSE '未知' END AS carwash_type_std,
       *
FROM raw_intelligence_form;
```

---

## 3. 融合与使用
- **ER 融合**：标准化后的 `std_intelligence_form` 与 `dim_station_master` 做 ER，写入 `xref_source_station`，`source_id='intel'`。
- **权重**：在多源仲裁中按 intel 权重=0.7；仅推动 evidence_state 晋升，不直接覆盖 value。
- **trace 写法**：`{"src":"intel","report_time":"2025-09-02","field":"has_carwash","val":"1","evidence_url":"http://..."}`。

---

## 4. 流程 SLA
1. 区域/运营人员填表（当日）
2. 表单入库 `raw_intelligence_form`（实时）
3. 每日 02:00 → 标准化写入 `std_intelligence_form`
4. 04:00 与官方/region/ops/external 融合，产出标签

---

## 5. 最低可行方案（MVP）
- 表单：Excel/在线表单工具（飞书/钉钉）
- 每日导入脚本：Python + openpyxl → CSV → Hive Load
- 标准化：SQL 脚本（如上）
- 融合：沿用 ER 流程，赋值 `source='intel'`、权重=0.7

---

## 6. 后续优化方向
- 自动采集：OCR 门头、POI 爬虫 → 半自动补全情报源
- 产品化：BD App 内置填报与拍照上传，自动归集入库
- 质量控制：随机 5% 样本人工复核，双人一致性 Kappa≥0.8

