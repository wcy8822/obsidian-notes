# 迭代日志 3 · 合并版（1&2&本轮）

---

## 🚀 启动 Prompt（统一口径）
- **目标**：930 上线 P0=13；SLA：D+1 ≤ 11:00；质量闸门：Acc/Cov≥90、Stable≤5%、Fresh=T+1。  
- **四源**：S1（官方）/ S2（区域）/ S3（运营订正·Locked+TTL）/ S4（情报侧证）。  
- **三段式**：RAW → STD → INPUT Tall → OUTPUT Tall（tag_value_fact+七件套+SCD2；trace 外置）。  
- **交付口径**：业务一律交 CSV，不产 JSON；DE 负责承接并组装内部 JSON。  
- **订正优先**：S3 命中即 Locked，TTL 到期降级。  
- **关键词触发**：“先对焦/继续/拍板/确认”等。  

---

## 📝 本轮任务
- 明确 **业务交付 CSV 的最小集**（治理六张+四源 RAW）。
- 沉淀 **执行 Checklist** 与 **填表指南**，保证小白可用。  
- 对接 **直通版自动化脚本**（P0=13 标签），解决 brand_text 等直通与 validate_enum 校验问题。  
- 共识：品牌字段统一口径 `brand_display → brand_name`，后续全链路沿用。  

---

## 📂 产出文档/工具（合并版）

### 1. 《治理10表 · 业务交付CSV模板（首批）》
- 明确“业务交 CSV → DE 消费/生成对象”的映射链路。  
- 表间顺序：治口径 → 装规则 → 喂 RAW → 落分区 → 做 STD → 产 INPUT → 跑规则 → 写 Tall → 透视 Hot → 质检发布。  
- 一次性交齐：manifest + 四源 RAW + 六张治理 CSV + 规则 CSV + 字典增量。  

### 2. 《业务填表指南（P0·六张治理+四源RAW）》
- 把需要业务填写的 CSV 列头逐一讲人话（作用、字段释义、允许值、状态字典）。
- 特别强调：事实层只写 code，不写中文。

### 3. 《RAW 执行 Checklist》
- 双方分工 + DoD 定义。
- Excel 自检公式、四件套目录、回放/回滚 SQL 样例。
- 放行前硬闸门：三槽位互斥、必填不空、布尔合法、枚举命中、TTL 合规。

### 4. 《P0 直通版（validate_enum=ON）—脚本+mapping 模板》
- 双击运行，硬编码路径，直通 13 个 P0 标签。
- 打开 validate_enum，非法 code → rejects。
- 支持 manifest / rejects / winner_preview 输出。
- 源规则：`*_code` 列写入，`*_code1` 中文列忽略。

---

## 🔑 共识要点（融合）
- **业务交付 CSV**：一律 CSV，DE 做 JSON 序列化。  
- **源字段直通**：源 CSV 已有清洗结果，脚本直通 code，不做别名匹配。  
- **字段命名**：统一 `brand_name`；所有 mapping/脚本保持一致。  
- **空值处理**：空源列不写 S3，不保留空主键行。  
- **主键冲突**：`store_id+as_of_date+tag_code` 同主键保留 conf 高/后行。  
- **validate_enum**：推荐开启，避免脏值进事实层。  
- **四源 RAW 投喂**：业务交付非分区 CSV，DE 承接入日分区表。  
- **枚举口径**：布尔=1/0/99；枚举写 code；ID 写 id；中文 label 仅展示，不入 RAW。  

---

## 📌 下一步（930 前路径）
1. 批次 20250906：按《业务填表指南》交付治理+四源 CSV。  
2. 本地跑直通脚本，生成 out/ 下的 `raw_s3_correction_tag_staging.csv`、manifest、rejects。  
3. 按 Checklist 自检三槽位互斥、枚举合法、订正 TTL。  
4. DE 承接 → RAW_DAILY → STD 校验 → INPUT 信号。  
5. 完成回放/回滚演练，质量门槛达标，写入 tag_release。  

---

## 📖 记忆口诀
**治口径 → 装规则 → 喂 RAW → 落分区 → 做 STD → 产 INPUT → 跑规则 → 写 Tall → 透视 Hot → 质检发布**

