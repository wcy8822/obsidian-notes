#### **1. 数据源信息**
- **文件路径**：`/Users/didi/Downloads/panth/tag_ct/overlap/标签数据-重叠站-202507.xlsx`
- **Sheet组成**：包含7个工作表，分别为`下发`、`收回`、`清洗`、`输出`，情报，商户1，商户2
- **关联字段**：各表通过`store_id`进行关联


#### **2. 核心分析目标**
**a. 产出一个算法版的`is_overlap_station_region`值
-比对，收回/情报/商户的`is_overlap_station_region`的状态值，并标记，产出3个不同的字段，（is_overlap_station_region收回，is_overlap_station_region情报，is_overlap_station_region商户）
	-is_overlap_station_region商户的值，来自于商户1和商户2的值汇总，优先取商户2的值，然后历遍商户1记录，非0和1的记录，赋值99-代表没有值；
	-is_overlap_station_region收回，is_overlap_station_region情报，来自收回/情报，历遍记录，0和1，非0和1的赋值99；
	
-标记后，做优先级逻辑处理，产出一个is_overlap_station_region_final值，并标记来源

	-当3个值，都相等，则直接产出相等值，标记 三方
	-当三个值不相等：（取商户值，标记 商户，取情报值，标记 情报，取区域标记区域）
		-商户的值，不等99，优先取商户值
		-商户的值，等于99：
			情报的值等于1，取情报的值；
			情报的值不等于1：取区域的值；


**b. <span style="font-family:.PingFangUITextSC-Regular;">清洗</span>`<span style="font-family:.PingFangUITextSC-Regular;">收回</span>`<span style="font-family:.PingFangUITextSC-Regular;">中的字段，</span><span style="font-family:.PingFangUITextSC-Bold;"><b>是否合作中小供给，主要中小供给名称</b></span>**  
	<span style="font-family:.PingFangUITextSC-Bold;"><b>-是否合作中小供给，是/否，是转成1，否和其他情况转成0，输出字段-</b></span>**is_cooperate_with_sme_suppliers，1/0**
	<span style="font-family:.PingFangUITextSC-Bold;"><b>-主要中小供给名称：</b></span>
		<span style="font-family:.PingFangUITextSC-Bold;"><b>-把结果值和列表【</b></span>**易加油,帮油,鲸车惠,站联科技,油吨吨,聚油加油,陕西万诚,广电猫猫，其他】对比**
		**-如果模糊匹配到【易加油,帮油,鲸车惠,站联科技,油吨吨,聚油加油,陕西万诚，广电猫猫】中任意一个值，输出一个值，举例：易加油，广电猫猫；命中易加油优先，返回易加油。**
		**-如果没有匹配到，则返回其他**
		**输出字段，typical_sme_supplier_names**
	

**c. 特征工程**  `清洗`sheet里
- 是否头部站，`清洗`sheet里，store_level_mtd_v2
	case
		
		WHEN
			store_level_mtd_v2 = '非头部站' THEN
				 '非头部站'  ELSE  '头部站'
			END ；
-抽检随机抽样，0/1,1代表抽中；is_overlap_station_region_final ，0/1，0-抽比例5%，1抽比例3%。如果绝对值少于10个自动补齐10个，按优先级取。
	-province_name1 维度下，抽样的比例误差小于3%，比例=随机抽样油站数/油站总数
	-party_first_name，相同的，最多只抽2个油站
	-is_overlap_station_region_final ，0/1，抽样比例误差小于5%，
	-is_overlap_station_region_final的数据来源标记，标记三方不抽，标记商户不抽，只抽标记区域和情报。
	-order_cnt_mtd,值越大，抽样优先级越高，
	输出到字段，is_rand
-商户差异， 0/1,0代表差异，1代表相同
	--party_first_name，分组下，值为空值则忽略这个逻辑
		-is_overlap_station_region_final 的结果不一样，标记0；
		--is_overlap_station_region_final 的结果一样，标记1；
-商户差异修正建议：
	---party_first_name，分组下，取出现次数最多的值，做建议值。比如有3个0,4个1，则取1；


#### **3. 数据处理要求**
**a. store_id 格式处理**  
- 以字符串形式读取，避免科学计数法（如`1.234E+17`）
- 清洗逻辑：移除引号、空格等特殊字符（例：`'5932526965` → `5932526965`）
- 保留原始长度（不限制为18位）

**b. 数据验证与错误处理**  
- 交互式处理缺失列：提示用户输入替代列名
- 处理重复值：发现重复`store_id`时，按优先级排序取第一行数据，即rn=1
- 缺失数据处理：允许部分环节状态为空值

**c. 结果产出**  
- 按下发中的store_id为初始store_id，后续找不到数据则留空
- 标记在哪个环节找不到数据的，是收回/清洗哪个环节没数据的？



#### **4. 输出要求**
- **格式**：CSV文件
- **路径**：与源文件同目录
- **文件名**：`重叠站分析结果_时间戳.csv`（例：`重叠站分析结果_20250729_153045.csv`）
- **字段结构**：
  ```plaintext
  party_first_name｜store_id | is_overlap_station_region收回，is_overlap_station_region情报，is_overlap_station_region商户，is_overlap_station_region_final ，is_overlap_station_region_final_标记来源，
is_cooperate_with_sme_suppliers，typical_sme_supplier_names，是否头部站，is_rand，商户差异，商户差异修正建议，

#### **5. 代码实现要点**
- **数据读取**：使用`converters={'store_id': str}`确保字符串格式
- **数据清洗**：自定义`clean_store_id`函数处理特殊字符
- **漏斗分析逻辑**：逐层对比ID变化，标记流失环节
- **结果保存**：使用`na_rep='nan'`明确表示缺失值，确保中文编码正确

仔细确认需求，评估方案，需要我的输入分配为我的todo，给出你的计划方案。跟我交互拉齐，待我完全确认后，我将回复“确认，请开始”，你在开始将需求转化为具体的代码编写。


1. **确认优先级规则**
	- 当发现重复store_id时，按order_cnt_mtd做降序排列
1. **明确区域值来源**
	- is_overlap_station_region_final计算逻辑中提到的 "区域值" 具体来自哪个·收回·sheet的is_overlap_station_region字段
	- 区域是我表述错了，应该是收回，你可以理解是 收回sheet
1. **确认抽样逻辑细节，来自于** `清洗`sheet中
	- province_name1字段在哪些表中存在？是否所有表都有该字段？
	- order_cnt_mtd字段在哪个表中存在？用于抽样优先级排序。
	- -province_name1 维度下，抽样的比例误差小于3%，比例=随机抽样油站数/油站总数
		- -party_first_name，相同的，最多只抽2个油站
		- -is_overlap_station_region_final ，0/1，抽样比例误差小于5%，
		- -is_overlap_station_region_final的数据来源标记，标记三方不抽，标记商户不抽，只抽标记区域和情报。
		- -order_cnt_mtd,值越大，抽样优先级越高
- <span style="font-family:.PingFangUITextSC-Bold;"><b>主要中小供给名称：模糊匹配，要用值取比对列表，</b></span>**易加油,帮油,鲸车惠,站联科技,油吨吨,聚油加油,陕西万诚,广电猫猫，其他，按优先级对比，先比对到哪个就是输出哪个。**
		- <span style="font-family:.PingFangUITextSC-Bold;"><b>-把结果值和列表【</b></span>**易加油,帮油,鲸车惠,站联科技,油吨吨,聚油加油,陕西万诚,广电猫猫，其他】历遍对比**
		- **-如果模糊匹配到【易加油,帮油,鲸车惠,站联科技,油吨吨,聚油加油,陕西万诚，广电猫猫】中任意一个值，输出一个值，举例：易加油，广电猫猫；命中易加油优先，返回易加油。**
		- **-如果没有匹配到，则返回其他**
		- **输出字段，typical_sme_supplier_names**



**能运行了，但还要修改一下：**
**1.** is_overlap_station_region收回，字段逻辑处理，<span style="font-family:.PingFangUITextSC-Bold;"><b>是/否，是转成1，否转成0，其他情况转成99；</b></span>
<span style="font-family:.PingFangUITextSC-Bold;"><b>2.</b></span> **is_cooperate_with_sme_suppliers，在基础逻辑上，增加空值的处理，空值处理成99；**
**3. typical_sme_supplier_names,在原来的基础上，增加前置逻辑判断，**
	**a. 当is_cooperate_with_sme_suppliers值不等于是或者1的时候；直接赋值99**
	**a. 当is_cooperate_with_sme_suppliers值等于是或者1的时候，才会有继续处理的逻辑，按之前的逻辑处理。**
**4.增加一个字段，id流失环节，**标记在哪个环节找不到数据的，是收回/清洗哪个环节没数据的？值：收回/清洗/nan,nan表示数据都有。
**5.**<span style="font-family:.PingFangUITextSC-Bold;"><b>全部的代码增加对空值</b></span>**/**<span style="font-family:.PingFangUITextSC-Bold;"><b>异常值的排除，</b></span>增加了对空值的处理，避免 KeyError

**还要再迭代一版：**
**1.**#### **核心分析目标**
**a. 产出一个算法版的`is_overlap_station_region`值
-比对，收回/情报/商户的`is_overlap_station_region`的状态值，并标记，产出3个不同的字段，（is_overlap_station_region收回，is_overlap_station_region情报，is_overlap_station_region商户）
	-is_overlap_station_region商户的值，来自于商户1和商户2的值汇总，优先取商户2的值，然后历遍商户1记录，非0和1的记录，赋值99-代表没有值；
	-is_overlap_station_region收回，字段逻辑处理，<span style="font-family:.PingFangUITextSC-Bold;"><b>是/否，是转成1，否转成0，其他情况转成99</b></span>
	-is_overlap_station_region情报，历遍记录，0和1，非0和1的赋值99；
	
-b.标记后，is_overlap_station_region_final_标记来源，值（三方/区域/情报/商户）
	-做优先级逻辑处理，产出一个is_overlap_station_region_final值，并标记来源
（is_overlap_station_region收回，is_overlap_station_region情报，is_overlap_station_region商户）简称3个值。
	-当3个值，相等（（is_overlap_station_region收回=is_overlap_station_region情报=is_overlap_station_region商户），则直接产出相等值，标记 `三方`
	-当三个值不相等：（取商户值 标记 商户，取情报值 标记 情报，取收回 标记 区域）
		-商户的值，不等99，优先取商户值；
		-商户的值，等于99：
			收回的值不等于99，取收回的值；
			收回的值等于99，取情报的值；
2.-商户差异， 0/1,0代表差异，1代表相同
	--party_first_name，分组下，
		-is_overlap_station_region_final 的结果不一样，标记0；
		--is_overlap_station_region_final 的结果一样，标记1；
	结果只比对0和1的值。

3.产出一个is_overlap_station_region_final_2的字段：逻辑如下：
	a.·商户差异修正建议·是0或1，优先取·商户差异修正建议· 
	b.·商户差异修正建议·不是0或1，取is_overlap_station_region_final
4.`下发`sheet，字段，油站名称，做清洗
	a.油站名称，包含`下线`或`测试`或`京测`，标记为’下线或测试`
5.`下发`sheet，字段，party_first_name，做清洗 
	a.party_first_name，包含`虚拟`或`虚拟商户`，标记为’虚拟商户`	
6.合并4和5，产出一个新字段，tag_1，组合4和5的字段。

**7.**

- **字段结构**：
  ```plaintext
  party_first_name｜store_id ，油站名称， is_overlap_station_region收回，is_overlap_station_region情报，is_overlap_station_region商户，is_overlap_station_region_final ，is_overlap_station_region_final_2，is_overlap_station_region_final_标记来源，
is_cooperate_with_sme_suppliers，typical_sme_supplier_names，是否头部站，is_rand，商户差异，商户差异修正建议，tag_1

**未涉及的部分，以V8版本的需求为准。**



1. 弃用品牌数据是否需要完全排除，输出的时候返回为空值，就是当数据库里没有这个品牌名。
1. 重叠站数据关联时，若store_id重复应如何处理？按store_level_mtd_v2，order_cnt_mtd，is_overlap做降序排列，rn=1.
2. 是否需要为新增字段添加数据质量校验（如空值率、数据类型等）？需要，增加校验。
3. 脏数据的产出逻辑，实控人未匹配的不算脏数据。与大逻辑冲突的才需要标记成脏数据；大逻辑是，主营>KA>品牌的冲突。



4. **确认大逻辑冲突示例**：是否有其他需纳入的冲突场景（如 “CKA 的 coop_station_cnt<10”）？无此类型
5. **提供品牌库预期值**：最终客户等级=KA时，对应的品牌名预期值（如 “中石油”“中石化”），用于校验条件
	1. 预期值，应该复核模糊匹配，品牌库中有N个值，如何取优先级呢?精度最高的值？匹配度最高的值？
	2. 模糊匹配的逻辑需要在给我确认一下，因为这个是关键。他决定了，匹配出来的结果是否符合预期。
	3. 本段代码的关键逻辑就是通过名称+关键词，匹配品牌库的数据来返回预期值。


**0.匹配逻辑**

**1.拆分关键词，关键词越细越好**
**2.关键词取匹配品牌库**
	**a.精准匹配，**
	**b.子串匹配**
	**c.模糊匹配**
**3.匹配不区分大小写，支持英文缩写**

**1.确认模糊匹配规则**
请确认以下场景的匹配预期：

- 关键词"中油碧辟广东石油有限公司" → 应识别”关键词，中油BP，中油碧辟，BP”，中油BP，最后在品牌库中比对预期结果。（通过强制匹配）。
- 关键词"壳牌能源（中国）" → 应匹配"壳牌"（通过子串匹配）。
- 关键词"Sinopec福建" → 应匹配"中石化"（通过相似度匹配，需确认是支持英文缩写）。
**2. 提供品牌库示例-路径**
 **'mapping_table_path': '/Users/didi/Downloads/panth/tag_ct/kacka/分类验证与品牌对照表.xlsx',**

仔细确认需求，评估方案，需要我的输入分配为我的todo，给出你的计划方案。跟我交互拉齐，待我完全确认后，我将回复“确认，请开始”，你在开始将需求转化为具体的代码编写。


对这个版本进行修改：标签CKA数据处理脚本V4创建时间：16:12


1. 弃用品牌数据是否需要完全排除，输出的时候返回为空值，就是当数据库里没有这个品牌名。
2. 重叠站数据关联时，若store_id重复应如何处理？按store_level_mtd_v2，order_cnt_mtd，is_overlap做降序排列，rn=1.
3. 是否需要为新增字段添加数据质量校验（如空值率、数据类型等）？需要，增加校验。
4. 脏数据的产出逻辑，实控人未匹配的不算脏数据。与大逻辑冲突的才需要标记成脏数据；大逻辑是，主营>KA>品牌的冲突。


**4.1确认大逻辑冲突示例**：是否有其他需纳入的冲突场景（如 “CKA 的 coop_station_cnt<10”）？无此类型
**4.2提供品牌库预期值**：最终客户等级=KA时，对应的品牌名预期值（如 “中石油”“中石化”），用于校验条件
a预期值，应该复核模糊匹配，品牌库中有N个值，如何取优先级呢?精度最高的值？匹配度最高的值？
B模糊匹配的逻辑需要在给我确认一下，因为这个是关键。他决定了，匹配出来的结果是否符合预期。
C本段代码的关键逻辑就是通过名称+关键词，匹配品牌库的数据来返回预期值。

5增加字段，放在数据分析表最后，关联  file_path = '/Users/didi/Downloads/panth/tag_ct/overlap/标签数据-重叠站-202507.xlsx'，sheet名是`在线`，通过字段，store_id，关联，store_level_mtd_v2，order_cnt_mtd，is_overlap。
6.最后输出字段：store_id	store_name	party_first_name	cleaned_party_name	cleaned_keywords	matched_abbr	confidence	主营/非主营	KA/CKA/小散	品牌名	actual_controller	coop_station_cnt	is_coop_station_cnt_valid	最终客户等级	分类层级	suggested_abbr	is_controller_matched，store_level_mtd_v2，order_cnt_mtd，is_overlap。顺序不可改。




**待你确认的事项（你的 ToDo）**
1. 请提供当前代码中读取数据的路径（例如输入文件、映射表路径）。

      'raw_data_path': '/Users/didi/Downloads/panth/tag_ct/kacka/shyy_store_tyep202507.csv',
        'mapping_table_path': '/Users/didi/Downloads/panth/tag_ct/kacka/分类验证与品牌对照表.xlsx',
        'base_output_dir': '/Users/didi/Downloads/panth/tag_ct/kacka/'  # 基础路径，自动创建子文件夹
1. 是否需要支持通过命令行参数、配置文件（如 JSON/YAML）或交互式输入修改路径？不用，在代码里，改就行，改一个地方就行，假设需要更改的话，只用改一个地方。
2. 对于 suggested_abbr，若 品牌名 存在但无实际意义（如 "其他”），排除其他，要有实际意义建议的才可以优先用？
3. 给代码加一个版本号，带时间戳的。方便我管理

仔细确认需求，评估方案，需要我的输入分配为我的todo，给出你的计划方案。跟我交互拉齐，待我完全确认后，我将回复“确认，请开始”，你在开始将需求转化为具体的代码编写。