先定义无意义的值,值不等于空值/无/0/乱码符号/错误值报错
定义:数据源中的字段是比对值,字典中的字段是参照值,只有参照值完整的体现在对照值中,才算匹配成功.比如参照值是延长石化,对比值是石化,就不能比对成功.如果比对值是延长石化恒安,就算比对成功,因为参制值包含于比对值.



1.匹配的逻辑,重新迭代,

1.1 取比对值,

<span style="font-family:.PingFangUITextSC-Regular;">当</span>

| <p style="text-align:center;margin:0"><b>sheet1_abbr</b></p> |
| -- |


,值有意义的时候,取**sheet1_abbr;**
**否则,取,有意义的**

| <p style="text-align:center;margin:0"><b>party_first_name</b></p> |
| -- |


,否则取有意义的

| <p style="text-align:center;margin:0"><b>pop_name</b></p> |
| -- |


,否则取有意义的

| <p style="text-align:center;margin:0"><b>store_name</b></p> |
| -- |


1.2 用比对值,按校验流程来校验

在原来的基础上,迭代如下,涉及到的冲突的部分以新需求为准.未涉及的以源代码为准.
1.
产出中间表,中间表_清洗逻辑+时间戳
定义:
数据源中的字段是比对值,
字典中的字段是参照值,
只有参照值完整的体现在对照值中,才算匹配成功.
比如参照值是延长石化,对比值是石化,就不能比对成功.
如果比对值是延长石化恒安,就算比对成功,因为参制值包含于比对值.



store_Id, pop_id,
**sheet1_abbr,**    **brand_name_abbr, method_abbr	 ,score_abbr**
store_name, store_name_a, **brand_name_**store**,method_**store	 **,score_**store
pop_name, pop_name_a, **brand_name_**pop**,method_**pop **,score_**pop
party_first_name, party_first_name_a, **brand_name_**party**,method_**party	 **,score_**party



store_name_a, pop_name_a, party_first_name_a,
表示,按停用词规则清洗的比对值_a


**brand_name_abbr,   表示**s**sheet1_abbr**用映射比对逻辑找到的 参照值 **brand_name**
**method_abbr	 ,sheet1_abbr**的**参照值用的清洗方法** 

**score_abbr   ,sheet1_abbr** 比对的相似度

 **brand_name_**store**, 表示**store_name_a用映射比对逻辑找到的 参照值**brand_name**
**method_**store	 **,**store_name_a的**参照值用的清洗方法**
**score_**store, store_name_a比对的相似度

 **brand_name_**pop**, 表示**pop_name_a用映射比对逻辑找到的 参照值**brand_name**
**method_**pop	 **,**pop_name_a**参照值用的清洗方法**
**score_**pop,比对pop_name_a的相似度

 **brand_name_**party**, 表示**party_first_name_a用映射比对逻辑找到的 参照值**brand_name**
**method_**party	 **,**party_first_name_a**参照值用的清洗方法**
**score_**party ,比对party_first_name_a的相似度

2.通过比对值,查找参照值(brand_name)

### 清洗与匹配模块详细逻辑阐述


<span style="font-family:.PingFangUITextSC-Regular;">该模块是数据处理的核心环节，负责对原始数据中的名称字段进行清洗（移除停用词），并通过多阶段匹配逻辑关联品牌信息，最终生成中间匹配结果及待确认数据。主要包含</span>**停用词清洗**、**多阶段品牌匹配**、**中间结果与待确认表生成**三个核心流程，对应代码中的`load_stop_words_rules`、`clean_name_with_stopwords`、`match_single_value`、`match_brands`等函数。


#### 1. 停用词清洗：基于规则的名称预处理
**功能**：移除名称字段中包含的停用词（如冗余前缀、后缀或无关词汇），同时支持“排除规则”（即满足特定条件时不执行停用词移除），提升后续匹配准确性。

**实现逻辑**：
- **加载停用词规则**：通过`load_stop_words_rules`函数读取“清洗规则配置表”（路径固定为`3清洗规则配置表.xlsx`），筛选出“是否停用=1”的规则（即需要生效的停用词规则），每条规则包含“原始值”（需移除的词）和“排除规则”（不执行移除的条件）。
- **应用清洗规则**：通过`clean_name_with_stopwords`函数对名称字段（如`pop_name`、`sheet1_abbr`等）执行清洗：
  - 若名称为空或空字符串，直接返回原始值；
  - 遍历所有停用词规则，检查名称中是否包含“原始值”：
    - 若“排除规则”为空（无特殊条件），直接移除名称中的“原始值”；
    - 若“排除规则”非空，仅当名称中**不包含**“排除规则”时，才移除“原始值”；
  - 清洗后处理连续空格（合并为单个空格），若清洗后结果为空，则保留原始名称。

**示例**：  
<span style="font-family:.PingFangUITextSC-Regular;">若停用词规则为“原始值</span>=‘店’，排除规则=‘旗舰店’”，则名称“张三店”会被清洗为“张三”，而“张三旗舰店”因包含排除规则“旗舰店”，保持不变。


#### 2. 多阶段品牌匹配：分层递进的匹配逻辑
**功能**：对清洗后的名称字段，按优先级从高到低尝试多种匹配方式，尽可能准确关联品牌字典中的品牌信息，匹配方式优先级为：`精确匹配（白名单）→ 包含匹配（白名单）→ 别名精确匹配 → 别名包含匹配 → 模糊匹配`。

**核心函数**：`match_single_value`（单值匹配逻辑）、`match_brands`（多字段批量匹配）。

**阶段详情**：
- **阶段1：精确匹配（优先白名单）**  
  检查清洗后的名称是否与品牌字典中“白名单品牌”（`white_list=1`）的`brand_name`完全一致。若匹配成功，返回该品牌名，匹配方式标记为`MATCH_METHOD_EXACT（0）`，分数X。

- **阶段2：包含匹配（白名单）**  
  若精确匹配失败，检查清洗后的名称是否**包含**品牌字典中“白名单品牌”的`brand_name`（如名称“星巴克咖啡”包含品牌“星巴克”）。若存在多个匹配，按品牌名长度倒序排序（更长的品牌名更精确），取最长匹配结果，匹配方式标记为`MATCH_METHOD_CONTAIN（3）`，分数X。

- **阶段3：别名精确匹配**  
  若前两阶段失败，检查清洗后的名称是否与品牌字典中`brand_aliases`（品牌别名，多别名用逗号分隔）中的某一别名完全一致（字符串精确匹配）。匹配成功则返回对应品牌名，方式标记为`MATCH_METHOD_ALIAS（1）`，分数X。

- **阶段4：别名包含匹配**  
  若别名精确匹配失败，检查清洗后的名称是否**包含**品牌字典中`brand_aliases`的任意一个别名（如名称“瑞幸饮品”包含别名“瑞幸”）。匹配成功则返回对应品牌名，方式标记为`MATCH_METHOD_CONTAIN（3）`，分数X。

- **阶段5：模糊匹配**  
  若前四阶段均失败，使用`fuzzywuzzy`库的`partial_ratio`算法计算清洗后的名称与品牌`brand_aliases`的相似度得分，当得分≥品牌字典中`match_score_threshold`（匹配阈值）时，返回该品牌名，方式标记为`MATCH_METHOD_FUZZY（2）`，分数为相似度得分（X）。

**过滤逻辑**：所有匹配阶段均会先过滤掉品牌字典中的“黑名单品牌”（`black_list=1`），不参与匹配。
	当比对值,有以下情形自动过滤这个比对值,比如 比对值等于石化,石油,化工,空值等;

** 分数X ,X需要根据 (比对值的可比值)/参照值  来计算,比如参照值是 中国石化,比对值是XX中国石化XX,XX表示通配符.比对值的可比值等于中国石化.


#### 3. 中间结果与待确认表生成
**功能**：记录各字段的匹配结果，汇总未匹配到任何品牌的记录至“待确认表”。

**实现逻辑**：
- **多字段匹配**：通过`match_brands`函数对每个数据源的每条记录，按顺序处理可用的名称字段（优先`sheet1_abbr`，再`pop_name`，最后`party_first_name`），每条字段对应一列匹配结果：
  - 记录清洗后的值（如`sheet1_abbr_cleaned`）；
  - 记录匹配到的品牌名（如`brand_name_1`对应`sheet1_abbr`的结果）、匹配方式（如`method_1`）、匹配分数（如`score_1`）。
- **待确认表生成**：对每条记录，若所有名称字段均未匹配到品牌（`brand_name_1`、`brand_name_2`、`brand_name_3`均为空），则将该记录加入待确认表，包含字段：`id_来源`（`store_id`+数据源名称）、`data_source`（数据源名称）、原始名称字段、未匹配原因等。

**输出**：  
- 中间表：每个数据源的匹配结果，包含原始字段、清洗后字段、各阶段匹配结果；  
- 待确认表：汇总所有未匹配成功的记录，用于人工校验或规则优化。

补充增加:

产出多一张,中间表,中间表_清洗逻辑+时间戳
定义:
数据源中的字段是比对值,
字典中的字段是参照值,
只有参照值完整的体现在对照值中,才算匹配成功.
比如参照值是延长石化,对比值是石化,就不能比对成功.
如果比对值是延长石化恒安,就算比对成功,因为参制值包含于比对值.



store_Id, pop_id,
**sheet1_abbr,**    **brand_name_abbr, method_abbr	 ,score_abbr**
store_name, store_name_a, **brand_name_**store**,method_**store	 **,score_**store
pop_name, pop_name_a, **brand_name_**pop**,method_**pop **,score_**pop
party_first_name, party_first_name_a, **brand_name_**party**,method_**party	 **,score_**party



store_name_a, pop_name_a, party_first_name_a,
表示,按停用词规则清洗的比对值_a


**brand_name_abbr,   表示**s**sheet1_abbr**用映射比对逻辑找到的 参照值 **brand_name**
**method_abbr	 ,sheet1_abbr**的**参照值用的清洗方法** 

**score_abbr   ,sheet1_abbr** 比对的相似度

 **brand_name_**store**, 表示**store_name_a用映射比对逻辑找到的 参照值**brand_name**
**method_**store	 **,**store_name_a的**参照值用的清洗方法**
**score_**store, store_name_a比对的相似度

 **brand_name_**pop**, 表示**pop_name_a用映射比对逻辑找到的 参照值**brand_name**
**method_**pop	 **,**pop_name_a**参照值用的清洗方法**
**score_**pop,比对pop_name_a的相似度

 **brand_name_**party**, 表示**party_first_name_a用映射比对逻辑找到的 参照值**brand_name**
**method_**party	 **,**party_first_name_a**参照值用的清洗方法**
**score_**party ,比对party_first_name_a的相似度


#### 模块小结
<span style="font-family:.PingFangUITextSC-Regular;">清洗与匹配模块通过“先清洗后匹配”的流程，结合分层递进的匹配策略，在保证匹配准确性的同时最大化匹配覆盖率。停用词清洗减少噪声干扰，多阶段匹配优先高置信度结果，未匹配记录的汇总则为后续数据治理提供依据，是连接原始数据与最终品牌标签的核心转换环节。</span>