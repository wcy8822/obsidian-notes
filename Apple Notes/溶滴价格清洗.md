# 船单溶滴数据清洗与汇总需求文档  


## 一、项目背景  
<span style="font-family:.PingFangUITextSC-Regular;">为实现对多源</span>Excel格式船单数据的标准化处理，聚焦92#产品的成交信息整合，需开发自动化工具完成数据清洗、字段标准化及汇总，减少人工处理成本，提升数据可用性，为后续分析提供统一数据源。  


## 二、项目目标  
1. 批量读取指定目录下的Excel文件（.xlsx/.xls），提取92#产品相关数据；  
2. 对数据进行清洗（填充缺失值、替换无效值等）和标准化（统一字段名、格式）；  
3. 汇总所有有效数据，输出结构化CSV文件，支持业务分析与统计。  


## 三、需求范围  
### 1. 输入范围  
- **文件类型**：指定目录下的Excel文件（.xlsx/.xls）；  
- **核心数据**：包含92#产品的出货、成交相关信息（如港口、供应商、价格等）；  
- **文件名要求**：需包含日期信息（格式为“YYYYMMDD”，用于提取数据所属日期）。  
/Users/didi/Downloads/panth/gyl/cd

### 2. 输出范围  
-1. **文件存储**：保存至指定路径`/Users/didi/Downloads/panth/gyl/`。
2. **文件命名**：格式为“溶滴价格数据清洗+时分级时间戳”（如“溶滴价格数据清洗_202507311530.xlsx”）。
3. **数据合并**：一次性遍历所有输入文件的工作表，将清洗后的数据合并为一个文件输出。
- **核心字段**：日期、港口、供应商、产品、报价、成交价、备注（共7个字段）。 优先核心字段的顺序排列，不可更改，有新增字段可按需罗列 备注 之后


## 四、功能需求  

### 1. 文件读取与筛选  
- 自动识别指定目录下所有Excel文件，排除非Excel格式文件；  
- 从文件名中提取日期（正则匹配“YYYYMMDD”格式），作为数据的“日期”字段；若无法提取日期，跳过该文件。  


### 2. 数据清洗规则  
#### （1）缺失值处理  
- 对“地区”“出货地/港口”“出货方”“产品”列，采用“向前填充”（即使用同一列中前一行的非空值填充当前空值）；  
- 其他字段缺失时，统一用“null”表示。  

#### （2）特殊值替换  
- 将数据中的“——”替换为“null”，统一无效值标识。  

#### （3）数据筛选  
- 仅保留“产品”列为“92#”的数据；若文件中无“产品”列，跳过该文件。  


### 3. 字段标准化规则  
#### （1）列名映射（支持模糊匹配）  
<span style="font-family:.PingFangUITextSC-Regular;">通过预设映射关系统一字段名，规则如下：</span>  

| 目标字段 | 源字段模糊匹配范围                  | 说明                                  |  
|----------|-------------------------------------|---------------------------------------|  
| 港口     | 出货地/港口、港口、卸货港           | 匹配包含任一关键词的列名              |  
| 供应商   | 出货方、供应商、卖家、卖方          | 匹配包含任一关键词的列名              |  
| 产品     | 产品、品种、油品                    | 匹配包含任一关键词的列名（最终固定为“92#”） |  
| 报价     | 厂家报价、报价、挂牌价、指导价、参考价        | 匹配包含任一关键词的列名              |  
| 成交价   | 成交价、成交价格、实际成交价、最终价格 | 匹配包含任一关键词的列名              |  
| 备注     | 备注、说明、附注                    | 匹配包含任一关键词的列名              |  

- 若未找到匹配的源列，目标字段默认填充“null”。  


#### （2）字段格式处理  
- **日期**：固定格式为“YYYY-MM-DD”（从文件名提取后转换）；  
- **报价/成交价**：从原始值中提取数字（支持整数/小数，如“89.5元”提取为89），转换为整数；若无法提取数字，报价为0（最终会被过滤），成交价为0；  
- **备注**：优先从“成交价”字段的括号中提取内容（如“90(含税)”提取“含税”）；若无括号，默认“null”。  


### 4. 数据过滤与汇总  
- 过滤“报价”为0的无效记录；  
- 合并所有符合条件的文件数据，按“日期、港口、供应商、产品、报价、成交价、备注”字段顺序输出；  
- 输出文件编码为GBK，确保中文正常显示。  


### （三）防呆校验规则
1. **新增均值字段**：为2个价格字段新增7天均值校验字段：
   - `报价_week`：对应`报价`的过去7天有效数据均值；
   - `成交价_week`：对应`成交价`的过去7天有效数据均值；
   
2. **异常标记**：若当天价格与对应7天均值偏离超过±20%（即`|(当天值-均值)/均值| > 20%`），标记为异常；“控制”状态或无数据不视为异常。


### （四）排序规则
1. **一级排序**：按`日期`降序（最新日期在前）。
2. **二级排序**：按`港口`（厂家）的降序顺序排列：
   

## 五、约束条件  
1. 输入Excel文件必须包含“产品”列（否则无法筛选92#数据）；  
2. 文件名需包含“YYYYMMDD”格式日期（否则无法提取日期，文件被跳过）；  
3. 依赖Python环境及`pandas`、`re`等库（需提前配置）。  


## 六、验收标准  
1. 输出CSV文件包含所有预设的7个字段，无缺失；  
2. 92#产品数据完整保留，非92#数据已排除；  
3. 日期格式统一为“YYYY-MM-DD”，报价/成交价为整数，无“——”等特殊值；  
4. 无报价为0的记录，缺失字段均以“null”填充；  
5. 支持至少10个Excel文件的批量处理，无数据丢失或格式错误。
6. 命令提示，数据值预览模型，比如本次处理X条数据，均值价格XX，最大值XX，最小值XXX。

import os
import re
from datetime import datetime, timedelta
import pandas as pd
from typing import List, Optional

# -------------------------- 配置参数 --------------------------
CONFIG = {
    "input_dir": "/Users/didi/Downloads/panth/cd",  # 输入Excel目录
    "output_dir": "/Users/didi/Downloads/panth/gyl/",  # 输出目录
    "target_product": "92#",  # 目标产品
    "output_prefix": "溶滴价格数据清洗",  # 输出文件前缀
    "required_columns": [  # 输出字段顺序
        "日期", "港口", "供应商", "产品", "报价", "成交价", 
        "备注", "报价_week", "成交价_week", "报价_异常", "成交价_异常"
    ]
}

# -------------------------- 工具函数 --------------------------
def extract_date_from_filename(filename: str) -> Optional[str]:
    """从文件名提取日期，返回YYYY-MM-DD格式或None"""
    date_pattern = r'(\d{4})(\d{2})(\d{2})'
    match = re.search(date_pattern, filename)
    if match:
        year, month, day = match.groups()
        try:
            # 验证日期合法性
            datetime(int(year), int(month), int(day))
            return f"{year}-{month}-{day}"
        except ValueError:
            print(f"警告: 文件名 {filename} 中的日期不合法，跳过该文件")
            return None
    print(f"警告: 无法从文件名 {filename} 提取日期，跳过该文件")
    return None

def extract_number(value) -> int:
    """从字符串中提取数字并转为整数"""
    if pd.isna(value):
        return 0
    # 处理"控制"等非数值情况
    if str(value).strip().lower() in ["控制", "null"]:
        return 0
    match = re.search(r'(\d+\.?\d*)', str(value))
    return int(float(match.group(1))) if match else 0

def extract_bracket_content(value) -> str:
    """提取字符串中括号内的内容作为备注"""
    if pd.isna(value):
        return "null"
    match = re.search(r'\((.*?)\)', str(value))
    return match.group(1) if match else "null"

def calculate_week_mean(df: pd.DataFrame, current_date: str, price_col: str) -> float:
    """计算当前日期过去7天（含当天）的有效价格均值"""
    # 转换日期为datetime类型
    df['日期_dt'] = pd.to_datetime(df['日期'])
    current_dt = pd.to_datetime(current_date)
    
    # 筛选过去7天内的有效数据（非0且非null）
    mask = (
        (df['日期_dt'] >= current_dt - timedelta(days=7)) &
        (df['日期_dt'] <= current_dt) &
        (df[price_col] > 0)
    )
    valid_data = df.loc[mask, price_col]
    
    df.drop(columns=['日期_dt'], inplace=True)  # 清理临时列
    return valid_data.mean() if len(valid_data) >= 1 else None

def judge_abnormal(price: int, mean: Optional[float]) -> str:
    """判断价格是否异常（偏离均值±20%）"""
    if mean is None or price == 0 or str(price).lower() == "控制":
        return "无校验"
    deviation = abs((price - mean) / mean)
    return "异常" if deviation > 0.2 else "正常"

# -------------------------- 数据处理逻辑 --------------------------
def process_worksheet(file_name: str, sheet_name: str, sheet_data: pd.DataFrame, file_date: str) -> Optional[pd.DataFrame]:
    """处理单个工作表数据"""
    # 缺失值填充（向前填充指定列）
    fill_columns = ['地区', '出货地/港口', '出货方', '产品']
    for col in fill_columns:
        if col in sheet_data.columns:
            sheet_data[col].fillna(method='ffill', inplace=True)
    
    # 筛选92#产品
    if '产品' not in sheet_data.columns:
        print(f"警告: 文件 {file_name} 的工作表 {sheet_name} 无'产品'列，跳过")
        return None
    filtered = sheet_data[sheet_data['产品'] == CONFIG['target_product']].reset_index(drop=True)
    if filtered.empty:
        print(f"文件 {file_name} 的工作表 {sheet_name} 无{CONFIG['target_product']}数据，跳过")
        return None
    
    # 特殊值替换
    filtered.replace('——', 'null', inplace=True)
    
    # 列名模糊映射
    column_mapping = {
        '港口': ['出货地/港口', '港口', '卸货港'],
        '供应商': ['出货方', '供应商', '卖家', '卖方'],
        '产品': ['产品', '品种', '油品'],
        '报价': ['厂家报价', '报价', '挂牌价', '指导价', '参考价'],
        '成交价': ['成交价', '成交价格', '实际成交价', '最终价格'],
        '备注': ['备注', '说明', '附注']
    }
    
    # 映射目标字段
    for target_col, possible_cols in column_mapping.items():
        # 模糊匹配包含关键词的列
        source_col = next(
            (col for col in filtered.columns if any(pattern in col for pattern in possible_cols)),
            None
        )
        if source_col:
            filtered[target_col] = filtered[source_col]
        else:
            filtered[target_col] = 'null'
    
    # 添加文件日期
    filtered.insert(0, '日期', file_date)
    
    # 处理价格字段（提取数字）
    filtered['报价'] = filtered['报价'].apply(extract_number)
    filtered['成交价'] = filtered['成交价'].apply(extract_number)
    
    # 提取备注（优先从成交价括号中）
    filtered['备注'] = filtered['成交价'].astype(str).apply(extract_bracket_content)
    
    # 补充缺失的必要字段
    for col in CONFIG['required_columns']:
        if col not in filtered.columns:
            filtered[col] = 'null'
    
    # 过滤报价为0的无效记录
    result = filtered[CONFIG['required_columns']]
    result = result[result['报价'] > 0].reset_index(drop=True)
    
    if result.empty:
        print(f"文件 {file_name} 的工作表 {sheet_name} 处理后无有效记录")
        return None
    
    print(f"成功处理文件 {file_name} 的工作表 {sheet_name}，保留 {len(result)} 条记录")
    return result

def main():
    # 创建输出目录（若不存在）
    os.makedirs(CONFIG['output_dir'], exist_ok=True)
    
    # 获取所有Excel文件
    excel_files = [
        f for f in os.listdir(CONFIG['input_dir'])
        if f.lower().endswith(('.xlsx', '.xls'))
    ]
    
    if not excel_files:
        print("警告: 未找到任何Excel文件")
        return
    
    # 批量处理所有文件及工作表
    all_data = []
    for file_name in excel_files:
        file_path = os.path.join(CONFIG['input_dir'], file_name)
        
        # 提取文件日期
        file_date = extract_date_from_filename(file_name)
        if not file_date:
            continue
        
        # 读取文件所有工作表
        try:
            xls = pd.ExcelFile(file_path)
            sheet_names = xls.sheet_names
            print(f"读取文件 {file_name}，包含 {len(sheet_names)} 个工作表")
        except Exception as e:
            print(f"读取文件 {file_name} 失败: {e}")
            continue
        
        # 处理每个工作表
        for sheet_name in sheet_names:
            try:
                # 跳过首行，以第2行为表头
                sheet_data = pd.read_excel(xls, sheet_name=sheet_name, skiprows=1, header=0)
            except Exception as e:
                print(f"读取文件 {file_name} 的工作表 {sheet_name} 失败: {e}")
                continue
            
            # 处理工作表数据
            processed_sheet = process_worksheet(file_name, sheet_name, sheet_data, file_date)
            if processed_sheet is not None:
                all_data.append(processed_sheet)
    
    # 合并所有数据
    if not all_data:
        print("警告: 没有有效数据可汇总")
        return
    combined = pd.concat(all_data, ignore_index=True)
    
    # 转换日期为datetime类型（用于排序和均值计算）
    combined['日期_dt'] = pd.to_datetime(combined['日期'])
    
    # 计算过去7天均值及异常标记
    combined['报价_week'] = combined.apply(
        lambda row: calculate_week_mean(combined, row['日期'], '报价'), axis=1
    )
    combined['成交价_week'] = combined.apply(
        lambda row: calculate_week_mean(combined, row['日期'], '成交价'), axis=1
    )
    
    # 处理均值为null的情况
    combined['报价_week'] = combined['报价_week'].apply(lambda x: x if x is not None else 'null')
    combined['成交价_week'] = combined['成交价_week'].apply(lambda x: x if x is not None else 'null')
    
    # 异常标记
    combined['报价_异常'] = combined.apply(
        lambda row: judge_abnormal(row['报价'], float(row['报价_week']) if row['报价_week'] != 'null' else None),
        axis=1
    )
    combined['成交价_异常'] = combined.apply(
        lambda row: judge_abnormal(row['成交价'], float(row['成交价_week']) if row['成交价_week'] != 'null' else None),
        axis=1
    )
    
    # 数据排序（日期降序 -> 港口降序）
    combined.sort_values(
        by=['日期_dt', '港口'],
        ascending=[False, False],
        inplace=True
    )
    combined.drop(columns=['日期_dt'], inplace=True)  # 移除临时日期列
    combined.reset_index(drop=True, inplace=True)
    
    # 生成输出文件名（带时分秒时间戳）
    timestamp = datetime.now().strftime("%Y%m%d%H%M")
    output_filename = f"{CONFIG['output_prefix']}_{timestamp}.xlsx"
    output_path = os.path.join(CONFIG['output_dir'], output_filename)
    
    # 保存为Excel
    try:
        combined.to_excel(output_path, index=False, engine='openpyxl')
        print(f"\n数据已保存至: {output_path}")
    except Exception as e:
        print(f"保存文件失败: {e}")
        return
    
    # 控制台输出统计信息
    total = len(combined)
    quote_valid = combined[combined['报价'] > 0]['报价']
    deal_valid = combined[combined['成交价'] > 0]['成交价']
    quote_abnormal = sum(combined['报价_异常'] == '异常')
    deal_abnormal = sum(combined['成交价_异常'] == '异常')
    
    print(f"\n本次处理 {total} 条有效数据；")
    print(f"报价均值：{round(quote_valid.mean(), 2) if not quote_valid.empty else 0}，"
          f"报价最大值：{quote_valid.max() if not quote_valid.empty else 0}，"
          f"报价最小值：{quote_valid.min() if not quote_valid.empty else 0}；")
    print(f"成交价均值：{round(deal_valid.mean(), 2) if not deal_valid.empty else 0}，"
          f"成交价最大值：{deal_valid.max() if not deal_valid.empty else 0}，"
          f"成交价最小值：{deal_valid.min() if not deal_valid.empty else 0}；")
    print(f"异常数据：报价异常 {quote_abnormal} 条，成交价异常 {deal_abnormal} 条。")

if __name__ == "__main__":
    main()