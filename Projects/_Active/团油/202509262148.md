# 自动标签

#团油OCR解析 #配置化工程 #测试与验收 #方法论落地 #证据化与回放

# 一句话核心结论

把“团油APP截图→结构化字段”从方案到落地，已沉淀为**配置驱动、证据可回放、可审可测**的一整套PRD与测试范式，并用严格无Mock的执行工单固化。

# 三段式逻辑支撑

**1）关键逻辑链条（推演与决策）**

- 业务诉求→PRD骨架→字段口径：先以三页面/十字段起步，后按你提供的CSV列**替换为最终口径**（附录A），对齐 STD/Tall 与校验规则（“三价+促销”一致性）。
    
- 决策固化→拍板面板（S1–S11）：全部选择A（推荐值）定稿：`page_type`四枚举、Tall价口径、TTL、阈值、POI半自动等。
    
- 工程化落地：去硬编码→**YAML配置栈+manifest**、热更新 `/config/reload`、证据回放 `/replay`、SLA/QA指标。
    
- 测试体系：从“空口完成”转为**证据驱动**；先给“最小沙盒”自测，再升级为**抽象路径**与**真实通义模型**的测试工单。
    
- 真实调用收口：仅允许 **qwen-vl-plus / qwen-vl-plus-latest**；Key从环境读取；强制**从INPUT_DIR读真实图片**；引入**FAIL_**_与**WARN_**_错误码。
    

**2）方法论与框架（可迁移）**

- **配置优先**：环境变量→配置模板→请求参数“三层解析”，任何路径/阈值/词典不落代码。
    
- **证据化闭环**：每次解析写 `evidence/{image_id}/{raw.json,std.json,config.snapshot.yaml}`，回放可追溯“用的什么配置、为什么这么判”。
    
- **拍板面板化**：把不确定项做成可勾选决策面板，默认A方案可直接发版。
    
- **无Mock验收**：以**文件哈希、目录清单、request_id、落盘产物**为真值证据；不满足即FAIL，不以“帮忙造数据”代替。
    
- **路径抽象**：以 `DATA_ROOT/OUTPUT_ROOT + image_dir_template` 渲染；目录缺失→HTTP上传模式或显式FAIL（按场景约束）。
    

**3）数据与事实（关键数字与取舍）**

- 字段：以你的CSV列为**最终字段清单**（附录A），三价口径：Tall默认为 `price_per_liter=group_price`。
    
- 校验：`price_group ≤ price_station_list + 0.05`；“满200前10升”→`promo_save_200 ≈ 10*(station_price - group_price)`；冲突→`VALIDATION_FAIL`。
    
- 阈值与SLA：`parse_conf≥0.60` 入库；TTL：price 7d / promo 3d / 站名&品牌90d / 服务180d；SLA D+1 ≤ 11:00。
    
- OCR模型白名单：**qwen-vl-plus / qwen-vl-plus-latest**；Key变量：`DASHSCOPE_API_KEY`。
    
- 错误码：`WARN_INPUT_DIR_MISSING`、`FAIL_KEY_MISSING`、`FAIL_OCR_MODEL_NOT_ALLOWED`、`FAIL_NO_FILES`、`FAIL_EVIDENCE_INCOMPLETE`、`FAIL_MOCKED_IO`、`FAIL_NO_REQUEST_ID`。
    

---

# 迭代日志

**【来源】** 从“要做OCR解析PRD”到字段对齐、配置化架构、拍板面板、抽象路径、DashScope真实测试、无Mock工单。  
**【结论】** 已形成**可执行PRD+配置体系+严格测试工单**，保证“真读文件、真调API、真落证据”。  
**【改动点】**

- 附录A改为“以你CSV为准”；新增附录D并入A。
    
- 增加S面板，一键选择A完成定稿。
    
- 路径从具体目录改为**变量+模板**；增加降级/错误码。
    
- 两版测试Prompt：标准测试 → “No-Mock合规测试”。  
    **【待补充】**
    
- 省级 `national_price` 参考表；`brand_aliases/coupon_dict` 首版词典；`layout_templates` 样本覆盖与灰度策略。
    
- `/metrics` 指标与失败码上报；POI半自动绑定结果的人工回路UI。  
    **【下一步建议】**  
    1）生成最小可跑 `config/` 包并走“真实测试工单”；  
    2）补齐词典/模板与省级价参，跑盲测集（≥1k）；  
    3）打通 `/metrics` → 日报与SLA看板，形成运维闭环。
    

---

# 深度展开：隐含假设、风险与盲区

**隐含假设**

- DashScope在现有网络/配额下可稳定调用；图片清晰度足以达到 `Acc_field≥90%` 的目标。
    
- `page_type` 四枚举覆盖现有页面差异；CSV列在后续版本中语义稳定。
    

**潜在风险**

- **版式漂移**：APP UI更新导致锚点失效 → 需模板灰度与匹配打分告警。
    
- **别名膨胀**：品牌/券型长尾 → 词典PR流程与近邻建议。
    
- **合规风险**：Key泄露/明文落盘 → 严格ENV注入与脱敏审计。
    
- **验收偏差**：若仍允许Mock，将再次“看上去通过” → 坚持FAIL_*硬性断言。
    

**盲区与收口**

- 国家参考价口径（省份粒度）与时效性来源未完全固化。
    
- 回放UI与人工复核工具尚是接口层，需前端承接。
    
- `/parse_batch` 在超大目录时的并发与资源限流策略待补（RPS、队列）。
    

**体系化认知/流程（升级版）**  
1）**定义口径**（字段/阈值/TTL/SLA）→  
2）**配置驱动**（manifest+YAML）→  
3）**证据化解析**（RAW/STD/Tall+evidence）→  
4）**可回放与热更新**（/replay, /config/reload）→  
5）**严格测试**（No-Mock工单+错误码）→  
6）**运维量化**（/metrics→日报→SLA治理）。

---

# 思维导图结构（文本大纲）

核心结论  
├─ 逻辑链条  
│ ├─ CSV作为最终口径→STD/Tall映射  
│ ├─ S面板拍板A→参数定稿  
│ ├─ 配置化/热更新/回放→工程闭环  
│ └─ 真实调用+无Mock→证据化验收  
├─ 方法论/框架  
│ ├─ 配置优先（ENV→YAML→参数）  
│ ├─ 证据化（evidence四件套）  
│ ├─ 拍板面板化（A/B选）  
│ └─ 抽象路径与错误码治理  
├─ 数据与事实  
│ ├─ 三价+促销公式与阈值  
│ ├─ TTL/SLA/Kappa/Recall 目标  
│ └─ 模型白名单与Key注入  
├─ 风险与盲区  
│ ├─ 版式漂移/别名膨胀/合规  
│ └─ 参考价数据源/批处理限流  
└─ 下一步行动  
├─ 交付 config 包，跑真实工单  
├─ 补词典/模板与省价参考  
└─ /metrics 上线，出QA日报

——

这份总结可直接归档为“版本基线”。下一轮建议：以**No-Mock工单**跑一批真实图，回传`request_id+evidence清单`，我们据实打分并生成首版《QA日报》。