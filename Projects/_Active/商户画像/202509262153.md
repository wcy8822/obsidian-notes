好的，我来按照你给的 prompt 对这段长对话做一次沉淀式总结，兼容 Ob 格式，方便后续归档与调用。

---

# 商户画像｜多源决胜与逆向检查逻辑讨论复盘

## 自动标签

#商户画像 / #数据治理 / #方法论 / #标签决策 / #QA校验

## 一句话核心结论

对话核心是把“多源→决胜”和“逆向检查”逻辑收敛为**抽象路径+具体算法**，通过候选有效性加固、配置字典映射、QA 阻断与回滚机制，使现有清洗系统可以严谨无环地落地。

---

## 三段式逻辑支撑

### 关键逻辑链条

- **路径约束**：决胜/逆向检查必须在 TALL 层完成，HOT 层仅行转列，避免环形依赖。
    
- **决胜逻辑**：由 `score = W_source × F_fresh` 驱动；W_source 来自 tag_spec，F_fresh 基于时间衰减 (linear/exp) 与 TTL。
    
- **逆向检查**：定义“预期变更”（时间窗法/对比法），对比最终选值，产出 APPLIED/NOT_APPLIED，并标注原因。
    
- **加固机制**：候选值必须通过有效性校验 (非空、合法枚举、主键完整、时间合理)，否则不参加决胜。
    
- **QA 与回滚**：失败判定用固定枚举，阻断全流程；回滚以批次为单位，保留开关可退回旧逻辑。
    

### 方法论与框架

- **逻辑具体，路径抽象**：避免写死文件路径，用 // 占位，强调上下游依赖关系。
    
- **治理字典驱动**：权重、TTL、衰减、阈值、预期变更窗口、HOT 填充策略，全部通过 tag_spec / tag_catalog / sources.yaml 配置。
    
- **先有效，再决胜**：先做 admissibility 过滤，再算分选值，防止空值/脏值误入。
    
- **灰度可控**：新算法通过配置开关启用，支持快速退回优先级逻辑。
    

### 数据与事实

- 必配字段：`store_id, tag_code, value, source_id, observed_at`。
    
- 候选有效性黑名单：`["", "-", "N/A", "null", "未知"]` 等。
    
- QA 阈值：ENUM_INVALID ≤1%，STORE_MAP_FAIL ≤1%，TS_MISSING ≤2%。
    
- 时间窗法默认 7 天；品牌 TTL 90 天 (linear)，重叠站 TTL 14 天 (exp)。
    

---

## 迭代日志

- 【来源】：多轮确认 PRD 逻辑、AI 约束、候选有效性、QA 阻断与回滚策略。
    
- 【结论】：决胜与逆查必须在 TALL 完成，算法以权重×新鲜度为核心，增加候选有效性护栏。
    
- 【改动点】：去掉不必要的中间层命名 (fuse)，强化输入有效性规则，明确 QA 阻断口径。
    
- 【待补充】：预期变更判定方法最终定版（时间窗/对比/可切换）；HOT 层空值填充策略。
    
- 【下一步建议】：
    
    1. 在 tag_spec / tag_catalog 中补齐必配参数 (W_source, TTL, Δ_min)。
        
    2. 在 QA 流程里加 invalid_reason 字段统计。
        
    3. 先在测试 batch 灰度跑，确认未误伤，再推生产。
        

---

## 深度展开（假设/风险/盲区）

- **隐含假设**：S1 永远有值；S2–S3 至少有一源；否则不触发变更。
    
- **风险**：候选有效性过严 → UNKNOWN 率上升，可能导致 HOT 稀疏。
    
- **盲区**：逆向检查仅基于 TALL，如果上游 RAW2 本身被裁剪，可能遗漏潜在变更。
    
- **升级路径**：可逐步引入策略因子（如证据强度），在现有两维（源权重+新鲜度）上扩展。
    

---

## 思维导图结构

**核心结论**  
├─ 逻辑链条  
│ ├─ 决胜算法：score=W_source×F_fresh  
│ ├─ 逆向检查：预期 vs 实际 → 回执  
│ ├─ 输入有效性：先过滤，再算分  
│ └─ QA+回滚：枚举阻断，批次回滚  
├─ 方法论/框架  
│ ├─ 路径抽象，逻辑具体  
│ ├─ 配置驱动，字典化管理  
│ ├─ 灰度上线，可退旧逻辑  
│ └─ HOT 只展开，不再决策  
├─ 数据与事实  
│ ├─ 必配字段五个  
│ ├─ QA 阈值：1%/1%/2%  
│ └─ TTL: 品牌90d，重叠站14d  
├─ 风险与盲区  
│ ├─ UNKNOWN率可能升高  
│ ├─ RAW2 剪裁影响逆查  
│ └─ 策略因子尚未纳入  
└─ 下一步行动  
├─ 补齐配置字段  
├─ 增加 invalid_reason 字段  
├─ 测试 batch 灰度跑  
└─ 确认逆查判定方法

---

要不要我把这个版本再浓缩成一个「一页纸 briefing」版，方便你在周会上口头用？