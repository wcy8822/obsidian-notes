# å•†æˆ·ç”»åƒï½œä¸‰è¡¨ä½¿ç”¨è¯´æ˜ & å…±è¯†è®°å½• & æ¸…æ´—æ¡†æ¶æ¨¡æ¿ï¼ˆv1.1ï½œ2025-09-19ï¼‰

> æ ¹ç›®å½•ï¼š`/Users/didi/Downloads/panth/tag_ct_local` èŒƒå›´ï¼šåªè¯»ç™½åå•ä¸‰è¡¨ + è¯´æ˜æ–‡æ¡£ï¼ˆåˆ†ç›®å½•æ²»ç†ï¼‰ï¼›å…¨ç¨‹ä»…ç”¨ `tag_code` å…³è”ï¼›ä¸æ”¹ç°ç½‘åˆ—å/ç»“æ„ã€‚

---

## 0. èƒŒæ™¯ä¸ç›®æ ‡ï¼ˆäººç±»å¯è¯»ï¼‰

* **ç›®æ ‡**ï¼šåœ¨ 9/23 å‰ï¼Œæœ¬åœ°ç«¯åˆ°ç«¯è·‘é€š **P0 13 æ ‡ç­¾** çš„æ¸…æ´—ä¸èåˆï¼Œäº§å‡º **Tall çœŸç›¸å±‚ + Hot å®½å±‚**ï¼Œæ”¯æŒ **å›æ”¾/å›æ»š** ä¸ **evidence\_state** å‘ˆç°ã€‚
* **æ–¹æ³•**ï¼š

  * ä¸‰è¡¨ç™½åå•ï¼ˆæ²»ç†ä¸‰ä»¶å¥—ï¼‰ï¼š`tag_catalog.csv / tag_spec.csv / tag_enum.csv`ã€‚
  * **vCurrentâ†’vCore é€‚é…å±‚**ï¼ˆrename/cast/enum\_map/é»˜è®¤å€¼ç­–ç•¥ï¼‰ï¼Œä¸æ”¹ç°ç½‘åˆ—åã€‚
  * **åˆ†å‹**ï¼šç»“æœå‹ï¼ˆæºå³ç»“æœï¼‰ä¸è®¡ç®—å‹ï¼ˆéœ€æ¸…æ´—/å½’ä¸€ï¼‰ã€‚
* **åˆ†ç›®å½•æ²»ç†**ï¼š

  * å£å¾„/å¥‘çº¦ï¼ˆä½é¢‘ã€éœ€è¦å®¡è®¡ï¼‰â†’ `conf/contracts/`
  * å­—å…¸/å‚è€ƒï¼ˆé«˜é¢‘ã€æ•°æ®ä¾§ç»´æŠ¤ï¼‰â†’ `data/ref/`

---

## 1. ç›®å½•ç»“æ„ï¼ˆæ‹æ¿è·¯å¾„ï¼‰

```
tag_ct_local/
â”œâ”€ conf/
â”‚  â”œâ”€ contracts/                # å£å¾„/å¥‘çº¦ï¼ˆspecï¼‰
â”‚  â”‚  â””â”€ tag_spec.csv
â”‚  â”œâ”€ manifest.yaml             # å•ä¸€äº‹å®æ¥æºï¼šå¯ç”¨èŒƒå›´ã€é€‚é…å£å¾„ã€I/Oã€QAä¸å˜å¼
â”‚  â”œâ”€ mappings/                 # é€‚é…å±‚é…ç½®ï¼ˆæ— ä»£ç ï¼‰
â”‚  â”œâ”€ fusion/                   # å®½å±‚èšåˆ/æ‹¼æ¥è§„åˆ™
â”‚  â””â”€ invariants/               # å¯é€‰ï¼šå°†ä¸å˜å¼æ‹†æ–‡ä»¶
â”œâ”€ data/
â”‚  â”œâ”€ ref/                      # å‚è€ƒå­—å…¸ï¼ˆcatalog/enumï¼‰
â”‚  â”‚  â”œâ”€ tag_catalog.csv
â”‚  â”‚  â””â”€ tag_enum.csv
â”‚  â””â”€ raw/                      # ä¸šåŠ¡ç°ç½‘è¾“å…¥ï¼ˆç•™å‘ï¼‰
â”œâ”€ scripts/
â”‚  â””â”€ qa_check.py               # çŠ¶æ€æŸ¥è¯¢å›æ‰§è„šæœ¬ï¼ˆåªè¯»æ ¡éªŒï¼‰
â”œâ”€ out/
â”‚  â””â”€ csv/
â”‚     â”œâ”€ tall/                  # çœŸç›¸å±‚è¾“å‡ºï¼ˆå«ä¾§å†™ä½ï¼‰
â”‚     â””â”€ hot/                   # å®½å±‚è¾“å‡ºï¼ˆä¸šåŠ¡æ¶ˆè´¹ï¼‰
â”œâ”€ logs/
â”‚  â”œâ”€ qa/                       # QA æŠ¥å‘Šï¼ˆjsonï¼‰
â”‚  â””â”€ snapshots/                # D-1 åœ°æ ‡å¿«ç…§ï¼ˆåŸæ · CSVï¼‰
â””â”€ docs/
   â””â”€ 3è¡¨å¯ç”¨è¯´æ˜.md
```

---

## 2. ä¸‰è¡¨ä½¿ç”¨è¯´æ˜ï¼ˆè¯¦ç»†ï¼‰

> å†å²å£å¾„æ¥æºç¡®è®¤ï¼šæˆ‘å·²é˜…è¯»é¡¹ç›®é™„ä»¶ã€Š3 ä¸ªè¡¨æ ¼çš„è¯´æ˜æ–‡æ¡£.mdã€‹ï¼ˆåªè¯»ï¼‰ï¼Œå¹¶æ²¿ç”¨å…¶ä¸­æ—¢æœ‰è§„åˆ™ï¼Œä¸æ”¹å†å²å£å¾„ï¼›æœ¬è¯´æ˜ä»…åšç»“æ„åŒ–å‘ˆç°ä¸å£å¾„å¤–åŒ–ã€‚å…³é”®è¦ç‚¹å·²å¸çº³ï¼š1) **æ²»ç†ä¸‰ä»¶å¥—**ï¼š`tag_catalog â†’ tag_spec â†’ tag_enum`ï¼›2) **ä¸€å€¼ä¸€è¡Œ**ï¼ˆæšä¸¾/å¸ƒå°”çš„çœŸå€¼é›†åœ¨ enum å†…é€è¡Œç®¡ç†ï¼‰ï¼›3) **äº‹å®å±‚ä»…å­˜ codeï¼Œä¸è½ä¸­æ–‡å±•ç¤ºå**ï¼›4) `brand_aliases / exclusion_field / keywords / white_list / black_list / match_method / match_score_threshold` ç­‰å­—æ®µæŒ‰æ–‡æ¡£è¯­ä¹‰ä½¿ç”¨ï¼›5) `value_type` åˆæ³•é›†åˆï¼š`bool|enum|string|id`ï¼›6) `fallback` ä¸ºç»Ÿä¸€å…œåº•ï¼Œä¾›é€‚é…å±‚è½åœ°ä¾§å†™ã€‚

### 2.1 `tag_catalog.csv`ï¼ˆç›®å½•/åˆ†å±‚/è´£ä»»ï¼‰

* **å®šä½**ï¼šæ ‡ç­¾ç›®å½•ä¸æ²»ç†åˆ†å±‚ï¼Œå†³å®šâ€œè°è´Ÿè´£ã€å±äºå“ªç±»ã€æ˜¯å¦çº³å…¥æœ¬æœŸâ€ã€‚
* **ä¸»é”®**ï¼š`tag_code`ï¼ˆå…¨å±€ç¨³å®šè‹±æ–‡ç ï¼‰
* **æ ¸å¿ƒåˆ—ï¼ˆå¯¹é½å†å²å£å¾„ï¼Œç²¾ç¡®å®šä¹‰ï¼‰**ï¼š

  * `tag_code, tier1, tier2, tier3`ï¼šä¸šåŠ¡å±‚çº§åˆ†ç±»ï¼ˆæ£€ç´¢/å±•ç¤ºç”¨ï¼‰ã€‚
  * `tag_class`ï¼šA/B ç±»ï¼ˆå¯é€‰ï¼‰â€”â€” **A=è¯æ®èåˆç±»**ï¼ˆå¤šæºæ‹©ä¼˜ã€çŠ¶æ€æŠ˜ç®—ã€è¯æ®ç•™ç—•ï¼‰ï¼Œ**B=å¥‘çº¦/ç®—æ³•ç›´ç®—ç±»**ï¼ˆæŒ‰å¥‘çº¦æˆ–ç®—æ³•ç›´æ¥è®¡ç®—äº§å‡ºï¼‰ã€‚
  * `owner_biz / owner_data`ï¼š**ä¸šåŠ¡/æ•°æ® owner**ï¼ˆ**äººåæˆ–ç»„å**ï¼Œç”¨äºè´£ä»»ç•Œå®šä¸è¯„å®¡è·¯ç”±ï¼‰ã€‚
  * `status`ï¼š**ç”Ÿå‘½å‘¨æœŸçŠ¶æ€**ï¼ˆè¯¦è§ä¸‹æ–¹â€œçŠ¶æ€å­—å…¸â€ï¼‰ï¼›ä»…å½“ `released` æ–¹å¯å¯¹å¤–è®¡ç®—/å‘å¸ƒï¼›`deprecated` ä»…ç»´æŠ¤ä¸æ–°å¢ï¼›`retired` å®Œå…¨åœç”¨ã€‚
  * `is_p0`ï¼šæ˜¯å¦çº³å…¥ **P0 13 æ ‡ç­¾**ï¼ˆ0/1ï¼‰ã€‚

**çŠ¶æ€å­—å…¸ï¼ˆä¸¥æ ¼ç»§æ‰¿å†å²å£å¾„ï¼‰**

* `draft` = è‰ç¨¿
* `in_review` = è¯„å®¡ä¸­
* `released` = **å·²å‘å¸ƒå¯è®¡ç®—**
* `deprecated` = æ‹Ÿä¸‹çº¿ï¼ˆä»…ç»´æŠ¤ï¼Œä¸æ–°å¢ï¼‰
* `retired` = å·²ä¸‹çº¿ï¼ˆä¸å†äº§å‡ºï¼‰

### 2.2 `tag_spec.csv`ï¼ˆå£å¾„/å¥‘çº¦ï¼‰ `tag_spec.csv`ï¼ˆå£å¾„/å¥‘çº¦ï¼‰

* **å®šä½**ï¼šæ ‡ç­¾å®šä¹‰ã€å€¼ç±»å‹ã€é»˜è®¤å…œåº•ã€ç‰ˆæœ¬ä¸æ‰¹å‡†ä¿¡æ¯ï¼›**å‘å¸ƒéœ€å®¡è®¡**ã€‚
* **ä¸»é”®**ï¼š`tag_code + spec_version`
* **æ ¸å¿ƒåˆ—**ï¼š

  * `definition`ï¼šå£å¾„å®šä¹‰ï¼ˆäººç±»å¯è¯»ï¼‰ã€‚
  * `value_type`ï¼š`bool|enum|id|string`ã€‚
  * `fallback`ï¼šç»Ÿä¸€å…œåº•ï¼ˆå¦‚ `99`/`other`/`unknown`ï¼‰ã€‚
  * `effective_from / effective_to`ï¼šç”Ÿæ•ˆåŒºé—´ï¼ˆå…è®¸ç©ºä¸ºå¼€æ”¾æœŸï¼‰ã€‚
  * `approved_by / approved_at`ï¼šæ‰¹å‡†é“¾è·¯ï¼ˆå®¡è®¡ï¼‰ã€‚
  * \`\`ï¼š`result|compute`ï¼ˆå”¯ä¸€æ‰§è¡Œå£å¾„ï¼‰ã€‚
  * \`\`ï¼šå¯é€‰ï¼›å¯¹ `string/id` æ ¡éªŒï¼ˆç¤ºä¾‹ï¼š`open_hours` çš„ HHMM-HHMM å¤šæ®µæ­£åˆ™ï¼‰ã€‚
* **ä½¿ç”¨è¦ç‚¹**ï¼š

  * æ¸…æ´—æ—¶ **ä»…ä»¥ **\`\`** åˆ¤åˆ«æ‰§è¡Œè·¯å¾„**ï¼›
  * å…œåº•ä¸€å¾‹å– `fallback`ï¼ŒTall ä¾§å†™ `used_fallback=1`ï¼›
  * æ ¡éªŒä¸æ”¹å€¼ï¼šregex æœªé€šè¿‡ â†’ QA å‘Šè­¦ã€‚

### 2.3 `tag_enum.csv`ï¼ˆå€¼åŸŸ/åˆ«å/ç­–ç•¥ï¼‰

* **å®šä½**ï¼š`enum`/`bool` å€¼åŸŸçœŸå€¼é›†ä¸å±•ç¤ºåï¼›å“ç‰Œå½’ä¸€/ç™½é»‘åå•/åŒ¹é…é˜ˆå€¼ç­‰ç­–ç•¥å­—æ®µã€‚
* **ä¸»é”®**ï¼š`tag_code + enum_code + spec_version`
* **æ ¸å¿ƒåˆ—**ï¼š

  * `enum_code / enum_label / is_default / sort_order / is_active`
  * å“ç‰Œç›¸å…³ï¼š`brand_aliases / exclusion_field / brand_category / keywords`
  * ç­–ç•¥ï¼š`match_method / match_score_threshold / white_list / black_list`
  * \`\`ï¼šå½’ä¸€ç­–ç•¥åï¼ˆå…¨åŠè§’/å»ç©ºæ ¼/å¤§å°å†™ç»Ÿä¸€â€¦ï¼‰ï¼Œå¢å¼ºå¯å¤ç°æ€§ã€‚
* **ä½¿ç”¨è¦ç‚¹**ï¼š

  * `bool/enum` å‹ä»¥æ­¤è¡¨ä¸º**å”¯ä¸€çœŸå€¼åŸŸ**ï¼›åŸŸå¤–å€¼ä»…å‘Šè­¦ï¼›
  * å±•ç¤ºæ—¶é€šè¿‡è”è¡¨å– `enum_label`ï¼ŒTall ä¸é‡å¤å­˜å†—ä½™å±•ç¤ºåï¼›
  * `open_hours` ä¸º `string`ï¼Œ**ä¸åœ¨æšä¸¾è¡¨ä¸­**å±åˆç†ã€‚

---

## 3. P0 æ ‡ç­¾æ¸…å•ï¼ˆ13ï¼‰

`brand_level, brand_name, competitive_overlap, sme_supplier_partner, sme_supplier, wyc_pricing_enabled, service_carwash_available, service_carwash_type, convenience_store_available, restroom_available, parking_available, open_24h, open_hours`

* å€¼ç±»å‹åˆ†å¸ƒï¼š`bool=8, enum=3, id=1, string=1`ï¼ˆ`open_hours` ä¸º stringï¼‰ã€‚
* ä¸‰è¡¨ä¸»é”®å”¯ä¸€ã€å­é›†å…³ç³»ä¸â€œé»˜è®¤æšä¸¾å”¯ä¸€æ€§â€æ ¡éªŒå‡é€šè¿‡ã€‚

### ä¸»çº¿é€»è¾‘ï¼ˆå¯¹é½å¹¶å†™æ­»ï¼‰

* **å¤šæºè¾“å…¥ â†’ RAW â†’ STD â†’ Tall â†’ Hot**ï¼Œå…¨ç¨‹è¯æ®å¯è¿½æº¯ï¼š

  1. **RAW**ï¼šå„ä¸Šæ¸¸åŸå§‹æ•°æ®ä¸å‚è€ƒå­—å…¸è½åœ°ï¼ˆæœ¬åœ°ä¸‰è¡¨ + ä¸šåŠ¡ CSVï¼‰ã€‚
  2. **STDï¼ˆé€‚é…å±‚ï¼‰**ï¼š`vCurrentâ†’vCore` ä»…åš **rename/cast/enum\_map/fallback** å¯¹é½ï¼Œä¸æ”¹ä¸šåŠ¡å«ä¹‰ã€‚
  3. **Tallï¼ˆçœŸç›¸å±‚ï¼‰**ï¼šä¸»é”® \`\`ï¼›è¾“å‡º `value_code/value_text/spec_version/calc_type`ï¼Œå¹¶ä¾§å†™ `used_enum_code/used_fallback/value_source/snapshot_date`ã€‚
  4. **Hotï¼ˆå®½å±‚ï¼‰**ï¼šæŒ‰ P0 13 æ ‡ç­¾é€è§†ï¼›å±•ç¤ºåé€šè¿‡æšä¸¾è”è¡¨å®æ—¶å–ï¼Œä¸æŠŠå±•ç¤ºåå†™å…¥ Tallã€‚
  5. **QA/ç›‘æ§**ï¼šç»“æ„ä¸å˜å¼ï¼ˆä¸»é”®/å­é›†/é»˜è®¤å”¯ä¸€ï¼‰ã€è´¨é‡æŒ‡æ ‡ï¼ˆP0 è¦†ç›–/åŸŸå¤–å€¼/`fallback` ä½¿ç”¨ç‡ï¼‰ã€æ–°é²œåº¦ä¸ D-1 ç¨³å®šæ€§ï¼›å½¢æˆ JSON å›æ‰§æ²‰æ·€åˆ° `logs/qa/`ã€‚
  6. **å›æ”¾/å›æ»š**ï¼š`logs/snapshots/snap_YYYYMMDD/` åŸæ ·å¿«ç…§ä¸‰è¡¨ï¼Œmanifest åˆ‡æºæˆ–è¿è¡Œå‚æ•°è¦†ç›–åé‡æ”¾ã€‚
* **ç»´åº¦ç»Ÿä¸€**ï¼šä»…ä¿ç•™ \`\` ä½œä¸ºåœ°ç†ç©ºé—´ä¸»é”®ï¼›**çœ/å¸‚ç­‰åœ°ç†ç»´åº¦ç»Ÿä¸€ä¸‹çº¿**ï¼Œç”±çº¿ä¸‹ Join è§£å†³ã€‚

---

## 4. ä¸å˜å¼ï¼ˆInvariantsï¼‰ä¸ QA æŒ‡æ ‡

* **ç»“æ„ä¸å˜å¼**ï¼š

  1. `catalog.tag_code` å”¯ä¸€ï¼›
  2. `spec(tag_code) âŠ† catalog(tag_code)`ï¼›
  3. `enum(tag_code) âŠ† catalog(tag_code)`ï¼›
  4. `enum.is_default` **æ¯ tag è‡³å¤šä¸€ä¸ª**ã€‚
* **è´¨é‡æŒ‡æ ‡**ï¼š

  * P0 è¦†ç›–ç‡ï¼ˆcatalog å‘½ä¸­ç‡ / `is_p0=1` è¦†ç›–ï¼‰ï¼›
  * `value_type` åˆæ³•å æ¯”ï¼›
  * åŸŸå¤–å€¼è®¡æ•°ï¼ˆæŒ‰ tag\_code åˆ†å¸ƒï¼‰ï¼›
  * `fallback` ä½¿ç”¨ç‡ï¼ˆæŒ‰ tag\_code åˆ†å¸ƒï¼‰ã€‚
* **æ–°é²œåº¦/ç¨³å®šæ€§**ï¼ˆåç»­åŠ å…¥ï¼‰ï¼š

  * æ–°é²œåº¦ï¼šæ–‡ä»¶ mtime ä¸ manifest æ‰¹æ¬¡æ—¶é—´å·®ï¼›
  * ç¨³å®šæ€§ï¼šä¸ D-1 å¿«ç…§å¯¹æ¯”å˜æ›´å æ¯”ï¼ˆæ•´ä½“/æŒ‰ tagï¼‰ã€‚

---

## 5. é€‚é…å±‚ï¼ˆvCurrentâ†’vCoreï¼‰æ‰§è¡Œå£å¾„

* å…³è”é”®ï¼š**ä»…ç”¨ \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\***\`\`ã€‚
* ç±»å‹/æ¯”è¾ƒå£å¾„ï¼š`trim + å…¨åŠè§’ç»Ÿä¸€ + å°å†™æ¯”è¾ƒ`ï¼›æ—¶é—´è¯»ä¸º ISO8601ï¼›å¸ƒå°”è§£æçœŸå€¼é›†ï¼š`1/true/t/yes/y`ã€‚
* å€¼åŸŸï¼š`bool/enum` ä»¥ `tag_enum` ä¸ºå”¯ä¸€çœŸå€¼åŸŸï¼›åŸŸå¤–å€¼ â†’ QA å‘Šè­¦ã€‚
* **calc\_type**ï¼šä»¥ `spec.calc_type` ä¸ºå‡†ï¼š

  * `result`ï¼šå¤šæºæ‹©ä¼˜ + çŠ¶æ€æŠ˜ç®— + ä¸å˜å¼é¢„è­¦ï¼›
  * `compute`ï¼šæ¸…æ´—/å½’ä¸€ + èåˆï¼ˆä¸ƒä»¶å¥—åœ¨æ¸…æ´—é˜¶æ®µå®ç°ï¼‰ã€‚
* **é»˜è®¤å€¼ç­–ç•¥**ï¼šå…œåº•æ¥è‡ª `spec.fallback`ï¼ŒTall ä¾§å†™æ ‡è®°ï¼Œä¸æ”¹æº/å®½å±‚ã€‚
* **ä¾§å†™ä½ï¼ˆTall ä¸“ç”¨ï¼‰**ï¼š`used_enum_code, used_fallback, value_source`ã€‚

---

## 6. å›æ”¾/å›æ»šä¸å¿«ç…§

* **åœ°æ ‡å¿«ç…§**ï¼š`logs/snapshots/snap_YYYYMMDD/{tag_catalog.csv, tag_spec.csv, tag_enum.csv}` åŸæ ·æ‹·è´ã€‚
* **å›æ”¾æ–¹æ³•**ï¼š

  * æ–¹å¼ Aï¼šä¸´æ—¶ä¿®æ”¹ `manifest.yaml â†’ sources.*` æŒ‡å‘ `snap_YYYYMMDD`ï¼›
  * æ–¹å¼ Bï¼šè¿è¡Œå‚æ•°è¦†ç›–æºè·¯å¾„ã€‚

---

## 7. æ“ä½œæ‰‹å†Œï¼ˆå¦‚ä½•äº§å‡º QA å›æ‰§ï¼‰

1. ä¸€æ¬¡æ€§å‡†å¤‡ï¼š

```
cd /Users/didi/Downloads/panth/tag_ct_local
python3 -m venv .venv && source .venv/bin/activate
pip install -q pandas pyyaml python-dateutil
```

2. è¿è¡Œï¼š

```
python3 scripts/qa_check.py --root . --manifest conf/manifest.yaml
```

3. è¾“å‡ºï¼š`logs/qa/qa_YYYYMMDD_HHMM.json`ï¼ŒåŸæ ·ç²˜è´´åˆ°å¯¹è¯åšå›æ‰§ã€‚

---

## 8. å…±è¯†è®°å½•ï¼ˆå†æ¬¡å¯¹ç„¦è¦ç‚¹ï¼‰

* åªè¯»ç™½åå•ï¼ˆåˆ†ç›®å½•ï¼‰ï¼šcatalog/enumâ†’`data/ref/`ï¼›specâ†’`conf/contracts/`ï¼›è¯´æ˜â†’`docs/`ã€‚
* å…³è”é”®ï¼šå…¨ç¨‹ä»…ç”¨ `tag_code`ï¼›ä¸ä½¿ç”¨ `tag_id`ã€‚
* ä»¥ `spec.calc_type` ä¸ºå”¯ä¸€æ‰§è¡Œå£å¾„ï¼›`catalog.tag_class` ä»…å‚è€ƒã€‚
* ç»´åº¦ä¸»é”®ç»Ÿä¸€ï¼š**store\_id**ï¼ˆåŸæ–‡æ¡£å¯èƒ½å‡ºç° `store_id` çš„å†å²ç§°å‘¼ï¼Œç°ç»Ÿä¸€ä¸º `store_id`ï¼‰ã€‚åœ°ç†ç»´åº¦ï¼ˆçœ/å¸‚ç­‰ï¼‰ç»Ÿä¸€ä¸‹çº¿ï¼Œç”±çº¿ä¸‹ Join è¡¥å…¨ã€‚
* `open_hours` ä¸º stringï¼Œä¸åœ¨æšä¸¾ï¼›å…¶å®ƒ bool/enum ä»¥ `tag_enum` ä¸ºçœŸå€¼åŸŸã€‚
* å…œåº•é»˜è®¤æ¥è‡ª `spec.fallback`ï¼›Tall ä¾§å†™ `used_fallback`ã€‚
* ä¸å˜å¼ä¸ QA æŒ‡æ ‡å¦‚ä¸Šï¼›D-1 å›æ”¾é€šè¿‡ `snap_*` å¿«ç…§å®ç°ã€‚

> å˜æ›´æ—¥å¿—ï¼ˆå ä½ï¼‰ï¼š
>
> * 2025-09-19 v1.0ï¼šå»ºç«‹åˆ†ç›®å½•æ²»ç†ã€é€‚é…å±‚æ‰§è¡Œå£å¾„ã€QA ä¸å›æ”¾æµç¨‹ã€‚

---

# äºŒã€æ¸…æ´—æ¡†æ¶ç›®å½•ä¸æ¨¡æ¿ï¼ˆæ— ä»£ç ç‰ˆï¼‰

## A. ç›®å½•éª¨æ¶ï¼ˆæ–°å¢/è¡¥å……ï¼‰

```
conf/
â”œâ”€ mappings/
â”‚  â”œâ”€ fields.yaml        # å­—æ®µå±‚é€‚é…ï¼ˆrename/cast/enum_map/é»˜è®¤ç­–ç•¥ï¼‰
â”‚  â”œâ”€ defaults.yaml      # é»˜è®¤/fallback ä¸ä¾§å†™ä½å¼€å…³
â”‚  â””â”€ regex.yaml         # string/id çš„æ ¡éªŒæ­£åˆ™ï¼ˆäº¦å¯ç›´æ¥ç”¨ spec.validation_regexï¼‰
â”œâ”€ fusion/
â”‚  â””â”€ hot_wide.yaml      # å®½å±‚å­—æ®µé€‰æ‹©ã€ç»´åº¦æ‹¼æ¥ä¸æšä¸¾å±•ç¤ºåå…³è”
â””â”€ qa/
   â””â”€ metrics.yaml       # QA æŒ‡æ ‡ä¸é˜ˆå€¼ï¼ˆå‘Šè­¦çº§åˆ«ï¼‰
```

## B. `conf/mappings/fields.yaml`ï¼ˆæ¨¡æ¿ï¼‰

```yaml
version: 1.0
# é€‚é…å±‚å­—æ®µå£å¾„ï¼ˆæŒ‰ tag_code ç®¡ç†ï¼‰ï¼Œä»…å£°æ˜ï¼Œä¸å†™ä¸šåŠ¡é€»è¾‘
# åŠ¨ä½œï¼šrenameï¼ˆåˆ—é‡å‘½åï¼‰ã€castï¼ˆç±»å‹è¯»å–/æ¯”è¾ƒå£å¾„ï¼‰ã€enum_mapï¼ˆå€¼åŸŸï¼‰ã€fallbackï¼ˆæ˜¯å¦é‡‡ç”¨ spec.fallbackï¼‰

common:
  compare:
    trim: true
    to_half_width: true
    lower_for_compare: true
  sidecar:
    used_enum_code: true
    used_fallback: true
    value_source: true

# æŒ‰æ ‡ç­¾å£°æ˜
labels:
  brand_level:
    value_type: enum
    calc_type_from: spec.calc_type   # result/compute
    enum_map:
      source: data.ref.tag_enum      # æŒ‡å®šå€¼åŸŸæ¥æºï¼ˆé€»è¾‘ä¸Šï¼‰
      prefer: enum_code              # å– enum_code å­˜ Tall
    fallback:
      from_spec: true
  brand_name:
    value_type: enum
    calc_type_from: spec.calc_type
    enum_map:
      source: data.ref.tag_enum
      prefer: enum_code
      alias:
        use_brand_aliases: true      # åˆ©ç”¨ brand_aliases
        norm_rule_from: alias_norm_rule
        white_list: true
        black_list: true
    fallback:
      from_spec: true
  open_hours:
    value_type: string
    calc_type_from: spec.calc_type
    validation:
      regex_from_spec: true          # ä½¿ç”¨ spec.validation_regex
    fallback:
      from_spec: true
```

## C. `conf/mappings/defaults.yaml`ï¼ˆæ¨¡æ¿ï¼‰

```yaml
version: 1.0
fallback:
  enabled: true
  source: spec.fallback
  record_sidecar: true

value_source_priority:
  # ç»“æœå‹ï¼šå¤šæºæ‹©ä¼˜ä¼˜å…ˆçº§ï¼ˆåç»­è¡¥å¤šæºåœºæ™¯ï¼‰ï¼Œç¤ºæ„
  - enum
  - raw
  - fallback
```

## D. `conf/mappings/regex.yaml`ï¼ˆå¯é€‰ï¼Œè‹¥ä¸èµ° spec.validation\_regexï¼‰

```yaml
version: 1.0
regex:
  open_hours: "^([0-2]\\d{3}-[0-2]\\d{3})(,([0-2]\\d{3}-[0-2]\\d{3}))*$"
```

## E. `conf/fusion/hot_wide.yaml`ï¼ˆæ¨¡æ¿ï¼‰

```yaml
version: 1.0
# å®½è¡¨å¯¼å‡ºå­—æ®µï¼ˆç¤ºä¾‹ï¼ŒæŒ‰ä¸šåŠ¡æ¶ˆè´¹éœ€è¦è°ƒæ•´ï¼‰
columns:
  # ä¸»é”®ä¸ç»´åº¦
  - store_id
    - tag_code
  # ç»“æœå­—æ®µï¼ˆæŒ‰ value_type è¾“å‡ºï¼‰
  - value_code      # enum/bool çš„ enum_code æˆ– 0/1/99
  - value_label     # å±•ç¤ºåï¼ˆenum_labelï¼Œstring å–åŸå€¼ï¼‰
  - value_text      # å…¼å®¹ string/id è¾“å‡ºï¼ˆå¯é€‰ï¼‰
  # å…ƒä¿¡æ¯
  - snapshot_date
  - spec_version
  - calc_type

joins:
  - name: enum_label_join
    on:
      left: [tag_code, value_code]
      right: [tag_code, enum_code]
    source: data.ref.tag_enum
    select: [enum_label as value_label]
```

## F. Tall/Hot è¡¨å¤´ï¼ˆç©ºè¡¨æ¨¡æ¿ï¼‰

**Tallï¼ˆæœ€å°çœŸç›¸å±‚ï¼‰**

```
store_id, tag_code, value_code, 
value_text, spec_version, calc_type, 
used_enum_code, used_fallback, value_source, snapshot_date
```

* è§£é‡Šï¼š

  * `value_code`ï¼šenum/bool çš„ç¨³å®šç ï¼›string/id å¯ç•™ç©ºï¼Œç”¨ `value_text`ï¼›
  * `used_enum_code`ï¼šå†—ä½™è®°è´¦ï¼ˆä¾¿äºè¿½è¸ªå½’ä¸€ç»“æœï¼‰ï¼›
  * `snapshot_date`ï¼šå¯¹é½å¿«ç…§æ‰¹æ¬¡ï¼ˆYYYY-MM-DDï¼‰ã€‚

**Hotï¼ˆå®½å±‚ç¤ºä¾‹ï¼‰**

```
store_id,  brand_level, brand_name, competitive_overlap, sme_supplier_partner, sme_supplier,
wyc_pricing_enabled, service_carwash_available, service_carwash_type, convenience_store_available,
restroom_available, parking_available, open_24h, open_hours, snapshot_date
```

* è§£é‡Šï¼šå®½å±‚å­—æ®µæŒ‰æ¶ˆè´¹ç«¯éœ€è¦æŒ‘é€‰ï¼›å±•ç¤ºåé€šè¿‡ `conf/fusion/hot_wide.yaml` è”è¡¨æ˜ å°„ã€‚

## G. è¿è¡Œé¡ºåºï¼ˆæ— ä»£ç ç‰ˆï¼‰

1. **QA**ï¼š`scripts/qa_check.py` â†’ äº§å‡º `logs/qa/qa_*.json`ï¼ˆç»“æ„/å­é›†/é»˜è®¤å”¯ä¸€æ€§/P0 è¦†ç›–ï¼‰ã€‚
2. **é€‚é…**ï¼šæŒ‰ `conf/mappings/*.yaml` è¯»å–æº â†’ ç”Ÿæˆ Tallï¼ˆä¾§å†™ä½é½å…¨ï¼‰ï¼Œ**ä¸æ”¹æºå€¼**ã€‚
3. **èåˆ**ï¼šæŒ‰ `conf/fusion/hot_wide.yaml` å°† Tall é€è§†/æ‹¼æ¥ â†’ Hotã€‚
4. **å›æ”¾**ï¼šå¤åˆ¶ä¸‰è¡¨åˆ° `logs/snapshots/snap_YYYYMMDD/`ï¼Œåˆ‡ manifest æºè·¯å¾„æˆ–è¿è¡Œå‚æ•° â†’ é‡è·‘å¯¹æ¯”ç¨³å®šæ€§ã€‚

---

## ç»“è¯­

* æœ¬æ–‡æ¡£ä½œä¸ºâ€œäººç±»å¯è¯»â€çš„å…±è¯†ä¸è¯´æ˜ä¹¦ï¼Œéšç‰ˆæœ¬è¿­ä»£æ›´æ–°ï¼›
* ä»£ç ä¸æ•°æ®å˜æ›´ä»¥ `manifest.yaml` + `logs/snapshots/` ä¸ºå‡†ï¼›
* ä»»ä½•æ–°å¢æ ‡ç­¾/å­—æ®µï¼Œå…ˆæ›´æ–°æœ¬è¯´æ˜ä¸ `spec`ï¼Œå†è½æ˜ å°„æ¨¡æ¿ã€‚

---

## 6) Delta äº§å‡ºç­–ç•¥ï¼ˆFull + Delta åŒäº§å‡ºï½œ**æ–°å¢**ï¼‰

> ç›®çš„ï¼šåŒä¸€æ‰¹æ¬¡åŒæ—¶äº§**å…¨é‡**ä¸**å˜æ›´å¢é‡**ï¼Œæ–¹ä¾¿ä¸‹æ¸¸â€œè¦å…¨è²Œ/è¦å˜åŒ–â€ä¸¤ç±»æ¶ˆè´¹ï¼›ä¸æ”¹å˜ Tall/Hot æ—¢æœ‰å£å¾„ï¼Œä»…åœ¨è¾“å‡ºé˜¶æ®µå¢åŠ å¯¹æ¯”äº§ç‰©ã€‚

### 6.1 é…ç½®ï¼ˆå»ºè®®æ–°å¢åˆ° `conf/policies/merge_policy.yaml` æˆ–å•ç‹¬ `conf/policies/delta.yaml`ï¼‰

```yaml
delta:
  enabled: true
  baseline:
    prefer: prev_day_tall           # prev_day_tall | external_s1
    external_s1_source: s1          # å½“ prefer=external_s1 æ—¶ä½¿ç”¨çš„æ¥æºé”®
    fallback_to_prev_day_tall: true # S1 ä¸å…¨æ—¶å›é€€åˆ° D-1 Tall
    # é˜²å‘†ï¼šå¦‚ä½•â€œæ‰¾ä¸Šä¸€ç‰ˆâ€
    lookup:
      from_snapshots_dir: logs/snapshots
      pattern: "snap_%Y%m%d"          # ç”¨äºè§£æä¸æ’åº
    first_day_delta: suppress          # output_all | suppress
  rules:
    compare_value_mode: canonical     # canonical | rawï¼ˆstring/id é‡‡ç”¨è§„æ ¼åŒ–åå†æ¯”ï¼‰
    include_state_change: true        # å€¼æœªå˜ä½†æ¥æº/çŠ¶æ€å˜åŒ–æ—¶ä¹Ÿè®° delta
    change_types: [CREATED, UPDATED, EXPIRED, FALLBACK_ADDED, FALLBACK_REMOVED, STATE_CHANGED]
  outputs:
    long: out/csv/delta/tall_delta_{date}.csv
    wide: out/csv/delta/hot_delta_{date}.csv
```

**è¯´æ˜**ï¼š

* **åŸºçº¿ä¼˜å…ˆçº§**ï¼ˆè‡ªä¸Šè€Œä¸‹ï¼‰ï¼š`Tall(D-1)` â†’ å¤–éƒ¨ `S1` â†’ï¼ˆéƒ½æ— ï¼‰æŒ‰ `first_day_delta` å¤„ç†ï¼ˆé»˜è®¤æŠ‘åˆ¶é¦–æ—¥æ´ªå³°ï¼‰ã€‚
* å½“ `prefer=external_s1` æ—¶ï¼Œ`S1` ä»…å¯¹å…¶è¦†ç›–åˆ°çš„ `(store, tag)` ç”Ÿæ•ˆï¼›å…¶ä½™å›é€€åˆ° `Tall(D-1)`ï¼ˆè‹¥ `fallback_to_prev_day_tall=true`ï¼‰ã€‚

### 6.2 Delta è®°å½•å­—æ®µï¼ˆé•¿è¡¨ï¼‰

* ä¸»é”®ï¼š`store_id, tag_code, snapshot_date`
* å­—æ®µï¼š`change_type, prev_value_code, prev_value_text, prev_value_source, prev_used_fallback, prev_conf, prev_evidence_state, curr_value_code, curr_value_text, curr_value_source, curr_used_fallback, curr_conf, curr_evidence_state, reason_code, reason_text`

### 6.3 QA æ‰©å±•ï¼ˆå»ºè®®åŠ å…¥ `conf/qa/metrics.yaml`ï¼‰

```yaml
thresholds:
  delta_changed_rate:   { warn: 0.05, error: 0.15 }
  delta_fallback_incr:  { warn: 0.02, error: 0.05 }
  delta_source_switch:  { warn: 0.02, error: 0.05 }
```

---

## 6) Delta äº§å‡ºé…ç½®ï¼ˆ**æ–°å¢ï¼ŒåŒäº§å‡ºå¼€å…³**ï¼‰

> ä¸ Fullï¼ˆTall/Hotï¼‰åŒæ‰¹ç”Ÿæˆï¼Œç”¨äºâ€œä»…æ¶ˆè´¹å˜åŒ–â€ã€‚é»˜è®¤å¼€å¯ï¼ŒåŸºçº¿ä¼˜å…ˆå–ä¸Šä¸€ç‰ˆç¡®è®¤ç»“æœï¼Œå…¶æ¬¡å–å¤–éƒ¨ S1ï¼Œæœ€åæŒ‰é˜²å‘†è§„åˆ™å¤„ç†ã€‚

```yaml
delta:
  enabled: true
  baseline:
    prefer: prev_day_tall           # ä¼˜å…ˆä½¿ç”¨æ—¥å¿—å¿«ç…§ï¼šlogs/snapshots/snap_YYYYMMDD/tall.csv
    external_s1_source: s1          # å¯åˆ‡æ¢ä¸ºå¤–éƒ¨ S1ï¼ˆæ¥æºé”®ï¼‰
    fallback_to_prev_day_tall: true # S1 è¦†ç›–ä¸å…¨æ—¶ï¼Œå¯¹ç¼ºå£å›é€€åˆ° D-1 Tall
    lookup:
      from_snapshots_dir: logs/snapshots
      pattern: "snap_%Y%m%d"         # è§£æä¸æ’åºè§„åˆ™ï¼ˆæœ€è¿‘ä¸” <= as_of_date-1ï¼‰
    first_day_delta: suppress         # é¦–æ—¥æ— åŸºçº¿æ—¶ï¼šsuppressï¼ˆä¸è¾“å‡ºï¼‰| output_allï¼ˆå…¨é‡è®°ä¸º CREATEDï¼‰
  rules:
    compare_value_mode: canonical     # string/id ç”¨è§„æ ¼åŒ–åæ¯”è¾ƒï¼›bool/enum æ¯” enum_code
    include_state_change: true
    change_types: [CREATED, UPDATED, EXPIRED, FALLBACK_ADDED, FALLBACK_REMOVED, STATE_CHANGED]
  outputs:
    long: out/csv/delta/tall_delta_{date}.csv
    wide: out/csv/delta/hot_delta_{date}.csv
```

**è¿è¡Œå»ºè®®**ï¼š

* `make full` åå¢ä¸€ä¸ªç›®æ ‡ `make delta`ï¼›ä¹Ÿå¯åˆå¹¶ä¸º `make full_with_delta`ã€‚
* å¿«ç…§åœ¨ `make snapshot` æ‰§è¡Œï¼Œç¡®ä¿ `Tall(D)` èƒ½ä½œä¸º `D+1` çš„åŸºçº¿ã€‚


ç¡®è®¤ä¸‰ç‚¹å¹¶ç»™å‡ºè½åœ°ç»†èŠ‚ï¼š

## âœ… å†³ç­–&å£å¾„ï¼ˆå·²é”å®šï¼‰

* **åŒäº§å‡ºå¼€å¯**ï¼šåŒä¸€è·‘æ‰¹åŒæ—¶äº§ **Fullï¼ˆTall+Hotï¼‰** ä¸ **Deltaï¼ˆtall\_delta+hot\_deltaï¼‰**ã€‚
* **åŸºçº¿ä¼˜å…ˆçº§**ï¼ˆè‡ªä¸Šè€Œä¸‹ï¼‰ï¼š

  1. **ä¸Šä¸€ç‰ˆç¡®è®¤ç»“æœ**ï¼š`Tall(D-1)` å¿«ç…§ï¼›
  2. **å¤–éƒ¨ S1**ï¼ˆè‹¥é…ç½®ï¼‰ï¼›
  3. **é˜²å‘†**ï¼šæ— å¯ç”¨åŸºçº¿æ—¶æŒ‰ç­–ç•¥å¤„ç†ï¼ˆé»˜è®¤æŠ‘åˆ¶é¦–æ—¥æ´ªå³°ï¼‰ã€‚
* å…¶ä»–é€»è¾‘ä¸æˆ‘ä»¬æ—¢æœ‰å…±è¯†ä¿æŒä¸€è‡´ï¼ˆRAW1 åªé‡‡/è§„èŒƒã€RAW2 è¯­ä¹‰å®ˆé—¨ã€Tall æ‹©ä¼˜ã€Hot é€è§†ã€å¿«ç…§å›æ”¾ï¼‰ã€‚

## ğŸ§­ é˜²å‘†ä¸â€œä¸Šä¸€ç‰ˆâ€çš„ä¸¥æ ¼å®šä¹‰ï¼ˆæˆ‘å…ˆç»™å‡ºé»˜è®¤ï¼Œå¯æ”¹ï¼‰

* **å¦‚ä½•æ‰¾â€œä¸Šä¸€ç‰ˆâ€**ï¼šä» `logs/snapshots/` ä¸­é€‰å–**æœ€è¿‘ä¸” â‰¤ as\_of\_dateâˆ’1** çš„ç›®å½•ï¼ˆå‘½å `snap_YYYYMMDD`ï¼‰ï¼›è‹¥å¤šæ¡ï¼Œå–æ—¥æœŸæœ€å¤§çš„ä¸€æ¡ã€‚
* **æ‰¾ä¸åˆ°ä¸Šä¸€ç‰ˆ**ï¼š

  * è‹¥é…ç½®äº†å¤–éƒ¨ S1ï¼šç”¨ `source==s1` ä½œä¸ºåŸºçº¿ï¼›S1 æœªè¦†ç›–åˆ°çš„ `(store, tag)` ç»§ç»­**å›é€€åˆ° D-1 Tall**ï¼ˆè‹¥å¼€å¯ `fallback_to_prev_day_tall=true`ï¼‰ï¼Œå¦åˆ™æ ‡è®°ä¸ºæ— åŸºçº¿ã€‚
  * è‹¥æ²¡æœ‰å¤–éƒ¨ S1ï¼šæŒ‰ `first_day_delta` æ‰§è¡Œï¼š

    * `suppress`ï¼ˆ**é»˜è®¤**ï¼‰ï¼šä¸è¾“å‡ºé¦–æ—¥çš„æµ·é‡å˜åŒ–ï¼›
    * `output_all`ï¼šæŠŠå…¨é‡è§†ä¸º `CREATED`ï¼ˆä»…åœ¨ä½ æ˜ç¡®éœ€è¦â€œé¦–æ—¥å…¨é‡å˜æ›´æ¸…å•â€æ—¶å¼€å¯ï¼‰ã€‚
* **æ¯”è¾ƒå£å¾„**ï¼š`bool/enum` æ¯” `value_code`ï¼›`string/id` èµ°**è§„æ ¼åŒ–å**çš„ `value_text`ï¼ˆ`compare_value_mode=canonical`ï¼‰ã€‚
* **çŠ¶æ€å˜åŒ–ä¹Ÿå¯è®¡ Delta**ï¼šå³ä½¿å€¼æ²¡å˜ï¼Œåªè¦ `value_source/used_fallback/evidence_state/conf` å‘ç”Ÿå®è´¨å˜åŒ–ï¼ŒæŒ‰ `STATE_CHANGED` è®°å½•ï¼ˆå¯å…³ï¼‰ã€‚

## ğŸ—‚ æˆ‘å·²æŠŠå˜æ›´å†™å…¥ Canvasï¼ˆå¹¶æ ‡æ³¨â€œæ–°å¢â€ï¼‰

* åœ¨ **ã€Šä¸‰è¡¨ä½¿ç”¨è¯´æ˜ & æ¸…æ´—æ¡†æ¶æ¨¡æ¿ï¼ˆv1ï¼‰ã€‹** é‡Œæ–°å¢äº† **â€œDelta äº§å‡ºç­–ç•¥ï¼ˆFull+Delta åŒäº§å‡ºï¼‰â€** å°èŠ‚ï¼šå®šä¹‰äº†**åŒäº§å‡º**ã€**åŸºçº¿ä¼˜å…ˆçº§**ã€**å­—æ®µç»“æ„**ä¸**QA æ‰©å±•æŒ‡æ ‡**ã€‚
* åŒæ­¥è¡¥äº†**é…ç½®ç‰‡æ®µ**ï¼ˆ`delta.enabled / baseline / rules / outputs`ï¼‰ï¼Œæ–¹ä¾¿ä½ ç›´æ¥çº³å…¥ `merge_policy.yaml` æˆ–ç‹¬ç«‹ `delta.yaml`ã€‚
* è¿™äº›å†…å®¹å·²æŒ‰æˆ‘ä»¬å…±è¯†å£å¾„æ’°å†™ï¼Œå¯ä½œä¸ºâ€œé”å®šç‰ˆæœ¬â€ã€‚

## ğŸ”§ é…ç½®ç‰‡æ®µï¼ˆä½ æ— éœ€æ”¹ä»£ç å³å¯å¯ç”¨ï¼‰

åœ¨ç­–ç•¥é…ç½®é‡ŒåŠ å…¥ï¼ˆæˆ‘å·²åœ¨ Canvas ç»™å‡ºå®Œæ•´ç‰ˆï¼‰ï¼š

```yaml
delta:
  enabled: true
  baseline:
    prefer: prev_day_tall            # ä¼˜å…ˆç”¨ D-1 Tall å¿«ç…§
    external_s1_source: s1           # éœ€è¦æ—¶å¯åˆ‡åˆ°å¤–éƒ¨ S1
    fallback_to_prev_day_tall: true  # S1 ä¸å…¨æ—¶å¯¹ç¼ºå£å›é€€ D-1 Tall
    lookup:
      from_snapshots_dir: logs/snapshots
      pattern: "snap_%Y%m%d"         # å¯»å€ä¸æ’åº
    first_day_delta: suppress         # é¦–æ—¥é˜²å‘†ï¼šsuppress|output_all
  rules:
    compare_value_mode: canonical
    include_state_change: true
    change_types: [CREATED, UPDATED, EXPIRED, FALLBACK_ADDED, FALLBACK_REMOVED, STATE_CHANGED]
  outputs:
    long: out/csv/delta/tall_delta_{date}.csv
    wide: out/csv/delta/hot_delta_{date}.csv
```

## â–¶ï¸ æ¥ä¸‹æ¥æ€ä¹ˆè·‘ï¼ˆä¿æŒä½ å½“å‰å·¥ä½œæµï¼‰

* ä»æ—§ï¼š`make raw1 && make raw2 && make tall && make hot && make snapshot`
* æ–°å¢ï¼ˆç­‰æˆ‘æŠŠç›®æ ‡åæ¥ä¸Šï¼‰ï¼š`make delta` â†’ ç”Ÿæˆ `tall_delta_YYYYMMDD.csv` ä¸ `hot_delta_YYYYMMDD.csv`
* å›æ”¾æ—¶åªè¦åˆ‡æ¢åˆ°å¯¹åº” `snap_YYYYMMDD`ï¼Œ**Delta å¯¹æ¯”ç»“æœä¹Ÿå¯å¤ç°**ï¼ˆå› ä¸ºåŸºçº¿æ£€ç´¢è§„åˆ™å·²å›ºå®šï¼‰ã€‚

## ğŸ“Œ æ”¶å°¾å°ç»“

* ä½ çš„â€œ**æœ¬æ‰¹å…¨é‡** + **ç›¸å¯¹åŸºçº¿çš„å˜æ›´å¢é‡**â€è¯‰æ±‚å·²å®Œå…¨çº³å…¥ï¼šä¸æ”¹ä¸»çº¿ï¼Œåªåœ¨**è¾“å‡º**é˜¶æ®µå¯¹æ¯”å¹¶äº§å‡ºä¸¤å¥—è§†å›¾ã€‚
* **é»˜è®¤ç­–ç•¥**ç¨³å¥ä¸”å¯é…ç½®ï¼šæœ‰å¿«ç…§èµ°å¿«ç…§ï¼›æ— å¿«ç…§èµ° S1ï¼›ä¸¤è€…éƒ½æ²¡æœ‰å°±é˜²å‘†æŠ‘åˆ¶é¦–æ—¥æ´ªå³°ï¼ˆå¯åˆ‡ä¸ºå…¨é‡ CREATEDï¼‰ã€‚
* æˆ‘å·²æŠŠå…³é”®ä¿¡æ¯å†™è¿› Canvas å¹¶æ ‡æ³¨æ–°å¢ï¼Œä¾¿äºä½ å›¢é˜ŸååŒå®¡é˜…ä¸é”å®šã€‚
  åç»­æˆ‘ä¼šæŠŠ `make delta` ç›®æ ‡ä¸è§£æé€»è¾‘æŒ‰è¿™ä»½å£å¾„æ¥ä¸Šï¼›ä½ æ— éœ€æ”¹ä»£ç è·¯å¾„ï¼Œåªéœ€åˆå…¥ä¸Šé¢çš„é…ç½®æ®µå³å¯å¯ç”¨åŒäº§å‡ºã€‚


---
ç¨³ï¼æˆ‘æŠŠâ€œä½ æœ¬åœ°éœ€è¦æ›´æ–°å“ªäº›é…ç½®è¡¨ã€æ›´æ–°å“ªäº›æ–‡ä»¶ã€æ€ä¹ˆæ”¹ã€æ€ä¹ˆè‡ªæ£€â€ä¸€æ¬¡è®²æ¸…ï¼Œå¹¶ä¸ Canvasï¼ˆã€Šé…ç½®æ¸…å• v1ã€‹+ æˆ‘åˆšè¡¥çš„ Delta å°èŠ‚ï¼‰100% å¯¹é½ã€‚ç…§å•æ‰§è¡Œå°±ä¸å®¹æ˜“å‡ºé”™ã€‚

---

# ä¸€å¼ æ€»æ¸…å•ï¼ˆè¦æ›´æ–°/æ–°å¢çš„æ–‡ä»¶ï¼‰

**æ ¹ç›®å½•**ï¼š`/Users/didi/Downloads/panth/tag_ct_local`

1. `conf/manifest.yaml`ï¼ˆæ›´æ–°ï¼‰
2. `conf/policies/raw1_fill.yaml`ï¼ˆæ›´æ–°ï¼‰
3. `conf/mappings/sources.yaml`ï¼ˆæ›´æ–°ï¼‰
4. `conf/policies/ttl.yaml`ï¼ˆå·²å­˜åœ¨ï¼ŒæŒ‰éœ€è¦å¾®è°ƒï¼‰
5. `conf/policies/merge_policy.yaml`ï¼ˆæ›´æ–°ï¼šåŠ å…¥ delta é…ç½®æ®µï¼‰
6. `conf/qa/metrics.yaml`ï¼ˆæ›´æ–°ï¼šåŠ å…¥ delta æŒ‡æ ‡é˜ˆå€¼ï¼‰
7. ç›®å½•å‡†å¤‡ï¼ˆè‹¥æœªåˆ›å»ºï¼‰ï¼š

   * `logs/snapshots/`
   * `output/tall/`ã€`output/hot/`ã€`output/delta/`
   * `data/raw/inbox/`ï¼ˆä½ æŠ•å–‚æ‰¹æ¬¡çš„æ ¹ï¼‰

ä¸‹é¢é€é¡¹ç»™â€œæ”¾å“ªã€å†™ä»€ä¹ˆã€ä¸ºä»€ä¹ˆâ€ã€‚

---

## 1) `conf/manifest.yaml`ï¼ˆç»Ÿä¸€å…¥å£ï¼‰

ç¡®ä¿åŒ…å«è¿™äº›**é”®è·¯å¾„**ï¼ˆæ‹¼å†™ä¸¥æ ¼ä¸€è‡´ï¼‰ï¼š

```yaml
version: 1.0

policies:
  ttl:   conf/policies/ttl.yaml
  merge: conf/policies/merge_policy.yaml

qa:
  metrics: conf/qa/metrics.yaml

mappings:
  raw1_fill: conf/policies/raw1_fill.yaml
  sources:   conf/mappings/sources.yaml

fusion:
  hot_wide:  conf/fusion/hot_wide.yaml   # è‹¥ä½ å·²é…ç½®

snapshots:
  include_patterns:
    - conf/policies/*.yaml
    - conf/qa/*.yaml
    - conf/mappings/*.yaml
```

> ç”¨å¤„ï¼šè„šæœ¬ä»è¿™é‡Œå®šä½æ‰€æœ‰ç­–ç•¥ä¸æ˜ å°„ï¼›`snapshots.include_patterns` è®©å¿«ç…§æŠŠé…ç½®ä¸€å¹¶å›ºåŒ–ï¼ŒæœåŠ¡â€œå›æ”¾/å¯¹æ¯”â€ã€‚

**è‡ªæ£€**ï¼š

```bash
python scripts/validate_manifest_keys.py --root . --manifest conf/manifest.yaml
```

é¢„æœŸï¼š`ok=true, warnings=[]`ï¼ˆè‹¥æç¤º `mappings.raw1_fill / mappings.sources / fusion.hot_wide å»ºè®®è¡¥å……`ï¼Œå°±æŒ‰ä¸Šé¢è¡¥é½ï¼‰ã€‚

---

## 2) `conf/policies/raw1_fill.yaml`ï¼ˆRAW1â€œè¯­æ³•çº§â€æ¸…æ´—ï¼‰

æŠŠ**Store ID åŠ å›º**ä¸**æ—¥æœŸè§£æ**å†™è¿›å»ï¼ˆè¿™æ˜¯æˆ‘ä»¬åˆšå¯¹é½çš„æ–°å£å¾„ï¼‰ï¼š

```yaml
version: 1.1
mode: pragmatic

# æ—¥æœŸè§£æï¼ˆdate_ob -> observed_atï¼‰
date_parse:
  formats: ["%Y-%m-%d", "%Y/%m/%d", "%Y%m%d", "%Y-%d-%m", "%Y.%m.%d",
            "%Y-%m-%d %H:%M", "%Y-%m-%d %H:%M:%S"]
  allow_fuzzy: true
  assume_time: "00:00:00"
  fallback: "file_mtime"

# store_id è§„èŒƒåŒ–ä¸é˜²å‘†
store_id_guard:
  strip: true
  nfkc: true
  case: "keep"                 # keep | upper | lower
  unwrap_quotes: true          # å»æˆå¯¹åŒ…è£¹å¼•å· "..." æˆ– '...'
  drop_excel_prefix_quote: true # å»ä¸€ä¸ªå‰å¯¼ 'ï¼ˆExcel é˜²å‘†ï¼‰
  null_tokens: ["", "null", "none", "nan", "NaN", "N/A", "-"]
  id_regex: "^[A-Za-z0-9_-]{3,64}$"

# å¸ƒå°”æ–‡æœ¬è§£æï¼ˆåªå½±å“ raw_value_code çš„ 0/1ï¼‰
boolean_truth:
  true:  ["1","true","t","yes","y","æ˜¯","å¼€å¯","TRUE","YES"]
  false: ["0","false","f","no","n","å¦","å…³é—­","FALSE","NO"]

batch:
  id_format: "YYYYMMDD_HHMM"

origin:
  format: "json"
  max_len: 2048

observed_at:
  fallback: "file_mtime"
```

---

## 3) `conf/mappings/sources.yaml`ï¼ˆS2=å®½ã€S3=é•¿ï¼Œåˆ—æ˜ å°„ï¼‰

æŠŠ S2/S3 çš„**id åˆ—ã€æ—¶é—´åˆ—**å’Œ**æ ‡ç­¾åˆ—**å†™æ¸…æ¥šã€‚ç¤ºä¾‹ï¼ˆæ ¹æ®ä½ çœŸå®è¡¨å¤´æ›¿æ¢å³å¯ï¼‰ï¼š

```yaml
version: 1.1
extractors:

  s2:                              # åŒºåŸŸï¼ˆå®½è¡¨ï¼‰
    mode: wide
    id_cols: [store_id, station_id]
    default_observed_at_col: date_ob
    tags:
      competitive_overlap: { prefer_cols: [competitive_overlap, overlap_flag] }
      brand_name:          { prefer_cols: [brand_name, brand_text], code_cols: [] }
      brand_level:         { prefer_cols: [brand_level, level_code], code_cols: [level_code] }
      open_24h:            { prefer_cols: [open_24h, is_24h] }
      open_hours:          { prefer_cols: [open_hours, hours] }

  s3:                              # å•†æˆ·ï¼ˆé•¿è¡¨ï¼‰
    mode: long
    id_cols: [store_id, station_id]
    default_observed_at_col: date_ob
    long:
      tag_code_col:    tag_code
      value_text_col:  value_text
      value_code_col:  enum_code

normalize:
  trim: true
  to_half_width: true
  strip_html: true
```

> å£å¾„å›é¡¾ï¼šS2 å®½è¡¨**åˆ—å=tag\_code**ï¼›S3 é•¿è¡¨ç”¨ `tag_code/enum_code/value_text`ã€‚RAW1 å°†ä¸¤è€…ç»Ÿä¸€è½ä¸ºè¡Œå¼äº‹å®ï¼ˆä¸»é”® `store_id, tag_code, source, observed_at`ï¼‰ã€‚

---

## 4) `conf/policies/ttl.yaml`ï¼ˆTTL ç­–ç•¥ï¼‰

å¦‚ Canvas v1 æ‰€ç¤ºï¼Œå¯ä¿æŒï¼š

```yaml
version: 1.0
updated_at: 2025-09-19
ttl:
  default_days: 30
  by_tag:
    brand_name: 90
    open_24h: 7
  by_tag_source:
    brand_name:
      s1: 60
      s2: 30
```

> ä½ è‹¥å†³å®šç¼©çŸ­æŸäº›â€œç»“æœå‹â€TTLï¼ˆä¾‹å¦‚ `competitive_overlap: 7`ï¼‰ï¼Œç›´æ¥å†™åˆ° `by_tag` å†…å³å¯ã€‚

---

## 5) `conf/policies/merge_policy.yaml`ï¼ˆåˆå¹¶ç­–ç•¥ + **Delta æ–°å¢**ï¼‰

ä¿ç•™ä½ ç°æœ‰ç­–ç•¥æ®µï¼Œ**æ–°å¢** `delta:` å°èŠ‚ï¼ˆè¿™å°±æ˜¯â€œFull + Delta åŒäº§å‡ºâ€çš„é…ç½®å¼€å…³ä¸é˜²å‘†é€»è¾‘ï¼‰ï¼š

```yaml
version: 1.0
updated_at: 2025-09-19

strategy: balanced

presets:
  conservative: { weights: { C_source: 0.60, C_fresh: 0.25, C_rule: 0.05, C_match: 0.10 } }
  balanced:     { weights: { C_source: 0.40, C_fresh: 0.30, C_rule: 0.10, C_match: 0.20 } }
  aggressive:   { weights: { C_source: 0.25, C_fresh: 0.50, C_rule: 0.05, C_match: 0.20 } }

functions:
  conf_formula: geo
  freshness: { type: exp, params: { tau_days: 14 } }
  rule_completeness: { regex_pass: 1.0, fallback: 0.5, invalid: 0.0 }
  tie_break_order: [ conf_desc, observed_at_desc, C_source_desc, source_whitelist, source_lexi_asc ]

sources:
  weights:   { s1: 0.9, s2: 0.7, s3: 0.5 }
  whitelist: [ s1 ]
  blacklist: [ ]

overrides:
  by_tag:
    brand_name:
      weights: { C_source: 0.50, C_fresh: 0.30, C_rule: 0.10, C_match: 0.10 }
      freshness: { type: exp, params: { tau_days: 7 } }
  by_tag_source:
    brand_name:
      s2:
        weights: { C_source: 0.30, C_fresh: 0.50, C_rule: 0.10, C_match: 0.10 }

# === æ–°å¢ï¼šDelta åŒäº§å‡ºé…ç½®ï¼ˆä¸ Canvas ä¸€è‡´ï¼‰===
delta:
  enabled: true
  baseline:
    prefer: prev_day_tall            # ä¼˜å…ˆç”¨ D-1 Tall å¿«ç…§
    external_s1_source: s1           # å¯åˆ‡åˆ°å¤–éƒ¨ S1
    fallback_to_prev_day_tall: true  # S1 è¦†ç›–ä¸å…¨æ—¶ï¼Œç¼ºå£å›é€€ D-1 Tall
    lookup:
      from_snapshots_dir: logs/snapshots
      pattern: "snap_%Y%m%d"         # è§£æä¸æ’åºï¼›æŒ‘æœ€è¿‘ä¸” <= as_of_date-1
    first_day_delta: suppress         # é¦–æ—¥é˜²å‘†ï¼šsuppress | output_all
  rules:
    compare_value_mode: canonical     # string/id æ¯”è§„æ ¼åŒ–åæ–‡æœ¬ï¼›bool/enum æ¯” enum_code
    include_state_change: true        # å€¼ä¸å˜ä½†çŠ¶æ€/æ¥æºå˜åŒ–ä¹Ÿè®° delta
    change_types: [CREATED, UPDATED, EXPIRED, FALLBACK_ADDED, FALLBACK_REMOVED, STATE_CHANGED]
  outputs:
    long: output/delta/tall_delta_{date}.csv
    wide: output/delta/hot_delta_{date}.csv
```

---

## 6) `conf/qa/metrics.yaml`ï¼ˆåŠ å…¥ Delta æŒ‡æ ‡ï¼‰

åœ¨ä½ ç°æœ‰é˜ˆå€¼ä¸‹**è¿½åŠ **ä¸‰æ¡æŒ‡æ ‡ï¼ˆç”¨äºçœ‹æ³¢åŠ¨ä¸å›å½’è´¨é‡ï¼‰ï¼š

```yaml
version: 1.0
updated_at: 2025-09-19

thresholds:
  out_of_enum_rate: { warn: 0.01, error: 0.05 }
  fallback_rate:    { warn: 0.05, error: 0.10 }
  changed_rate:     { warn: 0.05, error: 0.10 }
  freshness_lag_h:  { warn: 24,   error: 72   }
  # æ–°å¢ï¼ˆDeltaï¼‰
  delta_changed_rate:  { warn: 0.05, error: 0.15 }
  delta_fallback_incr: { warn: 0.02, error: 0.05 }
  delta_source_switch: { warn: 0.02, error: 0.05 }

reverse_checks:
  open_24h:
    hours_cover_full_day: true
```

---

## 7) ç›®å½•å‡†å¤‡ï¼ˆä¸€æ¬¡æ€§åˆ›å»ºï¼‰

```bash
mkdir -p logs/snapshots
mkdir -p output/{tall,hot,delta}
mkdir -p data/raw/inbox
```

---

# è‡ªæ£€å‰§æœ¬ï¼ˆä¸€æ­¥ä¸€æ£€ï¼Œé¿å…èµ°å¼¯è·¯ï¼‰

1. **é”®è·¯å¾„ä¸æ–‡ä»¶å­˜åœ¨æ€§**

```bash
python scripts/validate_manifest_keys.py --root . --manifest conf/manifest.yaml
```

* é¢„æœŸï¼š`ok=true, warnings=[]`
* è‹¥æœ‰â€œå»ºè®®è¡¥å……/è·¯å¾„ä¸å­˜åœ¨â€ï¼ŒæŒ‰ä¸Šé¢ manifest é”®è·¯å¾„ä¿®æ­£ã€‚

2. **å¥‘çº¦å ä½**ï¼ˆå¦‚æœªç”Ÿæˆè¿‡å ä½ CSVï¼‰

```bash
python scripts/touch_contract_outputs.py
python scripts/validate_pipeline_contracts.py --root .
```

* é¢„æœŸï¼š`ok=true, warnings=[]`ï¼ˆå››å¼  CSV è¡¨å¤´å°±ç»ªï¼‰

3. **RAW1 æ±‡èšè‡ªæ£€**ï¼ˆæ”¾å°‘é‡æ ·ä¾‹åˆ° `data/raw/inbox/<æ‰¹æ¬¡>/s2|s3/*.csv`ï¼‰

```bash
python scripts/run_ingest_raw1.py --root . --manifest conf/manifest.yaml --batch_id 20250920_2100_demo
# æŸ¥çœ‹ runs/<æ‰¹æ¬¡>/raw1_report.json â†’ missing_id / missing_obs / by_source / by_tag
```

> å½“ä½ ä¸‹ä¸€æ­¥è·‘ `make raw2 && make tall && make hot && make snapshot` åï¼Œå°±å…·å¤‡äº† `Tall(D)` å¿«ç…§ï¼›æŒ‰ä¸Šé¢ `merge_policy.yaml` çš„ **delta** æ®µé…ç½®ï¼Œ`make delta` ä¾¿ä¼šä»¥ **D-1** ä¸ºåŸºçº¿äº§å‡ºä¸¤ä»½å¢é‡è§†å›¾ï¼ˆç­‰æˆ‘æŠŠç›®æ ‡æ¥ä¸Šå³å¯ï¼Œæ— éœ€ä½ å†æ”¹é…ç½®ï¼‰ã€‚

---

## å¸¸è§â€œæ˜“é”™ç‚¹â€å¯¹ç…§è¡¨

* **é”®åæ‹¼å†™**ï¼š`mappings.raw1_fill`ã€`mappings.sources`ã€`fusion.hot_wide` ä¸€å®šæ˜¯å¤æ•°/ä¸‹åˆ’çº¿å½¢å¼ï¼›
* **è·¯å¾„ä¸€è‡´æ€§**ï¼š`delta.outputs` çš„ç›®å½•ä¸ä½ å¸Œæœ›çš„å®é™…è¾“å‡ºè·¯å¾„ä¸€è‡´ï¼ˆæœ¬æ–‡ç»Ÿä¸€åˆ° `output/delta/â€¦`ï¼‰ï¼›
* **sources.yaml çš„ `source_key`**ï¼šå¿…é¡»ä¸ä½  inbox çš„å­ç›®å½•åä¸€è‡´ï¼ˆå¦‚ `s2`ã€`s3`ï¼‰ï¼Œå¦åˆ™ä¼šè¢«è·³è¿‡ï¼›
* **store\_id æ¸…æ´—å£å¾„**ï¼šå·²å†™å…¥ `raw1_fill.yaml`ï¼›ä¸è¦åœ¨æºä¾§å†åšâ€œè¡¥é›¶/æ”¹å¤§å°å†™â€ï¼Œé¿å…äºŒæ¬¡å¤„ç†ï¼›
* **S1 ä¸å­˜åœ¨**ï¼š`delta.baseline.prefer=prev_day_tall` + `first_day_delta=suppress` é»˜è®¤ä¼šæŠ‘åˆ¶é¦–æ—¥æ´ªå³°ï¼›éœ€è¦â€œé¦–æ—¥å…¨é‡å˜æ›´æ¸…å•â€æ‰æ”¹ä¸º `output_all`ã€‚

---

# æœ€åä¸€å¥è¯è·¯çº¿å›¾

* ä½ **åªéœ€**ï¼šæŒ‰ä¸Šé¢æŠŠ 6 ä¸ªé…ç½®æ–‡ä»¶æ”¹å¥½ã€å»ºä¸€ä¸‹ 3 ä¸ªç›®å½•ï¼›
* è·‘ RAW1â†’RAW2â†’Tallâ†’Hotâ†’Snapshotï¼›
* æˆ‘è¿™è¾¹æŠŠ `make delta` æ¥ä¸Šåï¼ŒåŒæ‰¹å°±èƒ½å‡º **Full + Delta** åŒäº§ç‰©ï¼Œä¸”å®Œå…¨ç¬¦åˆæˆ‘ä»¬é”å®šçš„åŸºçº¿ä¼˜å…ˆçº§ä¸é˜²å‘†é€»è¾‘ã€‚

å¦‚æœä½ æ„¿æ„ï¼ŒæŠŠä½ å½“å‰çš„ `conf/manifest.yaml` å’Œä¸‰ä»½ç­–ç•¥æ–‡ä»¶ï¼ˆraw1\_fill / merge\_policy / metricsï¼‰çš„æ­£æ–‡è´´æˆ‘ï¼Œæˆ‘å¸®ä½ å¿«é€Ÿç›®æ£€ä¸€éé”®åä¸è·¯å¾„ï¼Œå†è·‘ä¸€è½® `validate_manifest_keys.py`ï¼Œç¡®è®¤â€œé›¶å‘Šè­¦â€åæˆ‘ä»¬å°±è¿›ä¸‹ä¸€æ‹ï¼ˆè·‘ä¸€æ¬¡çœŸå®å°æ‰¹æ¬¡ã€çœ‹ Delta æŠ¥å‘Šçš„ä¸‰ä¸ªå…³é”®æŒ‡æ ‡ï¼‰ã€‚


æ”¶åˆ°ä½ ä¼ çš„ 5 ä»½ YAMLï¼Œæˆ‘å·²ç»åœ¨æœ¬åœ°**è¯»å–å¹¶åšäº†ç»“æ„æ ¸éªŒ**ã€‚ç»“è®ºå…ˆè¯´åœ¨å‰ï¼š

## ç»“è®ºï¼ˆé…ç½®ä½“æ£€ç»“æœï¼‰

* `conf/manifest.yaml`ï¼šâœ… å…³é”®é”®è·¯å¾„é½å…¨ï¼ˆ`policies.ttl / policies.merge / qa.metrics / mappings.raw1_fill / mappings.sources` å­˜åœ¨ï¼›`fusion.hot_wide` å·²é…ç½®ï¼‰ã€‚
* `conf/policies/merge_policy.yaml`ï¼šâœ… åˆå¹¶ç­–ç•¥å®Œæ•´ï¼›**å·²åŒ…å« `delta:` åŒäº§å‡ºæ®µ**ï¼ˆå« `baseline.prefer=prev_day_tall`ã€è¾“å‡ºè·¯å¾„ long/wide ç­‰ï¼‰ã€‚
* `conf/qa/metrics.yaml`ï¼šâœ… å¸¸è§„é˜ˆå€¼é½ï¼›**å·²åŒ…å«ä¸‰é¡¹ delta æŒ‡æ ‡**ï¼ˆ`delta_changed_rate / delta_fallback_incr / delta_source_switch`ï¼‰ã€‚
* `conf/policies/raw1_fill.yaml`ï¼šâœ… `store_id_guard` ä¸ `date_parse` å·²æŒ‰æˆ‘ä»¬å£å¾„åŠ å›ºï¼›`boolean_truth` å®Œæ•´ã€‚
* `conf/policies/ttl.yaml`ï¼šâœ… ç»“æ„ä¸ä¼˜å…ˆçº§ OKï¼ˆ`default_days / by_tag / by_tag_source`ï¼‰ã€‚

> ç»¼ä¸Šï¼š**é›¶é˜»å¡ã€é›¶è­¦å‘Š**ã€‚é…ç½®ä¸ Canvas æœ€æ–°å£å¾„ä¸€è‡´ï¼Œå¯ç›´æ¥ç”¨äºè·‘æ‰¹ã€‚

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨æ–¹æ¡ˆï¼ˆæŒ‰ä½ ç°æœ‰å·¥ä½œæµï¼Œä¸€å£æ°”ç»™åˆ°ä½ï¼‰

### A. ç›®å½•ä¸æ‰¹æ¬¡ï¼ˆä¸€æ¬¡ç¡®è®¤ï¼‰

```bash
mkdir -p data/raw/inbox output/{tall,hot,delta} logs/snapshots
```

* æŠ•å–‚è·¯å¾„ï¼š`data/raw/inbox/<æ‰¹æ¬¡å·>/<source_key>/*.csv`
* æ‰¹æ¬¡å‘½åï¼š`YYYYMMDD_HHMM_ä»»åŠ¡å`ï¼ˆå”¯ä¸€æ€§ï¼Œä¾¿äºå›æ”¾ï¼‰ã€‚

### B. è·‘ä¸€ä¸ªæœ€å°â€œå®æˆ˜å°æ‰¹æ¬¡â€

1. **æŠ•å–‚ CSV**ï¼ˆS2=å®½è¡¨ï¼ŒS3=é•¿è¡¨ï¼Œåˆ—åå·²ç»Ÿä¸€ `store_id / date_ob / tag_codeâ€¦`ï¼‰
2. **RAW1**ï¼š

```bash
python scripts/run_ingest_raw1.py --root . --manifest conf/manifest.yaml \
  --batch_id 20250920_2230_smoke
# äº§å‡ºï¼šruns/<æ‰¹æ¬¡>/{raw1.csv,raw1_report.json} ä¸ data/raw/sample/sample_raw1.csv
```

3. **RAW2 â†’ Tall â†’ Hot**ï¼ˆä½ çš„å·²æœ‰å‘½ä»¤ä¸å˜ï¼‰ï¼š

```bash
make raw2
make tall
make hot
```

4. **å¿«ç…§**ï¼ˆåš D å½“å¤©åŸºçº¿ï¼Œä¾› Delta ä½¿ç”¨ï¼‰ï¼š

```bash
make snapshot
```

5. **Delta åŒäº§å‡º**ï¼ˆç›¸å¯¹â€œä¸Šä¸€ç‰ˆç¡®è®¤ç»“æœâ€ï¼‰ï¼š

```bash
make delta
# äº§å‡ºï¼šoutput/delta/{tall_delta_YYYYMMDD.csv, hot_delta_YYYYMMDD.csv}
```

### C. è‡ªæ£€è¦ç‚¹ï¼ˆè‚‰çœ¼ + æœºå™¨ï¼‰

* `runs/<æ‰¹æ¬¡>/raw1_report.json`

  * `missing_id` / `missing_obs` = 0ï¼ˆæˆ–å¯æ¥å—ï¼‰
  * `by_source / by_tag` åˆ†å¸ƒç¬¦åˆé¢„æœŸ
* `data/raw/sample/sample_raw2.csv`

  * `competitive_overlap` ä»…å‡ºç° `0/1`ï¼ˆåŸŸå¤–åº”è¢«æ ‡æ³¨ `OUT_OF_ENUM`ï¼Œä¸ä¼šè¢«å·å·æ”¹ 99ï¼‰
  * `open_hours` è¿‡æ­£åˆ™ï¼›å¤±è´¥è¡Œ `REGEX_FAIL`
* `output/tall/tall_*.csv`

  * æ¯ä¸ª `store_id Ã— tag_code` æ° 1 è¡Œï¼›`value_source / used_fallback / conf / evidence_state` ä¾§å†™åˆç†
* `output/delta/tall_delta_*.csv`

  * `change_type` åªå‡ºç°æˆ‘ä»¬å®šä¹‰çš„ 6 ç±»ï¼›é¦–æ—¥è‹¥æ— åŸºçº¿æŒ‰ä½ çš„é…ç½®æ˜¯ **suppress**ï¼Œä¸ä¼šçˆ†â€œå…¨é‡ CREATEDâ€
* `QA æŠ¥å‘Š`ï¼ˆå¦‚æœä½ å·²æ¥ä¸Š `make qa`ï¼‰

  * å››å¤§å¸¸è§„é˜ˆå€¼ + ä¸‰ä¸ª delta é˜ˆå€¼éƒ½åœ¨ç»¿/é»„èŒƒå›´å†…ï¼›å¼‚å¸¸ç›´æ¥çœ‹ delta æ–‡ä»¶å®šä½é—¨åº—ä¸æ ‡ç­¾ã€‚

---

## å…³äºâ€œåŸºçº¿ä¼˜å…ˆçº§ + é˜²å‘†â€å†ç¡®è®¤ä¸€éï¼ˆä½ å…³å¿ƒçš„ç»†èŠ‚ï¼‰

* **ä¼˜å…ˆçº§**ï¼š`Tall(D-1)` ï¼ å¤–éƒ¨ `S1` ï¼ é˜²å‘†ï¼ˆ`first_day_delta=suppress`ï¼‰
* **D-1 çš„å¯»å€**ï¼šä» `logs/snapshots/` ä¸­æŒ‘ **æœ€è¿‘ä¸” â‰¤ as\_of\_dateâˆ’1** çš„ `snap_YYYYMMDD/`ï¼›å¤šæ¡å–æ—¥æœŸæœ€å¤§é‚£ä¸€ä¸ªã€‚
* **S1 ä¸å…¨**ï¼šå¼€å¯çš„ `fallback_to_prev_day_tall: true` ä¼šå¯¹ S1 è¦†ç›–ä¸åˆ°çš„ `(store, tag)` å›é€€åˆ° `D-1 Tall`ï¼›å¦åˆ™æ ‡è®°ç¼ºä¹åŸºçº¿ï¼ˆä¸å‡º delta æˆ–æŒ‰ç­–ç•¥è§†ä½œ CREATEDï¼‰ã€‚
* **å­—ç¬¦ä¸²å¯¹æ¯”**ï¼š`compare_value_mode=canonical` â†’ string/id ä¼šæŒ‰**è§„æ ¼åŒ–æ–‡æœ¬**æ¯”å¯¹ï¼›bool/enum æ¯” `value_code`ã€‚
* **çŠ¶æ€å˜æ›´**ï¼š`include_state_change=true` â†’ å€¼ç›¸åŒä½† `value_source / used_fallback / evidence_state / conf` å˜åŒ–ä¼šè®° `STATE_CHANGED`ã€‚

---

## å°ä¼˜åŒ–å»ºè®®ï¼ˆéå¿…é¡»ï¼Œä½†ä¼šæ›´ç¨³ï¼‰

* **TTL**ï¼šç»™ç»“æœå‹å¦‚ `competitive_overlap` é™åˆ° `7` å¤©ï¼ˆé¿å…é•¿æŒ‚è€ç»“è®ºï¼‰ã€‚
* **æºæƒé‡**ï¼šè‹¥åŒºåŸŸ S2 æ›´å¯ä¿¡å¯åœ¨ `sources.weights` æˆ– `overrides.by_tag_source` ä¸­è°ƒé«˜ã€‚
* **é¦–æ—¥ç­–ç•¥**ï¼šè‹¥ä½ éœ€è¦â€œé¦–æ—¥å…¨é‡å˜æ›´æ¸…å•â€ï¼ŒæŠŠ `first_day_delta` ä¸´æ—¶æ”¹ä¸º `output_all`ï¼Œç”Ÿæˆä¸€æ¬¡åå†æ”¹å› `suppress`ã€‚

---

## æ¥ä¸‹æ¥æˆ‘è¿™è¾¹ä¼šåšçš„

* æŠŠ `make delta` çš„ç›®æ ‡ä¸è„šæœ¬æŒ‰ä½ ç°æœ‰é…ç½®æ¥ä¸Šï¼ˆä¸æ”¹ä½ å·²æœ‰åˆ—å/æ–‡ä»¶ç»“æ„ï¼‰ã€‚
* åœ¨â€œæ¸…æ´—æ¡†æ¶â€ Canvas çš„**è¾“å‡ºå±‚**é‡Œï¼ŒæŠŠ **Full + Delta åŒäº§å‡º** çš„å­—æ®µå®šä¹‰ä¸æ ·ä¾‹è¡Œè¡¥å……ä¸€ä¸ªâ€œå¯å¯¹ç…§æˆªå›¾â€ï¼Œä¾¿äºå›¢é˜ŸååŒå¯¹é½ã€‚

ä½ è¿™è¾¹ç°åœ¨å°±å¯ä»¥è·‘ä¸€ä¸ªå°æ‰¹æ¬¡çœ‹çœ‹ `raw1_report.json / tall / hot / delta` çš„å®é™…äº§ç‰©ï¼›å¦‚æœæ„¿æ„ï¼Œè´´å‡ºå››ä¸ªæ–‡ä»¶çš„**è¡¨å¤´ + 3 è¡Œæ ·ä¾‹**ï¼Œæˆ‘èƒ½å¿«é€Ÿç»™å‡ºä¸€æ¬¡â€œè¯»ç‰‡â€ç‚¹è¯„ï¼Œé©¬ä¸Šæ ¡å‡†ä¸‹ä¸€è½®é˜ˆå€¼ä¸æƒé‡ã€‚


---
ç»å¯¹èƒ½ä¸Šï¼æˆ‘æŠŠä½ è¦çš„ä¸‰ä»¶äº‹ä¸€æ¬¡æ€§ç»™åˆ°ä½ï¼š

1. **æ¥ä¸Š `make delta`ï¼ˆå¯ç›´æ¥ç²˜è´´ï¼‰**
2. **è½åœ°è„šæœ¬ `scripts/delta_build.py`ï¼ˆå¯ç›´æ¥è·‘ï¼‰**
3. **â€œç®­â‘ /ç®­â‘¡â€å…¨é‡æ¸…æ´—çš„é£é™©ç‚¹ä¸æ“ä½œç»†èŠ‚**ï¼ˆä¸€é¡µå£å¾„è¡¨ï¼Œè·‘ä¹‹å‰çœ‹ä¸€çœ¼å°±ä¸å®¹æ˜“è¸©å‘ï¼‰

---

# ä¸€ã€Makefile å¢é‡ï¼ˆæ¥ä¸Š `delta`ï¼Œå…¼å®¹ä½ ç°æœ‰æµç¨‹ï¼‰

æŠŠä¸‹é¢è¿™æ®µè¿½åŠ åˆ°ä½ çš„ `Makefile`ï¼ˆæ³¨æ„ï¼šç¼©è¿›å¿…é¡»æ˜¯çœŸ Tabï¼‰ï¼š

```make
# === paths ===
DATE ?= $(shell date +%Y%m%d)
MANIFEST ?= conf/manifest.yaml

# === delta: åŸºäºå¿«ç…§æˆ–å¤–éƒ¨ S1 çš„åŒäº§å‡º ===
delta:
	python scripts/delta_build.py --root . --manifest $(MANIFEST) --date $(DATE)

# å¯é€‰ï¼šä¸€æŠŠæ¢­ï¼ˆFull + Snapshot + Deltaï¼‰
full_with_delta: tall hot snapshot delta

.PHONY: delta full_with_delta
```

> è¯´æ˜ï¼š`DATE` é»˜è®¤å½“å¤©ï¼›ä½ ä¹Ÿå¯ `make delta DATE=20250920` æŒ‡å®šæŸå¤©çš„å¯¹æ¯”ã€‚

---

# äºŒã€è½åœ°è„šæœ¬ï¼š`scripts/delta_build.py`ï¼ˆç›´æ¥å¯ç”¨ï¼‰

è¿™ä¸ªè„šæœ¬è¯»å– `merge_policy.yaml` é‡Œçš„ `delta.*` é…ç½®ï¼Œè‡ªåŠ¨é€‰æ‹©åŸºçº¿ï¼ˆä¼˜å…ˆ **D-1 å¿«ç…§**ï¼Œå¦åˆ™çœ‹é…ç½®æ˜¯å¦å…è®¸ `external_s1`ï¼›éƒ½æ²¡æœ‰æ—¶æŒ‰ `first_day_delta` é˜²å‘†ï¼‰ï¼Œå¯¹æ¯” **Tall** ä¸ **Hot**ï¼Œåˆ†åˆ«äº§å‡ºï¼š

* `output/delta/tall_delta_YYYYMMDD.csv`
* `output/delta/hot_delta_YYYYMMDD.csv`

å°†ä¸‹åˆ—ä»£ç ä¿å­˜ä¸º `scripts/delta_build.py`ï¼š

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Delta åŒäº§å‡ºï¼šç›¸å¯¹åŸºçº¿ï¼ˆä¼˜å…ˆ D-1 Tall å¿«ç…§ï¼‰è®¡ç®— tall_delta / hot_delta
- è¯»å– conf/merge_policy.yaml çš„ delta.* é…ç½®
- åŸºçº¿ä¼˜å…ˆçº§ï¼šprev_day_tall > external_s1ï¼ˆæœªå®ç°S1é‡ç®—ï¼Œè‹¥æ— å¿«ç…§åˆ™æŒ‰ first_day_delta å¤„ç†ï¼‰
- Tall: æŒ‰ (store_id, tag_code) å¯¹æ¯”ï¼›Hot: è¡Œå®½å¯¹æ¯”ï¼ˆä»»ä¸€åˆ—ä¸åŒå³è®°å˜æ›´ï¼‰
"""
import argparse, csv, json, re, sys
from pathlib import Path
from datetime import datetime, date
import yaml

def load_yaml(p: Path):
    with p.open("r", encoding="utf-8") as f:
        return yaml.safe_load(f) or {}

def parse_date(s: str) -> date:
    return datetime.strptime(s, "%Y%m%d").date()

def latest_file_by_date(dirp: Path, prefix: str, until: date=None):
    """åœ¨ç›®å½•ä¸‹å¯»æ‰¾ prefix_YYYYMMDD.csvï¼Œè¿”å›æ—¥æœŸ<=untilçš„æœ€å¤§é‚£ä¸€ä¸ªï¼›until=Noneåˆ™å–æœ€å¤§"""
    best = None
    for p in dirp.glob(f"{prefix}_*.csv"):
        m = re.search(rf"{re.escape(prefix)}_(\d{{8}})\.csv$", p.name)
        if not m: continue
        d = parse_date(m.group(1))
        if until and d > until: continue
        if best is None or d > best[0]:
            best = (d, p)
    return best[1] if best else None

def read_csv_indexed(p: Path, key_cols):
    idx = {}
    if not p or not p.exists(): return idx
    with p.open("r", encoding="utf-8-sig") as f:
        r = csv.DictReader(f)
        for row in r:
            key = tuple(row[k] for k in key_cols)
            idx[key] = row
    return idx, r.fieldnames

def canonical_value(row):
    """ä» Tall è¡Œé‡ŒæŠ½å–â€œå¯æ¯”å€¼â€ï¼šä¼˜å…ˆ number/codeï¼Œå† stringï¼›ç©ºåˆ™ '' """
    # å…¼å®¹æˆ‘ä»¬ Tall çš„ä¸‰æ§½å‘½å
    for k in ("target_value_number", "target_value_bool", "used_enum_code", "target_value_code"):
        if k in row and (row[k] or row[k] == "0"):
            return ("code", row[k])
    for k in ("target_value_string",):
        if k in row and row[k] != "":
            return ("text", row[k].strip())
    # æœ‰äº›å®ç°åªä¿ç•™ä¸€ä¸ªæ§½ï¼šç»Ÿä¸€å…œåº•
    for k in row:
        if k.startswith("target_value_") and row[k] != "":
            return ("any", row[k])
    return ("none", "")

def changed_value(prev, curr):
    """å€¼ç­‰ä»·åˆ¤æ–­ï¼šç±»å‹ä¸€è‡´ä¸”å€¼ç›¸ç­‰â†’ä¸å˜ï¼›å¦åˆ™è§†ä¸ºå˜æ›´"""
    if prev[0] == curr[0] and prev[1] == curr[1]:
        return False
    return True

def ensure_dir(p: Path):
    p.parent.mkdir(parents=True, exist_ok=True)

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--root", required=True)
    ap.add_argument("--manifest", required=True)
    ap.add_argument("--date", required=True, help="YYYYMMDD")
    args = ap.parse_args()

    root = Path(args.root).resolve()
    asof = parse_date(args.date)

    manifest = load_yaml(root / args.manifest)
    merge_policy_path = root / str((manifest.get("policies") or {}).get("merge", "conf/policies/merge_policy.yaml"))
    mp = load_yaml(merge_policy_path)
    delta_cfg = (mp.get("delta") or {})
    baseline_cfg = (delta_cfg.get("baseline") or {})
    rules_cfg = (delta_cfg.get("rules") or {})
    outputs_cfg = (delta_cfg.get("outputs") or {})

    # å½“å‰äº§ç‰©ï¼ˆFullï¼‰
    tall_dir = root / "output" / "tall"
    hot_dir  = root / "output" / "hot"
    curr_tall = latest_file_by_date(tall_dir, "tall", until=asof)
    curr_hot  = latest_file_by_date(hot_dir,  "hot",  until=asof)
    if not curr_tall or not curr_hot:
        print(json.dumps({"ok": False, "error": "CURR_FULL_NOT_FOUND", "tall": str(curr_tall) if curr_tall else None, "hot": str(curr_hot) if curr_hot else None}, ensure_ascii=False))
        sys.exit(2)

    # åŸºçº¿ï¼ˆä¼˜å…ˆå¿«ç…§ï¼‰
    snap_dir = root / str((baseline_cfg.get("lookup") or {}).get("from_snapshots_dir", "logs/snapshots"))
    pattern = (baseline_cfg.get("lookup") or {}).get("pattern", "snap_%Y%m%d")
    # ç®€åŒ–ï¼šæˆ‘ä»¬æŒ‰ç›®å½•å snap_YYYYMMDD è§£ææ—¥æœŸ
    baseline_date_limit = asof.replace(day=asof.day)  # just to keep type= date
    prev_tall = None
    if snap_dir.exists():
        best = None
        for d in snap_dir.iterdir():
            if not d.is_dir(): continue
            m = re.match(r"snap_(\d{8})$", d.name)
            if not m: continue
            ddt = parse_date(m.group(1))
            if ddt >= asof: continue
            # éœ€è¦ç›®å½•ä¸‹æœ‰ tall.csv
            tall_csv = d / "tall.csv"
            if not tall_csv.exists(): continue
            if best is None or ddt > best[0]:
                best = (ddt, tall_csv)
        if best: prev_tall = best[1]

    first_day = False
    prefer = (baseline_cfg.get("prefer") or "prev_day_tall").lower()
    if not prev_tall:
        if prefer == "external_s1":
            # å¤–éƒ¨ S1 æœªåœ¨æ­¤è„šæœ¬å†…é‡ç®— Tallï¼Œè¿™é‡Œé™çº§ä¸º first-day è¡Œä¸º
            pass
        # é˜²å‘†
        fd = (baseline_cfg.get("first_day_delta") or "suppress").lower()
        first_day = True
        if fd == "suppress":
            # ä¸è¾“å‡º deltaï¼Œç»™å‡ºæŠ¥å‘Š
            out = {"ok": True, "delta": "suppressed", "reason": "NO_BASELINE", "curr_tall": str(curr_tall), "curr_hot": str(curr_hot)}
            print(json.dumps(out, ensure_ascii=False))
            return

    # è¯»å– curr/prev Tall
    curr_idx, curr_cols = read_csv_indexed(curr_tall, ["store_id","tag_code"])
    prev_idx, prev_cols = read_csv_indexed(prev_tall, ["store_id","tag_code"]) if prev_tall else ({}, [])

    # ç”Ÿæˆ tall_delta
    tall_delta_rows = []
    all_keys = set(curr_idx.keys()) | set(prev_idx.keys())
    include_state_change = bool(rules_cfg.get("include_state_change", True))
    for k in sorted(all_keys):
        curr = curr_idx.get(k)
        prev = prev_idx.get(k)
        if prev is None and curr is not None:
            change_type = "CREATED"
        elif curr is None and prev is not None:
            # æœ¬æœŸæ²¡å€¼ï¼šå¯èƒ½è¢«å‰”é™¤æˆ–å…¨è½ fallbackï¼›æˆ‘ä»¬è®°ä¸º EXPIRED æˆ– FALLBACK_ADDED
            change_type = "EXPIRED"
        else:
            # ä¸¤è€…éƒ½æœ‰
            pv = canonical_value(prev) if prev else ("none","")
            cv = canonical_value(curr) if curr else ("none","")
            if changed_value(pv, cv):
                change_type = "UPDATED"
            else:
                # å€¼æœªå˜ï¼Œåˆ¤æ–­çŠ¶æ€å˜åŒ–
                if include_state_change:
                    prev_state = (prev.get("value_source",""), prev.get("used_fallback",""), prev.get("evidence_state",""), prev.get("conf",""))
                    curr_state = (curr.get("value_source",""), curr.get("used_fallback",""), curr.get("evidence_state",""), curr.get("conf",""))
                    if prev_state != curr_state:
                        # fallback åˆ‡æ¢å¯ç»†åˆ†
                        if prev.get("used_fallback","0") != curr.get("used_fallback","0"):
                            change_type = "FALLBACK_ADDED" if curr.get("used_fallback","0")=="1" else "FALLBACK_REMOVED"
                        else:
                            change_type = "STATE_CHANGED"
                    else:
                        continue
                else:
                    continue

        row = {
            "store_id": k[0],
            "tag_code": k[1],
            "snapshot_date": args.date,
            "change_type": change_type,
            "prev_value_code": (prev.get("target_value_number") or prev.get("target_value_bool") or prev.get("used_enum_code") or prev.get("target_value_code") or "") if prev else "",
            "prev_value_text": (prev.get("target_value_string") or "") if prev else "",
            "prev_value_source": (prev.get("value_source") or "") if prev else "",
            "prev_used_fallback": (prev.get("used_fallback") or "0") if prev else "",
            "prev_conf": (prev.get("conf") or "") if prev else "",
            "prev_evidence_state": (prev.get("evidence_state") or "") if prev else "",
            "curr_value_code": (curr.get("target_value_number") or curr.get("target_value_bool") or curr.get("used_enum_code") or curr.get("target_value_code") or "") if curr else "",
            "curr_value_text": (curr.get("target_value_string") or "") if curr else "",
            "curr_value_source": (curr.get("value_source") or "") if curr else "",
            "curr_used_fallback": (curr.get("used_fallback") or "0") if curr else "",
            "curr_conf": (curr.get("conf") or "") if curr else "",
            "curr_evidence_state": (curr.get("evidence_state") or "") if curr else "",
            "reason_code": (curr.get("reason_code") or "") if curr else "",
            "reason_text": (curr.get("reason_text") or "") if curr else "",
        }
        tall_delta_rows.append(row)

    # å†™ tall_delta
    out_long = outputs_cfg.get("long", "output/delta/tall_delta_{date}.csv").format(date=args.date)
    outp_long = root / out_long
    ensure_dir(outp_long)
    long_cols = ["store_id","tag_code","snapshot_date","change_type",
                 "prev_value_code","prev_value_text","prev_value_source","prev_used_fallback","prev_conf","prev_evidence_state",
                 "curr_value_code","curr_value_text","curr_value_source","curr_used_fallback","curr_conf","curr_evidence_state",
                 "reason_code","reason_text"]
    with outp_long.open("w", newline="", encoding="utf-8") as f:
        w = csv.DictWriter(f, fieldnames=long_cols)
        w.writeheader()
        for r in tall_delta_rows:
            w.writerow(r)

    # ç”Ÿæˆ hot_deltaï¼šä»»ä¸€åˆ—ä¸åŒå³è¾“å‡ºå½“å‰è¡Œï¼ˆåªè¾“å‡ºå‘ç”Ÿå˜åŒ–çš„ storeï¼‰
    curr_hot_rows = []
    with curr_hot.open("r", encoding="utf-8-sig") as f:
        cr = csv.DictReader(f)
        curr_hot_rows = list(cr)
        hot_cols = cr.fieldnames

    prev_hot = None
    # ä»å¿«ç…§é‡Œæ‰¾ hot.csvï¼ˆå¯é€‰ï¼‰
    prev_hot_path = None
    if prev_tall:
        # æ¨æ–­åŒç›®å½•æœ‰ hot.csv
        pdir = prev_tall.parent
        ph = pdir / "hot.csv"
        if ph.exists(): prev_hot_path = ph
    if not prev_hot_path:
        # é€€å›åˆ° output/hot é‡Œé€‰ <= asof-1 çš„æœ€å¤§
        prev_hot_path = latest_file_by_date(hot_dir, "hot", until=asof.replace(day=asof.day))

    prev_hot_idx = {}
    if prev_hot_path and prev_hot_path.exists():
        with prev_hot_path.open("r", encoding="utf-8-sig") as f:
            pr = csv.DictReader(f)
            for row in pr:
                prev_hot_idx[row.get("store_id","")] = row

    changed_hot = []
    for row in curr_hot_rows:
        sid = row.get("store_id","")
        prev = prev_hot_idx.get(sid)
        if not prev:
            changed_hot.append(row)  # CREATED
            continue
        # æ¯”è¾ƒé™¤ store_id/snapshot_date å¤–çš„åˆ—
        diff = False
        for c in hot_cols:
            if c in ("store_id","snapshot_date"): continue
            if (prev.get(c) or "") != (row.get(c) or ""):
                diff = True; break
        if diff:
            changed_hot.append(row)

    out_wide = outputs_cfg.get("wide", "output/delta/hot_delta_{date}.csv").format(date=args.date)
    outp_wide = root / out_wide
    ensure_dir(outp_wide)
    with outp_wide.open("w", newline="", encoding="utf-8") as f:
        w = csv.DictWriter(f, fieldnames=hot_cols)
        w.writeheader()
        for r in changed_hot:
            w.writerow(r)

    print(json.dumps({
        "ok": True,
        "as_of": args.date,
        "curr_tall": str(curr_tall),
        "baseline_tall": str(prev_tall) if prev_tall else None,
        "tall_delta": str(outp_long),
        "hot_delta": str(outp_wide),
        "tall_delta_count": len(tall_delta_rows),
        "hot_delta_count": len(changed_hot),
        "first_day_mode": first_day
    }, ensure_ascii=False))

if __name__ == "__main__":
    main()
```

**ä½¿ç”¨æ–¹å¼ï¼š**

```bash
# äº§å‡º Fullï¼ˆä½ ç°æœ‰æµç¨‹ï¼‰
make raw2 && make tall && make hot && make snapshot
# äº§å‡º Deltaï¼ˆç›¸å¯¹ D-1 å¿«ç…§ï¼‰
make delta DATE=20250920
```

> ä¸ Canvas é…ç½®ä¸€è‡´ï¼š`delta.outputs.long`/`wide` ä¼šå†³å®šè½ç›˜è·¯å¾„ï¼›å¿«ç…§ç›®å½•ä¸º `logs/snapshots/snap_YYYYMMDD/`ï¼ˆæœŸæœ›å­˜åœ¨ `tall.csv`ï¼›è‹¥æœ‰ `hot.csv` æ›´ä½³ï¼‰ã€‚

---

# ä¸‰ã€é£é™©ç‚¹ & ç»†èŠ‚æé†’ï¼ˆæŒ‰â€œç®­â‘ /ç®­â‘¡â€åˆ†åˆ«è¯´ï¼‰

## ç®­â‘ ï¼š`competitive_overlap`ï¼ˆç»“æœå‹ï¼Œå…¨é‡ç›´è·‘ + ä¸¾è¯ï¼‰

**æ•°æ®æŠ•å–‚**

* å»ºè®®æ¥æºé”®ï¼š`s_overlap`ï¼ˆæˆ–çº³å…¥ `s2` å®½è¡¨ï¼‰ã€‚
* å®½è¡¨åˆ—ï¼š`store_id,date_ob,competitive_overlap`ï¼ˆå€¼å¯ä¸º `1/0/YES/NO/99`ï¼‰ã€‚
* `sources.yaml`ï¼š

  ```yaml
  s2:
    mode: wide
    id_cols: [store_id]
    default_observed_at_col: date_ob
    tags:
      competitive_overlap: { prefer_cols: [competitive_overlap, overlap_flag] }
  ```

**ä¸‰è¡¨/ç­–ç•¥å£å¾„**

* `tag_enum.csv`ï¼šä¸º `competitive_overlap` å®šä¹‰åˆæ³•ç ï¼š`1,0,99`ï¼ˆ99=å…¶ä»–/æœªçŸ¥ï¼Œ**ä»…å…œåº•ä½¿ç”¨**ï¼‰ã€‚
* `tag_spec.csv`ï¼š`value_type=bool/enum`ï¼ˆä¸ä½ å½“å‰è®¾ç½®å¯¹é½ï¼‰+ `fallback=99`ã€‚
* `ttl.yaml`ï¼šå»ºè®® `by_tag.competitive_overlap: 7`ï¼ˆæ–°é²œåº¦æ•æ„Ÿï¼‰ã€‚
* `merge_policy.yaml`ï¼šç»™ `s_overlap` æºè¾ƒé«˜ `C_source` æƒé‡ã€‚

**å¸¸è§å‘**

* **åŸŸå¤–å€¼**ï¼ˆä¾‹å¦‚ `"å¯èƒ½"`ã€`"Y"`ï¼‰ï¼šRAW2 ä¼šæ ‡ `OUT_OF_ENUM`ï¼Œä¸ä¼šè‡ªåŠ¨æ”¹æˆ `99`ï¼›åªæœ‰ Tall æ— åˆæ³•å€™é€‰æ—¶æ‰ä¼š fallbackã€‚
* **TTL è¿‡é•¿**ï¼šå¯¼è‡´â€œå‡ç¨³â€ã€‚å»ºè®®ä» 7 å¤©èµ·æ­¥ã€‚
* **æ—¶ç‚¹é”™é…**ï¼š`date_ob` ç¼ºå¤±ä¼šè½ mtimeï¼Œ`freshness` åˆ†ä¼šè¢«æ‰“ä½ï¼›å»ºè®®æºä¾§å°½é‡ç»™æ—¶é—´åˆ—ã€‚

**QA è¦çœ‹**

* `fallback_rate`ï¼ˆåº”ä½ï¼‰
* `out_of_enum_rate`ï¼ˆæ¥è¿‘ 0ï¼‰
* `freshness_lag_h`ï¼ˆ< 24 å°æ—¶è¾ƒå¥½ï¼‰

---

## ç®­â‘¡ï¼š`brand_name` + `brand_level`ï¼ˆè®¡ç®—å‹é“¾è·¯ï¼ŒNâ†’1 å†³ç­–ï¼‰

### A) æŠ“å–ä¸æ±‡èšï¼ˆN ä¸ªåå­— â†’ å€™é€‰é›†ï¼‰

* **æ•°æ®æŠ•å–‚**

  * S2 å®½è¡¨ï¼š`brand_name` åˆ—ï¼ˆå¯èƒ½æ˜¯ä¸­æ–‡/è‹±æ–‡/ç æ··ç”¨ï¼‰
  * S3 é•¿è¡¨ï¼š`tag_code=brand_name, enum_code=å“ç‰Œç ï¼ˆè‹¥æœ‰ï¼‰, value_text=å“ç‰ŒåŸæ–‡`
* **RAW1 è¡Œä¸º**ï¼šå°†æ¯ä¸ªæ¥æºçš„å€™é€‰**é€è¡Œå…¥åº“**ï¼Œä¿ç•™åŸæ–‡ä¸ç ï¼›ä¸åšå½’ä¸€ã€‚

### B) å½’ä¸€ä¸æ‰“åˆ†ï¼ˆRAW2ï¼‰

* **åˆ«åå½’ä¸€**ï¼š`tag_enum.brand_aliases/keywords/alias_norm_rule` äº§å‡ºå€™é€‰å“ç‰Œç  + `C_match`ï¼›
* **ç™½/é»‘åå•**ï¼šå‘½ä¸­ç›´æ¥åŠ /å‡åˆ†æˆ–å‰”é™¤ï¼›
* **é˜ˆå€¼è£å†³**ï¼šä½äº `match_score_threshold` çš„å€™é€‰æ ‡è®° `LOW_CONF`ï¼ˆè¿›å…¥ Tall æ—¶åˆ†æ•°ä¼šä½ï¼‰ã€‚
* **è¯æ®ä¾§å†™**ï¼š

  * `candidate_count / best_score / match_method / alias_norm_rule`
  * `white_list_hit / black_list_hit`
  * `reason_code/text`ï¼ˆä¾‹å¦‚ `{"hit":"SINOPEC","score":0.86,"from":"s2.brand_text"}`ï¼‰

### C) Tall æ‹©ä¼˜ï¼ˆNâ†’1ï¼‰

* **è¯„åˆ†å…¬å¼**ï¼š`conf = C_source^w1 Ã— C_fresh^w2 Ã— C_rule^w3 Ã— C_match^w4`

  * `brand_name` å·²åœ¨ `overrides.by_tag` ä¸­è°ƒé«˜ `C_fresh`ï¼›
  * å¯¹â€œé«˜è´¨é‡å“ç‰Œæºâ€å¯åœ¨ `overrides.by_tag_source.brand_name.sX.weights` å†åŠ æƒã€‚
* **Tie-break é¡ºåº**ï¼ˆå·²åœ¨é…ç½®ï¼‰ï¼š`conf_desc â†’ observed_at_desc â†’ C_source_desc â†’ source_whitelist â†’ source_lexi_asc`ã€‚
* **fallback**ï¼š`brand_name` çš„ `fallback=other`ï¼›ä»…åœ¨**æ— åˆæ³•å€™é€‰**æ—¶è§¦å‘ï¼Œ`used_fallback=1`ã€‚

### D) `brand_level` è®¡ç®—ï¼ˆä»¥ `brand_name` ä¸ºå…ˆå¯¼ï¼‰

ä½ ç»™çš„å£å¾„æˆ‘æ€»ç»“æˆä¸¤æ®µè§„åˆ™ï¼ˆå¯é…ç½®åŒ–ï¼‰ï¼š

1. **KAï¼ˆç‰¹æŒ‡åå•ï¼‰**ï¼š`brand_name âˆˆ {ä¸­å›½çŸ³åŒ–, ä¸­å›½çŸ³æ²¹, ä¸­å›½æµ·æ²¹, ä¸­å›½ä¸­åŒ–, å»¶é•¿çŸ³æ²¹, BP, é“è¾¾å°”, å£³ç‰Œ, åŠ å¾·å£«}`
2. **CKAï¼ˆè§„æ¨¡é˜ˆå€¼ï¼‰**ï¼šè‹¥è¯¥å“ç‰Œï¼ˆæŒ‰ `brand_name` å½’ä¸€åçš„**å“ç‰Œç **ï¼‰çš„**æœ‰æ•ˆåˆä½œç«™ç‚¹æ•° â‰¥ å“ç‰Œä¸­ä½æ•°é˜ˆå€¼**ï¼ˆä½ ä¹‹å‰ä¼° 10ï¼‰ï¼Œåˆ™ `CKA`
3. **å…¶ä½™**ï¼š`å°æ•£`

> è½åœ°ç‚¹ï¼š
>
> * è§„åˆ™ â‘  æ¥æºï¼š`conf/policies/brand_level.yaml`ï¼ˆå»ºè®®ä½ æ–°å»ºï¼ŒæŠŠ KA åå•é›†ä¸­ç®¡ç†ï¼‰ï¼›
> * è§„åˆ™ â‘¡ éœ€è¦ä¸€ä¸ª**æ˜¨æ—¥æˆ–å½“æ—¥çš„å“ç‰Œè®¡æ•°è¡¨**ï¼ˆç”± Tall åæ¨å³å¯ï¼šæŒ‰ `brand_name` åˆ†ç»„è®¡æ•°ï¼‰ï¼Œé˜ˆå€¼æ”¾ `brand_level.yaml`ï¼ˆå¦‚ `cka_threshold: 10`ï¼‰ã€‚
> * Tall åœ¨è®¡ç®— `brand_level` æ—¶ï¼Œå…ˆçœ‹ â‘ ï¼Œå†çœ‹ â‘¡ï¼Œæœ€åå…œåº• `å°æ•£`ï¼›å¹¶åœ¨ `reason_text` é‡Œä¾§å†™ä¾æ®ï¼ˆå‘½ä¸­ KA åå• or è®¡æ•°â‰¥é˜ˆå€¼ Nï¼‰ã€‚

**å¸¸è§å‘**

* **åˆ«åæ²¡è¦†ç›–**ï¼š`OUT_OF_ENUM` æˆ– `LOW_CONF` å¤š â†’ æ‰©å…… `brand_aliases/keywords`ï¼›
* **å¤šå€™é€‰åŒåˆ†**ï¼štie-break èµ°â€œç™½åå•æ¥æºä¼˜å…ˆâ€ï¼›å¿…è¦æ—¶ä¸´æ—¶ `by_tag_source` è°ƒä¸€æ¡£ï¼›
* **å±‚çº§æŠ–åŠ¨**ï¼š`CKA` ä¾èµ–ç«™ç‚¹æ•°é˜ˆå€¼ï¼ŒåˆæœŸå»ºè®®ç”¨**D-1 çš„ Tall è®¡æ•°**ï¼ˆæ›´ç¨³å®šï¼‰ï¼Œå¹¶è®¾ç½®**æœ€å°ç”Ÿæ•ˆå¤©æ•°**ï¼ˆä¾‹å¦‚ 7 å¤©å†…ä¸é‡å¤é™çº§ï¼‰ã€‚

**QA è¦çœ‹**

* `brand_name` çš„ `out_of_enum_rate`ï¼ˆ< 1%ï¼‰
* `fallback_rate`ï¼ˆother çš„æ¯”ä¾‹ä¸èƒ½å¤ªé«˜ï¼›é«˜äº†å°±è¡¥åˆ«åï¼‰
* `changed_rate`ï¼ˆå“ç‰Œæ¯æ—¥å˜åŒ–ç‡è¿‡é«˜è¯´æ˜åŒ¹é…ä¸ç¨³ï¼‰
* `delta_source_switch`ï¼ˆæ¥æºé¢‘ç¹åˆ‡æ¢è¦å…³æ³¨ï¼‰

---

# å››ã€ä»Šå¤©å°±èƒ½åšçš„ä¸‰æ­¥

1. æŠŠä¸Šé¢çš„ **Makefile** æ®µå’Œ **`scripts/delta_build.py`** è½è¿›å»ï¼ˆä¿å­˜ã€èµ‹æƒï¼š`chmod +x scripts/delta_build.py`ï¼‰ã€‚
2. è·‘ä¸€è½®â€œç®­â‘ +ç®­â‘¡â€çš„å°æ‰¹æ¬¡ï¼ˆå„ 20â€“50 è¡Œå³å¯ï¼‰ï¼ŒæŒ‰ä½ ç°æœ‰æµç¨‹äº§ **Full**ï¼Œå†ï¼š

   ```bash
   make delta DATE=20250920
   ```
3. çœ‹å››ä¸ªäº§ç‰©çš„**è¡¨å¤´+3è¡Œæ ·ä¾‹**ï¼š`tall_*.csv / hot_*.csv / tall_delta_*.csv / hot_delta_*.csv`ï¼Œæˆ‘ç»™ä½ åšä¸€æ¬¡â€œè¯»ç‰‡â€å¿«é€Ÿä½“æ£€ï¼Œé¡ºä¾¿æŠŠ `brand_level` çš„é˜ˆå€¼ä¸ KA åå•é…ç½®æ–‡ä»¶ä¹Ÿå›ºåŒ–è¿› `conf/policies/brand_level.yaml`ã€‚

å¦‚æœä½ è®¤å¯ï¼Œæˆ‘ä¸‹ä¸ªå›åˆå°±æŠŠ `brand_level.yaml` çš„**æ¨¡æ¿**ä¸â€œç”± Tall åæ¨å“ç‰Œç«™ç‚¹æ•°â€çš„**è¾…åŠ©è„šæœ¬**ä¸€å¹¶æä¾›ï¼Œè®©â€œKA/CKA/å°æ•£â€å®Œå…¨é…ç½®åŒ–ã€å¯å›æ”¾ã€‚
