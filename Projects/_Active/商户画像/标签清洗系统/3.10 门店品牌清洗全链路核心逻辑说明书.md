# 门店品牌清洗全链路核心逻辑说明书（完整版・校准版）

## 一、输入源定义（核心共识）

**核心结构**：以「门店实体」为锚点，关联「多标签值」作为待清洗输入，术语与字段定义统一校准如下：

|   |   |   |   |
|---|---|---|---|
|核心要素|英文标识|具体定义|示例（门店场景）|
|核心实体标识|store_id|唯一标识单个门店的 ID，作为后续结果聚合的关联键|1134360783908786368|
|标签属性|tag_code|固定标签类型，标识待清洗的业务属性，**固定值为 “brand_name”**|brand_name|
|多标签值（输入）|raw_values|同一 store_id 下，tag_code=brand_name 对应的 N 个独立待清洗文本，每个值独立执行清洗流程|store_id=STO_10001 的 5 个文本："中化油站"“中石化路站点” 等|
|品牌枚举标识|enum_code|品牌字典中唯一标识品牌的编码，需以 “BRAND_0” 开头|BRAND_001|

## 二、全链路核心清洗逻辑（按流程递进，术语校准 + 规则强化）

整体流程：**单标签值独立清洗→门店级结果聚合→兜底补全**，核心强化「sort_order 值越大优先级越高」规则，所有冲突项以本版校准内容为准。

### 阶段 1：单标签值独立清洗（N 个 raw_values 并行执行）

每个待清洗文本按 “快速命中→深度清洗→冲突仲裁” 三步走，输出该 raw_value 的 “初步清洗结果”。

#### 步骤 1.1：前置快速通道 —— 标准表达精准匹配

- **匹配对象**：原始 raw_value（未做任何清洗） vs 品牌字典enum_label（标准品牌名，如 “中国石化”）

- **判定规则**：全字符完全一致（全角空格先转半角，首尾空格自动剔除后匹配，例：“中国石化”→匹配 “中国石化”）

- **结果分支**：

✅ 命中 + 该品牌white_list=1（白名单启用）→ 直接输出enum_label作为该 raw_value 的 “初步结果”，终止后续流程；

❌ 未命中 / 非白名单 → 进入「深度清洗流程」。

#### 步骤 1.2：深度清洗流程 —— 预处理→降噪→深度匹配→阈值拦截

##### 1.2.1 第一步：四级预处理（输出 “标准化文本”）

|   |   |   |   |
|---|---|---|---|
|预处理层级|操作细节|依赖配置 / 规则|示例（原始 raw_value：“中化 石油。(站点) - 中石化路公司”）|
|1. 编码清洗|全角→半角：采用字符编码转换实现（禁用maketrans方法）；剥离首尾空格|固定编码转换规则（如unicodedata.normalize('NFKC', text)）|“中化 石油.(站点) - 中石化路公司”|
|2. 符号剔除|去除所有括号、标点符号（中英文()（）,，;；.。""''、-等）|固定符号集合|“中化 石油 站点 中石化路公司”|
|3. 后缀剥离|调用brand_cleaning_rules.yaml，去除 80 + 品牌特定后缀（如 “店”“站”“公司”“站点” 等）|配置项brand_cleaning_rules.yaml（含后缀列表）|“中化 石油 中石化路”|
|4. 地址专项去噪|执行正则过滤：`(中石化|中石油|移动|

##### 1.2.2 第二步：停用词处理（含兜底豁免逻辑）

- **输入**：预处理后的文本

- **核心逻辑**：先判断 “是否触发豁免”，再执行过滤，支持双格式停用词表输入：

1. **豁免条件（二选一即不应用停用词）**：

- 文本中中文字符数量＜5 个；

- 文本 100% 命中某品牌白名单（white_list=1的enum_label或brand_aliases）。

2. **过滤规则**：

- 先匹配 “例外规则”（如 “城市投资” 不删 “投资”）；

- 再加载停用词表（支持 Excel [需表头stop_word] 或 YAML [stop_words: [电子, 的, 等]] 格式），过滤冗余词汇。

- **依赖配置**：stop_words.yaml（停用词列表）、例外规则清单

- xlsx 文件路径和表头,要用 stop_word,判断是否启用 1,比对排除字段

- |   |   |   |   |   |
    |---|---|---|---|---|
    |num|word_type|stop_word|is_active|exclusion_field|
    |1|文本|公司|1||
    

/Users/didi/Downloads/panth/tag_ct_local/data/ref/stop_rule.xlsx

- **示例**：预处理后文本 “中化 石油 电子”→ 非豁免→ 过滤 “电子”→ 输出 “中化 石油”

##### 1.2.3 第三步：分级深度匹配（限定品牌范围，别名排除前置）

以 “标准化文本” 为输入，**先执行 “别名排除校验”，再按 “别名→正则→关键词” 优先级匹配**，且仅符合以下条件的品牌可参与匹配：

✅ 品牌字典tag_enum.csv中is_active=1；

✅ enum_code以 “BRAND_0” 开头；

✅ white_list=1（允许入池）。

|   |   |   |
|---|---|---|
|流程节点|操作逻辑|依赖配置 / 规则|
|前置：别名排除校验|检查标准化文本是否包含该品牌exclusion_field（排除关键词）→ 若包含，直接跳过该品牌的匹配|品牌字典tag_enum.csv的exclusion_field（分号分隔排除词，如 “新中石化”“BP”）|
|1 级：别名精准匹配|标准化文本是否包含brand_aliases（别名集合）中的任一子串→ 是则生成候选|1. match_method不限（必走）；2. 基础得分 = 1.0|
|2 级：正则匹配|1 级未命中→ 标准化文本是否满足regex_pattern（正则规则）→ 是则生成候选|1. match_method=0（允许扩展匹配）；2. 基础得分≈0.95|
|3 级：关键词匹配|2 级未命中→ 标准化文本是否全命中keywords（关键词集合，AND 逻辑）→ 是则生成候选|1. match_method=0；2. 基础得分 =（命中数 / 总关键词数）×0.90|

##### 1.2.4 第四步：候选过滤→排序→阈值拦截

1. **无效候选过滤**：剔除以下候选：

- 得分＜该品牌match_score_threshold（0.0-1.0）；

- black_list=1（黑名单）；

- enum_label为 “other” 或空值。

2. **候选排序（核心规则强化）**：按以下优先级**降序排列**，其中sort_order值越大优先级越高：

① sort_order（字典优先级序号，核心决胜项）；

② 匹配得分；

③ 别名长度（越长特异性越高）；

④ enum_code字典序（升序，保障稳定性）。

3. **阈值拦截**：剩余候选中，取排序第一的候选；若所有候选均被过滤→ 标记为 “待兜底”。

#### 步骤 1.3：置信度计算（四档固定分值）

根据候选情况赋值，分值与场景强绑定：

|   |   |
|---|---|
|候选场景|置信度分值（confidence）|
|唯一候选且过阈值|100|
|多候选但以sort_order/ 匹配得分决胜|85|
|多候选靠别名长度 /enum_code决胜|80|
|无候选（待兜底）|40-50|

### 阶段 2：门店级结果聚合（按 store_id 关联）

基于同一 store_id 的 N 个 raw_value “初步结果”，进行跨值优选，输出该门店的 “最终品牌结果”。

#### 步骤 2.1：结果分类统计

先统计 N 个初步结果的分布，分为两类场景：

- **场景 A：结果一致**：N 个初步结果均为同一品牌（非 “待兜底”）→ 直接将该品牌作为brand_final，置信度沿用单值分值；

- **场景 B：结果冲突**：存在≥2 个不同品牌（或含 “待兜底”）→ 执行「加权优选逻辑」。

#### 步骤 2.2：冲突场景的加权优选逻辑（强化 sort_order 权重）

1. **计算 “品牌票数”**：

票数 = Σ（单个 raw_value 的 “匹配得分 × 该品牌sort_order”）

_例_：store_id=STO_10001 的 5 个结果中，“中国石化” 命中 3 次（得分 1.0，sort_order=30），“小散” 命中 2 次（得分 0.8，sort_order=10）→ 中国石化票数 = 3×(1.0×30)=90；小散票数 = 2×(0.8×10)=16

2. **决胜规则**：

- 取票数最高的品牌；

- 若票数差异＜10%→ 取sort_order更大的品牌；

- 仍冲突→ 标记 “待人工复核”，暂用兜底值。

### 阶段 3：白名单校验与兜底补全

#### 步骤 3.1：白名单最终准入

- 仅 “初步结果 / 聚合结果” 为white_list=1的品牌，可作为有效清洗结果；

- 非白名单品牌→ 直接剔除，进入兜底流程。

#### 步骤 3.2：兜底机制（优先级固定）

按以下顺序补全，无有效结果时强制触发：

1. **优先兜底**：取tag_enum.csv中is_default=true、is_active=1且enum_code以 “BRAND_0” 开头的品牌；

2. **次级兜底**：无默认值→ 回退到固定值 “other”；

3. **兜底属性**：置信度 = 40-50，is_valid_brand=false（非有效清洗结果）。

## 三、核心配置项说明（术语校准）

|   |   |   |   |
|---|---|---|---|
|配置文件名|存储路径|核心内容|作用|
|brand_cleaning_rules.yaml|/conf/|80 + 个品牌特定后缀（如 “店”“站”“公司” 等）|预处理阶段剥离冗余后缀|
|stop_words.yaml|/conf/|停用词列表（如 “电子”“的” 等），支持 YAML 数组格式|过滤无意义词汇|
|tag_enum.csv|/conf/|关键字段：enum_code（BRAND_0 开头）、enum_label、brand_aliases、sort_order、is_active、is_default、match_score_threshold等|定义品牌枚举与匹配规则|

/Users/didi/Downloads/panth/tag_ct_local/data/ref/stop_rule.xlsx

## 四、关键规则固化（精准表达）

|   |   |
|---|---|
|规则类别|核心细节|
|术语统一|门店 = store，门店 ID=store_id，标签名称 = tag_code（固定 = brand_name），品牌编码 = enum_code（BRAND_0 开头）|
|sort_order 优先级|严格遵循 “值越大，优先级越高”，为候选排序、冲突聚合的第一决胜项|
|匹配范围限制|仅is_active=1+is_default= FALSE+white_list=1的品牌可参与匹配|
|停用词豁免|中文字符＜5 个 或 100% 命中白名单时，不执行停用词过滤|
|兜底边界|“other” 仅为兜底值，不算有效结果，is_valid_brand固定为 false|

## 五、流程流转示意图（按校准术语更新）

## 六、核心输出结果表（英文字段 + 中文描述）

|   |   |   |   |
|---|---|---|---|
|字段名（Field Name）|数据类型（Data Type）|描述（Description）|示例（Example）|
|store_id|String|门店唯一标识|STO_10001|
|tag_code|String|标签类型，固定为 “brand_name”|brand_name|
|raw_values|String|待清洗的多个原始文本（用；分隔）|“中化油站；中石化路店；中国石化站点”|
|preliminary_results|String|每个原始文本的初步清洗结果（用；分隔，格式：结果 (置信度)）|“中国石化 (100); 中国石化 (85); 中国石化 (90)”|
|brand_final|String|门店最终清洗出的品牌|中国石化|
|win_logic|String|最终品牌的胜出逻辑|“所有初步结果一致，直接选中”|
|confidence|Integer|最终结果的置信度分值（100/85/80/40-50）|100|
|is_valid_brand|Boolean|是否为有效清洗结果（非兜底）|TRUE|
|is_fallback|Boolean|是否触发了兜底逻辑|FALSE|
|trace_id|String|审计追踪 ID（关联详细清洗日志）|TRC_20240520_STO10001|