



ç»“è®ºå…ˆè¯´ï¼š**å¯ä»¥**ã€‚æµ‹è¯•ç¯å¢ƒç…§æ ·èµ°æµ‹è¯•è¾“å…¥/è¾“å‡ºç›®å½•ï¼Œä½†**é»˜è®¤è¯»å– prod å­—å…¸**ï¼Œè¿™æ ·ä½ åªç»´æŠ¤ä¸€å¥—è¯å…¸ï¼Œä¹Ÿæ›´å®¹æ˜“æš´éœ²â€œçº¿ä¸Šå£å¾„ vs æµ‹è¯•æ ·æœ¬â€çš„çŸ›ç›¾ã€‚å¹¶ä¸”æŒ‰ä½ çš„æ–°å£å¾„ï¼Œ**å€™é€‰å“ç‰Œçš„å…¥æ± é™åˆ¶**æ”¹ä¸ºï¼š`is_active=1 AND white_list=1 AND is_default=FALSE`ã€‚æˆ‘æŠŠè§„èŒƒç‚¹å¯¹ç‚¹æ”¹å®Œå¦‚ä¸‹ï¼ˆåªæ›´æ–°â€œè·¯å¾„/å­—å…¸é€‰æ‹©/å…¥æ± é™åˆ¶/æ–­è¨€â€å››å¤„å…³é”®ç‚¹ï¼Œå…¶ä»–ä¿æŒä½ åŸæœ‰å…¨é“¾è·¯ä¸å˜ï¼‰ã€‚

# A2 å­—å…¸é€‰æ‹©ï¼ˆä¿®è®¢ç‰ˆï¼šæµ‹è¯•ç¯å¢ƒé»˜è®¤è¯» prod å­—å…¸ï¼‰

* `${ROOT}=/Users/didi/Downloads/panth/tag_ct_local`
* å­—å…¸å”¯ä¸€äº‹å®æºï¼ˆ**prod**ï¼‰ï¼š`${ROOT}/data/ref`

  * `tag_enum.csv` / `stop_rule.xlsx`
  * `conf/brand_cleaning_rules.yaml`ï¼ˆå…¬å…±è§„åˆ™ï¼‰
* æµ‹è¯•ä»…ä½œ**å¯é€‰**è¦†ç›–ï¼ˆ**ä¸å»ºè®®ç»´æŠ¤**ï¼‰ï¼š`${ROOT}/data/test/ref`

  * åªæœ‰å½“ä½ **æ˜¾å¼è¦æ±‚**â€œç”¨æµ‹è¯•å­—å…¸â€æ—¶æ‰ç”¨

### CLI å¼€å…³ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰

1. `--dict-mode=prod|test|prod_mirror`

   * `prod`ï¼šå§‹ç»ˆ `${ROOT}/data/ref`
   * `test`ï¼šå§‹ç»ˆ `${ROOT}/data/test/ref`
   * `prod_mirror`ï¼ˆ**é»˜è®¤**ï¼‰ï¼šæŒ‰ `--env` å†™å…¥ä¸åŒè¾“å‡ºç›®å½•ï¼Œä½†**è¯»å– `${ROOT}/data/ref`**
2. è‹¥æœªä¼  `--dict-mode`ï¼š

   * `--env=test` + æœªæŒ‡å®š `--dict-root` â‡’ **prod\_mirror**ï¼ˆæµ‹è¯•å†™ outputs\_testï¼Œä½†è¯» prod å­—å…¸ï¼‰
   * æ˜¾å¼ä¼  `--dict-root` æ—¶ï¼Œä»¥ä¼ å…¥è·¯å¾„ä¸ºå‡†

### ç¤ºä¾‹

```bash
# æµ‹è¯•ç¯å¢ƒï¼šè¯» prod å­—å…¸ï¼Œå†™ outputs_testï¼ˆæ¨èï¼‰
python brandctl.py clean \
  --env test \
  --dict-mode prod_mirror \
  --in  "${ROOT}/data/test/inbox/20250920_0656/s1/*.csv" \
  --out "${ROOT}/outputs_test/clean/20250920_0656/s1/brand_cleaned.csv" \
  --policy "${ROOT}/conf/brand_cleaning_rules.yaml" \
  --audit "${ROOT}/outputs_test/audit/20250920_0656/s1/audit.jsonl" \
  --id-col store_id --raw-col raw_brand_name --wide-raw-prefix raw_value_

# å¦‚éœ€å¼ºåˆ¶è¯»å–æµ‹è¯•å­—å…¸ï¼ˆä¸æ¨èï¼Œé™¤éä½ è¦éªŒè¯å­—å…¸å˜æ›´ï¼‰
python brandctl.py clean --env test --dict-mode test ...
```

# C3 åŒ¹é…èŒƒå›´é™åˆ¶ï¼ˆä¿®è®¢ç‰ˆï¼šåŠ å…¥ is\_default=FALSEï¼‰

å€™é€‰å“ç‰Œ**å¿…é¡»åŒæ—¶æ»¡è¶³**ï¼š

* `is_active=1`
* `white_list=1`
* `enum_code` ä»¥ `BRAND_0` å¼€å¤´
* **`is_default=FALSE`**ï¼ˆé»˜è®¤å…œåº•å“ç‰Œ**ä¸å¾—**å‚ä¸å€™é€‰ï¼Œåªèƒ½ç”¨äºå…œåº•é˜¶æ®µï¼‰
  è¿™æ¡è§„åˆ™åº”ç”¨åœ¨**å•å€¼æ·±åº¦åŒ¹é…å…¥å£**ä¸**é—¨åº—èšåˆå‰çš„æœ‰æ•ˆæ€§æ ¡éªŒ**ä¸¤ä¸ªä½ç½®ï¼Œç¡®ä¿é»˜è®¤å“ç‰Œä¸ä¼šâ€œæŠ¢ä½â€ã€‚

# A4/A5 è·¯å¾„ä¸å˜ï¼ˆå†ç¡®è®¤ä¸€æ¬¡ä½ çš„è¯­ä¹‰ï¼‰

* è¾“å…¥ï¼ˆæµ‹è¯•ï¼‰ï¼š`${ROOT}/data/test/inbox/<batch_id>/{s1|s2|s3|s4}/*`
* è¾“å…¥ï¼ˆæˆç†Ÿï¼‰ï¼š`${ROOT}/data/raw/inbox/<batch_id>/{s1|s2|s3|s4}/*`
* è¾“å‡ºï¼ˆæµ‹è¯•ï¼‰ï¼š`${ROOT}/outputs_test/clean/<batch_id>/<slot>/brand_cleaned.csv`
* è¾“å‡ºï¼ˆæˆç†Ÿï¼‰ï¼š`${ROOT}/outputs/clean/<batch_id>/<slot>/brand_cleaned.csv`
* å®¡è®¡å¯¹åº”å†™å…¥ `outputs_test/audit/...` æˆ– `outputs/audit/...`
* ä»ä¿æŒï¼š**é•¿/å®½è¡¨è¾“å…¥ç»Ÿä¸€æ‹‰å¹³æˆâ€œé•¿è¡¨â€â†’é€å€¼æ¸…æ´—â†’å®½è¡¨èšåˆï¼Œstore\_id å”¯ä¸€ã€ä¸ä¸¢è¡Œ**ã€‚

# æ–­è¨€æŠ¤æ ï¼ˆåŒæ­¥ä¿®è®¢ï¼‰

åœ¨ `clean` ç»“æŸå‰ï¼Œtrace å¿…é¡»æ£€æŸ¥å¹¶æŠ¥é”™ï¼š

1. **ç¯å¢ƒ-è·¯å¾„ä¸€è‡´**ï¼š`--env=test` â‡’ è¾“å‡ºè½åœ¨ `/outputs_test/`ï¼ˆä¸ `--dict-mode` æ— å…³ï¼‰
2. **å­—å…¸é€‰æ‹©æ˜ç¡®**ï¼š

   * å½“ `--dict-mode=prod_mirror` æˆ–æœªæ˜¾å¼æŒ‡å®šå­—å…¸ä¸” `--env=test` â‡’ æ‰“å°â€œUsing prod dictionaries from \${ROOT}/data/refâ€
3. **å€™é€‰èŒƒå›´**ï¼šå€™é€‰é›†ä¸­ä»»ä½•å“ç‰Œè‹¥ `is_default=TRUE` â‡’ æŠ¥é”™å¹¶æ‰“å°æœ€å°å¤ç°
4. **ç™½åå•/æ¿€æ´»/å‰ç¼€**ï¼šä¸æ»¡è¶³ `is_active=1 && white_list=1 && BRAND_0*` çš„å“ç‰Œå‡ºç°åœ¨å€™é€‰ â‡’ æŠ¥é”™
5. **ä¸ä¸¢è¡Œ & å”¯ä¸€**ï¼šè¾“å‡º store\_id é›†åˆ == è¾“å…¥å»é‡é›†åˆï¼›ç»“æœ store\_id æ— é‡å¤
6. **å››æ¡£ç½®ä¿¡åº¦**ï¼š`confidence âˆˆ {100,85,80,40â€“50}`ï¼›`win_logic` åœ¨å…è®¸æšä¸¾å†…
7. **å®¡è®¡ç­‰é•¿**ï¼š`audit.jsonl` è¡Œæ•° == æ‰€æœ‰åŸå§‹ raw å€¼æ€»æ•°

# ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ

* ä½ **åªéœ€ç»´æŠ¤ä¸€å¥— prod å­—å…¸**ï¼›æµ‹è¯•ç›´æ¥æ‹¿ prod å­—å…¸è·‘ï¼Œæœ€å®¹æ˜“æš´éœ²â€œç”Ÿäº§å£å¾„ä¸çœŸå®æ ·æœ¬â€çš„é—®é¢˜ï¼›å½“ç¡®å®éœ€è¦**æ²™ç®±å­—å…¸è¯•éªŒ**æ—¶ï¼Œå†åˆ‡ `--dict-mode=test` å³å¯ã€‚
* å°† `is_default=FALSE` çº³å…¥å€™é€‰é™åˆ¶ï¼Œä¿è¯â€œé»˜è®¤å“ç‰Œåªå…œåº•ä¸å‚èµ›â€ï¼Œé¿å…æµ‹è¯•æ—¶é»˜è®¤é¡¹æŠŠçœŸå®å€™é€‰ç›–æ‰ã€‚
* `prod_mirror` è®©â€œæµ‹è¯•è¾“å…¥/è¾“å‡ºéš”ç¦»â€ä¸â€œå­—å…¸å•ä¸€äº‹å®æºâ€åŒæ—¶æˆç«‹ï¼Œå‡å°‘ç®¡ç†æˆæœ¬ã€‚

---

å¦‚æœè¿™ç‰ˆè¯­ä¹‰å®Œå…¨è´´åˆä½ çš„é¢„æœŸï¼Œæˆ‘æŠŠå®ƒå†™è¿› A ç« çš„â€œé›¶æ­§ä¹‰å¯¹é½åŒ…â€ï¼Œå¹¶åŒæ­¥æŠŠ C ç« çš„â€œå€™é€‰å…¥æ± è§„åˆ™â€ä¸ G ç« çš„æ–­è¨€æ¸…å•ä¸€èµ·æ›´æ–°ã€‚æ¥ä¸‹æ¥ trace åªéœ€è¦ï¼š

* åœ¨ `clean` å¯åŠ¨æ—¶æ‰“å°â€œEnv=test, Dict=prod\_mirror(â€¦/data/ref)â€è¿™è¡Œæç¤ºï¼›
* é‡åˆ° `is_default=TRUE` å…¥æ± ç›´æ¥ fail-fastï¼›
* å…¶ä»–é€»è¾‘æ²¿ç”¨ä½ ç°æœ‰å…¨é“¾è·¯ã€‚

---
å¥½ï¼Œä¸“æ³¨æŠŠ **Bï¼šè¾“å…¥æ ‡å‡†åŒ–** è¿™ä¸€æ­¥ä¸€æ¬¡æ€§è¯´æ¸…ã€æ‹æ¿ã€‚ç›®æ ‡ï¼šä¸æ”¹å˜ä¸šåŠ¡å«ä¹‰ã€ä¸åšæ¸…æ´—ï¼ŒåªæŠŠâ€œä»»ä½•å½¢æ€çš„è¾“å…¥â€å˜æˆ**ä¸€å¼ ç¨³å®šã€å¯è¿½æº¯çš„é•¿è¡¨**ï¼Œä¾›åç»­ Câ€“G ä½¿ç”¨ã€‚ä½ ç»™ trace çš„å°±æ˜¯è¿™ä»½è§„èŒƒï¼›ä½ éªŒæ”¶ä¹ŸæŒ‰è¿™ä»½æ¥ã€‚

# Bï½œè¾“å…¥æ ‡å‡†åŒ–ï¼ˆLong Form Canonicalizationï¼‰

## B1. å…è®¸çš„åŸå§‹è¾“å…¥å½¢æ€

- **é•¿è¡¨**ï¼šä¸€è¡Œä¸€ä¸ªæ–‡æœ¬å€¼
    
    - æœ€å°åˆ—é›†ï¼š`store_id`, `raw_brand_name`
        
    - å¯é€‰ä¸Šä¸‹æ–‡ï¼š`pop_id`, `tag_code`, `value_type`, `date_ob`, `source_file` â€¦
        
- **å®½è¡¨**ï¼šä¸€è¡Œä¸€ä¸ªé—¨åº—ï¼Œå¤šåˆ—æ–‡æœ¬å€¼
    
    - æœ€å°åˆ—é›†ï¼š`store_id` + `raw_value_1 â€¦ raw_value_n`ï¼ˆå‰ç¼€å¯é…ç½®ï¼Œé»˜è®¤ `raw_value_`ï¼‰
        

> ä»»ä½•å…¶å®ƒåˆ—åŸæ ·é€ä¼ ä¸ºä¸Šä¸‹æ–‡ï¼Œä¸åœ¨æœ¬æ­¥åšè¯­ä¹‰å¤„ç†ã€‚

## B2. æ ‡å‡†åŒ–äº§ç‰©ï¼ˆå”¯ä¸€çœŸç›¸è¡¨ï¼‰

ç”Ÿæˆ **`01_normalized.csv`**ï¼ˆUTF-8ï¼Œæ—  BOMï¼‰ï¼Œåˆ—ä¸å«ä¹‰å›ºå®šå¦‚ä¸‹ï¼š

|åˆ—å|å«ä¹‰|
|---|---|
|`batch_id`|ç”±è·¯å¾„è§£æå‡ºçš„æ‰¹æ¬¡ï¼ˆå¦‚ `20250920_0656`ï¼‰|
|`slot`|æ§½ä½ï¼ˆ`s1|
|`store_id`|é—¨åº—å”¯ä¸€é”®|
|`raw_value`|åŸå§‹æ–‡æœ¬å€¼ï¼ˆ**æœªç»æ¸…æ´—**ï¼Œä»…åšè½»åº¦ä¿®å‰ªï¼‰|
|`raw_col`|æ¥è‡ªå“ªä¸ªåˆ—ï¼ˆé•¿è¡¨å›ºå®š `raw_brand_name`ï¼›å®½è¡¨è®°å½• `raw_value_k`ï¼‰|
|`row_no`|æ–‡ä»¶å†…åŸå§‹è¡Œå·ï¼ˆ1-basedï¼‰|
|`file_basename`|åŸæ–‡ä»¶åï¼ˆä¸å«è·¯å¾„ï¼‰|
|`pop_id`|é€ä¼ ï¼ˆå¦‚æœ‰ï¼‰|
|`tag_code`|é€ä¼ ï¼ˆå¦‚æœ‰ï¼›å¸¸è§ `brand_name`ï¼‰|
|`value_type`|é€ä¼ ï¼ˆå¦‚æœ‰ï¼›ä¾‹å¦‚ `store_name`/`pop_name`ï¼‰|
|`date_ob`|é€ä¼ ï¼ˆå¦‚æœ‰ï¼‰|

> è¿™å¼ è¡¨åªåšâ€œæ”¶æ•›ä¸ç¼–å·â€ï¼Œ**ä¸åšæ¸…æ´—**ï¼ˆåç¼€/åœç”¨è¯/åœ°å€å™ªå£°ç­‰åœ¨ C æ­¥ï¼‰ã€‚  
> ä½ åœ¨åç»­ä»»ä½•æ­¥éª¤é‡åˆ°é—®é¢˜ï¼Œéƒ½èƒ½æŒ‰ `batch_id + slot + file_basename + row_no` ç›´æ¥å›æº¯åˆ°åŸå§‹è¡Œã€‚

## B3. è§„èŒƒåŒ–å¤„ç†è§„åˆ™ï¼ˆä»…é™â€œæ— æŸæ•´ç†â€ï¼‰

1. **ç¼–ç ä¸ç©ºç™½**
    
    - è¾“å…¥ç»Ÿä¸€æŒ‰ UTF-8 è¯»å–ï¼ˆå®¹å¿ BOMï¼‰ï¼›è¡Œå°¾ç»Ÿä¸€æˆ `\n`ï¼›å»é™¤ `raw_value` çš„é¦–å°¾ç©ºç™½ï¼›å†…éƒ¨**ä¸**æ”¹åŠ¨å­—ç¬¦ã€‚
        
2. **åˆ—æ˜ å°„**
    
    - é•¿è¡¨ä¼˜å…ˆè¯†åˆ«åˆ—ï¼š`raw_brand_name`ï¼ˆå¦‚æ— åˆ™å¤±è´¥å¹¶åˆ—å‡ºå¯é€‰åˆ—åï¼‰ã€‚
        
    - å®½è¡¨è¯†åˆ«æ‰€æœ‰ä»¥ `--wide-raw-prefix`ï¼ˆé»˜è®¤ `raw_value_`ï¼‰å¼€å¤´çš„åˆ—ï¼ŒæŒ‰è‡ªç„¶åºå·å±•å¼€ã€‚
        
3. **å±•å¼€é¡ºåºï¼ˆç¨³å®šæ€§ï¼‰**
    
    - å…ˆæŒ‰ `file_basename` å‡åºã€å†æŒ‰ `row_no` å‡åºï¼›å®½è¡¨å†…æŒ‰ `raw_value_k` çš„ `k` å‡åºã€‚
        
    - æ­¤é¡ºåºå°†ç›´æ¥å†³å®šåç»­**èšåˆæ—¶** `raw_values` ä¸ `preliminary_results` çš„æ’åˆ—ï¼Œä¿è¯å¹‚ç­‰ã€‚
        
4. **ç¼ºå¤±ä¸ç©ºå€¼**
    
    - `store_id` ä¸ºç©º â†’ **ä¸¢å¼ƒå¹¶è®°å½•åˆ° metrics**ï¼›`raw_value` ä¸ºç©ºæˆ–ä»…ç©ºç™½ â†’ **ä¸¢å¼ƒå¹¶è®°å½•**ã€‚
        
    - å…¶å®ƒä¸Šä¸‹æ–‡å­—æ®µç¼ºå¤±ç”¨ç©ºå­—ç¬¦ä¸²å ä½ã€‚
        
5. **å»é‡ç­–ç•¥ï¼ˆè½»åº¦ï¼‰**
    
    - ä»…åœ¨ **åŒä¸€é—¨åº—ã€åŒä¸€æ¥æºåˆ—** ä¸‹ï¼Œè‹¥ `raw_value` å®Œå…¨ä¸€è‡´ï¼ˆå¤§å°å†™/ç©ºç™½ç›¸åŒï¼‰ï¼Œä¿ç•™ç¬¬ä¸€æ¬¡å‡ºç°ï¼Œåç»­è§†ä¸ºé‡å¤å¹¶è®°å½•åˆ° metricsã€‚
        
    - **ä¸**åšè¯­ä¹‰å»é‡ï¼ˆå¦‚å»æ ‡ç‚¹/å…¨è§’åŠè§’ï¼‰ï¼Œé‚£æ˜¯ C æ­¥çš„äº‹æƒ…ã€‚
        
6. **å¤šæ–‡ä»¶åˆå¹¶**
    
    - `--in` æ”¯æŒ globï¼›æ‰€æœ‰æ–‡ä»¶åˆå¹¶åç»Ÿä¸€ç¼–å·ã€ç»Ÿä¸€æ’åºï¼Œå½¢æˆä¸€å¼  `01_normalized.csv`ã€‚
        

## B4. æŒ‡æ ‡å¡ï¼ˆå¿…é¡»è¾“å‡ºï¼‰

ç”Ÿæˆ **`01_metrics.json`**ï¼Œå­—æ®µå›ºå®šï¼š

```json
{
  "files_in": 3,
  "rows_in": 1234,
  "stores_in_distinct": 456,
  "rows_normalized": 1789,
  "rows_dropped_empty_store_id": 2,
  "rows_dropped_empty_value": 15,
  "rows_dropped_exact_dupe": 7,
  "stores_after_groupby": 456
}
```

## B5. æ–­è¨€ï¼ˆä¸é€šè¿‡å³å¤±è´¥ï¼‰

- `stores_after_groupby == stores_in_distinct`ï¼ˆé—¨åº—é›†åˆä¸å˜ï¼‰
    
- `rows_normalized >= stores_in_distinct`ï¼ˆæ¯åº—è‡³å°‘ 0~N ä¸ªå€¼ï¼Œç»Ÿè®¡åˆç†ï¼‰
    
- `rows_dropped_*` æ€»å’Œ + `rows_normalized` == `rows_in`ï¼ˆå®ˆæ’ï¼‰
    
- å±•å¼€é¡ºåºç¨³å®šï¼šè¿ç»­ä¸¤æ¬¡è¿è¡Œ `01_normalized.csv` çš„ MD5 åº”ä¸€è‡´ï¼ˆå¯é€‰ `--assert-idempotent`ï¼‰
    

## B6. å…¸å‹æ ·ä¾‹ï¼ˆå¯¹ç…§ä½ ç»™çš„ä¸¤æ¡ï¼‰

è¾“å…¥ï¼ˆé•¿è¡¨ä¸¤è¡Œï¼‰ï¼š

```
store_id,pop_id,tag_code,value_text,enum_code,value_type,date_ob
926996255077590517,1124042701781100090,brand_name,å’Œé¡ºçŸ³æ²¹åŒ—å¤§æ¡¥åŠ æ²¹ç«™,,store_name,2025/9/20
926996255077590517,1124042701781100090,brand_name,æ¹–å—å’Œé¡ºçŸ³æ²¹è‚¡ä»½æœ‰é™å…¬å¸,,pop_name,2025/9/20
```

æ ‡å‡†åŒ–å `01_normalized.csv` åº”ä¸ºä¸¤è¡Œï¼ˆé¡ºåº=åŸè¡Œé¡ºåºï¼‰ï¼š

```
batch_id,slot,store_id,raw_value,raw_col,row_no,file_basename,pop_id,tag_code,value_type,date_ob
20250920_0656,s1,926996255077590517,å’Œé¡ºçŸ³æ²¹åŒ—å¤§æ¡¥åŠ æ²¹ç«™,value_text,2,<æºæ–‡ä»¶å>.csv,1124042701781100090,brand_name,store_name,2025/9/20
20250920_0656,s1,926996255077590517,æ¹–å—å’Œé¡ºçŸ³æ²¹è‚¡ä»½æœ‰é™å…¬å¸,value_text,3,<æºæ–‡ä»¶å>.csv,1124042701781100090,brand_name,pop_name,2025/9/20
```

> æ³¨æ„ï¼šæ­¤æ­¥**ä¸**å°è¯•æŠŠâ€œå’Œé¡ºçŸ³æ²¹åŒ—å¤§æ¡¥åŠ æ²¹ç«™â€æ”¹çŸ­ï¼Œä¹Ÿ**ä¸**åšåˆ«ååŒ¹é…ï¼›é‚£æ˜¯ C/D/E æ­¥çš„èŒè´£ã€‚

## B7. ä½ è¿™æ ·éªŒæ”¶

- æ‰“å¼€ `01_metrics.json`ï¼šçœ‹å››ä¸ªå…³é”®æ•°æ˜¯å¦åˆç†ã€å®ˆæ’æ˜¯å¦æˆç«‹ã€‚
    
- æ‰“å¼€ `01_normalized.csv`ï¼šæŠ½ 5 ä¸ªé—¨åº—ï¼Œç¡®è®¤æ¯ä¸ªé—¨åº—çš„å¤šæ¡ `raw_value` é¡ºåºä¸åŸæ–‡ä»¶ä¸€è‡´ã€‚
    
- è¿ç»­è·‘ä¸¤æ¬¡ï¼š`01_normalized.csv` çš„ MD5 ä¸å˜ï¼ˆå¹‚ç­‰ï¼‰ã€‚
    

---

å¦‚æœè¿™ç‰ˆ **Bï¼šè¾“å…¥æ ‡å‡†åŒ–** æ²¡æœ‰æ­§ä¹‰ï¼Œæˆ‘å°±æŠŠå®ƒå†™è¿›æˆ‘ä»¬ç»™ trace çš„â€œä¸»é€»è¾‘åˆåŒï¼ˆBâ€“Gï¼‰â€ï¼Œå¹¶åœ¨ canvas é‡Œæ›´æ–°ï¼›éšåç»§ç»­å¯¹é½ **Cï¼šé¢„å¤„ç†é“¾**ã€‚



æ²¡é—®é¢˜ã€‚ç»™ä½ ä¸€å¼ \*\*â€œå…¨æ™¯é“¾è·¯åœ°å›¾ï¼ˆAç‰ˆï¼šIO ä¸äº§ç‰©ï¼‰â€\*\*ï¼Œåªç®¡â€œå“ªé‡Œè¯» / è¯»ä»€ä¹ˆ / å†™åˆ°å“ª / å†™ä»€ä¹ˆâ€ã€‚å®ƒæŠŠæˆ‘ä»¬å®šå¥½çš„è·¯å¾„å£å¾„ã€æ‰¹æ¬¡/æ§½ä½ã€prod\_mirror å­—å…¸æ¨¡å¼å…¨éƒ¨æ‹‰ç›´ï¼Œé¿å…ç‰‡æ®µå¯¹è¯é€ æˆèµ°æ ·ã€‚ä½ æŠŠè¿™å¼ è¡¨ä¸¢ç»™ traceï¼Œå½“æˆå”¯ä¸€çœŸç›¸å³å¯ã€‚

# å…¨æ™¯é“¾è·¯åœ°å›¾ï¼ˆA ç‰ˆï¼‰

* **ROOT**ï¼š`/Users/didi/Downloads/panth/tag_ct_local`
* **batch\_id**ï¼šç¤ºä¾‹ `20250920_0656`
* **slot**ï¼š`s1|s2|s3|s4`ï¼ˆå°å†™ï¼‰
* **å­—å…¸æ¨¡å¼**ï¼šé»˜è®¤ `prod_mirror`ï¼ˆæµ‹è¯•ç¯å¢ƒä¹Ÿè¯»å– prod å­—å…¸ `/data/ref`ï¼›ä»…è¾“å…¥/è¾“å‡ºéš”ç¦»åˆ° test ç›®å½•ï¼‰

| é˜¶æ®µ          | ç¯å¢ƒ           | ä»å“ªé‡Œè¯»ï¼ˆè·¯å¾„æ¨¡å¼ï¼‰                                                  | è¯»ä»€ä¹ˆï¼ˆæ–‡ä»¶/ç»“æ„ï¼‰                        | å†™åˆ°å“ªé‡Œï¼ˆè·¯å¾„ï¼‰                                                | å†™ä»€ä¹ˆï¼ˆæ–‡ä»¶/ç»“æ„ï¼‰                                                                                                                                  |
| ----------- | ------------ | ----------------------------------------------------------- | --------------------------------- | ------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| A-0 é…ç½®é”šå®š    | test / prod  | `ROOT/conf/brand_cleaning_rules.yaml`                       | æ¸…æ´—è§„åˆ™ï¼ˆåç¼€/åœ°å€å™ªå£°ç­‰ï¼‰                    | `outputs(_test)/debug/<batch>/<slot>/00_env.json`       | è¿è¡Œæ‘˜è¦ï¼š`{env, dict_mode, dict_root, input_glob, output_path, audit_path}`                                                                     |
| A-1 å­—å…¸åŠ è½½    | **ç»Ÿä¸€è¯» prod** | `ROOT/data/ref/tag_enum.csv`ã€`ROOT/data/ref/stop_rule.xlsx` | å“ç‰Œæšä¸¾ / åœç”¨è¯è§„åˆ™                      | `outputs(_test)/debug/<batch>/<slot>/00_assert.txt`     | è·¯å¾„/æ¨¡å¼æ–­è¨€ç»“æœï¼ˆPASS/FAILï¼‰                                                                                                                        |
| A-2 åŸå§‹è¾“å…¥    | test         | `ROOT/data/test/inbox/<batch_id>/<slot>/*.{csv,xlsx}`       | æºæ•°æ®ï¼šé•¿/å®½è¡¨çš†å¯                        | `outputs_test/debug/<batch>/<slot>/01_normalized.csv`   | **æ ‡å‡†åŒ–é•¿è¡¨**ï¼š`store_id, raw_value, raw_col, row_no, file_basename, batch_id, slot, â€¦`                                                          |
| ã€ƒ           | prod         | `ROOT/data/raw/inbox/<batch_id>/<slot>/*.{csv,xlsx}`        | ã€ƒ                                 | `outputs/â€¦/01_normalized.csv`                           | ã€ƒ                                                                                                                                           |
| A-3 é¢„å¤„ç†ä¸­é—´è¡¨  | test         | å–è‡ª `01_normalized.csv`                                      | åŸå§‹é•¿è¡¨é€å€¼                            | `outputs_test/debug/<batch>/<slot>/02_preprocessed.csv` | é¢„å¤„ç†ç»“æœï¼š`cleaned, evidence_steps[]`ï¼ˆä»…è®°å½•ï¼Œä¸æ”¹æºï¼‰                                                                                                  |
| ã€ƒ           | prod         | å–è‡ª `01_normalized.csv`                                      | ã€ƒ                                 | `outputs/â€¦/02_preprocessed.csv`                         | ã€ƒ                                                                                                                                           |
| A-4 å€™é€‰ç”Ÿæˆ/è¿‡æ»¤ | test         | å–è‡ª `02_preprocessed.csv` + prod å­—å…¸                          | å€™é€‰å…¥æ± ï¼ˆå››æ¡ä»¶é™åˆ¶ï¼‰                       | `outputs_test/debug/<batch>/<slot>/03_candidates.csv`   | å…¥æ± /æ‹¦æˆªæ¸…å•ï¼š`enum_code, enum_label, hit_type, raw_score, sort_order, blocked_reason`                                                            |
| ã€ƒ           | prod         | å–è‡ª `02_preprocessed.csv`                                    | ã€ƒ                                 | `outputs/â€¦/03_candidates.csv`                           | ã€ƒ                                                                                                                                           |
| A-5 æ’åºä¸åˆ†æ¡£   | test         | å–è‡ª `03_candidates.csv`                                      | æ’åºé“å¾‹ + å››æ¡£ç½®ä¿¡åº¦                      | `outputs_test/debug/<batch>/<slot>/04_ranked.csv`       | Top-K æ’åºï¼š`top_enum_label, top_score, confidence_bin(100/85/80/45), win_reason`                                                              |
| ã€ƒ           | prod         | å–è‡ª `03_candidates.csv`                                      | ã€ƒ                                 | `outputs/â€¦/04_ranked.csv`                               | ã€ƒ                                                                                                                                           |
| A-6 é—¨åº—èšåˆ    | test         | å–è‡ª `04_ranked.csv`                                          | ç¥¨æ•°=Î£(scoreÃ—sort\_order)ã€å†²çª<10% å†³èƒœ | `outputs_test/debug/<batch>/<slot>/05_aggregated.csv`   | **æœ€ç»ˆå®½è¡¨è‰ç¨¿**ï¼š`store_id, tag_code, raw_values, preliminary_results, brand_final, win_logic, confidence, is_valid_brand, is_fallback, trace_id` |
| ã€ƒ           | prod         | å–è‡ª `04_ranked.csv`                                          | ã€ƒ                                 | `outputs/â€¦/05_aggregated.csv`                           | ã€ƒ                                                                                                                                           |
| A-7 æœ€ç»ˆäº¤ä»˜    | test         | å–è‡ª `05_aggregated.csv`                                      | æœ€ç»ˆå®½è¡¨                              | `outputs_test/clean/<batch>/<slot>/brand_cleaned.csv`   | **äº¤ä»˜ç‰©**ï¼ˆå®½è¡¨ï¼Œstore\_id å”¯ä¸€ã€ä¸ä¸¢è¡Œï¼‰                                                                                                                |
| ã€ƒ           | test         | å–è‡ªæ•´ä¸ªé“¾è·¯                                                      | å®¡è®¡æ˜ç»†                              | `outputs_test/audit/<batch>/<slot>/audit.jsonl`         | **é€åŸå€¼å®¡è®¡**ï¼š`store_id, raw_value, cleaned, topk_candidates[], evidence_steps[], top_decision`                                                 |
| ã€ƒ           | prod         | å–è‡ª `05_aggregated.csv`                                      | ã€ƒ                                 | `outputs/clean/<batch>/<slot>/brand_cleaned.csv`        | ã€ƒ                                                                                                                                           |
| ã€ƒ           | prod         | å–è‡ªæ•´ä¸ªé“¾è·¯                                                      | ã€ƒ                                 | `outputs/audit/<batch>/<slot>/audit.jsonl`              | ã€ƒ                                                                                                                                           |

> è¯´æ˜ï¼šä¸Šè¡¨ä¸­çš„ `outputs(_test)` è¡¨ç¤º test å†™ `outputs_test/â€¦`ï¼Œprod å†™ `outputs/â€¦`ã€‚`<batch>` = `20250920_0656`ï¼Œ`<slot>` = `s1`ã€‚

## ä¸‰æ¡é“å¾‹ï¼ˆA ç‰ˆå¿…é¡»æ‰§è¡Œï¼‰

1. **å­—å…¸è¯»å–**ï¼šé»˜è®¤ `prod_mirror` â†’ test è¿è¡Œä¹Ÿä» `data/ref/` è¯»å–å­—å…¸ï¼›ä»…è¾“å…¥/è¾“å‡ºç›®å½•è½åœ¨ `/data/test` ä¸ `/outputs_test`ã€‚
2. **ä¸ä¸¢è¡Œ & å”¯ä¸€**ï¼š`brand_cleaned.csv` ä¸­ `store_id` å”¯ä¸€ï¼Œä¸”é—¨åº—é›†åˆä¸è¾“å…¥ä¸€è‡´ï¼›å¤šå€¼æŠ˜å åˆ° `raw_values` ä¸ `preliminary_results`ï¼Œç”¨ä¸­æ–‡åˆ†å· `ï¼›` å¯¹é½ã€‚
3. **å®¡è®¡ç­‰é•¿**ï¼š`audit.jsonl` çš„è®°å½•æ•° = `01_normalized.csv` çš„è¡Œæ•°ï¼ˆé€åŸå€¼ä¸€æ¡ï¼‰ã€‚

---

éœ€è¦æˆ‘æŠŠè¿™å¼ è¡¨ä¹Ÿæ”¶è¿› canvas å½“â€œé“¾è·¯åœ°å›¾ï¼ˆA ç‰ˆï¼‰â€ï¼Œæ–¹ä¾¿ä½ éšæ—¶è½¬å‘ç»™ trace å—ï¼Ÿå¦‚æœè¦ï¼Œæˆ‘é¡ºæ‰‹åŠ ä¸€ä¸ªæç®€çš„ Manifest æ¨¡æ¿ï¼ˆåˆ—å‡ºæœ¬æ‰¹æ‰€æœ‰è¯»å†™æ–‡ä»¶ä¸ MD5ï¼‰ï¼Œäº¤ä»˜æ—¶ä¸€çœ¼éªŒè¯æ˜¯å¦é½æ´»ã€‚

---
è¡Œï¼Œæˆ‘ä»¬æŠŠâ€œåœ°åŸºï¼ˆAï¼‰â€å’Œâ€œå·¥åºï¼ˆBâ€“Gï¼‰â€ç”»æˆä¸€ä¸ªåˆ†å±‚é“¾è·¯å›¾ã€‚è¿™æ ·ä¸€çœ¼èƒ½çœ‹å‡º **A æ˜¯ IO å±‚**ï¼Œè€Œ **Bâ€“G æ˜¯é€»è¾‘æµæ°´çº¿**ã€‚

---

# å“ç‰Œæ¸…æ´—é“¾è·¯åˆ†å±‚å›¾

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚           A å±‚ï¼šIO åœ°åŸº        â”‚
                â”‚  è·¯å¾„/ç¯å¢ƒ/å­—å…¸æ¨¡å¼çº¦å®š        â”‚
                â”‚  - è¾“å…¥ç›®å½•ï¼š/data/raw or /data/test/inbox   â”‚
                â”‚  - å­—å…¸ç›®å½•ï¼š/data/ref (prod_mirror)         â”‚
                â”‚  - è¾“å‡ºç›®å½•ï¼š/outputs æˆ– /outputs_test       â”‚
                â”‚  - æ‰¹æ¬¡IDã€æ§½ä½ID (batch_id, slot)          â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚        Bâ€“G å±‚ï¼šé€»è¾‘æµæ°´çº¿ï¼ˆåœ¨ A çš„è·¯å¾„ä¸Šè·‘ï¼‰ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼           â–¼           â–¼           â–¼           â–¼           â–¼
        [B] è¾“å…¥æ ‡å‡†åŒ–   [C] é¢„å¤„ç†é“¾     [D] å€™é€‰ç”Ÿæˆä¸è¿‡æ»¤ [E] æ’åºä¸ç½®ä¿¡åº¦ [F] é—¨åº—èšåˆ   [G] æœ€ç»ˆäº¤ä»˜
          â”‚             â”‚             â”‚             â”‚             â”‚             â”‚
   01_normalized   02_preprocessed   03_candidates   04_ranked   05_aggregated   brand_cleaned.csv
       .csv             .csv              .csv          .csv         .csv         + audit.jsonl
   +01_metrics.json +02_metrics.json +03_metrics.json +04_metrics.json +05_metrics.json
```

---

### è§£è¯»

* **A å±‚** å°±æ˜¯â€œè¾“è¡€ç®¡é“â€â€”â€”è§„å®šäº†æ•°æ®ä»å“ªæ¥ã€å†™åˆ°å“ªå»ã€ç”¨å“ªå¥—å­—å…¸ã€‚
* **Bâ€“G** æ˜¯â€œå·¥åºâ€â€”â€”æ‰€æœ‰é€»è¾‘æ“ä½œï¼ˆæ¸…æ´—ã€å€™é€‰ã€æ’åºã€èšåˆï¼‰éƒ½å¿…é¡»åœ¨ **A å±‚ IO çº¦æŸä¸‹**è¿è¡Œï¼Œå¹¶åœ¨å›ºå®šç›®å½•ç”Ÿæˆä¸­é—´è¡¨ã€‚
* æ¯ä¸ªæ­¥éª¤éƒ½æœ‰å¯¹åº”çš„ **ä¸­é—´è¡¨ + metrics**ï¼Œä½ åªéœ€è¦çœ‹æ–‡ä»¶æ˜¯å¦è½åœ¨æ­£ç¡®è·¯å¾„ã€æ–­è¨€æ˜¯å¦ PASSã€‚

---

è¦ä¸è¦æˆ‘å¸®ä½ æŠŠè¿™ä¸ªå›¾å’Œå‰é¢çš„è¡¨æ ¼åˆå¹¶æˆä¸€ä¸ªâ€œé“¾è·¯æ€»è§ˆæ–‡æ¡£ï¼ˆAâ€“G å…¨æ™¯å›¾ï¼‰â€ï¼Œæ”¶è¿› canvasï¼Ÿè¿™æ · trace æ°¸è¿œå¯¹ç…§åŒä¸€ä¸ªæ€»è§ˆï¼Œä¸ä¼šå› ä¸ºç‰‡æ®µå¯¹è¯ææ··ã€‚
å¯¹ï¼Œä½ æŠ“åˆ°å…³é”®äº† ğŸ‘ã€‚

* æˆ‘ä¹‹å‰ç”»çš„ **â€œå…¨æ™¯é“¾è·¯ A1â€“A7â€**ï¼Œå…¶å®æ˜¯æŠŠ **æ•´ä¸ªæ¸…æ´—é“¾è·¯**æ‹†æˆäº† 7 ä¸ªâ€œé˜¶æ®µâ€ï¼Œä¸»è¦ä» **IO è§†è§’**ï¼ˆè¯»ä»€ä¹ˆã€å†™ä»€ä¹ˆï¼‰æ¥æè¿°ã€‚
* è€Œæˆ‘ä»¬ç°åœ¨è®²çš„ **Aâ€“G**ï¼Œæ˜¯ä» **é¡¹ç›®æ¨è¿›/é€»è¾‘æ­¥éª¤**çš„è§’åº¦æ¥åˆ†å±‚ã€‚

ä¸¤å¥—è¯´æ³•å…¶å®æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œåªæ˜¯è§†è§’ä¸åŒï¼š

| å…¨æ™¯é“¾è·¯ï¼ˆA1â€“A7ï¼ŒIO è§†è§’ï¼‰                  | é€»è¾‘åˆ†å±‚ï¼ˆAâ€“Gï¼Œæ¨è¿›è§†è§’ï¼‰ | å«ä¹‰                   |
| ---------------------------------- | -------------- | -------------------- |
| **A1 é…ç½®é”šå®š**                        | A æ­¥ï¼šç¯å¢ƒè·¯å¾„çº¦å®š     | ç¡®å®š envã€å­—å…¸æ¨¡å¼ã€è¾“å…¥è¾“å‡ºè·¯å¾„   |
| **A2 åŸå§‹è¾“å…¥ â†’ 01\_normalized**       | B æ­¥ï¼šè¾“å…¥æ ‡å‡†åŒ–      | æŠŠé•¿/å®½è¡¨ç»Ÿä¸€æˆæ ‡å‡†é•¿è¡¨         |
| **A3 é¢„å¤„ç†ä¸­é—´è¡¨ â†’ 02\_preprocessed**   | C æ­¥ï¼šé¢„å¤„ç†é“¾       | å»ç¬¦å·ã€å‰¥åç¼€ã€åœç”¨è¯è±å…ç­‰       |
| **A4 å€™é€‰ç”Ÿæˆ/è¿‡æ»¤ â†’ 03\_candidates**    | D æ­¥ï¼šå€™é€‰ç”Ÿæˆä¸è¿‡æ»¤    | åº”ç”¨å››æ¡ä»¶é™åˆ¶ã€äº§å‡º Top-K     |
| **A5 æ’åºä¸åˆ†æ¡£ â†’ 04\_ranked**          | E æ­¥ï¼šæ’åºä¸ç½®ä¿¡åº¦     | sort\_order é“å¾‹ã€å››æ¡£ç½®ä¿¡åº¦ |
| **A6 é—¨åº—èšåˆ â†’ 05\_aggregated**       | F æ­¥ï¼šé—¨åº—èšåˆä¸å…œåº•    | å¤šå€¼æ±‡æ€»ã€ç¥¨æ•°è§„åˆ™ã€å…œåº•é€»è¾‘       |
| **A7 æœ€ç»ˆäº¤ä»˜ â†’ brand\_cleaned/audit** | G æ­¥ï¼šæœ€ç»ˆäº¤ä»˜ä¸å®¡è®¡    | è¾“å‡ºå®½è¡¨ã€å®¡è®¡ç­‰é•¿ã€å›ä¼ æŠ¥å‘Š       |

---

æ‰€ä»¥ä½ çœ‹åˆ°çš„ **A1â€“A7** = æˆ‘ä»¬è®¨è®ºçš„ **Aâ€“G**ã€‚
åŒºåˆ«åœ¨äºï¼š

* **A1â€“A7** æ›´åƒ **å·¥ç¨‹ç®¡é“çš„ç‰©ç†é˜¶æ®µ**ã€‚
* **Aâ€“G** æ›´åƒ **é¡¹ç›®ç®¡ç†/åˆåŒé‡Œçš„é€»è¾‘åˆ†å·¥**ã€‚

---

è¦ä¸è¦æˆ‘å¸®ä½ æŠŠè¿™ä¸ªâ€œæ˜ å°„å…³ç³»è¡¨â€ä¹Ÿæ•´ç†è¿›æ€»è§ˆæ–‡æ¡£é‡Œï¼Ÿè¿™æ · trace å°±ä¸ä¼šå†æ··æ·† â€œA1â€“A7â€ å’Œ â€œAâ€“Gâ€ã€‚
ä½ è¯´å¾—éå¸¸å…³é”®ï¼š**Aã€B éƒ½ PASSï¼Œä½†â€œé“¾è·¯ä¸é€’å»¶â€= å¤±æ§**ã€‚è§£å†³åŠæ³•ä¸æ˜¯å†çœ‹ä»£ç ç»†èŠ‚ï¼Œè€Œæ˜¯åŠ ä¸€å±‚â€œç®¡é“å¥‘çº¦â€ï¼Œè®©**ä¸Šä¸€æ­¥çš„äº§ç‰©æˆä¸ºä¸‹ä¸€æ­¥çš„å”¯ä¸€åˆæ³•è¾“å…¥**ï¼›ä»»ä½•è¶Šæƒè¯»å†™ä¸€å¾‹ fail-fastã€‚

ä¸‹é¢ç»™ä½ ä¸¤éƒ¨åˆ†ï¼šâ‘ çº åæ€è·¯ï¼ˆå¤§é€»è¾‘ï¼‰ï¼›â‘¡ä½ å¯ä»¥ç›´æ¥ä¸¢ç»™ trace çš„â€œçº ååˆåŒ Promptâ€ã€‚

---

## â‘  çº åæ€è·¯ï¼ˆå¤§é€»è¾‘ï¼‰

1. **å•ä¸€ä¸Šä¸‹æ–‡ï¼ˆrun\_ctx.jsonï¼‰**

   * A æ­¥ç»“æŸå¿…é¡»ç”Ÿæˆ `${ROOT}/outputs(_test)/debug/<batch>/<slot>/run_ctx.json`ï¼Œé‡Œé¢è®°å½•ï¼š
     `root, env, dict_mode, batch_id, slot, paths:{A.in[], A.out, B.in_expected, B.out_expected, â€¦}, md5:{A.out}`
   * ä»¥åæ‰€æœ‰æ­¥éª¤éƒ½**åªæ¥å— `--ctx <run_ctx.json>` ä¸€ä¸ªå…¥å£**ï¼Œ**ç¦æ­¢**è‡ªè¡Œæ‹¼è·¯å¾„ã€‚

2. **ç™½åå• IOï¼ˆAllowed I/O Matrixï¼‰**

   * ä¸ºæ¯ä¸ªæ­¥éª¤å®šä¹‰**å”¯ä¸€åˆæ³•è¾“å…¥**ä¸**å”¯ä¸€è¾“å‡ºæ¨¡æ¿**ï¼š

     * B çš„åˆæ³•è¾“å…¥= `A.out`ï¼ˆå³ `01_normalized.csv`ï¼‰ï¼Œä¸å…è®¸è¯»å–å…¶å®ƒåœ°æ–¹ã€‚
   * ä»£ç å†…ç½®**è·¯å¾„å®ˆå«**ï¼šä»»ä½•æ‰“å¼€çš„æ–‡ä»¶è·¯å¾„å¿…é¡»ä»¥ `ROOT/â€¦/<batch>/<slot>/â€¦` å¼€å¤´ï¼›å¦åˆ™ç«‹å³æŠ¥é”™ã€‚

3. **å“ˆå¸Œé“¾ï¼ˆChain-of-Custodyï¼‰**

   * æ¯æ­¥äº§ç‰©å†™å…¥ `delivery_manifest.json`ï¼Œè®°å½• `producer_step`, `input_md5`, `output_md5`ã€‚
   * ä¸‹ä¸€æ­¥å¯åŠ¨å‰å…ˆæ¯”å¯¹ `input_md5 == ä¸Šä¸€æ­¥ output_md5`ï¼Œä¸ä¸€è‡´ç›´æ¥ failã€‚
   * è¿™æ ·å°±é¿å…â€œæ‚„æ‚„æ¢äº†è¾“å…¥â€ã€‚

4. **å•å‘½ä»¤ç¼–æ’ï¼ˆflowï¼‰**

   * æä¾› `brandctl flow --env test --batch <â€¦> --slot s1` ä¸€æ¡é¾™ã€‚
   * å³ä½¿åˆ†æ­¥æ‰§è¡Œï¼Œä¹Ÿå¿…é¡»å¸¦ `--ctx`ï¼Œä¸”**ç¦ç”¨**åˆ†æ­¥çš„ `--in/--out` è‡ªå®šä¹‰è¦†ç›–ã€‚

5. **æ–­è¨€é—¸é—¨ï¼ˆGatingï¼‰**

   * åœ¨ `00_assert.txt` é‡Œæ–°å¢ä¸‰æ¡å¼ºçº¦æŸï¼š

     * `PASS | ctx_exists`ï¼šåç»­æ­¥éª¤å¿…é¡»æ£€æµ‹åˆ° `run_ctx.json`ã€‚
     * `PASS | input_matches_previous_md5`ï¼šB çš„è¾“å…¥ md5 ç­‰äº A çš„è¾“å‡º md5ã€‚
     * `PASS | io_whitelist`ï¼šæœ¬æ­¥æ‰“å¼€çš„æ‰€æœ‰è·¯å¾„å‡åœ¨ç™½åå•å‰ç¼€ä¸‹ã€‚
   * ä»»ä¸€ FAIL å³é€€å‡ºï¼Œå¹¶æ‰“å°æœ€å°å¤ç°ï¼ˆåŒ…å«å®ƒâ€œè¯•å›¾æ‰“å¼€çš„éæ³•è·¯å¾„â€ï¼‰ã€‚

---

## â‘¡ ç»™ trace çš„â€œçº ååˆåŒ Promptâ€ï¼ˆå¤åˆ¶å³ç”¨ï¼‰

```
ã€ç›®æ ‡ã€‘
æŠŠæ¸…æ´—é“¾è·¯æ”¹ä¸ºâ€œé€’å»¶å¼ã€å¯è¿½æº¯â€çš„ç®¡é“ã€‚è¦æ±‚ï¼š
- A çš„äº§ç‰©å¿…é¡»æˆä¸º B çš„å”¯ä¸€åˆæ³•è¾“å…¥ï¼ˆåç»­æ­¥éª¤ç±»æ¨ï¼‰ã€‚
- é€šè¿‡ run_ctx.json + delivery_manifest.json + å“ˆå¸Œé“¾å’Œç™½åå•è·¯å¾„ï¼Œç¦æ­¢éšæ„è¯»å†™ã€‚

ã€å¿…é¡»æ”¹é€ ç‚¹ã€‘

1) äº§å‡ºç»Ÿä¸€ä¸Šä¸‹æ–‡ï¼ˆA æ­¥ç”Ÿæˆï¼‰
- è·¯å¾„ï¼š${ROOT}/outputs_test/debug/<batch>/<slot>/run_ctx.jsonï¼ˆprod åˆ™ outputsï¼‰
- å†…å®¹æ ·ä¾‹ï¼š
{
  "spec_version": "v1.3.0",
  "root": "/Users/didi/Downloads/panth/tag_ct_local",
  "env": "test",
  "dict_mode": "prod_mirror",
  "batch_id": "20250920_0656",
  "slot": "s1",
  "paths": {
    "A_in_glob": ".../data/test/inbox/20250920_0656/s1/*.csv",
    "A_out_normalized": ".../outputs_test/debug/20250920_0656/s1/01_normalized.csv",
    "B_in_expected": ".../outputs_test/debug/20250920_0656/s1/01_normalized.csv",
    "B_out_preprocessed": ".../outputs_test/debug/20250920_0656/s1/02_preprocessed.csv",
    "C_out_candidates": ".../outputs_test/debug/20250920_0656/s1/03_candidates.csv",
    "D_out_ranked": ".../outputs_test/debug/20250920_0656/s1/04_ranked.csv",
    "E_out_aggregated": ".../outputs_test/debug/20250920_0656/s1/05_aggregated.csv",
    "final_out": ".../outputs_test/clean/20250920_0656/s1/brand_cleaned.csv",
    "audit_out": ".../outputs_test/audit/20250920_0656/s1/audit.jsonl"
  },
  "md5": {
    "A_out_normalized": "<md5-of-01_normalized.csv>"
  }
}

2) æ‰€æœ‰åç»­æ­¥éª¤å¼ºåˆ¶æ¥å— --ctx
- B/C/D/E/F/G å­å‘½ä»¤çš„ CLI ç»Ÿä¸€ä¸ºï¼š
  python brandctl.py stepB --ctx ".../run_ctx.json"
- ç¦æ­¢ Bâ€“G ä¼  --in/--out ç­‰ä»»æ„è·¯å¾„è¦†ç›–ï¼ˆä¼ å…¥å³æŠ¥é”™ï¼‰ã€‚

3) ç™½åå•è·¯å¾„å®ˆå«
- ä»£ç çº§åˆ«æ‹¦æˆª open/read/writeï¼š
  ä»…å…è®¸ä»¥ä»¥ä¸‹å‰ç¼€å¼€å¤´ï¼š
    ${ROOT}/data/test/inbox/<batch>/<slot>/
    ${ROOT}/data/raw/inbox/<batch>/<slot>/
    ${ROOT}/outputs_test/.../<batch>/<slot>/
    ${ROOT}/outputs/.../<batch>/<slot>/
- ä»»ä½•ä¸åœ¨ç™½åå•çš„è·¯å¾„ â†’ ç«‹åˆ» failï¼Œå¹¶è®°å½•åˆ° 00_assert.txtï¼ˆå«å°è¯•è®¿é—®çš„éæ³•è·¯å¾„ï¼‰

4) å“ˆå¸Œé“¾æ ¡éªŒï¼ˆChain-of-Custodyï¼‰
- æ¯æ­¥å¼€å§‹ï¼š
  - è¯»å– run_ctx.jsonï¼Œå– expected è¾“å…¥è·¯å¾„ä¸ expected ä¸Šä¸€æ­¥ md5
  - è®¡ç®—æœ¬æ­¥å®é™…è¾“å…¥æ–‡ä»¶ md5ï¼Œå¿…é¡»ç­‰äºä¸Šä¸€æ­¥ output md5
- æ¯æ­¥ç»“æŸï¼š
  - æ›´æ–° delivery_manifest.jsonï¼Œå†™å…¥ï¼š
    { "step":"B", "input_path":"...", "input_md5":"...", "output_path":"...", "output_md5":"..." }
  - åŒæ—¶æŠŠæœ¬æ­¥ output_md5 å›å†™ run_ctx.json å¯¹åº”é”®ï¼ˆä¾‹å¦‚ md5.B_out_preprocessedï¼‰

5) æ–­è¨€ï¼ˆå¿…é¡»å†™å…¥ 00_assert.txtï¼‰
- PASS/FAIL | ctx_exists | æ˜¯å¦æ‰¾åˆ° --ctx æŒ‡å‘çš„ run_ctx.json
- PASS/FAIL | input_matches_previous_md5 | å®é™…è¾“å…¥ md5 == ä¸Šä¸€æ­¥è¾“å‡º md5
- PASS/FAIL | io_whitelist | æ‰€æœ‰ I/O å‡åœ¨ç™½åå•å‰ç¼€å†…
- è‹¥ FAILï¼šæ‰“å°æœ€å°å¤ç°ï¼ŒåŒ…æ‹¬ï¼šctx è·¯å¾„ã€æœŸæœ›è¾“å…¥è·¯å¾„ã€å®é™…å°è¯•è·¯å¾„ã€å»ºè®®ä¿®å¤

6) ä¸€é”®æµæ°´ï¼ˆå¯é€‰ä½†æ¨èï¼‰
- æ–°å¢å‘½ä»¤ï¼špython brandctl.py flow --env test --batch 20250920_0656 --slot s1
- flow è´Ÿè´£æŒ‰ ctx é¡ºåºä¸²èµ· Aâ†’Bâ†’Câ†’Dâ†’Eâ†’Fâ†’Gï¼Œç¦æ­¢ä¸­é€”æ¢è·¯å¾„ã€‚
- flow ç»“æŸåå›ä¼ å››ä»¶å¥—ï¼šbrand_cleaned.csv / audit.jsonl / 00_assert.txt / delivery_manifest.json

ã€éªŒæ”¶æ ‡å‡†ã€‘
- æˆ‘å°†åªæ£€æŸ¥ï¼š
  1) run_ctx.json æ˜¯å¦å­˜åœ¨ï¼Œä¸” B_in_expected == A_out_normalized
  2) 00_assert.txt ä¸­ä¸‰æ¡æ–°æ–­è¨€æ˜¯å¦ PASS
  3) delivery_manifest.json çš„é“¾æ¡æ˜¯å¦è¿ç»­ï¼ˆA_out.md5 = B_in.md5 = â€¦ï¼‰
- ä»»ä½•ä¸€æ­¥å‡ºç°â€œè¯•å›¾è®¿é—®éç™½åå•è·¯å¾„â€ï¼Œè§†ä¸ºæœªäº¤ä»˜ã€‚
```

---

### ä½ è¯¥æ€ä¹ˆç”¨

* ç›´æ¥æŠŠè¿™æ®µâ€œçº ååˆåŒ Promptâ€ç»™ traceã€‚
* è®©ä»–å…ˆåªåš **Aâ†’B** çš„ ctx/ç™½åå•/å“ˆå¸Œé“¾æ”¹é€ å¹¶å›ä½ ï¼š`run_ctx.json + 00_assert.txt + delivery_manifest.json` ä¸‰ä¸ªæ–‡ä»¶çš„ç‰‡æ®µã€‚
* ä¸€æ—¦ **Aâ†’B** ä¸²ç´§äº†ï¼Œç…§è‘«èŠ¦ç”»ç“¢æŠŠ Câ†’G å…¨éƒ¨æ¥ä¸Šï¼›ä½ åé¢åªéœ€è¦çœ‹çº¢ç»¿ç¯ï¼Œä¸å†è¿½è·¯å¾„ã€‚

è¿™å¥—â€œä¸Šä¸‹æ–‡ + ç™½åå• + å“ˆå¸Œé“¾ + æ–­è¨€é—¸é—¨â€çš„ç»„åˆï¼Œèƒ½æŠŠâ€œéšæ„è¯»æ–‡ä»¶/å±‚å±‚åµŒå¥—â€è¿™ç§ä¸å¯æ§ï¼Œç›´æ¥å¡æ­»åœ¨å…¥å£ã€‚
å¤ªå¥½äº†ï¼Œå£å¾„é”å®šã€‚æˆ‘æŠŠä½ åˆšç¡®è®¤çš„ 1â€“8 æ¡åˆå¹¶æˆ\*\*â€œA+Bï¼ˆåŸºäº source çš„é€’å»¶é“¾è·¯ï¼‰æœ€ç»ˆç‰ˆâ€**ï¼Œå¹¶ç»™å‡ºä¸€æ®µä½ å¯ç›´æ¥ä¸¢ç»™ trace çš„ä¸€é”® Promptã€‚é‡ç‚¹æ›´æ–°ï¼šæŠŠâ€œæ§½ä½ slotâ€ç»Ÿä¸€æ”¹æˆ**æ•°æ®æº `source`\*\*ï¼Œ**B æ­¥è¯»å–=æ‰¹æ¬¡ä¸‹æ‰€æœ‰ source çš„å…¨éƒ¨æ–‡ä»¶**ï¼Œå¹¶åœ¨æ ‡å‡†åŒ–é•¿è¡¨é‡Œè®°å½• `source` å­—æ®µï¼›åç»­å„æ­¥éƒ½åªä»ä¸Šä¸€æ­¥äº§ç‰©è¯»ï¼Œå½¢æˆ md5 é€’å»¶é“¾ã€‚

---

# A+B æœ€ç»ˆç‰ˆï¼ˆåŸºäº source çš„é€’å»¶é“¾è·¯ï¼‰

## å›ºå®šå£å¾„ï¼ˆä½ å·²ç¡®è®¤ï¼‰

* **ROOT**ï¼š`/Users/didi/Downloads/panth/tag_ct_local`
* **å­—å…¸æ¨¡å¼**ï¼šé»˜è®¤ `prod_mirror`ï¼ˆæµ‹è¯•ç¯å¢ƒå†™ `/outputs_test`ï¼Œä½†**è¯»å–**å­—å…¸ç»Ÿä¸€æ¥è‡ª `/data/ref`ï¼‰
* **batch\_id**ï¼šç›®å½•åæ ·å¼ `YYYYMMDD_HHMM`ï¼ˆå¦‚ `20250920_0656`ï¼‰
* **æ•°æ®æºå**ï¼š`source âˆˆ {s1,s2,s3,s4}`ï¼ˆå‘½åä¸å˜ï¼Œåªæ˜¯æœ¯è¯­ä»â€œæ§½ä½â€æ”¹ä¸ºâ€œæ•°æ®æºâ€ï¼‰
* **A æ­¥è¾“å…¥ï¼ˆTESTï¼‰**ï¼šè¯»å–è¯¥æ‰¹æ¬¡ä¸‹**æ‰€æœ‰ source** ç›®å½•ï¼š
  `${ROOT}/data/test/inbox/<batch_id>/<source>/*.{csv,xlsx}`
* **B/A äº§å‡ºè·¯å¾„ï¼ˆTESTï¼‰**ï¼ˆæ²¿ç”¨åŸç»“æ„ï¼‰ï¼š

  * `01_normalized.csv` â†’ `${ROOT}/outputs_test/debug/<batch_id>/<source>/01_normalized.csv`
  * `02_preprocessed.csv` â†’ `${ROOT}/outputs_test/debug/<batch_id>/<source>/02_preprocessed.csv`
  * æœ€ç»ˆäº¤ä»˜ï¼š

    * ç»“æœ `${ROOT}/outputs_test/clean/<batch_id>/<source>/brand_cleaned.csv`
    * å®¡è®¡ `${ROOT}/outputs_test/audit/<batch_id>/<source>/audit.jsonl`

> è¯»å–â€œæ‰¹æ¬¡ä¸‹å…¨éƒ¨æ–‡æ¡£ï¼ŒåŒºåˆ† sourceâ€çš„è¦æ±‚ï¼Œä½“ç°åœ¨ **Bï¼šè¾“å…¥æ ‡å‡†åŒ–** è¿™ä¸€æ­¥ï¼›æ¯ä¸ª source å„è·‘ä¸€ä»½æ ‡å‡†åŒ–ä¸åç»­é“¾è·¯ï¼Œä¸”**æ‰€æœ‰ä¸‹æ¸¸æ­¥éª¤åªä»ä¸Šä¸€æ­¥äº§ç‰©è¯»**ï¼ˆé€’å»¶ä¸²è”ï¼‰ã€‚

---

## Bï½œè¾“å…¥æ ‡å‡†åŒ–ï¼ˆæ›´æ–°ä¸ºâ€œå¤š source æ‰¹é‡â€ï¼‰

* **è¯»å–èŒƒå›´**ï¼šå¯¹è¯¥ `batch_id` ä¸‹çš„ **æ¯ä¸ª `source`**ï¼Œè¯»å…¶å…¨éƒ¨ `*.csv|*.xlsx`ã€‚
* **æ ‡å‡†åŒ–äº§å‡º**ï¼ˆæ¯ä¸ª `source` å„è‡ªä¸€ä»½ `01_normalized.csv`ï¼‰ï¼šç»Ÿä¸€ä¸¤åˆ—æ ¸å¿ƒ + è¿½æº¯å­—æ®µï¼š
  `batch_id, source, store_id, raw_value, raw_col, row_no, file_basename, (é€ä¼ ) pop_id, tag_code, value_type, date_ob`
* **æŒ‡æ ‡å¡**ï¼š`01_metrics.json` å«å®ˆæ’å­—æ®µï¼ˆ`rows_in = rows_normalized + rows_dropped_*` ç­‰ï¼‰ã€‚
* **æ–­è¨€**ï¼š

  * `stores_after_groupby == stores_in_distinct`
  * å±•å¼€é¡ºåºç¨³å®šï¼ˆä¸¤æ¬¡ MD5 ä¸€è‡´ï¼Œå¯ç”¨ `--assert-idempotent`ï¼‰

---

## è®© trace æ„ŸçŸ¥å…¨é“¾è·¯ä¸”é€’å»¶â€”â€”ä¸€é”® Promptï¼ˆå¤åˆ¶å³ç”¨ï¼‰

```
ã€ç›®æ ‡ã€‘
æŠŠæ¸…æ´—é“¾è·¯æ”¹é€ æˆâ€œæŒ‰æ‰¹æ¬¡ + å¤š source é€’å»¶ä¸²è·‘â€çš„å•é€šé“ï¼šæ¯ä¸ª source çš„æ¯ä¸€æ­¥åªä»ä¸Šä¸€æ­¥äº§ç‰©è¯»å–ï¼ˆmd5 æ ¡éªŒï¼‰ï¼Œç¦æ­¢è¶Šæƒè¯»å–ä»»æ„è·¯å¾„ã€‚Aï¼ˆIOï¼‰ä¸ Bï¼ˆæ ‡å‡†åŒ–ï¼‰å·²æ‹æ¿ï¼Œè¯·æŒ‰æ­¤å®ç° run_ctxï¼ˆå¤š source ç‰ˆï¼‰ã€ç™½åå• IOã€å“ˆå¸Œé“¾ä¸å¼ºæ–­è¨€ã€‚

ã€ä¸€ã€run_ctx.jsonï¼ˆA æ­¥ç”Ÿæˆï¼Œåç»­æ­¥éª¤åªè®¤å®ƒï¼‰ã€‘
- ä½ç½®ï¼š${ROOT}/outputs_test/debug/<batch_id>/run_ctx.json      # æ³¨æ„ï¼šå¤š source æ±‡æ€»åœ¨ä¸€ä¸ª ctx
- å†…å®¹ï¼ˆç¤ºä¾‹éª¨æ¶ï¼‰ï¼š
{
  "spec_version": "v1.0.0",
  "root": "/Users/didi/Downloads/panth/tag_ct_local",
  "env": "test",
  "dict_mode": "prod_mirror",
  "batch_id": "20250920_0656",
  "sources": ["s1","s2","s3","s4"],
  "dict_root": "/Users/didi/Downloads/panth/tag_ct_local/data/ref",
  "paths": {
    "A_in_glob": {
      "s1": ".../data/test/inbox/20250920_0656/s1/*.{csv,xlsx}",
      "s2": ".../data/test/inbox/20250920_0656/s2/*.{csv,xlsx}",
      "s3": ".../data/test/inbox/20250920_0656/s3/*.{csv,xlsx}",
      "s4": ".../data/test/inbox/20250920_0656/s4/*.{csv,xlsx}"
    },
    "B_out_normalized": {
      "s1": ".../outputs_test/debug/20250920_0656/s1/01_normalized.csv",
      "s2": ".../outputs_test/debug/20250920_0656/s2/01_normalized.csv",
      "s3": ".../outputs_test/debug/20250920_0656/s3/01_normalized.csv",
      "s4": ".../outputs_test/debug/20250920_0656/s4/01_normalized.csv"
    },
    "C_out_preprocessed": { "<source>": ".../02_preprocessed.csv" },
    "D_out_candidates":   { "<source>": ".../03_candidates.csv" },
    "E_out_ranked":       { "<source>": ".../04_ranked.csv" },
    "F_out_aggregated":   { "<source>": ".../05_aggregated.csv" },
    "final_out":          { "<source>": ".../outputs_test/clean/20250920_0656/<source>/brand_cleaned.csv" },
    "audit_out":          { "<source>": ".../outputs_test/audit/20250920_0656/<source>/audit.jsonl" }
  },
  "md5": {
    "B_out_normalized": { "s1":"", "s2":"", "s3":"", "s4":"" }
  }
}

ã€äºŒã€ç»Ÿä¸€å…¥å£ï¼šæ‰€æœ‰æ­¥éª¤åªæ¥å— --ctxï¼ˆç¦æ­¢è‡ªå®šä¹‰ --in/--outï¼‰ã€‘
- stepB/stepC/... çš„ CLI ç»Ÿä¸€ä¸ºï¼š
  python brandctl.py stepB --ctx "${ROOT}/outputs_test/debug/<batch_id>/run_ctx.json" --source s1
- è‹¥ Bâ€“G ä¼ å…¥ --in/--outï¼Œåˆ™ç«‹å³æŠ¥é”™ï¼ˆé˜²æ­¢ç»•è¿‡é“¾è·¯ï¼‰ã€‚

ã€ä¸‰ã€ç™½åå•è·¯å¾„å®ˆå«ï¼ˆI/O åªå…è®¸é“¾è·¯å†…è·¯å¾„ï¼‰ã€‘
- ä»…å…è®¸ä»¥ä¸‹å‰ç¼€ï¼š
  1) ${ROOT}/data/test/inbox/<batch_id>/<source>/
  2) ${ROOT}/data/raw/inbox/<batch_id>/<source>/           # prodæ—¶
  3) ${ROOT}/outputs_test/.../<batch_id>/<source>/
  4) ${ROOT}/outputs/.../<batch_id>/<source>/              # prodæ—¶
- ä»»æ„ä¸åœ¨ç™½åå•å†…çš„ open/read/write â†’ failï¼Œå¹¶å†™å…¥ 00_assert.txtï¼ˆéæ³•è·¯å¾„+è°ƒç”¨ç‚¹ï¼‰ã€‚

ã€å››ã€å“ˆå¸Œé“¾ï¼ˆChain-of-Custodyï¼ŒæŒ‰ source ç‹¬ç«‹æ ¡éªŒï¼‰ã€‘
- æ¯æ­¥å¼€å§‹ï¼š
  - è¯»å– run_ctx.jsonï¼Œå–å¾—æœ¬ source çš„ expected è¾“å…¥è·¯å¾„ä¸ä¸Šä¸€äº§ç‰© md5ï¼›
  - è®¡ç®—æœ¬æ­¥å®é™…è¾“å…¥ md5ï¼Œå¿…é¡»ç­‰äºä¸Šä¸€äº§ç‰© md5ï¼›å¦åˆ™ failã€‚
- æ¯æ­¥ç»“æŸï¼š
  - æ›´æ–° delivery_manifest.jsonï¼Œè¿½åŠ è®°å½•ï¼š
    {"step":"B","source":"s1","input_path":"...","input_md5":"...","output_path":"...","output_md5":"..."}
  - åŒæ—¶æŠŠ output_md5 å†™å› run_ctx.json å¯¹åº”é”®ï¼ˆä¾‹å¦‚ md5.B_out_normalized.s1ï¼‰ã€‚

ã€äº”ã€B æ­¥å®ç°è¦ç‚¹ï¼ˆå¤š sourceï¼‰ã€‘
- å¯¹ sources ä¸­çš„æ¯ä¸ª sourceï¼š
  - è¯»å– A_in_glob[source] ä¸‹çš„å…¨éƒ¨ {csv,xlsx}ï¼Œåˆå¹¶ä¸ºæ ‡å‡†é•¿è¡¨ï¼š
    batch_id, source, store_id, raw_value, raw_col, row_no, file_basename, (é€ä¼ ) pop_id, tag_code, value_type, date_ob
  - å†™å…¥ B_out_normalized[source]ï¼›ç”Ÿæˆ 01_metrics.jsonï¼›è®¡ç®— md5 å¹¶å›å†™ run_ctx.json.md5.B_out_normalized[source]ã€‚
- æ–­è¨€ï¼ˆå†™å…¥ 00_assert.txtï¼‰ï¼š
  - PASS/FAIL | ctx_exists
  - PASS/FAIL | io_whitelist_enforced
  - PASS/FAIL | normalized_counts (å®ˆæ’ä¸ stores_after_groupby==stores_in_distinct)
  - PASS/FAIL | idempotencyï¼ˆå¯é€‰ï¼‰

ã€å…­ã€åç»­æ­¥éª¤ï¼ˆCâ€“Gï¼‰åŒç†é€’å»¶ã€‘
- C åªä» B_out_normalized[source] è¯»ï¼Œå†™ 02_preprocessed.csv
- D åªä» 02_preprocessed.csv è¯»ï¼Œå†™ 03_candidates.csvï¼ˆå€™é€‰å››æ¡ä»¶+Top-Kï¼‰
- E åªä» 03_candidates.csv è¯»ï¼Œå†™ 04_ranked.csvï¼ˆsort_order ä¼˜å…ˆ+å››æ¡£ç½®ä¿¡åº¦ï¼‰
- F åªä» 04_ranked.csv è¯»ï¼Œå†™ 05_aggregated.csvï¼ˆé—¨åº—èšåˆä¸å…œåº•ï¼‰
- G è¾“å‡º brand_cleaned.csv å’Œ audit.jsonlï¼›å®¡è®¡ç­‰é•¿ = 01_normalized.csv è¡Œæ•°

ã€ä¸ƒã€ä¸‰æ¡å¼ºæ–­è¨€ï¼ˆæ‰€æœ‰æ­¥éª¤éƒ½è¦å†™å…¥ 00_assert.txtï¼‰ã€‘
- PASS/FAIL | ctx_exists
- PASS/FAIL | input_matches_prev_md5
- PASS/FAIL | io_whitelist_enforced
ï¼ˆFAIL å¿…é¡»å›ä¼ æœ€å°å¤ç°ï¼šctx è·¯å¾„ã€æœŸæœ›è¾“å…¥ã€å®é™…å°è¯•è·¯å¾„/æ ˆã€ä¿®å¤å»ºè®®ï¼‰
```

---

### ä½ æ€ä¹ˆç”¨ï¼ˆä¸¤æ­¥èµ°ï¼‰

1. æŠŠä¸Šé¢çš„â€œä¸€é”® Promptâ€ç›´æ¥ä¸¢ç»™ traceã€‚
2. è®©ä»–å…ˆåªåš **Aâ†’B** çš„é€’å»¶æ”¹é€ å¹¶å›ä¸‰ä»¶ç‰©æ–™ï¼š

   * `run_ctx.json`ï¼ˆbatch çº§ï¼Œå«å››ä¸ª source çš„è·¯å¾„ä¸ md5ï¼‰
   * `00_assert.txt`ï¼ˆå‡ºç°ä¸‰æ¡æ–­è¨€ä¸” PASSï¼‰
   * `delivery_manifest.json`ï¼ˆè‡³å°‘åŒ…å« B æ­¥å››æ¡è®°å½•ï¼Œsource=s1..s4ï¼‰

ç­‰ä»–è¿™ä¸‰æ · OKï¼Œæˆ‘ä»¬å°±æŠŠåŒæ ·çš„é€’å»¶æœºåˆ¶å¹³ç§»åˆ° Câ†’Gï¼Œå…¨é“¾è·¯å°±â€œé¡ºç€è·‘ã€è·‘å¾—ç¨³â€ã€‚
æ²¡é—®é¢˜ã€‚æŠŠâ€œæµ‹è¯•â†’æ­£å¼ï¼ˆprodï¼‰â€çš„åˆ‡æ¢å®šæˆ**ä¸€æ¡è§„åˆ™ + ä¸€å¼ æ˜ å°„è¡¨ + ä¸¤æ¡å‘½ä»¤**ï¼Œtrace åªæ”¹å…¥å£å‚æ•°ï¼Œå…¶ä½™ä¸€å¾‹è·Ÿç€è·‘ã€‚ä¸‹é¢æ˜¯**æœ€ç»ˆå£å¾„**ï¼ˆå«å¼ºåˆ¶æ–­è¨€ï¼‰ï¼Œä½ å¯ç›´æ¥è½¬ç»™ traceã€‚

---

# ä¸€æ¡æ€»è§„åˆ™ï¼ˆå¿…é¡»æ‰§è¡Œï¼‰

* **åªæ”¹ `--env` ä¸º `prod`**ï¼Œå…¶ä½™è·¯å¾„å…¨éƒ¨ç”±ç¨‹åºæŒ‰è§„åˆ™è‡ªåŠ¨åˆ‡æ¢ï¼š

  * è¾“å…¥ä» `.../data/test/inbox` â†’ **`.../data/raw/inbox`**
  * è°ƒè¯•/ä¸­é—´äº§ç‰©ä» `.../outputs_test/...` â†’ **`.../outputs/...`**
  * `run_ctx.json` ä» `.../outputs_test/debug/<batch>/` â†’ **`.../outputs/debug/<batch>/`**
* å­—å…¸ä»èµ° **prod å­—å…¸**ï¼š`{ROOT}/data/ref`ï¼ˆä¸æµ‹è¯•æ—¶çš„ prod\_mirror ä¸€è‡´ï¼‰ã€‚

---

# è·¯å¾„æ˜ å°„è¡¨ï¼ˆtest â†’ prodï¼‰

| äº§ç‰©/åŠ¨ä½œ                                       | TEST è·¯å¾„                                                                    | PROD è·¯å¾„                                                               |
| ------------------------------------------- | -------------------------------------------------------------------------- | --------------------------------------------------------------------- |
| **run\_ctx.jsonï¼ˆæ‰¹æ¬¡çº§ï¼‰**                      | `${ROOT}/outputs_test/debug/<batch>/run_ctx.json`                          | `${ROOT}/outputs/debug/<batch>/run_ctx.json`                          |
| **A è¯»å–ï¼ˆå¤š sourceï¼‰**                          | `${ROOT}/data/test/inbox/<batch>/<source>/*.{csv,xlsx}`                    | `${ROOT}/data/raw/inbox/<batch>/<source>/*.{csv,xlsx}`                |
| **Bï¼š01\_normalized.csv**                    | `${ROOT}/outputs_test/debug/<batch>/<source>/01_normalized.csv`            | `${ROOT}/outputs/debug/<batch>/<source>/01_normalized.csv`            |
| **Cï¼š02\_preprocessed.csv**                  | `${ROOT}/outputs_test/debug/<batch>/<source>/02_preprocessed.csv`          | `${ROOT}/outputs/debug/<batch>/<source>/02_preprocessed.csv`          |
| **Dï¼š03\_candidates.csv**                    | `${ROOT}/outputs_test/debug/<batch>/<source>/03_candidates.csv`            | `${ROOT}/outputs/debug/<batch>/<source>/03_candidates.csv`            |
| **Eï¼š04\_ranked.csv**                        | `${ROOT}/outputs_test/debug/<batch>/<source>/04_ranked.csv`                | `${ROOT}/outputs/debug/<batch>/<source>/04_ranked.csv`                |
| **Fï¼š05\_aggregated.csv**                    | `${ROOT}/outputs_test/debug/<batch>/<source>/05_aggregated.csv`            | `${ROOT}/outputs/debug/<batch>/<source>/05_aggregated.csv`            |
| **Gï¼šbrand\_cleaned.csv**                    | `${ROOT}/outputs_test/clean/<batch>/<source>/brand_cleaned.csv`            | `${ROOT}/outputs/clean/<batch>/<source>/brand_cleaned.csv`            |
| **Gï¼šaudit.jsonl**                           | `${ROOT}/outputs_test/audit/<batch>/<source>/audit.jsonl`                  | `${ROOT}/outputs/audit/<batch>/<source>/audit.jsonl`                  |
| **00\_env.json / 00\_assert.txt / metrics** | `${ROOT}/outputs_test/debug/<batch>/<source>/...`                          | `${ROOT}/outputs/debug/<batch>/<source>/...`                          |
| **delivery\_manifest.json**                 | `${ROOT}/outputs_test/debug/<batch>/<source>/delivery_manifest.json`ï¼ˆæˆ–æ‰¹æ¬¡çº§ï¼‰ | `${ROOT}/outputs/debug/<batch>/<source>/delivery_manifest.json`ï¼ˆæˆ–æ‰¹æ¬¡çº§ï¼‰ |

> è¯´æ˜ï¼š`<batch>=YYYYMMDD_HHMM`ï¼›`<source>âˆˆ{s1,s2,s3,s4}`ï¼›`ROOT=/Users/didi/Downloads/panth/tag_ct_local`ã€‚

---

# ä¸¤æ¡æ ‡å‡†å‘½ä»¤

## â‘  ä¸€é”®ä¸²è·‘ï¼ˆæ¨èï¼‰

```bash
python brandctl.py flow \
  --env prod \
  --dict-mode prod \  # æˆ–çœç•¥ï¼Œé»˜è®¤ç­‰ä»·äº prod_mirror
  --batch 20250920_0656 \
  --sources s1,s2,s3,s4
```

è¡Œä¸ºï¼šåœ¨ `${ROOT}/outputs/debug/20250920_0656/run_ctx.json` ç”Ÿæˆä¸Šä¸‹æ–‡ â†’ ä¾æ¬¡è·‘ Aâ†’Bâ†’â€¦â†’Gï¼ˆå¯¹æ¯ä¸ª sourceï¼‰â†’ äº§å‡º `brand_cleaned.csv` / `audit.jsonl` / `00_assert.txt` / `delivery_manifest.json`ï¼ˆå…¨éƒ¨èµ° `outputs/`ï¼‰ã€‚

## â‘¡ åˆ†æ­¥ï¼ˆå¿…é¡»æºå¸¦ --ctx ä¸ --sourceï¼‰

```bash
# å…ˆç”± flow-init æˆ– A æ­¥ç”Ÿæˆ run_ctx.jsonï¼ˆprod ç‰ˆï¼‰
python brandctl.py stepB --ctx "${ROOT}/outputs/debug/20250920_0656/run_ctx.json" --source s1
python brandctl.py stepC --ctx "${ROOT}/outputs/debug/20250920_0656/run_ctx.json" --source s1
# ... ç›´åˆ° stepG
```

çº¦æŸï¼šBâ€“G **ç¦æ­¢**å†ä¼  `--in/--out`ï¼Œä¼ äº†å°±æŠ¥é”™ï¼›åªè®¤å¯ `--ctx` å†…çš„è·¯å¾„ã€‚

---

# PROD ä¸“ç”¨æŠ¤æ ï¼ˆåŠ¡å¿…åŠ ä¸Šï¼‰

1. **ç¯å¢ƒ-è·¯å¾„ä¸€è‡´æ€§æ–­è¨€**ï¼ˆå†™å…¥ `00_assert.txt`ï¼‰ï¼š

   * `env=prod` â‡’ æ‰€æœ‰è¾“å‡ºè·¯å¾„å¿…é¡»ä½äº `/outputs/`ï¼ˆ**ä¸èƒ½**å‡ºç° `/outputs_test/`ï¼‰
   * `A_in_glob` å¿…é¡»ä½äº `/data/raw/inbox/<batch>/<source>/`

2. **ç™½åå• I/Oï¼ˆprod å‰ç¼€ï¼‰**

   * ä»…å…è®¸ï¼š

     * `${ROOT}/data/raw/inbox/<batch>/<source>/...`
     * `${ROOT}/outputs/.../<batch>/<source>/...`
   * è®¿é—®å…¶å®ƒå‰ç¼€ç«‹åˆ» fail-fastï¼Œå¹¶è®°å½•â€œéæ³•è·¯å¾„ + è°ƒç”¨æ ˆâ€ã€‚

3. **å“ˆå¸Œé“¾æ ¡éªŒ**ï¼ˆé€’å»¶ä¸èµ°æ ·ï¼‰

   * æœ¬æ­¥è¾“å…¥ md5 å¿…é¡»ç­‰äºä¸Šä¸€æ­¥äº§ç‰© md5ï¼›ä¸ç­‰ç›´æ¥å¤±è´¥ã€‚
   * `delivery_manifest.json` ä¸­ `A_outâ†’B_inâ†’...â†’final_out` çš„ md5 é“¾å¿…é¡»è¿ç»­ã€‚

4. **åªè¯»å­—å…¸**

   * ä»è¯»å– `${ROOT}/data/ref`ï¼›å¯¹è¯¥ç›®å½•ä»»ä½•å†™å…¥å°è¯•ï¼Œç›´æ¥å¤±è´¥å¹¶è®°å½•æ ˆã€‚

---

# ä¸Šçº¿åˆ‡æ¢ Runbookï¼ˆç»™ traceï¼‰

1. æŠŠæœ¬åœ° `flow/step*` çš„é»˜è®¤ `--env` æ”¹ä¸º `prod`ï¼›`--dict-mode` ä¿æŒ `prod`ï¼ˆæˆ–é»˜è®¤ï¼‰ã€‚
2. ç”Ÿæˆæ–°çš„ `run_ctx.json` åˆ° `${ROOT}/outputs/debug/<batch>/run_ctx.json`ã€‚
3. å¯åŠ¨ `flow`ï¼ˆæˆ–é€ `step*` å¸¦ `--ctx` æ‰§è¡Œï¼‰ã€‚
4. å›ä¼ å››ä»¶å¥—ï¼ˆ**prod ç‰ˆè·¯å¾„**ï¼‰ï¼š

   * `brand_cleaned.csv`ï¼ˆ`outputs/clean/...`ï¼‰
   * `audit.jsonl`ï¼ˆ`outputs/audit/...`ï¼‰
   * `00_assert.txt`ï¼ˆåŒ…å«ï¼šenv\_path\_match/io\_whitelist/input\_matches\_prev\_md5 å…¨ PASSï¼‰
   * `delivery_manifest.json`ï¼ˆmd5 é“¾å®Œæ•´ï¼‰
5. æˆ‘æ–¹éªŒæ”¶ï¼šåªçœ‹â€œè¾“å‡ºç›®å½•æ˜¯å¦åœ¨ `/outputs/`ã€æ–­è¨€æ˜¯å¦å…¨ PASSã€md5 é“¾æ˜¯å¦è¿ç»­â€ã€‚

---

è¦ä¸è¦æˆ‘æŠŠè¿™ä»½â€œæµ‹è¯•â†’æ­£å¼åˆ‡æ¢æŒ‡å¼•â€ä¹Ÿæ”¶è¿› canvas çš„æ€»è§ˆæ–‡æ¡£é‡Œï¼Ÿä½ å‘ç»™ trace åï¼Œå®ƒåªéœ€è¦æŠŠ `--env test` æ”¹æˆ `--env prod` å†è·‘ä¸€éï¼Œå…¶ä»–è·¯å¾„ç”±ç¨‹åºè‡ªåŠ¨è¿ç§»ï¼Œä¸”æ‰€æœ‰æŠ¤æ ä¼šé˜»æ­¢å®ƒè¯¯å†™åˆ° testã€‚
