

## **阶段1：多源数据收集 → RAW1（无损摄入层）**

#### **输入依赖：**
- **上一步**：原始数据源（S1、S2、S3、S4）
- **输入数据**：
  - **表类型**：混合（宽表+长表）
  - 表名：各数据源的原始Excel文件
  - 字段：`store_id`, `tag_code`, `raw_value`, `source`, `observed_at`
  - 样例数据：
    ```
    store_id: 5439970606908645474
    tag_code: brand_name
    raw_value: 中海油毛易加油站
    source: s2
    observed_at: 2025-09-22
    ```

#### **处理逻辑：**
- 配置驱动数据读取
- 宽表长表分离处理
- 穷举P0标签检查
- 数据有效性验证

#### **输出数据：**
- **下一步**：RAW1 → RAW2（语义清洗层）
- **输出数据**：
  - **表类型**：长表
  - 表名：`RAW1.xlsx`
  - 字段：`store_id`, `tag_code`, `raw_value`, `source`, `observed_at`, `data_quality_score`
  - 样例数据：
    ```
    store_id: 5439970606908645474
    tag_code: brand_name
    raw_value: 中海油毛易加油站
    source: s2
    observed_at: 2025-09-22
    data_quality_score: 0.85
    ```

### **问题确认：**
1. RAW1输出为长表格式是否正确？
2. 输入混合表类型（宽表+长表）的标记是否清晰？
3. 字段定义和样例数据是否准确？

**请确认阶段1，或提出修改建议。**

```plaintext
    store_id: 5439970606908645474
    tag_code: brand_name
    raw_value: 中海油毛易加油站
    source: s2
    observed_at: 2025-09-22
```

```plaintext
    store_id: 5439970606908645474
    tag_code: brand_name
    raw_value: 中海油毛易加油站
    source: s2
    observed_at: 2025-09-22
    data_quality_score: 0.85
```

---

## **阶段2：RAW1（无损摄入层）→ RAW2（语义清洗层）【通用能力设计版】**

#### **输入依赖：**
- **上一步**：RAW1（无损摄入层）
- **输入数据**：
  - **表类型**：长表
  - 表名：`RAW1.xlsx`
  - 字段：`store_id`, `tag_code`, `raw_value`, `source`, `observed_at`, `data_quality_score`

#### **处理逻辑（双路径设计）：**

##### **路径判断（配置驱动）：**
```yaml
complex_cleaning:
  brand_name: true  # 需要复杂清洗
  competitive_overlap: false  # 走标准化清洗
  service_carwash_available: false  # 走标准化清洗
  # 未来可扩展：other_complex_tag: true
```

##### **路径1：复杂清洗（可扩展设计）**
- **通用能力**：
  - 清洗流程框架（预处理→停用词→归一）
  - 校验和测试链路
  - 证据链追踪机制
  - 审计规则框架
- **标签特定能力**：
  - 清洗字典（如brand_name用tag_enum.csv）
  - 清洗细节规则（docs/5门店品牌清洗全链路核心逻辑.md 
和 ）
  - 标签特定的校验标准(docs/3.12 brand_name 清洗final_副本.md)

##### **路径2：标准化清洗（兜底清洗）**
- 将输入值校准到符合标签枚举值的规范要求
- 适用非复杂清洗的P0标签

##### **归化输出**：
- 两个路径统一归化到RAW2

#### **输出数据：**
- **表类型**：长表
- **表名**：`RAW2.xlsx`
- **字段**：`store_id`, `tag_code`, `cleaned_value`, `confidence_score`, `cleaning_type`, `cleaning_steps`, `source`, `evidence`, `audit_result`

### **关于复杂清洗逻辑对齐的时机：**
您提到的2个文档（docs/5门店品牌清洗全链路核心逻辑.md 
和 docs/3.12 brand_name 清洗final_副本.md）的具体清洗逻辑和校验规则，我建议在**阶段2确认完成后**立即对齐，因为：
1. 需要基于具体的清洗规则设计通用能力接口
2. 需要确定brand_name的特定清洗逻辑作为第一个实现
3. 需要设计可扩展的配置结构
```
###   
5. 复杂清洗总流程（按PRD口径，单值→聚合）

- 流程：输入标准化→预处理链→候选入池→候选排序与分档→门店聚合与兜底→最终产物。

### 6. Step 1 输入标准化（01_normalized）

- 统一长格式：store_id, raw_value, source, observed_at；保留多值。

### 7. Step 2 预处理链（02_preprocessed）

- 置顶“停用词豁免”（二选一即豁免停用词）：

- 有效中文字符数 < 5；

- 100% 命中白名单（white_list=1 的 enum_label 或 brand_aliases 任一别名）。

- 编码规范化（NFKC）→（严格口径下）仅按 PRD 白名单执行的符号/后缀/地址去噪；停用词仅在未豁免时生效。

- 产出：cleaned_value、stopword_exempt、stopword_exempt_reason、evidence_steps_json。

### 8. Step 3 候选入池与过滤（03_candidates）

- 入池约束（全满足）：is_active=1 ∧ white_list=1 ∧ is_default=FALSE ∧ enum_code LIKE 'BRAND_0%'>

- 匹配类型：exact（标准名/别名）；alias 命中；模糊默认关闭（除非显式开启且受阈值约束）。

- 字段：enum_code/enum_label/hit_type/raw_score/sort_order/blocked_reason。

### 9. Step 4 候选排序与置信度分档（04_ranked）

- 排序铁律：sort_order(降) > raw_score(降) > 别名长度(降) > enum_code(升)。

- 置信度四档：100/85/80/45（固定集合，不得越权）。

### 10. Step 5 门店聚合与兜底（05_aggregated）

- 聚合逻辑（win_logic）：一致直选 / 票数×sort_order / 兜底 / 待人工复核。

- 兜底限制：默认品牌只用于兜底，不得入候选。

- 字段：raw_values；preliminary_results；brand_final；win_logic；confidence；is_valid_brand；is_fallback；trace_id。

### 11. Step 6 最终产物（06_final + brand_cleaned.csv 等价）

- 等长表，store_id 唯一；不丢行；trace_id 贯穿证据。

### 12. 中间产物与可验收过程表（必须）

- 01_normalized, 02_preprocessed, 03_candidates, 04_ranked, 05_aggregated, 06_final（结构见上）。

### 13. 审计与断言（3.12，必须）

- 基础断言：plan_used / io_whitelist_enforced / input_matches_prev_md5 / env_path_match。

- 流程断言：normalized_counts / default_not_in_candidates / whitelist_active_prefix / conf_bins / no_row_loss / unique_store / pairwise_align / audit_length / idempotency。

- 回传：00_assert.txt + metrics.json（01/03/04/05）。
```

```yaml
complex_cleaning:
  brand_name: true  # 需要复杂清洗
  competitive_overlap: false  # 走标准化清洗
  service_carwash_available: false  # 走标准化清洗
  # 未来可扩展：other_complex_tag: true
```

---
## **阶段3：RAW2（语义清洗层）→ Tall（真相层）**

#### **输入依赖：**
- **上一步**：RAW2（语义清洗层）
- **输入数据**：
  - **表类型**：长表
  - 表名：`RAW2.xlsx`
  - 字段：`store_id`, `tag_code`, `cleaned_value`, `confidence_score`, `cleaning_type`, `cleaning_steps`, `source`, `evidence`, `audit_result`
  - 样例数据：
    ```
    store_id: 5439970606908645474
    tag_code: brand_name
    cleaned_value: 中海油
    confidence_score: 0.95
    cleaning_type: complex
    source: s2
    evidence: {"original": "中海油毛易加油站", "rules_applied": ["stop_rule_001"]}
    audit_result: "passed"
    ```

#### **处理逻辑（多源数据融合）：**
- **冲突解决机制**：
  - 基于`source_priority`优先级排序
  - 置信度评分机制
  - 数据质量权重
- **融合规则配置**：
  - 基于`conf/policies/merge_policy.yaml`
  - 支持不同数据源的优先级设置
- **融合流程**：
  1. 按`store_id`分组
  2. 同一标签的多个值进行融合
  3. 选择最佳质量的数据
  4. 生成融合证据链

#### **输出数据：**
- **下一步**：Tall → Hot（宽表层）
- **输出数据**：
  - **表类型**：长表
  - 表名：`Tall.xlsx`
  - 字段：`store_id`, `tag_code`, `final_value`, `confidence_score`, `fusion_sources`, `fusion_evidence`, `data_quality_score`
  - 样例数据：
    ```
    store_id: 5439970606908645474
    tag_code: brand_name
    final_value: 中海油
    confidence_score: 0.95
    fusion_sources: ["s2", "s3"]
    fusion_evidence: {"s2": {"value": "中海油", "confidence": 0.95}, "s3": {"value": "中海油", "confidence": 0.90}}
    data_quality_score: 0.92
    ```

### **问题确认：**
1. Tall作为真相层的定义是否准确？
2. 多源数据融合的冲突解决机制是否合理？
3. 融合证据链的字段设计是否充分？
4. 输出数据格式和样例是否清晰？

**请确认阶段3，或提出修改建议。**

```plaintext
    store_id: 5439970606908645474
    tag_code: brand_name
    cleaned_value: 中海油
    confidence_score: 0.95
    cleaning_type: complex
    source: s2
    evidence: {"original": "中海油毛易加油站", "rules_applied": ["stop_rule_001"]}
    audit_result: "passed"
```

```plaintext
    store_id: 5439970606908645474
    tag_code: brand_name
    final_value: 中海油
    confidence_score: 0.95
    fusion_sources: ["s2", "s3"]
    fusion_evidence: {"s2": {"value": "中海油", "confidence": 0.95}, "s3": {"value": "中海油", "confidence": 0.90}}
    data_quality_score: 0.92
```

---


## **阶段4：Tall（真相层）→ Hot（宽表层）【版本管理版】**

#### **输入依赖：**
- **上一步**：Tall（真相层）
- **输入数据**：
  - **表类型**：长表
  - 表名：`Tall.xlsx`
  - 字段：`store_id`, `tag_code`, `final_value`, `confidence_score`, `fusion_sources`, `fusion_evidence`, `data_quality_score`

#### **处理逻辑（长表转宽表 + 版本管理）：**
- **数据透视**：将长表格式转换为宽表格式
- **字段展开**：每个P0标签作为独立列
- **数据聚合**：按`store_id`分组，展开所有标签值
- **版本管理**：添加版本变更标记
- **质量汇总**：生成整体数据质量指标

#### **输出数据：**
- **下一步**：最终输出（Hot表）
- **输出数据**：
  - **表类型**：宽表
  - 表名：`Hot.xlsx`
  - 字段：`store_id`, `brand_name`, `competitive_overlap`, `service_carwash_available`, `sme_supplier_partner`, `sme_supplier`, `wyc_pricing_enabled`, `service_carwash_type`, `convenience_store_available`, `restroom_available`, `parking_available`, `open_24h`, `open_hours`, `brand_level`, `overall_quality_score`, `version_info`
  - 样例数据：
    ```
    store_id: 5439970606908645474
    brand_name: 中海油
    competitive_overlap: 1
    service_carwash_available: 1
    sme_supplier_partner: 0
    sme_supplier: null
    wyc_pricing_enabled: null
    service_carwash_type: null
    convenience_store_available: null
    restroom_available: null
    parking_available: null
    open_24h: null
    open_hours: null
    brand_level: null
    overall_quality_score: 0.92
    version_info: {
      "batch_id": "test_20250922_0656_final",
      "version": "v1.0",
      "change_type": "initial",  // initial/update/unchanged
      "previous_value": null,
      "current_value": "中海油",
      "change_timestamp": "2025-09-22T16:45:00"
    }
    ```

### **版本管理建议：**
**建议放在Hot表**，因为：
1. Hot表是最终输出，便于业务使用和管理
2. 宽表格式便于版本信息的展示和查询
3. 可以按门店维度管理版本变更历史

### **问题确认：**
1. 版本管理放在Hot表是否合适？
2. 版本信息字段设计是否充分？
3. 版本变更标记的字段结构是否合理？

**请确认阶段4版本管理版，或提出修改建议。**

```plaintext
    store_id: 5439970606908645474
    brand_name: 中海油
    competitive_overlap: 1
    service_carwash_available: 1
    sme_supplier_partner: 0
    sme_supplier: null
    wyc_pricing_enabled: null
    service_carwash_type: null
    convenience_store_available: null
    restroom_available: null
    parking_available: null
    open_24h: null
    open_hours: null
    brand_level: null
    overall_quality_score: 0.92
    version_info: {
      "batch_id": "test_20250922_0656_final",
      "version": "v1.0",
      "change_type": "initial",  // initial/update/unchanged
      "previous_value": null,
      "current_value": "中海油",
      "change_timestamp": "2025-09-22T16:45:00"
    }
```

---

## **阶段5：整体数据质量评估与报告生成【管理优化版】**

#### **输入依赖：**
- **上一步**：Hot（宽表层）
- **输入数据**：
  - **表类型**：宽表
  - 表名：`Hot.xlsx`

#### **处理逻辑（统一报告 + 问题聚焦）：**
- **统一报告生成**：
  - 合并所有评估结果到一个主报告
  - 按问题严重程度分级（Critical/High/Medium/Low）
  - 提供可执行的改进建议
- **问题聚焦机制**：
  - 自动识别Top 3关键问题
  - 提供问题根因分析
  - 给出具体的修复步骤

#### **输出数据：**
- **最终输出**：统一管理报告
- **输出数据**：
  - **表类型**：报告文件
  - 表名：`system_quality_report.json`
  - 字段：`batch_id`, `overall_status`, `critical_issues`, `quality_summary`, `action_items`, `next_steps`
  - 样例数据：
    ```
    batch_id: "test_20250922_0656_final"
    overall_status: "WARNING"  // PASS/WARNING/FAIL
    critical_issues: [
      {
        "issue": "brand_name数据覆盖率不足",
        "severity": "HIGH",
        "impact": "影响95%的门店品牌识别",
        "root_cause": "S2数据源brand_name列为空",
        "solution": "启用油站名称列映射",
        "priority": 1
      }
    ]
    quality_summary: {
      "total_records": 8924,
      "data_coverage": 0.85,
      "accuracy_score": 0.92,
      "processing_time": "45.2s"
    }
    action_items: [
      "1. 修复S2数据源brand_name映射",
      "2. 增加S4数据源",
      "3. 优化清洗规则"
    ]
    next_steps: "建议优先处理brand_name数据覆盖率问题"
    ```

### **管理建议：**
1. **单一报告**：所有信息集中在一个报告中
2. **问题分级**：按严重程度自动排序
3. **可执行建议**：提供具体的修复步骤
4. **状态总览**：一眼看出系统整体健康度

### **问题确认：**
1. 统一报告的管理方式是否更清晰？
2. 问题聚焦机制是否有助于快速定位问题？
3. 可执行建议的格式是否实用？

**请确认阶段5管理优化版，或提出修改建议。**

```plaintext
    batch_id: "test_20250922_0656_final"
    overall_status: "WARNING"  // PASS/WARNING/FAIL
    critical_issues: [
      {
        "issue": "brand_name数据覆盖率不足",
        "severity": "HIGH",
        "impact": "影响95%的门店品牌识别",
        "root_cause": "S2数据源brand_name列为空",
        "solution": "启用油站名称列映射",
        "priority": 1
      }
    ]
    quality_summary: {
      "total_records": 8924,
      "data_coverage": 0.85,
      "accuracy_score": 0.92,
      "processing_time": "45.2s"
    }
    action_items: [
      "1. 修复S2数据源brand_name映射",
      "2. 增加S4数据源",
      "3. 优化清洗规则"
    ]
    next_steps: "建议优先处理brand_name数据覆盖率问题"
```

---

**User**

确认,给 2 个版本吧,我可以选择要什么报告,实践中来确认.

---

**Cursor**

## **阶段5：整体数据质量评估与报告生成【双版本版】**

#### **输入依赖：**
- **上一步**：Hot（宽表层）
- **输入数据**：
  - **表类型**：宽表
  - 表名：`Hot.xlsx`

#### **处理逻辑（双版本报告）：**

##### **版本A：统一管理报告（简化版）**
- **输出数据**：
  - 表名：`system_quality_report.json`
  - 字段：`batch_id`, `overall_status`, `critical_issues`, `quality_summary`, `action_items`, `next_steps`

##### **版本B：详细分析报告（完整版）**
- **输出数据**：
  - 表名：`detailed_quality_report.json`
  - 字段：`batch_id`, `data_coverage`, `accuracy_score`, `processing_time`, `conflict_count`, `quality_metrics`, `performance_metrics`, `conflict_analysis`, `recommendations`

#### **配置选择机制：**
```yaml
report_config:
  default_version: "A"  # 默认使用简化版
  available_versions: ["A", "B"]
  version_A: "system_quality_report.json"
  version_B: "detailed_quality_report.json"
```

#### **输出数据：**
- **版本A样例**：
  ```
  batch_id: "test_20250922_0656_final"
  overall_status: "WARNING"
  critical_issues: [
    {
      "issue": "brand_name数据覆盖率不足",
      "severity": "HIGH",
      "solution": "启用油站名称列映射",
      "priority": 1
    }
  ]
  action_items: ["1. 修复S2数据源brand_name映射", "2. 增加S4数据源"]
  next_steps: "建议优先处理brand_name数据覆盖率问题"
  ```

- **版本B样例**：
  ```
  batch_id: "test_20250922_0656_final"
  data_coverage: {
    "brand_name": 0.95,
    "competitive_overlap": 0.67,
    "service_carwash_available": 0.22
  }
  accuracy_score: 0.92
  processing_time: "45.2s"
  conflict_count: 156
  quality_metrics: {
    "completeness": 0.85,
    "accuracy": 0.92,
    "consistency": 0.88
  }
  performance_metrics: {
    "data_reading": "12.3s",
    "data_cleaning": "18.7s",
    "data_fusion": "8.2s",
    "data_output": "6.0s"
  }
  ```

### **问题确认：**
1. 双版本报告设计是否满足不同使用场景？
2. 配置选择机制是否灵活？
3. 版本A和版本B的字段设计是否合理？

**请确认阶段5双版本版，或提出修改建议。**

```yaml
report_config:
  default_version: "A"  # 默认使用简化版
  available_versions: ["A", "B"]
  version_A: "system_quality_report.json"
  version_B: "detailed_quality_report.json"
```

```plaintext
  batch_id: "test_20250922_0656_final"
  overall_status: "WARNING"
  critical_issues: [
    {
      "issue": "brand_name数据覆盖率不足",
      "severity": "HIGH",
      "solution": "启用油站名称列映射",
      "priority": 1
    }
  ]
  action_items: ["1. 修复S2数据源brand_name映射", "2. 增加S4数据源"]
  next_steps: "建议优先处理brand_name数据覆盖率问题"
```

```plaintext
  batch_id: "test_20250922_0656_final"
  data_coverage: {
    "brand_name": 0.95,
    "competitive_overlap": 0.67,
    "service_carwash_available": 0.22
  }
  accuracy_score: 0.92
  processing_time: "45.2s"
  conflict_count: 156
  quality_metrics: {
    "completeness": 0.85,
    "accuracy": 0.92,
    "consistency": 0.88
  }
  performance_metrics: {
    "data_reading": "12.3s",
    "data_cleaning": "18.7s",
    "data_fusion": "8.2s",
    "data_output": "6.0s"
  }
```

---

**User**

确认

---

**Cursor**

## **整体架构确认完成！**

### **✅ 已确认的完整流程：**

**多源 → RAW1 → RAW2 → Tall → Hot → 质量报告**

#### **阶段1：多源数据收集 → RAW1（无损摄入层）**
- 输入：混合表类型（宽表+长表）
- 输出：长表格式，包含数据质量评分

#### **阶段2：RAW1 → RAW2（语义清洗层）**
- 双路径设计：复杂清洗 vs 标准化清洗
- 配置驱动的路径判断
- 通用能力 + 标签特定能力
- 归化统一输出

#### **阶段3：RAW2 → Tall（真相层）**
- 多源数据融合
- 冲突解决机制
- 融合证据链

#### **阶段4：Tall → Hot（宽表层）**
- 长表转宽表
- 版本管理标记
- 13个P0标签完整展开

#### **阶段5：质量评估与报告**
- 双版本报告：简化版 + 详细版
- 问题聚焦机制
- 可执行建议

---
