
---
# PRD｜商户画像本地化标签清洗系统（Excel 全链路版）v1.0

> 目的：本 PRD 供「AI 编程」直接落地为可运行的本地清洗系统；包含**清晰的数据契约、配置契约、目录结构、CLI 约定、验收标准与测试用例**。不含实现代码。

---

## 0. 概要

* **产品名**：商户画像｜本地化标签清洗系统（P0 13 标签）
* **上线目标**：在 **2025-09-23** 前于本地端到端跑通 **P0** 标签的清洗与融合，产出 \*\*Tall（真相层）\*\*与 **Hot（宽层）**，支持 **回放/回滚** 与 **evidence\_state** 呈现。
* **关键原则**：

  1. **Excel-only**（入口与产出全部使用 Excel：`.xlsx/.xls`）；
  2. **RAW1 无损摄取**（不清洗、不转码）；
  3. **RAW2 语义清洗 + 兜底**（类型化、99 容错、写明原因）；
  4. **只用 `tag_code` 关联**；
  5. **S2 严格品牌列名**：S2 的品牌仅认列名 `brand_name`，其它标签按映射读取；
  6. **不改现网三表**：`tag_catalog.csv / tag_spec.csv / tag_enum.csv` 只读、不可更名。

---

## 1. 背景与问题陈述

* 历史痛点：CSV 编码/分隔符异构导致的中文乱码与列位移；RAW1 过度清洗导致文本被误改；不同源字段不齐。
* 目标：以最小路径消除编码风险与口径分歧，固化“Excel-only + RAW1 无损 + RAW2 清洗”的标准链路，确保可回放、可审计、可配置。

---

## 2. 范围 / 标签清单

* **P0（13）**：`brand_level, brand_name, competitive_overlap, sme_supplier_partner, sme_supplier, wyc_pricing_enabled, service_carwash_available, service_carwash_type, convenience_store_available, restroom_available, parking_available, open_24h, open_hours`。
* **本期实现**：以 `brand_name`、`competitive_overlap` 为试点跑通全链路，框架可扩展至全部 P0。
* **非目标**：外部接口发布、实时同步、跨平台部署不在本期。

---

## 3. 用户与场景

* **用户**：数据运营、区域同学、算法与数据工程同学（本地跑批、人工抽检）。
* **场景**：

  * 将 S1/S2/S3/S4 Excel 文件投入批次目录；
  * 一键跑 RAW1→RAW2→Tall/Hot；
  * 通过 Excel 产物抽检中文与语义；
  * 对比前一日快照，输出增量（Delta）清单。

---

## 4. 总体架构

**数据源（Excel） → RAW1.xlsx（无损） → RAW2.xlsx（语义化） → Tall.xlsx / Hot.xlsx → Snapshots（回放/Delta）**

* **Excel-only**：入口严禁 CSV；产物统一 Excel，便于人工审阅。
* **RAW1**：记录原文 + 来源证据；
* **RAW2**：按 `tag_spec.value_type` 清洗至目标值位，无法识别统一落 99，并标注 `reason_*`；
* **融合**：用 TTL、合并策略、QA 门限，产出全量与增量；
* **快照**：配置与产物入库，支持回放。

---

## 5. 目录结构（固定）

```
/Users/didi/Downloads/panth/tag_ct_local
├─ conf/
│  ├─ manifest.yaml
│  ├─ policies/
│  │  ├─ ttl.yaml
│  │  └─ merge_policy.yaml
│  └─ qa/
│     └─ metrics.yaml
├─ data/
│  ├─ ref/
│  │  ├─ tag_catalog.csv
│  │  ├─ tag_spec.csv
│  │  └─ tag_enum.csv
│  └─ raw/
│     ├─ inbox/<batch>/s1~s4/   # 仅 Excel
│     └─ sample/
│        ├─ sample_raw1.xlsx
│        └─ sample_raw2.xlsx
├─ output/
│  ├─ raw2/raw2_YYYYMMDD.xlsx
│  ├─ tall/tall_YYYYMMDD.xlsx
│  ├─ hot/hot_YYYYMMDD.xlsx
│  └─ delta/
├─ logs/
│  └─ snapshots/snap_YYYYMMDD/{tall.xlsx, hot.xlsx, configs}
├─ runs/
│  └─ <batch>/raw1.xlsx
└─ scripts/  # 实现代码放这里（本 PRD 不含）
```

---

## 6. 数据契约（Schemas）

### 6.1 数据源 Excel（投喂）

* **批次目录**：`data/raw/inbox/<batch>/s1|s2|s3|s4/`，`<batch>=YYYYMMDD_HHMM`；同源可多文件，合并处理。
* **S1（宽表）**：必含 `store_id`；时间列：`date_ob`（可选）；示例标签列：`is_overlap` 或 `competitive_overlap`。
* **S2（宽表）**：必含 `store_id`；时间列：`date_ob`（可选）；**品牌列必须为 `brand_name`**；其它标签（如 `competitive_overlap`、设施类）按映射列读取。
* **S3（长表）**：必含 `store_id, tag_code`，值列：`enum_code` 或 `value_text` 至少一列；时间列：`date_ob`（可选）。
* **S4**：按需，遵循宽/长其中之一。
* **无效值**（系统忽略，不入 RAW1）：空白/`nan/none/null/未知` 等。

### 6.2 RAW1.xlsx（无损摄取）

* **主键建议**：`store_id, tag_code, source, observed_at`（不强校唯一，仅作为去重参考）。
* **Sheet**：`RAW1`
* **列**：

  * `store_id`（string）
  * `tag_code`（string）
  * `raw_value_text`（string）— 原文，不清洗
  * `raw_value_code`（string）— 仅当源长表自带 `enum_code` 时填写
  * `source`（enum：`s1|s2|s3|s4`）
  * `observed_at`（string；优先 `date_ob/observed_at`，都无则文件 mtime）
  * `upload_batch_id`（string；批次号）
  * `origin_cols`（json；含 {file, mode, hit\_col?}）

### 6.3 RAW2.xlsx（语义化）

* **Sheet**：`RAW2`

* **列**：

  * `store_id`（string）
  * `as_of_date`（date：`YYYY-MM-DD`）
  * `tag_code`（string）
  * `target_value_bool`（string/空）
  * `target_value_number`（string/空）
  * `target_value_string`（string/空）
  * `source`（enum）
  * `evidence_state`（string；本阶段留空，融合时补）
  * `ttl_days`（int/空；融合时补）
  * `reason_code`（string）
  * `reason_text`（string）
  * `conf`（string/空；融合时补）
  * `upload_batch_id`（string）

* **清洗规则（示例两标签）**：

  * `competitive_overlap`：`是/1/true/有→1`；`否/0/false/无→0`；`未知/未核验/空/其他→99`，并写 `reason_*`；落位：`target_value_number`。
  * `brand_name`：**文本直传**到 `target_value_string`；空/无效则不产出该行。

### 6.4 Tall.xlsx（真相层）

* **行式长表**：`store_id, tag_code, snapshot_date, target_value_bool/number/string, spec_version, calc_type, value_source, used_fallback, used_enum_code, evidence_state, reason_code, reason_text, conf, ttl_days, source`。

### 6.5 Hot.xlsx（宽层）

* **列式宽表**：主键 `store_id, snapshot_date` + P0 标签展开列；标签 column type 依据 `tag_spec.value_type`（bool/enum/id/string/number）。

---

## 7. 配置契约（YAML）

* `conf/policies/ttl.yaml`：新鲜度寿命（`default_days / by_tag / by_tag_source`）。
* `conf/policies/merge_policy.yaml`：多源合并策略（预置 `conservative|balanced|aggressive` + 覆盖）。
* `conf/qa/metrics.yaml`：QA 阈值（越界率/回填率/变更率/新鲜度）与反向校验。
* **建议新增** `conf/policies/ingest.yaml`：无效值词表与按标签的特定无效规则（供 RAW1 过滤）。
* **manifest**：指明三表与上述配置在清单中的路径，并纳入快照。

> 以上 YAML 的字段定义以已共享的《配置清单 v1.0》为准；AI 编程需遵守字段名与层级，不得随意新增/更名。

---

## 8. CLI / 运行约定（AI 必须实现）

> 不要求实现细节，仅规定**命令、参数、输入/输出位置、返回语义**。

1. **入口闸门（可选）**：`python scripts/inbox_gate_excel_only.py --root . --batch_id <batch>`

   * **输入**：批次目录
   * **输出**：stdout JSON `{ok: true, excel_only: true, files_counted: N}`；若发现 CSV/其他格式：`{ok:false, err:"CSV_NOT_ALLOWED", csv_files:[...]} `

2. **RAW1（Excel in → Excel out，无损）**：`python scripts/xlsx_ingest_raw1_pure.py --root . --batch_id <batch>`

   * **输出**：`runs/<batch>/raw1.xlsx`（sheet: `RAW1` + `sample_s1..s4`）；stdout JSON `{ok:true, rows, raw1: path}`。

3. **RAW2（语义清洗）**：`python scripts/raw2_clean_excel.py --root . --batch_id <batch> --as_of YYYYMMDD`

   * **输出**：`output/raw2/raw2_<as_of>.xlsx`（sheet: `RAW2`）；`data/raw/sample/sample_raw2.xlsx`（前 200 行）。

4. **Tall / Hot（Excel 出品）**：

   * `python scripts/tall_merge_excel.py --root . --as_of YYYYMMDD`
   * `python scripts/hot_wide_excel.py --root . --as_of YYYYMMDD`
   * **输出**：`output/tall/tall_<as_of>.xlsx`、`output/hot/hot_<as_of>.xlsx`。

5. **快照与回放**：

   * 快照保存：`python scripts/snapshot_save_excel.py --root . --as_of YYYYMMDD`
   * 增量对比：`python scripts/delta_build_excel.py --root . --as_of YYYYMMDD`
   * **输出**：`logs/snapshots/snap_<as_of>/{tall.xlsx, hot.xlsx, configs}`；`output/delta/{tall_delta_<as_of>.xlsx, hot_delta_<as_of>.xlsx}`；stdout JSON `{ok:true, tall_delta_count, hot_delta_count}`。

**统一返回规范**：所有脚本 stdout 输出 **简明 JSON**（`ok/err/paths/counts`），便于另一端（人或 AI）自动判断。

---

## 9. 业务规则（关键）

* **S2 品牌列名**：仅认 `brand_name`；该列缺失或为空→本源不产出品牌，由 S3 补；
* **RAW1 无损**：任何非无效词的文本均写入 `raw_value_text`；`enum_code` 仅占位于 `raw_value_code`；
* **RAW2 清洗**：

  * 布尔/枚举类：按照 `tag_spec.value_type` 清洗到对应目标位；无法识别→`99`（或空值），并写 `reason_*`；
  * 文本类（如 `brand_name`）：文本直传；语义归一（别名/尾缀）放融合/规约规则阶段实现；
* **TTL/合并/QA**：以配置为准，不得写死在代码里。

---

## 10. 验收标准（Definition of Done）

1. **结构与一致性**：

   * 三表主键无重复：`catalog(tag_code)`、`spec(tag_code,spec_version)`、`enum(tag_code,enum_code,spec_version)`；
   * P0 13 标签在三表中可唯一识别；
   * 产出文件满足目录与文件命名规范。
2. **功能**：

   * 入口拒收 CSV；Excel 投喂通过；
   * RAW1.xlsx：中文可读、样例页齐备；
   * RAW2.xlsx：`competitive_overlap ∈ {0,1,99}`；`brand_name` 仅在 `target_value_string`；
   * Tall/Hot：与当日 RAW2 对应一致；
   * 快照/Delta：可保存与对比，首日 delta 为 0。
3. **可配置**：

   * TTL/合并/QA 三份 YAML 可被加载并生效；
   * 变更 YAML 后可回放到 D-1 进行对比验证。
4. **可观测**：

   * 所有 CLI 返回 JSON；遇错包含 `err` 与 `file`/`hint`；
   * 产出样例（sample）存在；
   * 基本指标：覆盖率/新鲜度/变更率可在 QA 报表中查看。

---

## 11. 测试用例（可由 AI 自动生成与执行）

* **TC-001**：S2 有 `brand_name` 中文，RAW1/RAW2/Hot 全链路中文可读；
* **TC-002**：S2 缺 `brand_name`，S3 长表提供品牌 → 最终 Tall/Hot 品牌存在；
* **TC-003**：`competitive_overlap` 文本包含“已下线/未知/未核验” → RAW2 记为 99，写 `reason_*`；
* **TC-004**：入口混入 CSV → 闸门报错 `{ok:false, err:"CSV_NOT_ALLOWED"}`；
* **TC-005**：D 日与 D-1 相同数据 → delta 计数为 0；
* **TC-006**：无效值（`nan/none/null/未知`）在 RAW1 被过滤，不进入 RAW2；
* **TC-007**：TTL 缺失 → `evidence_state=TTL_NOT_SET`（融合阶段）。

---

## 12. 风险与缓解

* **编码/乱码**：已通过 Excel-only 规避；仍异常时回源重导。
* **字段缺失**：S2 品牌缺失由 S3 弥补；必要最小字段（`store_id`、时间列建议）在入口校验提示。
* **规则漂移**：所有口径在 YAML；变更纳入快照，支持回放核验。

---

## 13. 计划与里程碑

* M1（当天）：Excel-only 入口 + RAW1.xlsx + RAW2.xlsx（试点 2 标签）
* M2（+1 天）：Tall/Hot Excel 化 + 快照/Delta 链路贯通
* M3（+2\~3 天）：P0 全量标签配置完备 + QA 报告
* M4（9/23 前）：验收、冻结配置、留存回放样例

---

## 14. 附录

* **三表说明**：`tag_class`（A=证据融合类，B=契约/直算类）；`owner_biz/owner_data`（业务/数据 Owner）；`status`（draft/in\_review/released/deprecated/retired）。
* **术语**：`as_of_date`（产出口径日期）、`observed_at`（观测时间，源侧字段或文件时间）、`evidence_state`（证据状态）、`conf`（置信分）。
* **命名规范**：批次 `YYYYMMDD_HHMM`；产出 `*_YYYYMMDD.xlsx`；快照 `snap_YYYYMMDD/`。

> 本 PRD 与《配置清单 v1.0》配套使用；AI 编程需严格遵守**路径/文件名/列名/返回 JSON 字段**，否则验收不通过。
