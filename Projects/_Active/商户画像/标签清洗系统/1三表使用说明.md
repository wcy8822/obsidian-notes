# 商户画像｜三表使用说明 & 共识记录 & 清洗框架模板（v1.0｜2025-09-19）

> 根目录：`/Users/didi/Downloads/panth/tag_ct_local`
> 范围：只读白名单三表 + 说明文档（分目录治理）；全程仅用 `tag_code` 关联；不改现网列名/结构。

---

## 0. 背景与目标（人类可读）

* **目标**：在 9/23 前，本地端到端跑通 **P0 13 标签** 的清洗与融合，产出 **Tall 真相层 + Hot 宽层**，支持 **回放/回滚** 与 **evidence\_state** 呈现。
* **方法**：

  * 三表白名单（治理三件套）：`tag_catalog.csv / tag_spec.csv / tag_enum.csv`。
  * **vCurrent→vCore 适配层**（rename/cast/enum\_map/默认值策略），不改现网列名。
  * **分型**：结果型（源即结果）与计算型（需清洗/归一）。
* **分目录治理**：

  * 口径/契约（低频、需要审计）→ `conf/contracts/`
  * 字典/参考（高频、数据侧维护）→ `data/ref/`

---

## 1. 目录结构（拍板路径）

```
tag_ct_local/
├─ conf/
│  ├─ contracts/                # 口径/契约（spec）
│  │  └─ tag_spec.csv
│  ├─ manifest.yaml             # 单一事实来源：启用范围、适配口径、I/O、QA不变式
│  ├─ mappings/                 # 适配层配置（无代码）
│  ├─ fusion/                   # 宽层聚合/拼接规则
│  └─ invariants/               # 可选：将不变式拆文件
├─ data/
│  ├─ ref/                      # 参考字典（catalog/enum）
│  │  ├─ tag_catalog.csv
│  │  └─ tag_enum.csv
│  └─ raw/                      # 业务现网输入（留坑）
├─ scripts/
│  └─ qa_check.py               # 状态查询回执脚本（只读校验）
├─ out/
│  └─ csv/
│     ├─ tall/                  # 真相层输出（含侧写位）
│     └─ hot/                   # 宽层输出（业务消费）
├─ logs/
│  ├─ qa/                       # QA 报告（json）
│  └─ snapshots/                # D-1 地标快照（原样 CSV）
└─ docs/
   └─ 3表启用说明.md
```

---

## 2. 三表使用说明（详细）

> 历史口径来源确认：我已阅读项目附件《3 个表格的说明文档.md》（只读），并沿用其中既有规则，不改历史口径；本说明仅做结构化呈现与口径外化。关键要点已吸纳：1) **治理三件套**：`tag_catalog → tag_spec → tag_enum`；2) **一值一行**（枚举/布尔的真值集在 enum 内逐行管理）；3) **事实层仅存 code，不落中文展示名**；4) `brand_aliases / exclusion_field / keywords / white_list / black_list / match_method / match_score_threshold` 等字段按文档语义使用；5) `value_type` 合法集合：`bool|enum|string|id`；6) `fallback` 为统一兜底，供适配层落地侧写。

### 2.1 `tag_catalog.csv`（目录/分层/责任）

* **定位**：标签目录与治理分层，决定“谁负责、属于哪类、是否纳入本期”。
* **主键**：`tag_code`（全局稳定英文码）
* **核心列（对齐历史口径，精确定义）**：

  * `tag_code, tier1, tier2, tier3`：业务层级分类（检索/展示用）。
  * `tag_class`：A/B 类（可选）—— **A=证据融合类**（多源择优、状态折算、证据留痕），**B=契约/算法直算类**（按契约或算法直接计算产出）。
  * `owner_biz / owner_data`：**业务/数据 owner**（**人名或组名**，用于责任界定与评审路由）。
  * `status`：**生命周期状态**（详见下方“状态字典”）；仅当 `released` 方可对外计算/发布；`deprecated` 仅维护不新增；`retired` 完全停用。
  * `is_p0`：是否纳入 **P0 13 标签**（0/1）。

**状态字典（严格继承历史口径）**

* `draft` = 草稿
* `in_review` = 评审中
* `released` = **已发布可计算**
* `deprecated` = 拟下线（仅维护，不新增）
* `retired` = 已下线（不再产出）

### 2.2 `tag_spec.csv`（口径/契约） `tag_spec.csv`（口径/契约）

* **定位**：标签定义、值类型、默认兜底、版本与批准信息；**发布需审计**。
* **主键**：`tag_code + spec_version`
* **核心列**：

  * `definition`：口径定义（人类可读）。
  * `value_type`：`bool|enum|id|string`。
  * `fallback`：统一兜底（如 `99`/`other`/`unknown`）。
  * `effective_from / effective_to`：生效区间（允许空为开放期）。
  * `approved_by / approved_at`：批准链路（审计）。
  * **`calc_type`**：`result|compute`（唯一执行口径）。
  * **`validation_regex`**：可选；对 `string/id` 校验（示例：`open_hours` 的 HHMM-HHMM 多段正则）。
* **使用要点**：

  * 清洗时 **仅以 ****************`calc_type`**************** 判别执行路径**；
  * 兜底一律取 `fallback`，Tall 侧写 `used_fallback=1`；
  * 校验不改值：regex 未通过 → QA 告警。

### 2.3 `tag_enum.csv`（值域/别名/策略）

* **定位**：`enum`/`bool` 值域真值集与展示名；品牌归一/白黑名单/匹配阈值等策略字段。
* **主键**：`tag_code + enum_code + spec_version`
* **核心列**：

  * `enum_code / enum_label / is_default / sort_order / is_active`
  * 品牌相关：`brand_aliases / exclusion_field / brand_category / keywords`
  * 策略：`match_method / match_score_threshold / white_list / black_list`
  * **`alias_norm_rule`**：归一策略名（全半角/去空格/大小写统一…），增强可复现性。
* **使用要点**：

  * `bool/enum` 型以此表为**唯一真值域**；域外值仅告警；
  * 展示时通过联表取 `enum_label`，Tall 不重复存冗余展示名；
  * `open_hours` 为 `string`，**不在枚举表中**属合理。

---

## 3. P0 标签清单（13）

`brand_level, brand_name, competitive_overlap, sme_supplier_partner, sme_supplier, wyc_pricing_enabled, service_carwash_available, service_carwash_type, convenience_store_available, restroom_available, parking_available, open_24h, open_hours`

* 值类型分布：`bool=8, enum=3, id=1, string=1`（`open_hours` 为 string）。
* 三表主键唯一、子集关系与“默认枚举唯一性”校验均通过。

### 主线逻辑（对齐并写死）

* **多源输入 → RAW → STD → Tall → Hot**，全程证据可追溯：

  1. **RAW**：各上游原始数据与参考字典落地（本地三表 + 业务 CSV）。
  2. **STD（适配层）**：`vCurrent→vCore` 仅做 **rename/cast/enum\_map/fallback** 对齐，不改业务含义。
  3. **Tall（真相层）**：主键 **`store_id + tag_code`**；输出 `value_code/value_text/spec_version/calc_type`，并侧写 `used_enum_code/used_fallback/value_source/snapshot_date`。
  4. **Hot（宽层）**：按 P0 13 标签透视；展示名通过枚举联表实时取，不把展示名写入 Tall。
  5. **QA/监控**：结构不变式（主键/子集/默认唯一）、质量指标（P0 覆盖/域外值/`fallback` 使用率）、新鲜度与 D-1 稳定性；形成 JSON 回执沉淀到 `logs/qa/`。
  6. **回放/回滚**：`logs/snapshots/snap_YYYYMMDD/` 原样快照三表，manifest 切源或运行参数覆盖后重放。
* **维度统一**：仅保留 **`store_id`** 作为地理空间主键；**省/市等地理维度统一下线**，由线下 Join 解决。

---

## 4. 不变式（Invariants）与 QA 指标

* **结构不变式**：

  1. `catalog.tag_code` 唯一；
  2. `spec(tag_code) ⊆ catalog(tag_code)`；
  3. `enum(tag_code) ⊆ catalog(tag_code)`；
  4. `enum.is_default` **每 tag 至多一个**。
* **质量指标**：

  * P0 覆盖率（catalog 命中率 / `is_p0=1` 覆盖）；
  * `value_type` 合法占比；
  * 域外值计数（按 tag\_code 分布）；
  * `fallback` 使用率（按 tag\_code 分布）。
* **新鲜度/稳定性**（后续加入）：

  * 新鲜度：文件 mtime 与 manifest 批次时间差；
  * 稳定性：与 D-1 快照对比变更占比（整体/按 tag）。

---

## 5. 适配层（vCurrent→vCore）执行口径

* 关联键：**仅用 \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*`tag_code`**。
* 类型/比较口径：`trim + 全半角统一 + 小写比较`；时间读为 ISO8601；布尔解析真值集：`1/true/t/yes/y`。
* 值域：`bool/enum` 以 `tag_enum` 为唯一真值域；域外值 → QA 告警。
* **calc\_type**：以 `spec.calc_type` 为准：

  * `result`：多源择优 + 状态折算 + 不变式预警；
  * `compute`：清洗/归一 + 融合（七件套在清洗阶段实现）。
* **默认值策略**：兜底来自 `spec.fallback`，Tall 侧写标记，不改源/宽层。
* **侧写位（Tall 专用）**：`used_enum_code, used_fallback, value_source`。

---

## 6. 回放/回滚与快照

* **地标快照**：`logs/snapshots/snap_YYYYMMDD/{tag_catalog.csv, tag_spec.csv, tag_enum.csv}` 原样拷贝。
* **回放方法**：

  * 方式 A：临时修改 `manifest.yaml → sources.*` 指向 `snap_YYYYMMDD`；
  * 方式 B：运行参数覆盖源路径。

---

## 7. 操作手册（如何产出 QA 回执）

1. 一次性准备：

```
cd /Users/didi/Downloads/panth/tag_ct_local
python3 -m venv .venv && source .venv/bin/activate
pip install -q pandas pyyaml python-dateutil
```

2. 运行：

```
python3 scripts/qa_check.py --root . --manifest conf/manifest.yaml
```

3. 输出：`logs/qa/qa_YYYYMMDD_HHMM.json`，原样粘贴到对话做回执。

---

## 8. 共识记录（历次对焦要点）

* 只读白名单（分目录）：catalog/enum→`data/ref/`；spec→`conf/contracts/`；说明→`docs/`。
* 关联键：全程仅用 `tag_code`；不使用 `tag_id`。
* 以 `spec.calc_type` 为唯一执行口径；`catalog.tag_class` 仅参考。
* 维度主键统一：**store\_id**（原文档可能出现 `store_id` 的历史称呼，现统一为 `store_id`）。地理维度（省/市等）统一下线，由线下 Join 补全。
* `open_hours` 为 string，不在枚举；其它 bool/enum 以 `tag_enum` 为真值域。
* 兜底默认来自 `spec.fallback`；Tall 侧写 `used_fallback`。
* 不变式与 QA 指标如上；D-1 回放通过 `snap_*` 快照实现。

> 变更日志（占位）：
>
> * 2025-09-19 v1.0：建立分目录治理、适配层执行口径、QA 与回放流程。

---

# 二、清洗框架目录与模板（无代码版）

## A. 目录骨架（新增/补充）

```
conf/
├─ mappings/
│  ├─ fields.yaml        # 字段层适配（rename/cast/enum_map/默认策略）
│  ├─ defaults.yaml      # 默认/fallback 与侧写位开关
│  └─ regex.yaml         # string/id 的校验正则（亦可直接用 spec.validation_regex）
├─ fusion/
│  └─ hot_wide.yaml      # 宽层字段选择、维度拼接与枚举展示名关联
└─ qa/
   └─ metrics.yaml       # QA 指标与阈值（告警级别）
```

## B. `conf/mappings/fields.yaml`（模板）

```yaml
version: 1.0
# 适配层字段口径（按 tag_code 管理），仅声明，不写业务逻辑
# 动作：rename（列重命名）、cast（类型读取/比较口径）、enum_map（值域）、fallback（是否采用 spec.fallback）

common:
  compare:
    trim: true
    to_half_width: true
    lower_for_compare: true
  sidecar:
    used_enum_code: true
    used_fallback: true
    value_source: true

# 按标签声明
labels:
  brand_level:
    value_type: enum
    calc_type_from: spec.calc_type   # result/compute
    enum_map:
      source: data.ref.tag_enum      # 指定值域来源（逻辑上）
      prefer: enum_code              # 取 enum_code 存 Tall
    fallback:
      from_spec: true
  brand_name:
    value_type: enum
    calc_type_from: spec.calc_type
    enum_map:
      source: data.ref.tag_enum
      prefer: enum_code
      alias:
        use_brand_aliases: true      # 利用 brand_aliases
        norm_rule_from: alias_norm_rule
        white_list: true
        black_list: true
    fallback:
      from_spec: true
  open_hours:
    value_type: string
    calc_type_from: spec.calc_type
    validation:
      regex_from_spec: true          # 使用 spec.validation_regex
    fallback:
      from_spec: true
```

## C. `conf/mappings/defaults.yaml`（模板）

```yaml
version: 1.0
fallback:
  enabled: true
  source: spec.fallback
  record_sidecar: true

value_source_priority:
  # 结果型：多源择优优先级（后续补多源场景），示意
  - enum
  - raw
  - fallback
```

## D. `conf/mappings/regex.yaml`（可选，若不走 spec.validation\_regex）

```yaml
version: 1.0
regex:
  open_hours: "^([0-2]\\d{3}-[0-2]\\d{3})(,([0-2]\\d{3}-[0-2]\\d{3}))*$"
```

## E. `conf/fusion/hot_wide.yaml`（模板）

```yaml
version: 1.0
# 宽表导出字段（示例，按业务消费需要调整）
columns:
  # 主键与维度
  - store_id
    - tag_code
  # 结果字段（按 value_type 输出）
  - value_code      # enum/bool 的 enum_code 或 0/1/99
  - value_label     # 展示名（enum_label，string 取原值）
  - value_text      # 兼容 string/id 输出（可选）
  # 元信息
  - snapshot_date
  - spec_version
  - calc_type

joins:
  - name: enum_label_join
    on:
      left: [tag_code, value_code]
      right: [tag_code, enum_code]
    source: data.ref.tag_enum
    select: [enum_label as value_label]
```

## F. Tall/Hot 表头（空表模板）

**Tall（最小真相层）**

```
store_id, tag_code, value_code, 
value_text, spec_version, calc_type, 
used_enum_code, used_fallback, value_source, snapshot_date
```

* 解释：

  * `value_code`：enum/bool 的稳定码；string/id 可留空，用 `value_text`；
  * `used_enum_code`：冗余记账（便于追踪归一结果）；
  * `snapshot_date`：对齐快照批次（YYYY-MM-DD）。

**Hot（宽层示例）**

```
store_id,  brand_level, brand_name, competitive_overlap, sme_supplier_partner, sme_supplier,
wyc_pricing_enabled, service_carwash_available, service_carwash_type, convenience_store_available,
restroom_available, parking_available, open_24h, open_hours, snapshot_date
```

* 解释：宽层字段按消费端需要挑选；展示名通过 `conf/fusion/hot_wide.yaml` 联表映射。

## G. 运行顺序（无代码版）

1. **QA**：`scripts/qa_check.py` → 产出 `logs/qa/qa_*.json`（结构/子集/默认唯一性/P0 覆盖）。
2. **适配**：按 `conf/mappings/*.yaml` 读取源 → 生成 Tall（侧写位齐全），**不改源值**。
3. **融合**：按 `conf/fusion/hot_wide.yaml` 将 Tall 透视/拼接 → Hot。
4. **回放**：复制三表到 `logs/snapshots/snap_YYYYMMDD/`，切 manifest 源路径或运行参数 → 重跑对比稳定性。

---

## 结语

* 本文档作为“人类可读”的共识与说明书，随版本迭代更新；
* 代码与数据变更以 `manifest.yaml` + `logs/snapshots/` 为准；
* 任何新增标签/字段，先更新本说明与 `spec`，再落映射模板。
