# 《数据整理PRD｜RAW1×final→raw_s*_correction_tag_staging》v1.1（slot=全称约束版）

**一句话结论：**  
在指定根目录下，读取 `RAW1.xlsx` 与 `06_final.xlsx`，严格以 **`tag_spec.csv.value_type_connect` 的卡槽全称**（`target_value_bool/number/string`）为唯一写入槽，生成统一中间表；对 `brand_name` 用 final 回填并校验来源；最终按 `source∈{s1,s2,s3}` 分流输出 `raw_s*_correction_tag_staging.csv` 到批次目录。

**三段论据：**

1. **强约束与防呆**：`value_type_connect` 直接给出目标槽位全称，**三槽互斥且仅一项非空**；TTL 由 `tag_spec` 与 `as_of_date` 计算；`source` 空值兜底 `s3`。
    
2. **可追溯**：`target_value_string_back/closest_source` 等溯源字段保留覆盖轨迹；`run_manifest.json` 记录计数、hash、异常。
    
3. **可落地**：不改上游结构，路径/时间戳参数化，输出命名稳定，支持自动化调度与回放。
    

---

## 0. 目录与输入输出

- **根目录**：`/Users/didi/Downloads/panth/tag_ct_clean`
    
- **数据源目录**：`/Users/didi/Downloads/panth/tag_ct_clean/outputs_real_prod_20250923_093500/temp`
    

### 必要输入

1. **RAW1**：`20250923_0833_RAW1.xlsx`
    
    - 字段：`store_id, tag_code, raw_value, source, observed_at, data_quality_score, value_type, value_text, value_column, enum_code`
        
2. **final**：`06_final.xlsx`
    
    - 字段：`store_id, tag_code, raw_values, preliminary_results, brand_final, win_logic, confidence, is_valid_brand, is_fallback, observed_at, data_quality_score, value_type, closest_source, trace_id`
        
3. **标签规格**：`tag_spec.csv`（路径由参数传入或放根目录）
    
    - **必须字段**：
        
        - `tag_code`
            
        - `value_type_connect` ∈ {`target_value_bool`,`target_value_number`,`target_value_string`}（**全称卡槽名**）
            
        - `ttl_days`
            
    - （可选）`enum_dict_name`：若为枚举，指向字典名称（落 `target_value_string`，但做字典校验）
        

### 产出（批次目录）

- 批次目录：`{根目录}/out_{YYYYMMDD_HHMMSS}/`
    
- 文件：
    
    - `raw_s1_correction_tag_staging.csv`
        
    - `raw_s2_correction_tag_staging.csv`
        
    - `raw_s3_correction_tag_staging.csv`
        
    - `correction_tag_staging_all.csv`（合并前全量）
        
    - `run_manifest.json`（运行元数据与计数）
        

---

## 1. 业务目标与范围

- **目标**：对齐多源 RAW1 与 final 的判定结果，生成可直接消费的 S1/S2/S3 分流修正表，`brand_name` 以 final 为准做一致化回填，同时保留溯源用于审计与回放。
    
- **不做**：修改上游结构/写库/产出除三份 staging 外的业务下游文件。
    

---

## 2. 目标中间表 schema（统一字段）

| 字段名                        | 含义         | 规则                                                      |
| -------------------------- | ---------- | ------------------------------------------------------- |
| `store_id`                 | 门店ID       | 来自 RAW1，必填                                              |
| `as_of_date`               | 数据日期       | `date(observed_at)`；不可解析则空                              |
| `tag_code`                 | 标签编码       | 来自 RAW1，必填                                              |
| `target_value_bool`        | 布尔槽        | **唯一槽**之一，互斥                                            |
| `target_value_number`      | 数值槽        | **唯一槽**之一，互斥                                            |
| `target_value_string`      | 文本槽        | **唯一槽**之一，互斥（枚举也落此）                                     |
| `source`                   | 来源         | 来自 RAW1；空值稍后兜底                                          |
| `evidence_state`           | 证据状态       | 初始 `FOUND_IN_RAW`；brand 回填后 `UPDATED_FROM_FINAL`        |
| `ttl_days`                 | 剩余有效天数     | `max(ttl_from_spec - (today - as_of_date), 0)`；缺值则空     |
| `reason`                   | 处理原因       | 初始 `RAW1.value_type`；回填追加原因码                            |
| `conf`                     | 置信度        | RAW1.`data_quality_score`；brand 回填可取 final.`confidence` |
| `upload_batch_id`          | 批次标识       | RAW1 文件名或运行 batch_id                                    |
| `closest_source`           | final 推荐来源 | 来自 final，兜底 `source` 用                                  |
| `target_value_string_back` | 文本槽备份      | brand 回填前的旧值                                            |

**三槽选择规则（全称版）**

- **唯一来源**：`slot = tag_spec.value_type_connect`（值为 `target_value_bool/number/string` 之一）。
    
- **写入**：`row[slot] = cleaned_value`；其他两个槽**必须为空**。
    
- **异常**：若 `value_type_connect` 缺失/非法 → 记录 `INVALID_SLOT`，该行落审计并默认仅保留 `target_value_string`（降级策略可开关）。
    

**类型标准化**

- `target_value_bool`：接受 `1/0/是/否/Y/N/true/false` → 归一为 `true/false`；失败→置空+`BOOL_PARSE_FAIL`。
    
- `target_value_number`：可解析为数值；失败→置空+`NUMBER_PARSE_FAIL`。
    
- `target_value_string`（含枚举）：若存在 `enum_dict_name`，不在字典 → 保留原值+`ENUM_VIOLATION`。
    

---

## 3. 处理流程

### 步骤 1｜RAW1→中间表

1. 读取 `RAW1.xlsx`、`tag_spec.csv`。
    
2. 以（`store_id`,`tag_code`）为强关联键映射到中间表：
    
    - `as_of_date = date(observed_at)`；
        
    - 根据 `tag_spec.value_type_connect` **直接定位槽位全称**并写入；
        
    - `ttl_days`：`as_of_date` 与 `ttl_from_spec` 均存在才计算；
        
    - `evidence_state='FOUND_IN_RAW'`；`reason=RAW1.value_type`；`conf=RAW1.data_quality_score`；`upload_batch_id=RAW1 文件名`。
        
3. 类型与合法性检查：见“类型标准化”。
    

> 产出：`correction_tag_staging_all.csv`（第一版，未回填 brand）

### 步骤 2｜brand_name 回填与来源兜底

- 过滤 `tag_code='brand_name'`：
    
    1. 备份 `target_value_string_back = target_value_string`；
        
    2. 若 `final.is_valid_brand=TRUE` 且 `final.brand_final` 非空 → 覆盖写入 `target_value_string = final.brand_final`；
        
    3. `source` 为空 → 回填 `source = final.closest_source`；
        
    4. `evidence_state='UPDATED_FROM_FINAL'`；`conf` 可用 `final.confidence` 覆盖空值；
        
    5. 若 `tag_spec.value_type_connect != target_value_string` → **拒绝写入**并标记 `TYPE_MISMATCH_SKIP`。
        

> 产出：`correction_tag_staging_all.csv`（第二版，已完成 brand 回填）

### 步骤 3｜按 source 分流并落盘

- 依据中间表的 `source`：
    
    - `s1` → `raw_s1_correction_tag_staging.csv`
        
    - `s2` → `raw_s2_correction_tag_staging.csv`
        
    - `s3/空/未知` → `raw_s3_correction_tag_staging.csv`（兜底）
        
- 落盘：`{根目录}/out_{YYYYMMDD_HHMMSS}/`
    
- 生成 `run_manifest.json`：输入/输出计数、hash、brand 覆盖数、异常计数、运行参数时间戳。
    

---

## 4. 参数与运行方式（给 cline）

**CLI**

```bash
python organize_tags.py \
  --root "/Users/didi/Downloads/panth/tag_ct_clean" \
  --input_dir "/Users/didi/Downloads/panth/tag_ct_clean/outputs_real_prod_20250923_093500/temp" \
  --raw1 "20250923_0833_RAW1.xlsx" \
  --final "06_final.xlsx" \
  --tag_spec "tag_spec.csv" \
  --out_dir "{root}/out_{timestamp}" \
  --batch_id "outputs_real_prod_20250923_093500" \
  --today "2025-09-23"
```

- **必选**：`--root --input_dir --raw1 --final --tag_spec`
    
- **可选**：`--out_dir --batch_id --today`
    

---

## 5. 防呆与错误处理

- **三槽互斥**：仅字典指定槽可非空；多槽非空 → 保留字典槽 + `MULTI_SLOT_CONFLICT_DOWNGRADED`。
    
- **类型校验**：见“类型标准化”。
    
- **brand 覆盖**：需 `is_valid_brand=TRUE` 且槽位为 `target_value_string`；否则 `TYPE_MISMATCH_SKIP`。
    
- **source 兜底**：空值先回填 `final.closest_source`，若仍空 → `s3`。
    
- **TTL**：缺 `as_of_date` 或 `ttl_from_spec` 不计算；不得为负。
    
- **幂等**：同一 `batch_id` 重跑覆盖输出；`run_manifest.json` 记录 hash。
    

---

## 6. 验收标准（Acceptance）

1. 结构正确：三份 `raw_s*_correction_tag_staging.csv` 字段齐全、顺序一致；
    
2. 互斥成立：任一行仅 `value_type_connect` 指定槽非空；
    
3. brand 一致：`brand_name` 在 final 可用时完成覆盖，备份存在；
    
4. 分流正确：空/未知 `source` 进入 `s3`；
    
5. TTL 合理：抽检不为负，公式正确；
    
6. 回执完整：`run_manifest.json` 含计数与异常明细；
    
7. 零硬编码：路径/时间/批次参数化。
    

---

## 7. 最小可测样例（示意）

- **RAW1**：`store_id=1134..., tag_code=brand_name, value_text="中国石化铜都加油站(春晓路)", source=s3, observed_at=2025-07-24, data_quality_score=1`
    
- **final**：`brand_final="中国石化", is_valid_brand=TRUE, confidence=80, closest_source="s3"`
    
- **tag_spec**：`tag_code=brand_name, value_type_connect=target_value_string, ttl_days=90`
    
- **期望**：步骤1写入 `target_value_string`；步骤2 备份并覆盖为`中国石化`，`source` 保持/回填 `s3`，`evidence_state=UPDATED_FROM_FINAL`；步骤3 分流到 `raw_s3_*`。
    

---

## 8. 开发要点（给 cline 的实现提示）

- 读写 `.xlsx/.csv`；UTF-8；xlsx 读写建议 `openpyxl`。
    
- 核心函数：
    
    - `assign_slot(slot_name)`：按全称落槽并清空其他槽；
        
    - `to_bool()/to_number()/to_enum()`：类型清洗；
        
    - `calc_ttl(as_of_date, ttl, today)`；
        
    - `apply_brand_final(row, final_lookup)`；
        
- 分流：`source in {s1,s2,s3}` 之外统一归 `s3`。
    
- 审计与统计：输入/输出计数、brand 覆盖计数、异常计数、样例抽检。
    

---

## 《迭代日志》

- **来源**：v1.0 PRD + 你补充“`value_type_connect` 为槽位全称”的强约束要求。
    
- **结论**：v1.1 明确以 `value_type_connect` 作为**唯一写槽开关**，删除“bool/number/string 短语映射”；其余流程与验收标准不变。
    
- **改动点**：
    
    1. 三槽选择规则改为全称直写；
        
    2. 增加 `INVALID_SLOT`、`TYPE_MISMATCH_SKIP` 等异常码；
        
    3. 强化三槽互斥的降级策略描述。
        
- **待补充**：`tag_spec.csv` 的最终路径、`enum` 字典文件（如有）、`today` 的取值策略。
    
- **下一步建议**：用 10 条样本回归三处关键点：`TTL/brand 覆盖/source 分流`；确认通过后接入调度批量跑。