
---

# PRD（AI语义版，抽象路径）

**目标**：在不改变你现有产物结构的前提下，把**多源→决胜**与**逆向检查**跑通，并且可审计、可回放。

## A. 抽象管线（仅占位，不新增环节名）

```
<RAW1>  →  <RAW2>  →  <TALL>  →  <HOT>
                 └─(在 <TALL> 内完成 决胜 + 逆向检查标注)
```

- **约束**：决胜与逆向检查的计算与标注**发生在** ；
    
- 仅做“行→列展开”，**不得**再次做取值/打分/冲突判断。
    

---

## B. 多源→决胜（仅两维）

**选择规则（对任意 `(store_id, tag_code)` 的候选集合）：**

```
score = W_source(tag_code, source_id) × F_fresh(observed_at, ttl_days, decay_mode)
Top1 为候选分数最高者；
若 Top1 − Top2 < Δ_min(tag_code) → 标记 CONFLICT；
若所有候选 score = 0 → 标记 UNKNOWN。
```

- **W_source**：按标签定义的 S1–S4 权重（标签可覆写，未定则走默认）。
    
- **F_fresh**：新鲜度因子（linear 或 exp，按标签定义；过 TTL 逼近 0）。
    
- **Δ_min**：分差阈值（按标签定义）。
    
- **输出语义**（写入 的同一行/同一组聚合字段）：
    
    - 被选中行打 `is_selected=1`；组内其余为 0。
        
    - 组级别产生 `select_status ∈ {SELECTED, CONFLICT, UNKNOWN}` 与 `delta_to_second`（仅 Top1 有值）。
        

---

## C. 逆向检查（对“预期变更”做回执）

**预期变更（Expected）定义（两选一，拍板即可）：**

- **时间阈值法**：`observed_at ≥ now - N天`（如 7 天），且与上期同键不同；
    
- **对比法**：与上期候选对比，出现新组合 `(store_id, tag_code, source_id, value)`。
    

**判定：**

- 若本期该组最终 `is_selected=1` 的值 == 预期值 → `APPLIED`；
    
- 否则 → `NOT_APPLIED`，并标注原因枚举：
    
    - `WEIGHT_LOWER` / `STALE` / `SMALL_DELTA` / `ENUM_INVALID` / `MERGE_CONFLICT` / `OTHER`。
        

**输出语义**（仍写入 ，不新增文件）：

- 对被判定为“预期变更”的候选，标 `is_expected_change=1`；
    
- 组级别补 `check_status（APPLIED/NOT_APPLIED）` 与 `not_applied_reason`。
    

---

## D. 与现有清洗系统的结合（只用占位，不改路径）

1. **→** ：
    
    - 在生成 时，对每条候选计算 `score` 并给组打“被选中/冲突/未知”；
        
    - 在同一张表内标注“预期变更”的回执结果（APPLIED/NOT_APPLIED+原因）。
        
2. **→** ：
    
    - 仅透视 `is_selected=1` 的行到各列；
        
    - 如果某组 `CONFLICT/UNKNOWN`，则 对应列**留空或填占位值**（按你口径）。
        
3. **版本追溯（可写为全表常量列）**：
    
    - `run_id`、`algo_version`（决胜参数版本）、`source_snapshot_ids`（各源快照标识）。
        

---

## E. 前置校验（Preflight，失败则终止本期）

- **权重缺失**：`W_source` 对应标签/源**未配置**且无默认 → 阻断：`MISSING_WEIGHT`。
    
- **TTL缺失**：标签无 TTL 且无 hint → 阻断：`MISSING_TTL`。
    
- **主键缺失**：任一候选缺 `store_id/tag_code/source_id/observed_at/value` → 阻断：`MISSING_KEY_FIELDS`。
    
- **枚举非法**（若标签定义枚举域）：非法占比超阈值（如 1%）→ 阻断：`ENUM_INVALID_RATE`。
    
- **S1缺席**（若标签定义“强依赖 S1”）→ 阻断：`MANDATORY_SOURCE_MISSING`。
    
- **元数据缺失**：未写入 `run_id/algo_version` → 阻断：`META_INCOMPLETE`。
    

> 校验结论可写回你的 QA 面板或日志；**不用新增文件**。

---

## F. 对外口径（不改变你现有产物）

- ：作为真相层，携带“被选中标记/冲突标记/逆向检查回执/版本元数据”；
    
- ：宽表，仅消费 的 `is_selected=1`，不再做任何“取值决策”。
    

---

## G. AI 执行提示（总模板，填占位即可投喂）

```
任务：在不改变现有产物与路径的前提下，在 <TALL> 内完成“多源→决胜”和“逆向检查”标注，并由 <TALL> 透视为 <HOT>。

输入：
- <RAW2>：多源候选行（含 store_id, tag_code, value, source_id, observed_at, ttl_days?）
- <CONFIG:tag_spec>：各标签/各源的权重 W_source、TTL/decay、Δ_min（无则用 <CONFIG:tag_catalog> 默认）
- <CONFIG:tag_catalog>：标签默认 TTL、Δ_min、是否参与决胜
- <CONFIG:tag_enum>（可选）：用于枚举合法性检查
- <META:run_id, algo_version, source_snapshot_ids>
- （可选）<RAW2_prev>/<TALL_prev>：用于判定“预期变更”

逻辑：
1) 预检（Preflight）：若出现 MISSING_WEIGHT / MISSING_TTL / MISSING_KEY_FIELDS / ENUM_INVALID_RATE / MANDATORY_SOURCE_MISSING / META_INCOMPLETE，终止本期。
2) 在 <TALL> 生成时，对同一 (store_id, tag_code) 的候选集合：
   - 计算 score = W_source × F_fresh；
   - 按 Δ_min 判 SELECTED/CONFLICT/UNKNOWN；
   - 在被选中行打 is_selected=1，并写入组级 select_status、delta_to_second。
3) 逆向检查：
   - 用（时间阈值法 或 对比法）判定 is_expected_change；
   - 若最终被选值 == 预期值 → APPLIED；否则 NOT_APPLIED，并枚举原因。
4) <HOT> 仅透视 <TALL> 中 is_selected=1 的值到各列，禁止再次决策。
5) 把 run_id/algo_version/source_snapshot_ids 写入 <TALL> 的全表常量列，便于回放与审计。
```

---

## H. 字段解释字典（统一放在这里，AI照此理解）

**输入候选最小字段（来自 ）**

- `store_id`：站点标准主键
    
- `tag_code`：标签编码（与配置一致）
    
- `value`：候选取值（若为枚举，需在枚举域内）
    
- `source_id`：数据源标识（S1/S2/S3/S4）
    
- `observed_at`：该候选的观测时间（可解析为日期）
    
- `ttl_days`（可空）：该候选的有效天数提示（若空则用配置默认）
    

**配置字段**

- `W_source(tag_code, source_id)`：该标签在某源的权重（0–1）
    
- `ttl_days(tag_code)`：该标签默认 TTL
    
- `decay_mode(tag_code)`：新鲜度衰减方式（`linear`/`exp`）
    
- `Δ_min(tag_code)`：分差阈值，判定是否冲突
    
- `enum_values(tag_code)`（可选）：合法取值列表
    

**在 里新增/聚合的字段（建议名，具体可映射）**

- `freshness_factor`：基于 `observed_at` 与 `ttl_days` 计算的新鲜度（0–1）
    
- `score`：`W_source × freshness_factor`
    
- `rank_in_group`：同组内按 score 排名（1 为最高）
    
- `delta_to_second`：Top1 与 Top2 的分差（仅 Top1 有值）
    
- `is_selected`：被选中行=1，其余=0
    
- `select_status`：`SELECTED` / `CONFLICT` / `UNKNOWN`（组级）
    
- `is_expected_change`：该候选是否属于“本期预期变更”
    
- `check_status`：`APPLIED` / `NOT_APPLIED`（组级）
    
- `not_applied_reason`：未生效原因枚举
    
- `run_id`：本期运行批次标识
    
- `algo_version`：决胜参数版本（例如 `OLAP-V1.0-202509`）
    
- `source_snapshot_ids`：各源快照标识（结构可为字符串或 JSON）
    

