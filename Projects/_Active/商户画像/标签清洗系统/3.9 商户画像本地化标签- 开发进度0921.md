## 核心共识总结
### 项目概述
- 产品名 ：商户画像本地化标签清洗系统
- 核心目标 ：端到端跑通P0标签的清洗与融合，产出Tall（真相层）和Hot（宽层）
- 关键原则 ：Excel-only、RAW1无损摄取、RAW2语义清洗+兜底、只用tag_code关联、S2严格品牌列名、不改现网三表
### 当前实现状态
- RAW1无损摄取 已实现：支持标签字段动态适配、字段完整性校验、Excel格式输出
- RAW2语义清洗 为简化版：基本的三槽值分配逻辑已存在，但需完善
- hot_wide.py和tall_merge.py 只有框架：核心逻辑待实现
- 标签规范 明确：13个P0标签，每个标签有值类型和默认值定义
### 待实现功能
1. 1.
   RAW2语义清洗完善 ：根据tag_spec.value_type将数据清洗到对应目标位
2. 2.
   Tall表生成 ：实现真相层（行式长表）的生成逻辑
3. 3.
   Hot表生成 ：实现宽层（列式宽表）的生成逻辑
4. 4.
   快照与增量对比 ：支持数据回放和增量分析
## 逻辑确认清单
1. 1.
   RAW2清洗逻辑 ：严格按照PRD要求实现
   
   - competitive_overlap ：是/1/true/有→1；否/0/false/无→0；未知/未核验/空/其他→99
   - brand_name ：文本直传，空/无效不产出该行
   - 其他标签根据 tag_spec.value_type 清洗到对应目标位
2. 2.
   Tall/Hot表结构 ：严格按照PRD定义实现
   
   - Tall表 ：行式长表，包含store_id, tag_code, snapshot_date等所有必需字段
   - Hot表 ：列式宽表，主键store_id, snapshot_date + P0标签展开列
3. 3.
   配置驱动 ：从配置表动态读取
   
   - 从 tag_spec.csv 和 tag_enum.csv 读取标签规格和枚举值
   - 从 ttl.yaml 、 merge_policy.yaml 和 metrics.yaml 读取策略配置
4. 4.
   输出格式 ：统一使用Excel格式
   
   - 所有产出均为.xlsx格式，便于人工审阅和抽检
   - 支持样例数据输出，便于验证
## 实现计划
1. 1.
   第一阶段 ：完善RAW2语义清洗脚本
   
   - 读取tag_spec和tag_enum配置
   - 实现按标签类型的三槽值分配逻辑
   - 处理缺失值和异常情况
2. 2.
   第二阶段 ：实现Tall表生成脚本
   
   - 读取RAW2数据和配置文件
   - 实现真相层的数据结构和逻辑
   - 支持配置驱动的TTL和合并策略
3. 3.
   第三阶段 ：实现Hot表生成脚本
   
   - 读取Tall表数据
   - 实现宽表的展开逻辑
   - 确保数据类型符合tag_spec定义
4. 4.
   第四阶段 ：实现快照和增量对比功能
   
   - 支持保存配置和产物快照
   - 实现增量对比逻辑
   - 输出增量报告
请确认以上逻辑是否符合您的预期，我将在得到确认后开始实现代码。



---
