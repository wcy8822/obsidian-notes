
---
# 商户画像｜全链路总结（目标 / 框架 / 进度 / 坑位与解法 / 后续计划）

> 本页是对话阶段性的“人类可读”对焦记录：不含代码，只讲口径、流程、配置与目录。用于对齐与固化决策，便于后续回放与交接。

---

## 1) 项目目标（P0 13 标签｜9/23 前达成）

* **总目标**：在 **2025-09-23** 前，基于现网“三表口径”（`tag_catalog.csv / tag_spec.csv / tag_enum.csv`），本地端到端跑通 **P0 13 标签** 的清洗与融合，产出 **Tall 真相层** 与 **Hot 宽层**；支持 **回放/回滚** 与 **evidence\_state** 呈现；**不改你现网列名/表结构**，由适配层完成对齐。
* **当期里程碑（本次对焦）**：

  1. **Excel-only 入口**（拒收 CSV）；
  2. **RAW1 无损摄取**（只保留原文，不清洗）；
  3. **RAW2 语义清洗与兜底**（类型化、容错 99）；
  4. **Tall/Hot** 仍按既定口径产出（将逐步切换到 Excel 出品，以便人工抽检）。

---

## 2) 大框架（全链路）

**数据源 → RAW1 → RAW2 → Tall（长）/ Hot（宽） → 快照/回放**

* **数据源（S1/S2/S3/S4）**：

  * **S1**=基线（宽表，例：`competitive_overlap`）；
  * **S2**=区域（宽表，多标签；其中 **brand\_name** 在 S2 仅**严格找列名 `brand_name`**，不启用别名；其它标签按映射读取）；
  * **S3**=商户（长表三列：`store_id, tag_code, enum_code/value_text`；品牌主供来源）；
  * **S4**=辅助源（按需）。
* **RAW1（原始摄取，不改语义）**：

  * **主键**：`store_id, tag_code, source, observed_at`；
  * **字段**：`store_id, tag_code, raw_value_text, raw_value_code, source, observed_at, upload_batch_id, origin_cols`；
  * **职责**：**Excel in → Excel out**；**不清洗**、不转码，原文落 `raw_value_text`；若源自带 `enum_code` 则入 `raw_value_code`；记录来源证据 `origin_cols`。
* **RAW2（语义清洗 + 兜底）**：

  * **字段**：`store_id, as_of_date, tag_code, target_value_bool/number/string, source, evidence_state, ttl_days, reason_code, reason_text, conf, upload_batch_id`；
  * **职责**：完成类型化与兜底（例如 `competitive_overlap` → `0/1/99`；无法识别统一落 **99** 且写 `reason_*`；`brand_name` 作为文本直传，不在 RAW2 做别名归一）。
* **Tall / Hot**：

  * **Tall（长）**：`(store_id, tag_code, as_of_date, 值位, 证据信息…)`；
  * **Hot（宽）**：按 P0 标签展开列；
  * **融合策略**：按 `TTL / 合并策略 / QA` 配置执行（见下）。
* **快照 / 回放**：将 **配置与产出**纳入 `snap_*` 快照；支持 D-1 回放、回滚与差异（Delta）对账。

---

## 3) 小框架（清洗节点拆解）

1. **入口摄取**（批次目录：`data/raw/inbox/<batch>/s1~s4`）

   * 仅接受 **`.xlsx/.xls`**；发现 `.csv` 直接驳回（Excel-only 闸门）。
   * 批次命名：`YYYYMMDD_HHMM`；同批可多文件，多文件合并处理。
2. **RAW1（无损）**

   * 原文透传：**任何中文/文本保留在 `raw_value_text`**；不做布尔/枚举解释。
   * 仅在源长表携带 `enum_code` 时写入 `raw_value_code`；否则留空。
   * `observed_at`：优先 `date_ob / observed_at`，缺失用文件 mtime 兜底（文本格式保留）。
   * **无效值过滤**（最小集合）：空白/`nan/none/null/未知` 等视为无效，行级跳过该标签条目；除无效值，其余一律写入。
3. **RAW2（语义化 + 容错）**

   * `competitive_overlap`：是/否/true/false → `1/0`；未知/未核验/空 → `99`；无法识别 → `99 + reason_*`；
   * `brand_name`：**文本直传**至 `target_value_string`，不在此步做别名与尾缀；
   * 其它布尔/枚举类标签：依 `tag_spec.value_type` 与枚举域清洗 → 目标值位；
   * 产出 Excel（`raw2_YYYYMMDD.xlsx`）。
4. **融合（生成 Tall/Hot）**

   * **TTL 策略**：`by_tag_source ＞ by_tag ＞ default_days`；缺失 TTL → `evidence_state=TTL_NOT_SET`；
   * **合并策略**：`conf = C_source^w1 × C_fresh^w2 × C_rule^w3 × C_match^w4`；黑名单源 → `SOURCE_BLACKLISTED`；
   * **QA**：越界率/回填率/变更率/新鲜度滞后阈值；超阈值出告警。
5. **快照/回放/增量**

   * `snap_YYYYMMDD/{tall.xlsx, hot.xlsx, configs}`；
   * **双口径产出**：全量 `tall/hot` 与当日 `delta`（与基线快照对比）。

---

## 4) 关键口径（锁定）

* **Excel-only**：入口只收 Excel；**Excel in → Excel out**（RAW1、RAW2、后续 Tall/Hot 逐步切换到 Excel 出品），保障人工抽检时无编码风险。
* **S2 品牌列名**：S2 **仅严格找** `brand_name` 列名；若表中无该列 → 不产出品牌（由 S3 长表补充）。其它标签（`competitive_overlap` 等）按映射读取。
* **RAW1 无损、RAW2 清洗**：

  * RAW1 **不清洗**（不做 1/0/99 判断，不清空文本）；
  * RAW2 统一做类型化与 99 兜底，并写明 `reason_code/reason_text`；
  * 证据字段在后续融合阶段补齐（`evidence_state`/`conf`/`ttl_days`）。
* **主键关系**：

  * RAW1：`store_id, tag_code, source, observed_at`；
  * RAW2：`store_id, tag_code, as_of_date`（同源同日可出现多条证据，融合时择优）。
* **只用 `tag_code` 关联**（不使用 `tag_id`）；三表（`catalog/spec/enum`）仅作**规范与映射依据**，不可更名。

---

## 5) 目录结构（最新）

```
/Users/didi/Downloads/panth/tag_ct_local
├─ conf/
│  ├─ manifest.yaml
│  ├─ policies/
│  │  ├─ ttl.yaml
│  │  └─ merge_policy.yaml
│  └─ qa/
│     └─ metrics.yaml
├─ data/
│  ├─ ref/                 # 三表
│  │  ├─ tag_catalog.csv
│  │  ├─ tag_spec.csv
│  │  └─ tag_enum.csv
│  └─ raw/
│     ├─ inbox/<batch>/s1~s4/   # 仅投喂 Excel
│     └─ sample/
│        ├─ sample_raw1.xlsx
│        └─ sample_raw2.xlsx
├─ output/
│  ├─ raw2/raw2_YYYYMMDD.xlsx
│  ├─ tall/tall_YYYYMMDD.(xlsx|csv)
│  ├─ hot/hot_YYYYMMDD.(xlsx|csv)
│  └─ delta/
├─ logs/
│  └─ snapshots/snap_YYYYMMDD/{tall.xlsx, hot.xlsx, configs}
├─ runs/
│  └─ <batch>/raw1.xlsx
└─ scripts/               # 运行脚本（此页不贴代码）
```

---

## 6) 配置单（归口与职责）

* **`conf/policies/ttl.yaml`**：数据新鲜度寿命（默认值 / 按标签 / 按标签×来源）。
* **`conf/policies/merge_policy.yaml`**：多源合并算法策略（权重、衰减、规则分、黑白名单、覆盖）。
* **`conf/qa/metrics.yaml`**：质检阈值（越界率、回填率、变更率、新鲜度）；反向校验规则（如 `open_24h` 全天覆盖）。
* **（建议新增）`conf/policies/ingest.yaml`**：无效值词表与各标签的特定无效规则，可拓展而不改代码。

---

## 7) 进度回顾（到当前回合）

* ✅ **白名单存在性 & 三表主键检查**：通过；P0 13 标签在 `catalog` 可被唯一识别。
* ✅ **骨架与清洗框架**：目录与配置齐备（`ttl/merge/qa`）。
* ✅ **入口稳定性**：由“CSV & 猜编码”转为 **Excel-only**（根因定位：CSV 编码/分隔符异构导致的花字节；Excel-only 后全部消失）。
* ✅ **RAW1（Excel in→out，无损）**：已产出 `raw1.xlsx`，中文可读；
* ⏳ **RAW2（Excel 出品）**：已跑通 `competitive_overlap`→`0/1/99` 兜底；`brand_name` 文本直传；
* ⏳ **Tall/Hot Excel 化**：准备接入（当前 Tall/Hot 仍可按 CSV 口径并存，一步步切换）。
* ⏳ **Delta/快照**：已具备流程，待与 Excel 产物联通（保存 `tall.xlsx/hot.xlsx` 至 `snap_*`）。

---

## 8) 坑位与解法（经验沉淀）

* **乱码/错位**：

  * 坑：CSV 编码与分隔符异构（UTF-8/GBK、逗号/制表、引号风格不一）导致 `Ã/�` 等花字节与列位移；
  * 解法：**Excel-only** 入口 + **Excel 出品**；RAW1 **不清洗**；BOM/编码问题直接规避；
  * 辅助：投喂前做“体检”（关键词扫描 `�/Ã/Â`），发现异常回源重导。
* **清洗过度**：

  * 坑：在 RAW1 就进行布尔/枚举解释，导致“已下线”等文本被误清洗；
  * 解法：清洗完全后移至 RAW2；RAW1 保证“原文如实呈现”。
* **S2 品牌缺列/空值**：

  * 坑：S2 某些宽表没有 `brand_name` 或填入 `nan` 文本；
  * 解法：S2 品牌仅严格找 `brand_name`；该列缺失时由 S3 长表补品牌；`nan/未知` 视为无效值不入库。
* **字段超长**：

  * 坑：原 CSV 路径下曾触发 `field_size_limit`；
  * 解法：Excel-only 后消失；保留“上限调整”作为兜底脚本备份。

---

## 9) 操作流程（简明 SOP）

1. **准备批次**：把源 Excel 放入 `data/raw/inbox/<batch>/s1~s4/`（`<batch>=YYYYMMDD_HHMM`）。
2. **入口体检**：执行 Excel-only 闸门（拒收 CSV）；异常即回源重导。
3. **跑 RAW1（Excel）** → 产出 `runs/<batch>/raw1.xlsx`；人工抽检 `sample_s1/s2/s3/s4` 页是否中文正常。
4. **跑 RAW2（Excel）** → 产出 `output/raw2/raw2_<as_of>.xlsx`；检查 `competitive_overlap ∈ {0,1,99}`；`brand_name` 在 `target_value_string`。
5. **跑 Tall/Hot（逐步 Excel 化）** → 产出 `output/tall_*.xlsx / output/hot_*.xlsx`；
6. **快照**：`logs/snapshots/snap_<as_of>/{tall.xlsx, hot.xlsx, configs}`；
7. **Delta**：对比基线与当日，产出增量清单（对账用）。

---

## 10) 风险识别与对应策略

* **源文件口径变动**：新增/更名列、混入 CSV → **入口体检 + Excel-only 闸门**；S2 品牌严格找 `brand_name` 保障确定性。
* **无效值渗透**：`nan/none/null/未知` 等 → **无效值词表**统一过滤；建议外置到 `conf/policies/ingest.yaml`。
* **语义歧义**：`competitive_overlap` 异常文本 → RAW2 统一落 **99**，并写明 `reason_*`，不影响系统稳定。
* **回放一致性**：配置变更导致结果波动 → 配置纳入快照，**D-1 回放**核验。

---

## 11) 下一步计划（行动清单）

* **A. Canvas & 配置**（今天）

  * 将本页与《TTL/合并/QA》页链接，标注“Excel-only 生效”；
  * 新增 `conf/policies/ingest.yaml`（无效值词表与按标签特定无效规则）。
* **B. Tall/Hot Excel 化**（明天）

  * Tall/Hot 改为 Excel 出品；纳入 `snap_*`；
  * 增量（Delta）对齐至 Excel 产物。
* **C. P0 标签扩容**（本周内）

  * 在 RAW2 配置中补齐 P0 其余标签的语义清洗与兜底；
  * 跑一版全量 + 增量，出 QA 报告（覆盖率/新鲜度/稳定性/冲突预警）。
* **D. 长期优化**

  * RAW2 的清洗词典/枚举域 → 全量外置到 YAML；
  * 证据打分（`conf`）与 `evidence_state` 的规则表达 → 与 `merge_policy.yaml` 对齐，形成“可解释分数”。

> 本页作为“共识快照”，随对话推进做轻量迭代；当某部分完全稳定时，将拆分为独立锁定页（例如《清洗框架（Excel 全链路版）》）。
